<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMAKINE - Agenda</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Paleta de colores base clara con acentos vibrantes */
            --background: #F5F7FA;
            --surface: #FFFFFF;
            --surface-hover: #F9FAFC;
            --border: #E2E8F0;
            --text-primary: #2D3748;
            --text-secondary: #718096;
            --accent-blue: #2D3FE0;
            --accent-teal: #00BFA5;
            --accent-coral: #FF6B6B;
            --accent-purple: #9B59B6;
            --shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            --shadow-elevated: 0 10px 25px rgba(0, 0, 0, 0.1);
            
            /* Tipos de cita */
            --eval-msk: #FFD3E0;
            --eval-deportiva: #C4F2E0;
            --sesion-msk: #FFEAA7;
            --sesion-deportiva: #BEE3F8;

            /* Colores más distinguibles por estudiante */
            .appointment.estudiante1 { background-color: #FF5252; } /* Rojo */
            .appointment.estudiante2 { background-color: #4CAF50; } /* Verde */
            .appointment.estudiante3 { background-color: #2196F3; } /* Azul */
            .appointment.estudiante4 { background-color: #FFC107; } /* Amarillo */
            .appointment.estudiante5 { background-color: #9C27B0; } /* Púrpura */
            .appointment.estudiante6 { background-color: #FF9800; } /* Naranja */
            .appointment.estudiante7 { background-color: #00BCD4; } /* Cian */
            .appointment.estudiante8 { background-color: #795548; } /* Marrón */
            .appointment.estudiante9 { background-color: #607D8B; } /* Azul grisáceo */
            .appointment.estudiante10 { background-color: #E91E63; } /* Rosa */
            
            /* Asegurarse que el texto sea legible en fondos oscuros */
            .appointment.estudiante1, .appointment.estudiante5, .appointment.estudiante8, 
            .appointment.estudiante9, .appointment.estudiante10 {
                color: white;
            }
            
            /* Estados */
            --success: #4CAF50;
            --warning: #FF9800;
            --error: #F44336;
            
            /* Animaciones */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.25s ease;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 14px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }
        
        .app-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-blue);
        }
        
        .week-navigation {
            display: flex;
            align-items: center;
            background: var(--surface);
            padding: 8px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        
        .week-navigation button {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 8px 12px;
            color: var(--accent-blue);
            transition: var(--transition-fast);
            border-radius: 4px;
        }
        
        .week-navigation button:hover {
            background-color: rgba(45, 63, 224, 0.1);
        }
        
        #current-week {
            margin: 0 12px;
            font-weight: 600;
            font-size: 16px;
        }
        
        #user-info {
            display: flex;
            align-items: center;
            background: var(--surface);
            padding: 8px 16px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        
        #user-name {
            font-weight: 500;
            margin-right: 16px;
        }
        
        /* Estructura de la agenda */
        .scheduler-container {
            background: var(--surface);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        .days-header, .dates-header {
            display: grid;
            grid-template-columns: 80px repeat(4, 1fr);
            text-align: center;
            background-color: var(--surface);
        }
        
        .days-header {
            border-bottom: 1px solid var(--border);
        }
        
        .day-header, .date-header {
            padding: 14px 10px;
            font-weight: 600;
        }
        
        .day-header {
            font-size: 16px;
            color: var(--text-primary);
        }
        
        .date-header {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .time-column-header {
            border-right: 1px solid var(--border);
        }
        
        .schedule-grid {
            display: grid;
            grid-template-columns: 80px repeat(4, 1fr);
            position: relative;
        }
        
        .time-cell {
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: var(--text-secondary);
            padding: 10px;
            font-weight: 500;
        }
        
        .schedule-cell {
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            padding: 6px;
            position: relative;
            min-height: 100px;
            transition: var(--transition-fast);
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-content: flex-start;
        }
        
        .schedule-cell:hover {
            background-color: var(--surface-hover);
        }
        
        .current-day {
            background-color: rgba(45, 63, 224, 0.05);
        }
        
        /* Diseño de las citas */
        .appointment {
            position: relative;
            border-radius: 6px;
            padding: 8px 10px;
            font-size: 13px;
            overflow: hidden;
            transition: var(--transition-fast);
            box-shadow: var(--shadow);
            flex: 0 0 calc(50% - 3px); /* Dos citas por fila */
            max-width: calc(50% - 3px);
            cursor: pointer;
            height: auto;
        }
        
        .appointment:hover {
            box-shadow: var(--shadow-elevated);
            transform: translateY(-2px);
        }
        
        .appointment.evaluacion-msk { 
            background-color: var(--eval-msk); 
        }
        
        .appointment.evaluacion-deportiva { 
            background-color: var(--eval-deportiva); 
        }
        
        .appointment.sesion-msk { 
            background-color: var(--sesion-msk); 
        }
        
        .appointment.sesion-deportiva { 
            background-color: var(--sesion-deportiva); 
        }
        
        .appointment.recurring {
            border-left: 3px solid var(--success);
        }
        
        .appointment-title {
            font-weight: 600;
            margin-bottom: 4px;
            margin-right: 20px; /* Añadir margen derecho para evitar solapamiento */
            padding-top: 15px; /* Espacio para la etiqueta de estudiante */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .appointment-type {
            font-size: 11px;
            opacity: 0.8;
            margin-bottom: 3px;
        }
        
        .appointment-therapist {
            font-size: 11px;
            font-weight: 500;
            margin-top: 4px;
        }
        
        .student-badge {
            position: absolute;
            right: 6px;
            top: 6px;
            font-size: 10px;
            font-weight: 600;
            color: white;
            background: rgba(0, 0, 0, 0.5);
            padding: 3px 6px;
            border-radius: 4px;
            z-index: 5;
            max-width: 90px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .appointment-status {
            position: absolute;
            right: 8px;
            bottom: 8px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .appointment-status.attended {
            background-color: var(--success);
        }
        
        .appointment-status.missed {
            background-color: var(--error);
        }
        
        .appointment-status.rescheduled {
            background-color: var(--warning);
        }
        
        .web-indicator {
            position: absolute;
            left: 8px;
            bottom: 6px;
            font-size: 10px;
            color: var(--accent-teal);
        }
        
        /* Estadísticas */
        .stats-panel {
            background-color: var(--surface);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .stats-title {
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-box {
            background-color: var(--surface-hover);
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-blue);
        }
        
        .therapist-stats-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
        }
        
        .charts-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 200px;
            margin: 30px 0;
        }
        
        .chart-bar {
            width: 80px;
            background-color: var(--accent-blue);
            margin: 0 30px;
            border-radius: 8px 8px 0 0;
            position: relative;
            transition: var(--transition-normal);
        }
        
        .chart-bar:nth-child(2) {
            background-color: var(--accent-teal);
        }
        
        .chart-bar:nth-child(3) {
            background-color: var(--accent-coral);
        }
        
        .chart-value {
            position: absolute;
            top: -30px;
            width: 100%;
            text-align: center;
            font-weight: 700;
            font-size: 18px;
            color: var(--text-primary);
        }
        
        .chart-labels {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        
        .chart-label {
            width: 140px;
            text-align: center;
            font-size: 15px;
            font-weight: 500;
        }
        
        /* Modales */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
            overflow-y: auto; /* Permitir scroll */
        }
        
        .modal-content {
            background-color: var(--surface);
            width: 90%;
            max-width: 550px;
            margin: 40px auto;
            border-radius: 12px;
            box-shadow: var(--shadow-elevated);
            overflow: hidden;
            animation: modalFadeIn 0.3s ease;
            position: relative;
            max-height: 90vh; /* Altura máxima */
            display: flex;
            flex-direction: column;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            padding: 20px;
            background-color: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 20px;
            color: var(--accent-blue);
        }
        
        .close {
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: var(--transition-fast);
        }
        
        .close:hover {
            color: var(--accent-coral);
        }
        
        form {
            padding: 20px;
            overflow-y: auto; /* Permitir scroll en el formulario */
            flex: 1;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group input[type="time"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            transition: var(--transition-fast);
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(45, 63, 224, 0.1);
        }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
        }
        
        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .weekday-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 8px;
        }
        
        .weekday-selector label {
            display: flex;
            align-items: center;
            font-weight: normal;
            margin-right: 12px;
            cursor: pointer;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 30px;
            position: sticky;
            bottom: 0;
            background-color: var(--surface);
            padding: 10px 0;
            border-top: 1px solid var(--border);
        }
        
        .button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition-fast);
        }
        
        .save-btn {
            background-color: var(--accent-blue);
            color: white;
        }
        
        .save-btn:hover {
            background-color: #2235C0;
        }
        
        .cancel-btn {
            background-color: #E2E8F0;
            color: var(--text-primary);
        }
        
        .cancel-btn:hover {
            background-color: #CBD5E0;
        }
        
        .delete-btn {
            background-color: var(--error);
            color: white;
        }
        
        .delete-btn:hover {
            background-color: #D32F2F;
        }
        
        /* Modal de asistencia */
        .modal-body {
            padding: 20px;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            text-align: right;
            position: sticky;
            bottom: 0;
            background-color: var(--surface);
        }
        
        .attendance-options {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            gap: 10px;
        }
        
        .attendance-btn {
            padding: 12px;
            border: 1px solid var(--border);
            background-color: var(--surface);
            border-radius: 6px;
            cursor: pointer;
            flex: 1;
            text-align: center;
            transition: var(--transition-fast);
            font-weight: 500;
        }
        
        .attendance-btn[data-status="attended"] {
            border-color: var(--success);
            color: var(--success);
        }
        
        .attendance-btn[data-status="attended"].selected {
            background-color: var(--success);
            color: white;
        }
        
        .attendance-btn[data-status="missed"] {
            border-color: var(--error);
            color: var(--error);
        }
        
        .attendance-btn[data-status="missed"].selected {
            background-color: var(--error);
            color: white;
        }
        
        .attendance-btn[data-status="rescheduled"] {
            border-color: var(--warning);
            color: var(--warning);
        }
        
        .attendance-btn[data-status="rescheduled"].selected {
            background-color: var(--warning);
            color: white;
        }
        
        /* Arrastrar y soltar */
        .schedule-cell.drag-over {
            background-color: rgba(45, 63, 224, 0.1);
        }
        
        /* Spinner de carga */
        .spinner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }
        
        .spinner-content {
            width: 40px;
            height: 40px;
            border: 3px solid #E2E8F0;
            border-top: 3px solid var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Mensajes de estado */
        .status-message {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: var(--shadow-elevated);
            display: none;
            z-index: 1500;
            font-weight: 500;
            animation: fadeIn 0.3s ease;
        }
        
        .status-message.success {
            background-color: var(--success);
            color: white;
        }
        
        .status-message.error {
            background-color: var(--error);
            color: white;
        }
        
        .status-message.warning {
            background-color: var(--warning);
            color: white;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Login */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background-color: var(--surface);
            border-radius: 12px;
            box-shadow: var(--shadow-elevated);
        }
        
        .login-title {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
            color: var(--accent-blue);
        }
        
        /* Responsive */
        @media (max-width: 900px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
            
            .week-navigation, #user-info {
                width: 100%;
            }
            
            .days-header, .dates-header, .schedule-grid {
                grid-template-columns: 60px repeat(4, 1fr);
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-container {
                flex-direction: column;
                height: auto;
                align-items: center;
            }
            
            .chart-bar {
                width: 100%;
                height: 40px !important;
                margin: 10px 0;
                border-radius: 0 5px 5px 0;
            }
            
            .chart-value {
                top: 10px;
                right: -25px;
                left: auto;
            }
            
            .chart-labels {
                flex-direction: column;
            }
            
            .appointment {
                flex: 0 0 100%;
                max-width: 100%;
            }
            
            .modal-content {
                width: 95%;
                margin: 20px auto;
                max-height: 85vh;
            }
        }
        
        @media (min-width: 901px) and (max-width: 1200px) {
            .appointment {
                flex: 0 0 calc(50% - 3px);
                max-width: calc(50% - 3px);
            }
        }
        
        @media (min-width: 1201px) {
            .appointment {
                flex: 0 0 calc(33.333% - 4px);
                max-width: calc(33.333% - 4px);
            }
        }


        /* Buscador de pacientes */
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: var(--surface);
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        
        .search-container input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
        }
        
        .search-container button {
            padding: 8px 15px;
        }

        
        /* Panel de administración de estudiantes */
.admin-panel {
    background-color: var(--surface);
    border-radius: 12px;
    box-shadow: var(--shadow);
    padding: 20px;
    margin-bottom: 30px;
}

.admin-title {
    margin-bottom: 20px;
    font-size: 20px;
    font-weight: 600;
    color: var(--text-primary);
}

.student-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
}

.student-item {
    background-color: var(--surface-hover);
    padding: 15px;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.student-code {
    font-weight: 600;
    color: var(--text-primary);
}

.student-name {
    padding: 8px;
    border: 1px solid var(--border);
    border-radius: 6px;
}

.save-student-btn {
    background-color: var(--accent-blue);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    margin-top: 5px;
}

.save-student-btn:hover {
    background-color: #2235C0;
}

/* Estilos para días feriados */
.holiday-cell {
    background-color: rgba(255, 107, 107, 0.1);
    position: relative;
}

.holiday-cell::after {
    content: "Feriado";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: var(--error);
    font-size: 14px;
    font-weight: 600;
    opacity: 0.7;
}

    /* Mejorar formato de la tabla de estadísticas */
.student-stats-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    box-shadow: var(--shadow);
    border-radius: 8px;
    overflow: hidden;
}

.student-stats-table thead th {
    background-color: var(--accent-blue);
    color: white;
    padding: 12px 15px;
    text-align: left;
    font-weight: 600;
}

.student-stats-table tbody td {
    padding: 12px 15px;
    border-bottom: 1px solid var(--border);
}

.student-stats-table tbody tr:last-child td {
    border-bottom: none;
}

.student-stats-table tbody tr:hover {
    background-color: var(--surface-hover);
}

/* Contenedor de exportación */
.export-container {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}

/* Resaltado para búsqueda de pacientes */
.appointment.highlighted {
    box-shadow: 0 0 0 3px var(--accent-blue);
    transform: translateY(-3px);
    z-index: 10;
}

/* Gráfico circular */
.chart-legend {
    margin-top: 15px;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
}

.legend-item {
    display: flex;
    align-items: center;
    margin: 5px 10px;
}

.legend-item div {
    width: 12px;
    height: 12px;
    margin-right: 5px;
    border-radius: 2px;
}

/* Mejorar espaciado en estadísticas */
.stats-section {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid var(--border);
}

.therapist-stats-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 20px;
    color: var(--text-primary);
}

/* Buscador de pacientes */
.search-container {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    background: var(--surface);
    padding: 15px;
    border-radius: 8px;
    box-shadow: var(--shadow);
}

.search-container input {
    flex: 1;
    padding: 10px;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 14px;
}

.search-container button {
    padding: 8px 15px;
}  
        /* Añadir estos estilos al final de la sección de CSS */
.stats-panel {
    position: relative;
    overflow: visible;
    padding-bottom: 50px; /* Añadir espacio adicional abajo */
}

.student-stats-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin-top: 20px;
    box-shadow: var(--shadow);
    border-radius: 8px;
    overflow: hidden;
    position: relative;
    z-index: 10; /* Aumentar para evitar solapamientos */
}

/* Mejorar separación entre secciones de estadísticas */
.stats-section {
    margin-top: 50px;
    padding-top: 30px;
    border-top: 1px solid var(--border);
    clear: both; /* Evitar solapamientos con elementos flotantes */
}

h4.therapist-stats-title {
    margin-top: 30px;
    margin-bottom: 20px;
    padding-top: 10px;
    clear: both;
}

/* Botones de exportación */
.export-container {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 30px;
    position: relative;
    z-index: 20; /* Asegurar que los botones estén encima */
}
    </style>
</head>
<body>
    <!-- Spinner de carga -->
    <div class="spinner" id="spinner">
        <div class="spinner-content"></div>
    </div>
    
    <!-- Mensaje de estado -->
    <div class="status-message" id="status-message"></div>
    
    <!-- Contenedor de login (se muestra solo si el usuario no está autenticado) -->
    <div class="login-container" id="login-container" style="display: none;">
        <h2 class="login-title">SISTEMAKINE - Agenda</h2>
        <form id="login-form">
            <div class="form-group">
                <label for="email">Correo electrónico:</label>
                <input type="email" id="email" required>
            </div>
            <div class="form-group">
                <label for="password">Contraseña:</label>
                <input type="password" id="password" required>
            </div>
            <div class="form-actions">
                <button type="submit" class="button save-btn">Iniciar sesión</button>
            </div>
            <p style="margin-top: 20px; text-align: center; color: var(--text-secondary);">
                <small>Si eres estudiante, solicita las credenciales a tu profesor.</small>
            </p>
        </form>
    </div>
    
    <!-- Contenedor principal (se muestra solo si el usuario está autenticado) -->
    <div class="container" id="main-container" style="display: none;">
        <header>
            <h1 class="app-title">SISTEMAKINE</h1>
            <div class="week-navigation">
                <button id="prev-week">◀</button>
                <h2 id="current-week">Semana del 17 al 20 de marzo de 2025</h2>
                <button id="next-week">▶</button>
            </div>
            <div id="user-info">
                <span id="user-name"></span>
                <button id="logout-btn" class="button cancel-btn" style="padding: 6px 12px; font-size: 13px;">Cerrar sesión</button>
            </div>
        </header>

        <!-- Buscador de pacientes -->
        <div class="search-container">
            <input type="text" id="patient-search" placeholder="Buscar paciente...">
            <button id="search-btn" class="button save-btn">Buscar</button>
            <button id="clear-search-btn" class="button cancel-btn">Limpiar</button>
        </div>
        
        <div class="scheduler-container">
            <!-- Encabezado de la semana con días -->
            <div class="days-header">
                <div class="time-column-header"></div>
                <div class="day-header" id="day-header-1">Lunes</div>
                <div class="day-header" id="day-header-2">Martes</div>
                <div class="day-header" id="day-header-3">Miércoles</div>
                <div class="day-header" id="day-header-4">Jueves</div>
            </div>

            <!-- Encabezado con fechas -->
            <div class="dates-header">
                <div class="time-column-header"></div>
                <div class="date-header" id="date-header-1">17/3</div>
                <div class="date-header" id="date-header-2">18/3</div>
                <div class="date-header" id="date-header-3">19/3</div>
                <div class="date-header" id="date-header-4">20/3</div>
            </div>

            <!-- Cuadrícula de la agenda -->
            <div class="schedule-grid">
                <!-- Horas -->
                <div class="time-cell">09:00</div>
                <div class="schedule-cell" data-hour="9" data-day="1"></div>
                <div class="schedule-cell" data-hour="9" data-day="2"></div>
                <div class="schedule-cell" data-hour="9" data-day="3"></div>
                <div class="schedule-cell" data-hour="9" data-day="4"></div>
                
                <div class="time-cell">10:00</div>
                <div class="schedule-cell" data-hour="10" data-day="1"></div>
                <div class="schedule-cell" data-hour="10" data-day="2"></div>
                <div class="schedule-cell" data-hour="10" data-day="3"></div>
                <div class="schedule-cell" data-hour="10" data-day="4"></div>
                
                <div class="time-cell">11:00</div>
                <div class="schedule-cell" data-hour="11" data-day="1"></div>
                <div class="schedule-cell" data-hour="11" data-day="2"></div>
                <div class="schedule-cell" data-hour="11" data-day="3"></div>
                <div class="schedule-cell" data-hour="11" data-day="4"></div>
                
                <div class="time-cell">12:00</div>
                <div class="schedule-cell" data-hour="12" data-day="1"></div>
                <div class="schedule-cell" data-hour="12" data-day="2"></div>
                <div class="schedule-cell" data-hour="12" data-day="3"></div>
                <div class="schedule-cell" data-hour="12" data-day="4"></div>
                
                <div class="time-cell">13:00</div>
                <div class="schedule-cell" data-hour="13" data-day="1"></div>
                <div class="schedule-cell" data-hour="13" data-day="2"></div>
                <div class="schedule-cell" data-hour="13" data-day="3"></div>
                <div class="schedule-cell" data-hour="13" data-day="4"></div>
                
                <div class="time-cell">14:00</div>
                <div class="schedule-cell" data-hour="14" data-day="1"></div>
                <div class="schedule-cell" data-hour="14" data-day="2"></div>
                <div class="schedule-cell" data-hour="14" data-day="3"></div>
                <div class="schedule-cell" data-hour="14" data-day="4"></div>
                
                <div class="time-cell">15:00</div>
                <div class="schedule-cell" data-hour="15" data-day="1"></div>
                <div class="schedule-cell" data-hour="15" data-day="2"></div>
                <div class="schedule-cell" data-hour="15" data-day="3"></div>
                <div class="schedule-cell" data-hour="15" data-day="4"></div>
                
                <div class="time-cell">16:00</div>
                <div class="schedule-cell" data-hour="16" data-day="1"></div>
                <div class="schedule-cell" data-hour="16" data-day="2"></div>
                <div class="schedule-cell" data-hour="16" data-day="3"></div>
                <div class="schedule-cell" data-hour="16" data-day="4"></div>
            </div>
        </div>
        
        <div class="stats-panel">
            <h3 class="stats-title">Estadísticas</h3>
            
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">Asistencia semanal</div>
                    <div class="stat-value" id="attendance-rate">85%</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Citas totales</div>
                    <div class="stat-value" id="total-appointments">32</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Hora más ocupada</div>
                    <div class="stat-value" id="busiest-hour">10:00</div>
                </div>
            </div>
            
            <h4 class="therapist-stats-title">Pacientes por estudiante</h4>
            
            <div class="charts-container" id="student-chart">
                <!-- Se llenará dinámicamente -->
            </div>
            
            <div class="chart-labels" id="student-chart-labels">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>
    </div>

     <!-- Panel de Administración de Estudiantes -->
        <div class="admin-panel">
            <h3 class="admin-title">Administración de Estudiantes</h3>
            <div class="student-list" id="student-list">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>
    
    <!-- Modal para agregar/editar citas -->
    <div class="modal" id="appointment-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Agregar Nueva Cita</h3>
                <span class="close">&times;</span>
            </div>
            <form id="appointment-form">
                <div class="form-group">
                    <label for="patient-name">Paciente:</label>
                    <input type="text" id="patient-name" required>
                </div>
                <div class="form-group">
                    <label for="appointment-type">Tipo de consulta:</label>
                    <select id="appointment-type" required onchange="handleAppointmentTypeChange()">
                        <option value="evaluacion-msk">Evaluación kinesiología MSK</option>
                        <option value="evaluacion-deportiva">Evaluación kinesiología deportiva</option>
                        <option value="sesion-msk">Sesión kinesiología MSK</option>
                        <option value="sesion-deportiva">Sesión kinesiología deportiva</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="student">Estudiante asignado:</label>
                    <select id="student" required>
                        <option value="estudiante1">Estudiante 1</option>
                        <option value="estudiante2">Estudiante 2</option>
                        <option value="estudiante3">Estudiante 3</option>
                        <option value="estudiante4">Estudiante 4</option>
                        <option value="estudiante5">Estudiante 5</option>
                        <option value="estudiante6">Estudiante 6</option>
                        <option value="estudiante7">Estudiante 7</option>
                        <option value="estudiante8">Estudiante 8</option>
                        <option value="estudiante9">Estudiante 9</option>
                        <option value="estudiante10">Estudiante 10</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="appointment-date">Fecha:</label>
                    <input type="date" id="appointment-date" required>
                </div>
                <div class="form-group">
                    <label for="appointment-time">Hora inicio:</label>
                    <input type="time" id="appointment-time" required>
                </div>
                <div class="form-group">
                    <label for="appointment-duration">Duración:</label>
                    <select id="appointment-duration" required>
                        <option value="60">1 hora</option>
                        <option value="120">2 horas</option>
                        <option value="30">30 minutos</option>
                        <option value="90">1 hora 30 minutos</option>
                    </select>
                </div>

                <!-- Sección para citas recurrentes -->
                <div id="recurrence-options" style="display: none;">
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="is-recurring">
                            <label for="is-recurring">Cita recurrente</label>
                        </div>
                    </div>
                    <div id="recurring-details" style="display: none; padding-left: 20px; margin-top: 10px;">
                        <div class="form-group">
                            <label>Días de la semana:</label>
                            <div class="weekday-selector">
                                <label><input type="checkbox" name="weekday" value="1"> Lunes</label>
                                <label><input type="checkbox" name="weekday" value="2"> Martes</label>
                                <label><input type="checkbox" name="weekday" value="3"> Miércoles</label>
                                <label><input type="checkbox" name="weekday" value="4"> Jueves</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="recurrence-end">Fecha fin:</label>
                            <input type="date" id="recurrence-end">
                        </div>
                    </div>
                </div>

                <!-- Comuna de residencia -->
<div class="form-group">
    <label for="patient-comuna">Comuna de residencia:</label>
    <select id="patient-comuna" required>
        <option value="">Seleccionar comuna</option>
        <option value="Santiago">Santiago</option>
        <option value="Providencia">Providencia</option>
        <option value="Las Condes">Las Condes</option>
        <option value="Ñuñoa">Ñuñoa</option>
        <option value="La Reina">La Reina</option>
        <option value="Vitacura">Vitacura</option>
        <option value="Lo Barnechea">Lo Barnechea</option>
        <option value="Maipú">Maipú</option>
        <option value="La Florida">La Florida</option>
        <option value="Puente Alto">Puente Alto</option>
        <option value="San Bernardo">San Bernardo</option>
        <option value="Peñalolén">Peñalolén</option>
        <option value="Macul">Macul</option>
        <option value="Estación Central">Estación Central</option>
        <option value="Quinta Normal">Quinta Normal</option>
        <option value="Recoleta">Recoleta</option>
        <option value="Independencia">Independencia</option>
        <option value="Conchalí">Conchalí</option>
        <option value="Huechuraba">Huechuraba</option>
        <option value="Quilicura">Quilicura</option>
        <option value="Renca">Renca</option>
        <option value="Cerrillos">Cerrillos</option>
        <option value="Pedro Aguirre Cerda">Pedro Aguirre Cerda</option>
        <option value="Lo Espejo">Lo Espejo</option>
        <option value="San Joaquín">San Joaquín</option>
        <option value="La Cisterna">La Cisterna</option>
        <option value="San Miguel">San Miguel</option>
        <option value="San Ramón">San Ramón</option>
        <option value="La Granja">La Granja</option>
        <option value="El Bosque">El Bosque</option>
        <option value="La Pintana">La Pintana</option>
        <option value="Cerro Navia">Cerro Navia</option>
        <option value="Lo Prado">Lo Prado</option>
        <option value="Pudahuel">Pudahuel</option>
        <option value="Otro">Otro</option>
    </select>
</div>

<!-- Teléfono -->
<div class="form-group">
    <label for="patient-phone">Teléfono:</label>
    <input type="tel" id="patient-phone" placeholder="+56 9 XXXX XXXX">
</div>

<!-- Correo electrónico -->
<div class="form-group">
    <label for="patient-email">Correo electrónico:</label>
    <input type="email" id="patient-email" placeholder="ejemplo@correo.cl">
</div>
                
                <div class="form-group">
                    <label for="appointment-notes">Notas:</label>
                    <textarea id="appointment-notes"></textarea>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="is-web">
                        <label for="is-web">Vía web</label>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="button delete-btn" id="delete-appointment" style="display: none; margin-right: auto;">Eliminar</button>
                    <button type="button" class="button cancel-btn" id="cancel-appointment">Cancelar</button>
                    <button type="submit" class="button save-btn">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal para confirmar asistencia -->
    <div class="modal" id="attendance-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirmar Asistencia</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <p><strong>Paciente:</strong> <span id="attendance-patient"></span></p>
                <p><strong>Fecha:</strong> <span id="attendance-date"></span></p>
                <p><strong>Hora:</strong> <span id="attendance-time"></span></p>
                <div class="attendance-options">
                    <button class="attendance-btn" data-status="attended">Asistió</button>
                    <button class="attendance-btn" data-status="missed">No asistió</button>
                    <button class="attendance-btn" data-status="rescheduled">Reprogramada</button>
                </div>
                <div class="form-group">
                    <label for="attendance-notes">Notas:</label>
                    <textarea id="attendance-notes"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="button cancel-btn" id="cancel-attendance">Cancelar</button>
                <button class="button save-btn" id="save-attendance">Guardar</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>


    <script>
  // Configuración de Firebase - REEMPLAZA ESTOS VALORES CON LOS DE TU PROYECTO FIREBASE
const firebaseConfig = {
    apiKey: "AIzaSyA8fY-L1r3nBq61CFPOAFRI6TlS9A5GNTA",
    authDomain: "agendapoli-13963.firebaseapp.com",
    projectId: "agendapoli-13963",
    storageBucket: "agendapoli-13963.firebasestorage.app",
    messagingSenderId: "265927768586",
    appId: "1:265927768586:web:c7e37e6a561bd996687df3"
};

// Inicializar Firebase (con manejo de errores)
try {
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
        console.log("[DEBUG] Firebase inicializado correctamente");
    } else {
        console.log("[DEBUG] Firebase ya estaba inicializado");
    }
} catch (error) {
    console.error("[DEBUG] Error al inicializar Firebase:", error);
    alert("Error al inicializar Firebase. Por favor revisa la consola para detalles.");
}

// Referencias a Firebase
let auth, db;
try {
    auth = firebase.auth();
    db = firebase.firestore();
    console.log("[DEBUG] Referencias a auth y db creadas");
} catch (error) {
    console.error("[DEBUG] Error al crear referencias:", error);
    alert("Error al conectar con Firebase. Verifica tu conexión a internet.");
}

// Variables globales
let currentUser = null;
let isAdmin = false;
let appointments = [];
let editingAppointmentId = null;
let holidays = [];
let currentWeekDate = new Date();
let studentNames = {}; // Para guardar los nombres reales de los estudiantes
let uniquePatientsByStudent = {}; // Para estadísticas

// Elementos DOM
const spinner = document.getElementById('spinner');
const statusMessage = document.getElementById('status-message');
const loginContainer = document.getElementById('login-container');
const mainContainer = document.getElementById('main-container');
const appointmentModal = document.getElementById('appointment-modal');
const appointmentForm = document.getElementById('appointment-form');
const attendanceModal = document.getElementById('attendance-modal');
const currentWeekDisplay = document.getElementById('current-week');
const loginForm = document.getElementById('login-form');
const userNameDisplay = document.getElementById('user-name');
const logoutBtn = document.getElementById('logout-btn');

// Inicializar la aplicación
document.addEventListener('DOMContentLoaded', function() {
    // Mostrar spinner mientras carga
    showSpinner();
    
    // Verificar estado de autenticación
    auth.onAuthStateChanged(function(user) {
        console.log("[DEBUG] Estado de autenticación cambiado");
        
        if (user) {
            // Usuario autenticado
            currentUser = user;
            console.log("[DEBUG] Usuario autenticado:", user.email);
            console.log("[DEBUG] UID del usuario:", user.uid);
            userNameDisplay.textContent = user.email;
            
            // Esperar un momento antes de verificar el rol (para asegurar que Firebase esté listo)
            setTimeout(() => {
                checkUserRole(user.uid);
            }, 1000);
        } else {
            // Usuario no autenticado
            console.log("[DEBUG] No hay usuario autenticado");
            showLoginScreen();
            hideSpinner();
        }
    });
    
    // Configurar event listeners
    setupEventListeners();
    
    // Solución temporal: si después de 10 segundos sigue mostrando spinner, ocultarlo
    setTimeout(() => {
        if (spinner.style.display === 'flex') {
            hideSpinner();
            showStatusMessage('Carga completada', 'success');
        }
    }, 10000);
});

function checkUserRole(userId) {
    console.log("[DEBUG] Usuario autenticado:", userId);
    
    // Tratar a todos los usuarios como administradores
    isAdmin = true;
    document.body.classList.remove('student-view');
    
    try {
        // Obtener información del usuario para el historial
        db.collection('usuarios').doc(userId).get()
            .then((doc) => {
                if (doc.exists) {
                    // Guardar información del usuario para el historial
                    const userData = doc.data();
                    console.log("[DEBUG] Información del usuario:", userData);
                } else {
                    // Si no existe el documento del usuario, crearlo con timestamp
                    db.collection('usuarios').doc(userId).set({
                        email: currentUser.email,
                        ultimoAcceso: new Date().toISOString()
                    })
                    .then(() => {
                        console.log("[DEBUG] Documento de usuario creado");
                    })
                    .catch(error => {
                        console.error("[DEBUG] Error al crear documento de usuario:", error);
                        showStatusMessage("Error al guardar información de usuario", "error");
                    });
                }
                
                // Inicializar la agenda
                initializeApp();
            })
            .catch((error) => {
                console.error("[DEBUG] Error al obtener información del usuario:", error);
                showStatusMessage("Error al cargar datos de usuario", "error");
                
                // De todos modos inicializar la aplicación
                isAdmin = true;
                document.body.classList.remove('student-view');
                initializeApp();
            });
    } catch (error) {
        console.error("Error crítico al acceder a la base de datos:", error);
        showStatusMessage("Error de conexión con la base de datos", "error");
        
        // Fallback para permitir al usuario ver al menos algo
        isAdmin = true;
        document.body.classList.remove('student-view');
        initializeApp();
    }
}

// Inicializar la aplicación
function initializeApp() {
    loadHolidays();
    updateWeekDisplay();
    
    // Cargar nombres de estudiantes primero
    loadStudentNames()
        .then(() => {
            try {
                loadAppointments();
            } catch (error) {
                console.error("Error al cargar citas:", error);
                showStatusMessage("Error al cargar citas. Usando datos de ejemplo.", "warning");
                loadSampleAppointments();
            }
        });
    
    // Mostrar la interfaz principal
    loginContainer.style.display = 'none';
    mainContainer.style.display = 'block';
    
    hideSpinner();
}

// Cargar nombres de estudiantes
function loadStudentNames() {
    return new Promise((resolve) => {
        const defaultStudents = {
            'estudiante1': 'Estudiante 1',
            'estudiante2': 'Estudiante 2',
            'estudiante3': 'Estudiante 3',
            'estudiante4': 'Estudiante 4',
            'estudiante5': 'Estudiante 5',
            'estudiante6': 'Estudiante 6',
            'estudiante7': 'Estudiante 7',
            'estudiante8': 'Estudiante 8',
            'estudiante9': 'Estudiante 9',
            'estudiante10': 'Estudiante 10'
        };
        
        db.collection('configuracion').doc('estudiantes').get()
            .then((doc) => {
                if (doc.exists) {
                    studentNames = doc.data();
                    // Combinar con estudiantes por defecto (para asegurar que todos existan)
                    studentNames = {...defaultStudents, ...studentNames};
                } else {
                    // Si no existe el documento, usar los nombres por defecto
                    studentNames = defaultStudents;
                    // Y crear el documento
                    db.collection('configuracion').doc('estudiantes').set(studentNames);
                }
                
                // Generar la lista de estudiantes en el panel de administración
                generateStudentsList();
                resolve();
            })
            .catch((error) => {
                console.error("Error al cargar nombres de estudiantes:", error);
                studentNames = defaultStudents;
                generateStudentsList();
                resolve();
            });
    });
}

// Generar la lista de estudiantes en el panel de administración
function generateStudentsList() {
    const studentList = document.getElementById('student-list');
    if (!studentList) return;
    
    studentList.innerHTML = '';
    
    // Actualizar el selector de estudiantes en el formulario
    const studentSelect = document.getElementById('student');
    if (studentSelect) {
        studentSelect.innerHTML = '';
    }
    
    for (const code in studentNames) {
        // Añadir al panel de administración
        const item = document.createElement('div');
        item.className = 'student-item';
        item.dataset.code = code;
        
        item.innerHTML = `
            <div class="student-code">${code}</div>
            <input type="text" class="student-name" placeholder="Nombre real" value="${studentNames[code]}">
            <button class="save-student-btn">Guardar</button>
        `;
        
        studentList.appendChild(item);
        
        // Configurar el botón de guardar
        const saveBtn = item.querySelector('.save-student-btn');
        saveBtn.addEventListener('click', function() {
            const input = item.querySelector('.student-name');
            saveStudentName(code, input.value);
        });
        
        // Actualizar el selector de estudiantes
        if (studentSelect) {
            const option = document.createElement('option');
            option.value = code;
            option.textContent = studentNames[code];
            studentSelect.appendChild(option);
        }
    }
}

// Guardar nombre de estudiante
function saveStudentName(code, name) {
    if (!name || name.trim() === '') {
        showStatusMessage('Por favor ingresa un nombre válido', 'warning');
        return;
    }
    
    showSpinner();
    console.log(`Guardando nombre para ${code}: ${name}`);
    
    const updateData = {};
    updateData[code] = name;
    
    db.collection('configuracion').doc('estudiantes').update(updateData)
        .then(() => {
            const oldName = studentNames[code] || code;
            studentNames[code] = name; // Actualizar en memoria
            showStatusMessage(`Nombre de ${code} actualizado a "${name}"`, 'success');
            console.log(`Nombre actualizado en configuración: ${oldName} → ${name}`);
            
            // Primero actualizar las referencias visuales y luego recargar
            updateStudentReferences(code, name);
        })
        .catch((error) => {
            console.error("Error al guardar nombre de estudiante:", error);
            showStatusMessage("Error al guardar el nombre", "error");
            hideSpinner();
        });
}

// Actualizar referencias visuales del estudiante y en la base de datos
function updateStudentReferences(code, name) {
    showSpinner();
    
    console.log(`Actualizando estudiante: ${code} a nombre: ${name}`);
    
    // Actualizar las tarjetas de cita visualmente
    document.querySelectorAll(`.appointment`).forEach(el => {
        const badgeEl = el.querySelector('.student-badge');
        if (badgeEl && (badgeEl.textContent === code || badgeEl.textContent === studentNames[code])) {
            badgeEl.textContent = name;
        }
    });
    
    // Actualizar las opciones del formulario
    const option = document.querySelector(`#student option[value="${code}"]`);
    if (option) {
        option.textContent = name;
    }
    
    // Actualizar todas las citas en la base de datos que tienen este estudiante
    db.collection('citas').where('estudiante', '==', code).get()
        .then((querySnapshot) => {
            console.log(`Encontradas ${querySnapshot.size} citas para actualizar`);
            
            // Si hay citas para actualizar
            if (!querySnapshot.empty) {
                const batch = db.batch();
                querySnapshot.forEach((doc) => {
                    batch.update(doc.ref, { 
                        estudianteNombre: name,
                        historial: firebase.firestore.FieldValue.arrayUnion({
                            accion: 'actualizacion_nombre_estudiante',
                            usuario: currentUser ? currentUser.email : 'sistema',
                            usuarioId: currentUser ? currentUser.uid : 'sistema',
                            fecha: new Date(),
                            detalles: `Nombre cambiado de ${studentNames[code]} a ${name}`
                        })
                    });
                });
                
                // Ejecutar todas las actualizaciones en un lote
                batch.commit()
                    .then(() => {
                        showStatusMessage(`Se actualizaron ${querySnapshot.size} citas con el nuevo nombre de estudiante`, 'success');
                        loadAppointments(); // Recargar citas
                    })
                    .catch((error) => {
                        console.error("Error al actualizar citas:", error);
                        showStatusMessage("Error al actualizar citas", "error");
                        hideSpinner();
                    });
            } else {
                showStatusMessage(`No se encontraron citas para el estudiante ${code}`, 'info');
                loadAppointments(); // Recargar citas de todos modos
                hideSpinner();
            }
        })
        .catch((error) => {
            console.error("Error al buscar citas para actualizar:", error);
            showStatusMessage("Error al buscar citas para actualizar", "error");
            hideSpinner();
        });
}

// Mostrar pantalla de login
function showLoginScreen() {
    loginContainer.style.display = 'block';
    mainContainer.style.display = 'none';
}

// Cargar los feriados chilenos
function loadHolidays() {
    holidays = [
        { date: '2025-01-01', name: 'Año Nuevo' },
        { date: '2025-04-18', name: 'Viernes Santo' },
        { date: '2025-04-19', name: 'Sábado Santo' },
        { date: '2025-05-01', name: 'Día del Trabajo' },
        { date: '2025-05-21', name: 'Día de las Glorias Navales' },
        { date: '2025-06-29', name: 'San Pedro y San Pablo' },
        { date: '2025-07-16', name: 'Virgen del Carmen' },
        { date: '2025-08-15', name: 'Asunción de la Virgen' },
        { date: '2025-09-18', name: 'Independencia Nacional' },
        { date: '2025-09-19', name: 'Día de las Glorias del Ejército' },
        { date: '2025-10-12', name: 'Encuentro de Dos Mundos' },
        { date: '2025-10-31', name: 'Día de las Iglesias Evangélicas' },
        { date: '2025-11-01', name: 'Día de Todos los Santos' },
        { date: '2025-12-08', name: 'Inmaculada Concepción' },
        { date: '2025-12-25', name: 'Navidad' }
    ];
}

// Actualizar la visualización de la semana actual
function updateWeekDisplay() {
    const startOfWeek = getStartOfWeek(currentWeekDate);
    
    // Actualizar el texto principal de la semana
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 3); // Solo hasta jueves (4 días)
    
    const startDay = startOfWeek.getDate();
    const endDay = endOfWeek.getDate();
    const startMonthName = getMonthName(startOfWeek.getMonth());
    const endMonthName = getMonthName(endOfWeek.getMonth());
    const year = startOfWeek.getFullYear();
    
    currentWeekDisplay.textContent = `Semana del ${startDay} al ${endDay} de ${endMonthName} de ${year}`;
    
    // Marcar feriados y días actuales
    const holidayDates = holidays.map(h => h.date);
    
    // Actualizar los encabezados de días con las fechas correspondientes
    for (let i = 1; i <= 4; i++) {
        const dayDate = new Date(startOfWeek);
        dayDate.setDate(startOfWeek.getDate() + (i - 1));
        
        const dayHeader = document.getElementById(`day-header-${i}`);
        const dateHeader = document.getElementById(`date-header-${i}`);
        
        if (dayHeader && dateHeader) {
            const dayNames = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
            dayHeader.textContent = dayNames[dayDate.getDay()];
            dateHeader.textContent = `${dayDate.getDate()}/${dayDate.getMonth() + 1}`;
            
            // Verificar si es feriado
            const dateStr = formatDate(dayDate);
            const isHoliday = holidayDates.includes(dateStr);
            
            // Resaltar el día actual si está en la semana mostrada
            const today = new Date();
            const isToday = dayDate.toDateString() === today.toDateString();
            
            // Aplicar clases según el caso
            if (isHoliday) {
                dayHeader.style.color = 'var(--error)';
                dateHeader.style.color = 'var(--error)';
                document.querySelectorAll(`.schedule-cell[data-day="${i}"]`).forEach(cell => {
                    cell.classList.add('holiday-cell');
                    cell.title = "Feriado: " + holidays.find(h => h.date === dateStr).name;
                });
            } else {
                dayHeader.style.color = '';
                dateHeader.style.color = '';
                document.querySelectorAll(`.schedule-cell[data-day="${i}"]`).forEach(cell => {
                    cell.classList.remove('holiday-cell');
                    cell.title = "";
                });
            }
            
            if (isToday) {
                dayHeader.classList.add('current-day');
                dateHeader.classList.add('current-day');
                document.querySelectorAll(`.schedule-cell[data-day="${i}"]`).forEach(cell => {
                    cell.classList.add('current-day');
                });
            } else {
                dayHeader.classList.remove('current-day');
                dateHeader.classList.remove('current-day');
                document.querySelectorAll(`.schedule-cell[data-day="${i}"]`).forEach(cell => {
                    cell.classList.remove('current-day');
                });
            }
        }
    }
}

// Obtener el primer día de la semana (lunes)
function getStartOfWeek(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Ajusta cuando el día es domingo
    const monday = new Date(d.setDate(diff));
    monday.setHours(0, 0, 0, 0);
    return monday;
}

// Obtener nombre del mes en español
function getMonthName(month) {
    const months = [
        'enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 
        'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'
    ];
    return months[month];
}

// Modificar la función loadAppointments() para que funcione correctamente
function loadAppointments() {
    showSpinner();
    
    // Obtener fecha de inicio y fin de la semana
    const startOfWeek = getStartOfWeek(currentWeekDate);
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 4); // Un día después del jueves
    
    try {
        // Consulta a Firestore
        db.collection('citas').get()
            .then((querySnapshot) => {
                appointments = [];
                
                querySnapshot.forEach((doc) => {
                    try {
                        // Convertir datos a formato utilizable
                        const data = doc.data();
                        
                        // Convertir el campo fecha a un objeto Date
                        let appointmentDate;
                        if (data.fecha && data.fecha.toDate) {
                            appointmentDate = data.fecha.toDate();
                        } else if (data.fecha) {
                            appointmentDate = new Date(data.fecha);
                        } else {
                            // Si no hay fecha, saltarse esta cita
                            console.warn("Cita sin fecha encontrada, ID:", doc.id);
                            return;
                        }
                        
                        // Filtrar solo las citas de esta semana
                        if (appointmentDate >= startOfWeek && appointmentDate < endOfWeek) {
                            const appointment = {
                                id: doc.id,
                                ...data,
                                fecha: appointmentDate
                            };
                            
                            appointments.push(appointment);
                        }
                    } catch (error) {
                        console.error("Error procesando cita individual:", error);
                    }
                });
                
                console.log(`Se cargaron ${appointments.length} citas para la semana actual`);
                
                // Renderizar citas y actualizar estadísticas
                renderAppointments();
                updateStatistics();
                
                // Cargar estadísticas históricas
                loadHistoricalPatientStats();
                
                hideSpinner();
            })
            .catch((error) => {
                console.error("Error al cargar citas:", error);
                showStatusMessage("Error al cargar citas. Cargando datos de ejemplo.", "warning");
                loadSampleAppointments(); // Cargar datos de ejemplo en caso de error
                hideSpinner();
            });
    } catch (error) {
        console.error("Error crítico al cargar citas:", error);
        showStatusMessage("Error de conexión. Cargando datos de ejemplo.", "error");
        loadSampleAppointments();
        hideSpinner();
    }
}

// Cargar citas de ejemplo (en caso de error o para la primera vez)
function loadSampleAppointments() {
    // Fecha de referencia (lunes de la semana actual)
    const startOfWeek = getStartOfWeek(currentWeekDate);
    
    appointments = [
        {
            id: '1',
            paciente: 'María González',
            tipo: 'Evaluación kinesiología MSK',
            tipoClase: 'evaluacion-msk',
            fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate(), 9, 0),
            duracion: 60,
            terapeuta: 'nicolas',
            estudiante: 'estudiante1'
        },
        {
            id: '2',
            paciente: 'Ana Martínez',
            tipo: 'Sesión kinesiología MSK',
            tipoClase: 'sesion-msk',
            fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate(), 11, 0),
            duracion: 60,
            terapeuta: 'ana-maria',
            estudiante: 'estudiante2'
        },
        {
            id: '3',
            paciente: 'Laura Pérez',
            tipo: 'Evaluación kinesiología deportiva',
            tipoClase: 'evaluacion-deportiva',
            fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate(), 13, 0),
            duracion: 60,
            terapeuta: 'nicolas',
            estudiante: 'estudiante3'
        },
        {
            id: '4',
            paciente: 'Isabel Rodríguez',
            tipo: 'Sesión kinesiología deportiva',
            tipoClase: 'sesion-deportiva',
            fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate() + 1, 10, 0),
            duracion: 60,
            terapeuta: 'ana-maria',
            estudiante: 'estudiante4',
            esRecurrente: true
        }
    ];
    
    renderAppointments();
    updateStatistics();
}

// Mejorar la función renderAppointments() con más logs y mejor manejo de errores
function renderAppointments() {
    try {
        // Limpiar citas existentes
        document.querySelectorAll('.appointment').forEach(el => el.remove());
        
        // Fecha de referencia (lunes de la semana actual)
        const startOfWeek = getStartOfWeek(currentWeekDate);
        
        console.log("Renderizando citas. Total:", appointments.length);
        console.log("Semana actual desde:", startOfWeek);
        
        // Renderizar cada cita de la semana actual
        appointments.forEach((appointment, index) => {
            try {
                if (!appointment.fecha) {
                    console.error("Cita sin fecha:", appointment);
                    return;
                }
                
                const appointmentDate = appointment.fecha;
                
                // Calcular diferencia de días desde el inicio de la semana
                const dayDiff = Math.floor((appointmentDate - startOfWeek) / (24 * 60 * 60 * 1000));
                
                // Solo mostrar citas de lunes a jueves (0-3)
                if (dayDiff >= 0 && dayDiff < 4) {
                    const hour = appointmentDate.getHours();
                    const dayIndex = dayDiff + 1; // 1 para lunes, 2 para martes, etc.
                    
                    console.log(`Cita ${index+1}: ${appointment.paciente} - Día ${dayIndex}, Hora ${hour}`);
                    
                    // Encontrar la celda correcta
                    const cell = document.querySelector(`.schedule-cell[data-hour="${hour}"][data-day="${dayIndex}"]`);
                    
                    if (cell) {
                        // Crear elemento de cita
                        const appointmentEl = document.createElement('div');
                        appointmentEl.className = `appointment ${appointment.tipoClase || ''} ${appointment.estudiante || 'estudiante1'}`;
                        appointmentEl.dataset.id = appointment.id;
                        
                        // Añadir clase si es recurrente
                        if (appointment.esRecurrente) {
                            appointmentEl.classList.add('recurring');
                        }
                        
                        // Determinar si mostrar el kinesiólogo (solo para sesiones)
                        const showTherapist = appointment.tipoClase && appointment.tipoClase.startsWith('sesion-');
                        
                        // Contenido de la cita con icono
                        let content = `
                            <div class="appointment-title">${appointment.paciente || 'Sin nombre'}</div>
                            <div class="appointment-type">${getAppointmentTypeIcon(appointment.tipoClase)} ${appointment.tipo || 'Sin tipo'}</div>
                        `;
                        
                        if (showTherapist) {
                            content += `<div class="appointment-therapist">${getTherapistName(appointment.terapeuta)}</div>`;
                        }
                        
                        // Estudiante asignado - mostrar nombre completo en lugar del código
                        const studentCode = appointment.estudiante || 'Sin asignar';
                        const studentName = studentNames[studentCode] || studentCode;
                        content += `<div class="student-badge">${studentName}</div>`;
                        
                        appointmentEl.innerHTML = content;
                        
                        // Indicador de estado si existe
                        if (appointment.estado) {
                            const statusEl = document.createElement('div');
                            statusEl.className = `appointment-status ${appointment.estado}`;
                            appointmentEl.appendChild(statusEl);
                        }
                        
                        // Indicador web si aplica
                        if (appointment.web) {
                            const webEl = document.createElement('div');
                            webEl.className = 'web-indicator';
                            webEl.innerHTML = '🌐';
                            appointmentEl.appendChild(webEl);
                        }
                        
                        // Agregar a la celda
                        cell.appendChild(appointmentEl);
                        
                        // Eventos para la cita
                        appointmentEl.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const app = appointments.find(a => a.id === this.dataset.id);
                            if (app) {
                                // Si la cita ya pasó, mostrar modal de asistencia
                                const today = new Date();
                                if (app.fecha < today) {
                                    if (isAdmin) {
                                        openAttendanceModal(app);
                                    } else {
                                        viewAppointmentDetails(app);
                                    }
                                } else {
                                    // Si es una cita futura
                                    if (isAdmin) {
                                        openAppointmentModal(app);
                                    } else {
                                        viewAppointmentDetails(app);
                                    }
                                }
                            }
                        });
                        
                        // Hacer que las citas sean arrastrables para administradores
                        if (isAdmin) {
                            appointmentEl.setAttribute('draggable', 'true');
                            appointmentEl.addEventListener('dragstart', function(e) {
                                e.dataTransfer.setData('text/plain', this.dataset.id);
                            });
                        }
                    } else {
                        console.warn(`No se encontró celda para día ${dayIndex}, hora ${hour}`);
                    }
                } else {
                    console.log(`Cita ${index+1} fuera del rango de la semana actual (diferencia: ${dayDiff} días)`);
                }
            } catch (error) {
                console.error("Error al renderizar cita individual:", error, appointment);
            }
        });
    } catch (error) {
        console.error("Error al renderizar citas:", error);
        showStatusMessage("Error al mostrar las citas", "error");
    }
}

// Mostrar detalles de la cita (para estudiantes)
function viewAppointmentDetails(appointment) {
    const options = { 
        weekday: 'long', 
        day: 'numeric', 
        month: 'long', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    };
    
    let details = `
        Paciente: ${appointment.paciente || 'Sin nombre'}
        Tipo: ${appointment.tipo || 'Sin especificar'}
        Fecha: ${appointment.fecha ? appointment.fecha.toLocaleDateString('es-ES', options) : 'Fecha no disponible'}
        Kinesiólogo: ${getTherapistName(appointment.terapeuta)}
        Estudiante: ${appointment.estudiante || 'Sin asignar'}
    `;
    
    if (appointment.estado) {
        details += `\nEstado: ${getStatusText(appointment.estado)}`;
    }
    
    alert(details);
}

// Obtener nombre completo del terapeuta
function getTherapistName(therapistId) {
    switch(therapistId) {
        case 'nicolas': return 'Nicolás';
        case 'ana-maria': return 'Ana María';
        case 'gustavo': return 'Gustavo';
        default: return therapistId || 'Sin asignar';
    }
}

// Obtener texto del estado
function getStatusText(status) {
    switch(status) {
        case 'attended': return 'Asistió';
        case 'missed': return 'No asistió';
        case 'rescheduled': return 'Reprogramada';
        default: return status;
    }
}

// Obtener icono según tipo de cita
function getAppointmentTypeIcon(typeClass) {
    switch(typeClass) {
        case 'evaluacion-msk': return '📋'; // Portapapeles para evaluación MSK
        case 'evaluacion-deportiva': return '📕'; // Persona corriendo para evaluación deportiva
        case 'sesion-msk': return '💪'; // Músculo para sesión MSK
        case 'sesion-deportiva': return '🏋️‍♀️'; // Trofeo para sesión deportiva
        default: return '📅'; // Calendario como icono por defecto
    }
}
        
// Actualizar estadísticas
// Actualizar estadísticas
// Actualizar estadísticas con datos de asistencia
function updateStatistics() {
    try {
        // Calcular asistencia semanal
        const totalPastAppointments = appointments.filter(a => {
            const now = new Date();
            return a.fecha && a.fecha < now;
        }).length;
        
        const attendedAppointments = appointments.filter(a => a.estado === 'attended').length;
        const missedAppointments = appointments.filter(a => a.estado === 'missed').length;
        const rescheduledAppointments = appointments.filter(a => a.estado === 'rescheduled').length;
        
        const attendanceRate = totalPastAppointments > 0 
            ? Math.round((attendedAppointments / totalPastAppointments) * 100) 
            : 0;
        
        // Citas por hora
        const appointmentsByHour = {};
        appointments.forEach(a => {
            if (a.fecha) {
                const hour = a.fecha.getHours();
                appointmentsByHour[hour] = (appointmentsByHour[hour] || 0) + 1;
            }
        });
        
        // Encontrar la hora más ocupada
        let busiestHour = 9; // Por defecto 9:00
        let maxAppointments = 0;
        
        for (const hour in appointmentsByHour) {
            if (appointmentsByHour[hour] > maxAppointments) {
                busiestHour = parseInt(hour);
                maxAppointments = appointmentsByHour[hour];
            }
        }
        
        // Calcular pacientes únicos por estudiante Y sesiones totales
        uniquePatientsByStudent = {};
        const sessionsByStudent = {};
        const patientsByStudent = {};
        
        // Estadísticas de asistencia por estudiante
        const attendanceByStudent = {};
        const missedByStudent = {};
        
        // Contador de tipos de cita
        const appointmentTypes = {};
        
        // Contador de sesiones por paciente
        const sessionsPerPatient = {};
        
        appointments.forEach(a => {
            if (!a.estudiante || !a.paciente) return;
            
            // Contar tipos de cita
            const tipoClase = a.tipoClase || 'sin-tipo';
            appointmentTypes[tipoClase] = (appointmentTypes[tipoClase] || 0) + 1;
            
            // Contar sesiones por paciente
            const patientKey = a.paciente.toLowerCase();
            sessionsPerPatient[patientKey] = (sessionsPerPatient[patientKey] || 0) + 1;
            
            // Contar sesiones totales por estudiante
            sessionsByStudent[a.estudiante] = (sessionsByStudent[a.estudiante] || 0) + 1;
            
            // Contar asistencias y faltas por estudiante
            if (a.estado === 'attended') {
                attendanceByStudent[a.estudiante] = (attendanceByStudent[a.estudiante] || 0) + 1;
            } else if (a.estado === 'missed') {
                missedByStudent[a.estudiante] = (missedByStudent[a.estudiante] || 0) + 1;
            }
            
            // Inicializar arrays si no existen
            if (!patientsByStudent[a.estudiante]) {
                patientsByStudent[a.estudiante] = [];
            }
            
            // Añadir paciente si no está ya (para evitar duplicados)
            if (!patientsByStudent[a.estudiante].includes(a.paciente)) {
                patientsByStudent[a.estudiante].push(a.paciente);
            }
        });
        
        // Contar pacientes únicos
        for (const student in patientsByStudent) {
            uniquePatientsByStudent[student] = patientsByStudent[student].length;
        }
        
        // Calcular tasa de asistencia por estudiante
        const attendanceRateByStudent = {};
        for (const student in sessionsByStudent) {
            const attended = attendanceByStudent[student] || 0;
            const total = (attendanceByStudent[student] || 0) + (missedByStudent[student] || 0);
            attendanceRateByStudent[student] = total > 0 ? Math.round((attended / total) * 100) : 0;
        }
        
        // Actualizar DOM
        document.getElementById('attendance-rate').textContent = `${attendanceRate}%`;
        document.getElementById('total-appointments').textContent = appointments.length;
        document.getElementById('busiest-hour').textContent = `${busiestHour}:00`;
        
        // Actualizar tabla de estudiantes con datos de asistencia
        updateStudentStats(uniquePatientsByStudent, sessionsByStudent, attendanceRateByStudent);
        
        // Crear gráfico circular para tipos de cita
        createAppointmentTypeChart(appointmentTypes);
        
        // Añadir tabla de evolución de pacientes
        createPatientEvolutionTable(sessionsPerPatient);
        
        // Crear gráfico de asistencia vs faltas
        createAttendanceChart(attendedAppointments, missedAppointments, rescheduledAppointments);
    } catch (error) {
        console.error("Error al actualizar estadísticas:", error);
    }
}

        // Añadir esta nueva función después de la función updateStatistics
function loadHistoricalPatientStats() {
    showSpinner();
    
    // Consultar TODAS las citas en Firestore (sin filtro de fecha)
    db.collection('citas').get()
        .then((querySnapshot) => {
            // Contador de sesiones por paciente (histórico)
            const historicalSessionsByPatient = {};
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                if (data.paciente) {
                    const patientKey = data.paciente.toLowerCase();
                    historicalSessionsByPatient[patientKey] = (historicalSessionsByPatient[patientKey] || 0) + 1;
                }
            });
            
            // Crear la sección para estadísticas históricas
            createHistoricalPatientStatsSection(historicalSessionsByPatient);
            hideSpinner();
        })
        .catch((error) => {
            console.error("Error al cargar estadísticas históricas:", error);
            hideSpinner();
        });
}

// Función para crear la sección de estadísticas históricas
function createHistoricalPatientStatsSection(historicalData) {
    // Verificar si existe la sección, si no, crearla
    let historicalSection = document.getElementById('historical-stats-section');
    
    if (!historicalSection) {
        const statsPanel = document.querySelector('.stats-panel');
        if (!statsPanel) return;
        
        historicalSection = document.createElement('div');
        historicalSection.id = 'historical-stats-section';
        historicalSection.className = 'stats-section';
        
        const sectionTitle = document.createElement('h4');
        sectionTitle.className = 'therapist-stats-title';
        sectionTitle.textContent = 'Historial Completo de Sesiones por Paciente';
        historicalSection.appendChild(sectionTitle);
        
        statsPanel.appendChild(historicalSection);
    } else {
        // Limpiar contenido previo pero mantener el título
        const title = historicalSection.querySelector('.therapist-stats-title');
        historicalSection.innerHTML = '';
        if (title) historicalSection.appendChild(title);
    }
    
    // Convertir los datos a un array para poder ordenarlos
    const patientsArray = Object.keys(historicalData).map(patient => ({
        name: patient,
        sessions: historicalData[patient]
    }));
    
    // Ordenar por número de sesiones (descendente)
    patientsArray.sort((a, b) => b.sessions - a.sessions);
    
    // Crear tabla
    const table = document.createElement('table');
    table.className = 'student-stats-table';
    
    // Encabezado
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    
    ['Paciente', 'Total Histórico de Sesiones', 'Estado de Evolución'].forEach(text => {
        const th = document.createElement('th');
        th.textContent = text;
        headerRow.appendChild(th);
    });
    
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // Cuerpo de la tabla
    const tbody = document.createElement('tbody');
    
    patientsArray.forEach(patient => {
        const row = document.createElement('tr');
        
        // Nombre del paciente (con primera letra capitalizada)
        const nameCell = document.createElement('td');
        nameCell.textContent = patient.name.charAt(0).toUpperCase() + patient.name.slice(1);
        
        // Número de sesiones
        const sessionsCell = document.createElement('td');
        sessionsCell.textContent = patient.sessions;
        
        // Estado de evolución basado en número de sesiones
        const evolutionCell = document.createElement('td');
        let evolutionStatus = '';
        let statusColor = '';
        
        if (patient.sessions === 1) {
            evolutionStatus = 'Evaluación Inicial';
            statusColor = '#FFC107'; // Amarillo
        } else if (patient.sessions >= 2 && patient.sessions <= 4) {
            evolutionStatus = 'En Tratamiento';
            statusColor = '#2196F3'; // Azul
        } else if (patient.sessions >= 5 && patient.sessions <= 8) {
            evolutionStatus = 'Avanzado';
            statusColor = '#4CAF50'; // Verde
        } else if (patient.sessions > 8) {
            evolutionStatus = 'Fase Final';
            statusColor = '#9C27B0'; // Púrpura
        }
        
        const statusIndicator = document.createElement('span');
        statusIndicator.textContent = evolutionStatus;
        statusIndicator.style.display = 'inline-block';
        statusIndicator.style.padding = '3px 8px';
        statusIndicator.style.borderRadius = '4px';
        statusIndicator.style.backgroundColor = statusColor;
        statusIndicator.style.color = 'white';
        statusIndicator.style.fontWeight = '500';
        statusIndicator.style.fontSize = '12px';
        
        evolutionCell.appendChild(statusIndicator);
        
        row.appendChild(nameCell);
        row.appendChild(sessionsCell);
        row.appendChild(evolutionCell);
        tbody.appendChild(row);
    });
    
    table.appendChild(tbody);
    historicalSection.appendChild(table);
}

// Llamar a esta función al inicializar la aplicación
// Añadir esta línea al final de la función loadAppointments
function loadAppointments() {
    // ... código existente ...
    
    // Al final de la función, justo antes de hideSpinner():
    loadHistoricalPatientStats();
}

        
// Nueva función para actualizar el gráfico de estudiantes con ambas métricas
function updateStudentChart(uniquePatients, totalSessions) {
    const chartContainer = document.getElementById('student-chart');
    const chartLabels = document.getElementById('student-chart-labels');
    
    if (chartContainer && chartLabels) {
        chartContainer.innerHTML = '';
        chartLabels.innerHTML = '';
        
        // Crear tabla de estadísticas en lugar de gráfico
        const statsTable = document.createElement('table');
        statsTable.className = 'student-stats-table';
        statsTable.style.width = '100%';
        statsTable.style.borderCollapse = 'collapse';
        statsTable.style.marginTop = '20px';
        
        // Crear encabezado
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        
        ['Estudiante', 'Pacientes Únicos', 'Total Sesiones'].forEach(text => {
            const th = document.createElement('th');
            th.textContent = text;
            th.style.padding = '10px';
            th.style.textAlign = 'left';
            th.style.borderBottom = '2px solid var(--border)';
            headerRow.appendChild(th);
        });
        
        thead.appendChild(headerRow);
        statsTable.appendChild(thead);
        
        // Crear cuerpo de tabla
        const tbody = document.createElement('tbody');
        
        // Ordenar estudiantes por número de pacientes
        const sortedStudents = Object.keys(uniquePatients || {}).sort((a, b) => 
            (uniquePatients[b] || 0) - (uniquePatients[a] || 0)
        );
        
        sortedStudents.forEach(student => {
            const row = document.createElement('tr');
            
            // Nombre del estudiante
            const nameCell = document.createElement('td');
            nameCell.textContent = studentNames[student] || student;
            nameCell.style.padding = '10px';
            nameCell.style.borderBottom = '1px solid var(--border)';
            
            // Número de pacientes únicos
            const patientsCell = document.createElement('td');
            patientsCell.textContent = uniquePatients[student] || 0;
            patientsCell.style.padding = '10px';
            patientsCell.style.borderBottom = '1px solid var(--border)';
            
            // Número total de sesiones
            const sessionsCell = document.createElement('td');
            sessionsCell.textContent = totalSessions[student] || 0;
            sessionsCell.style.padding = '10px';
            sessionsCell.style.borderBottom = '1px solid var(--border)';
            
            row.appendChild(nameCell);
            row.appendChild(patientsCell);
            row.appendChild(sessionsCell);
            tbody.appendChild(row);
        });
        
        statsTable.appendChild(tbody);
        
        // Reemplazar el gráfico con la tabla
        chartContainer.appendChild(statsTable);
        
        // Añadir un botón para exportar estadísticas
        const exportContainer = document.createElement('div');
        exportContainer.style.marginTop = '20px';
        exportContainer.style.textAlign = 'center';
        
        const exportExcelBtn = document.createElement('button');
        exportExcelBtn.className = 'button save-btn';
        exportExcelBtn.style.marginRight = '10px';
        exportExcelBtn.textContent = 'Exportar a Excel';
        exportExcelBtn.onclick = function() { exportStatisticsToExcel(); };
        
        const exportPdfBtn = document.createElement('button');
        exportPdfBtn.className = 'button save-btn';
        exportPdfBtn.textContent = 'Exportar a PDF';
        exportPdfBtn.onclick = function() { exportStatisticsToPdf(); };
        
        exportContainer.appendChild(exportExcelBtn);
        exportContainer.appendChild(exportPdfBtn);
        
        chartContainer.appendChild(exportContainer);
    }
}

// Función para exportar estadísticas a Excel
function exportStatisticsToExcel() {
    try {
        showSpinner();
        
        // Crear datos para el Excel
        let data = [['Estudiante', 'Pacientes Únicos', 'Total Sesiones']];
        
        // Calcular estadísticas
        const uniquePatients = {};
        const totalSessions = {};
        const patientsByStudent = {};
        
        appointments.forEach(a => {
            if (!a.estudiante || !a.paciente) return;
            
            // Contar sesiones totales
            totalSessions[a.estudiante] = (totalSessions[a.estudiante] || 0) + 1;
            
            // Inicializar arrays si no existen
            if (!patientsByStudent[a.estudiante]) {
                patientsByStudent[a.estudiante] = [];
            }
            
            // Añadir paciente si no está ya (para evitar duplicados)
            if (!patientsByStudent[a.estudiante].includes(a.paciente)) {
                patientsByStudent[a.estudiante].push(a.paciente);
            }
        });
        
        // Contar pacientes únicos
        for (const student in patientsByStudent) {
            uniquePatients[student] = patientsByStudent[student].length;
        }
        
        // Ordenar estudiantes
        const sortedStudents = Object.keys(uniquePatients).sort((a, b) => 
            uniquePatients[b] - uniquePatients[a]
        );
        
        // Añadir datos de cada estudiante
        sortedStudents.forEach(student => {
            data.push([
                studentNames[student] || student,
                uniquePatients[student] || 0,
                totalSessions[student] || 0
            ]);
        });
        
        // Crear workbook
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);
        
        // Obtener fechas de la semana actual
        const startOfWeek = getStartOfWeek(currentWeekDate);
        const endDate = new Date(startOfWeek);
        endDate.setDate(startOfWeek.getDate() + 3); // Jueves
        
        const startDateStr = startOfWeek.toLocaleDateString('es-ES');
        const endDateStr = endDate.toLocaleDateString('es-ES');
        
        // Añadir información adicional
        XLSX.utils.sheet_add_aoa(ws, [
            [`Estadísticas SISTEMAKINE - Semana del ${startDateStr} al ${endDateStr}`],
            [`Generado el: ${new Date().toLocaleDateString('es-ES')}`],
            [`Total de citas: ${appointments.length}`],
            []
        ], { origin: 'A1' });
        
        // Mover los datos principales hacia abajo
        XLSX.utils.sheet_add_aoa(ws, data, { origin: 'A6' });
        
        // Guardar el archivo
        XLSX.utils.book_append_sheet(wb, ws, "Estadísticas");
        XLSX.writeFile(wb, `Estadisticas_SISTEMAKINE_${startDateStr}_${endDateStr}.xlsx`);
        
        hideSpinner();
        showStatusMessage('Estadísticas exportadas a Excel correctamente', 'success');
    } catch (error) {
        console.error("Error al exportar a Excel:", error);
        hideSpinner();
        showStatusMessage("Error al exportar estadísticas a Excel", "error");
    }
}

// Función para exportar estadísticas a PDF
function exportStatisticsToPdf() {
    try {
        showSpinner();
        
        // Obtener fechas de la semana actual
        const startOfWeek = getStartOfWeek(currentWeekDate);
        const endDate = new Date(startOfWeek);
        endDate.setDate(startOfWeek.getDate() + 3); // Jueves
        
        const startDateStr = startOfWeek.toLocaleDateString('es-ES');
        const endDateStr = endDate.toLocaleDateString('es-ES');
        
        // Crear documento PDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Título
        doc.setFontSize(18);
        doc.text("Estadísticas SISTEMAKINE", 20, 20);
        
        // Subtítulo con fechas
        doc.setFontSize(12);
        doc.text(`Semana del ${startDateStr} al ${endDateStr}`, 20, 30);
        doc.text(`Generado el: ${new Date().toLocaleDateString('es-ES')}`, 20, 40);
        
        // Información general
        doc.text(`Total de citas: ${appointments.length}`, 20, 50);
        
        // Tabla de estudiantes
        const tableColumn = ["Estudiante", "Pacientes Únicos", "Total Sesiones"];
        let tableRows = [];
        
        // Calcular estadísticas
        const uniquePatients = {};
        const totalSessions = {};
        const patientsByStudent = {};
        
        appointments.forEach(a => {
            if (!a.estudiante || !a.paciente) return;
            
            // Contar sesiones totales
            totalSessions[a.estudiante] = (totalSessions[a.estudiante] || 0) + 1;
            
            // Inicializar arrays si no existen
            if (!patientsByStudent[a.estudiante]) {
                patientsByStudent[a.estudiante] = [];
            }
            
            // Añadir paciente si no está ya (para evitar duplicados)
            if (!patientsByStudent[a.estudiante].includes(a.paciente)) {
                patientsByStudent[a.estudiante].push(a.paciente);
            }
        });
        
        // Contar pacientes únicos
        for (const student in patientsByStudent) {
            uniquePatients[student] = patientsByStudent[student].length;
        }
        
        // Ordenar estudiantes
        const sortedStudents = Object.keys(uniquePatients).sort((a, b) => 
            uniquePatients[b] - uniquePatients[a]
        );
        
        // Añadir datos de cada estudiante
        sortedStudents.forEach(student => {
            tableRows.push([
                studentNames[student] || student,
                uniquePatients[student] || 0,
                totalSessions[student] || 0
            ]);
        });
        
        // Generar tabla
        doc.autoTable({
            head: [tableColumn],
            body: tableRows,
            startY: 60,
            styles: { fontSize: 10 },
            headStyles: { fillColor: [41, 63, 224] }
        });
        
        // Guardar PDF
        doc.save(`Estadisticas_SISTEMAKINE_${startDateStr}_${endDateStr}.pdf`);
        
        hideSpinner();
        showStatusMessage('Estadísticas exportadas a PDF correctamente', 'success');
    } catch (error) {
        console.error("Error al exportar a PDF:", error);
        hideSpinner();
        showStatusMessage("Error al exportar estadísticas a PDF", "error");
    }
}        

// Función para manejar cambios en el tipo de cita (mostrar opciones de recurrencia)
function handleAppointmentTypeChange() {
    try {
        const appointmentType = document.getElementById('appointment-type').value;
        const recurrenceOptions = document.getElementById('recurrence-options');
        
        // Solo mostrar opciones de recurrencia para sesiones, no para evaluaciones
        if (appointmentType && appointmentType.startsWith('sesion-')) {
            recurrenceOptions.style.display = 'block';
        } else {
            recurrenceOptions.style.display = 'none';
            document.getElementById('is-recurring').checked = false;
            document.getElementById('recurring-details').style.display = 'none';
        }
    } catch (error) {
        console.error("Error al cambiar tipo de cita:", error);
    }
}

// Configurar event listeners
function setupEventListeners() {
    try {
        // Login
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            showSpinner();
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Login exitoso
                    hideSpinner();
                    showStatusMessage('Sesión iniciada correctamente', 'success');
                })
                .catch((error) => {
                    console.error("Error de login:", error);
                    hideSpinner();
                    showStatusMessage("Error de inicio de sesión. Verifica tus credenciales.", "error");
                });
        });
        
        // Logout
        logoutBtn.addEventListener('click', function() {
            auth.signOut()
                .then(() => {
                    // Logout exitoso
                    showLoginScreen();
                    showStatusMessage('Sesión cerrada', 'success');
                })
                .catch((error) => {
                    console.error("Error al cerrar sesión:", error);
                    showStatusMessage("Error al cerrar sesión.", "error");
                });
        });
        
        // Navegación de semanas
        document.getElementById('prev-week').addEventListener('click', function() {
            navigateWeek(-1);
        });
        
        document.getElementById('next-week').addEventListener('click', function() {
            navigateWeek(1);
        });
        
        // Evento para mostrar/ocultar detalles de recurrencia
        const isRecurringCheckbox = document.getElementById('is-recurring');
        if (isRecurringCheckbox) {
            isRecurringCheckbox.addEventListener('change', function() {
                document.getElementById('recurring-details').style.display = this.checked ? 'block' : 'none';
            });
        }
        
        // Clic en celdas de la agenda (para agregar citas)
        document.querySelectorAll('.schedule-cell').forEach(cell => {
            cell.addEventListener('click', function() {
                if (isAdmin) {
                    const hour = parseInt(this.dataset.hour);
                    const day = parseInt(this.dataset.day);
                    
                    openAppointmentModal(null, hour, day);
                }
            });
            
            // Configuración para arrastrar y soltar
            if (isAdmin) {
                cell.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('drag-over');
                });
                
                cell.addEventListener('dragleave', function() {
                    this.classList.remove('drag-over');
                });
                
                cell.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');
                    
                    const appointmentId = e.dataTransfer.getData('text/plain');
                    const hour = parseInt(this.dataset.hour);
                    const day = parseInt(this.dataset.day);
                    
                    // Obtener fecha correspondiente a este día
                    const startOfWeek = getStartOfWeek(currentWeekDate);
                    const targetDate = new Date(startOfWeek);
                    targetDate.setDate(startOfWeek.getDate() + (day - 1));
                    
                    // Mover la cita a esta fecha y hora
                    moveAppointmentToDate(appointmentId, targetDate, hour);
                });
            }
        });
        
        // Formulario de citas
        appointmentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            if (isAdmin) {
                saveAppointment();
            }
        });
        
        document.getElementById('cancel-appointment').addEventListener('click', function() {
            closeAppointmentModal();
        });
        
        document.getElementById('delete-appointment').addEventListener('click', function() {
            if (isAdmin) {
                if (confirm('¿Estás seguro de que deseas eliminar esta cita?')) {
                    try {
                        deleteAppointment();
                    } catch (error) {
                        console.error("Error al eliminar cita:", error);
                        showStatusMessage("Error al eliminar la cita", "error");
                    }
                }
            }
        });
        
        // Cerrar modales con la X
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.addEventListener('click', function() {
                this.closest('.modal').style.display = 'none';
            });
        });
        
        // Eventos para asistencia
        document.querySelectorAll('.attendance-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.attendance-btn').forEach(b => {
                    b.classList.remove('selected');
                });
                this.classList.add('selected');
            });
        });
        
        document.getElementById('save-attendance').addEventListener('click', function() {
            if (isAdmin) {
                try {
                    saveAttendance();
                } catch (error) {
                    console.error("Error al guardar asistencia:", error);
                    showStatusMessage("Error al guardar asistencia", "error");
                }
            }
        });
        
        document.getElementById('cancel-attendance').addEventListener('click', function() {
            closeAttendanceModal();
        });
        
        // Evitar que el modal se cierre si se hace clic en él
        document.querySelectorAll('.modal-content').forEach(content => {
            content.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        });
        
        // Cerrar el modal si se hace clic fuera de él
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function() {
                this.style.display = 'none';
            });
        });
    } catch (error) {
        console.error("Error al configurar eventos:", error);
        showStatusMessage("Error al inicializar la interfaz", "error");
    }
    // Configurar búsqueda de pacientes
    setupPatientSearch();
}

// Navegar entre semanas
function navigateWeek(direction) {
    currentWeekDate.setDate(currentWeekDate.getDate() + (direction * 7));
    updateWeekDisplay();
    loadAppointments();
}

// Formatear fecha como YYYY-MM-DD
function formatDate(date) {
    if (!date) return '';
    
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Modificar openAppointmentModal para mostrar valores de los nuevos campos
function openAppointmentModal(appointment, hour, day) {
    if (!isAdmin) return;
    
    try {
        const modalTitle = document.getElementById('modal-title');
        const dateInput = document.getElementById('appointment-date');
        const timeInput = document.getElementById('appointment-time');
        const deleteBtn = document.getElementById('delete-appointment');
        const isRecurringCheckbox = document.getElementById('is-recurring');
        const recurringDetails = document.getElementById('recurring-details');
        
        // Ocultar opciones de recurrencia por defecto
        document.getElementById('recurrence-options').style.display = 'none';
        
        if (appointment) {
            // Editar cita existente
            modalTitle.textContent = 'Editar Cita';
            
            document.getElementById('patient-name').value = appointment.paciente || '';
            
            const typeSelect = document.getElementById('appointment-type');
            if (appointment.tipoClase && typeSelect) {
                typeSelect.value = appointment.tipoClase;
                
                // Mostrar opciones de recurrencia solo para sesiones
                if (appointment.tipoClase.startsWith('sesion-')) {
                    document.getElementById('recurrence-options').style.display = 'block';
                }
            }
            
            // Si es una cita recurrente, mostrar los detalles
            if (appointment.esRecurrente) {
                isRecurringCheckbox.checked = true;
                recurringDetails.style.display = 'block';
                
                // Marcar los días de la semana
                if (appointment.patronRecurrencia && appointment.patronRecurrencia.diasSemana) {
                    const weekdays = appointment.patronRecurrencia.diasSemana;
                    document.querySelectorAll('input[name="weekday"]').forEach(checkbox => {
                        checkbox.checked = weekdays.includes(parseInt(checkbox.value));
                    });
                }
                
                // Establecer fecha fin
                if (appointment.patronRecurrencia && appointment.patronRecurrencia.fechaFin) {
                    let endDate;
                    try {
                        if (typeof appointment.patronRecurrencia.fechaFin === 'object' && 
                            appointment.patronRecurrencia.fechaFin.toDate) {
                            endDate = appointment.patronRecurrencia.fechaFin.toDate();
                        } else if (typeof appointment.patronRecurrencia.fechaFin === 'string') {
                            endDate = new Date(appointment.patronRecurrencia.fechaFin);
                        }
                    } catch (error) {
                        console.error("Error al convertir fecha fin:", error);
                    }
                    
                    if (endDate) {
                        document.getElementById('recurrence-end').value = formatDate(endDate);
                    }
                }
            } else {
                isRecurringCheckbox.checked = false;
                recurringDetails.style.display = 'none';
            }
            
            const fecha = appointment.fecha;
            if (fecha) {
                dateInput.value = formatDate(fecha);
                timeInput.value = `${fecha.getHours().toString().padStart(2, '0')}:${fecha.getMinutes().toString().padStart(2, '0')}`;
            }
            
            if (appointment.duracion) {
                document.getElementById('appointment-duration').value = appointment.duracion;
            }
            
            // Ya no necesitamos establecer el valor del terapeuta porque eliminamos ese campo
            
            document.getElementById('student').value = appointment.estudiante || 'estudiante1';
            document.getElementById('appointment-notes').value = appointment.notas || '';
            document.getElementById('is-web').checked = appointment.web || false;
            
            // Establecer valores para los nuevos campos
            if (appointment.comuna) {
                document.getElementById('patient-comuna').value = appointment.comuna;
            }
            
            if (appointment.telefono) {
                document.getElementById('patient-phone').value = appointment.telefono;
            }
            
            if (appointment.correo) {
                document.getElementById('patient-email').value = appointment.correo;
            }
            
            editingAppointmentId = appointment.id;
            deleteBtn.style.display = 'block';
        } else {
            // Nueva cita
            modalTitle.textContent = 'Agregar Nueva Cita';
            
            // Limpiar formulario
            document.getElementById('patient-name').value = '';
            document.getElementById('appointment-notes').value = '';
            document.getElementById('is-web').checked = false;
            document.getElementById('patient-comuna').value = '';
            document.getElementById('patient-phone').value = '';
            document.getElementById('patient-email').value = '';
            
            // Obtener la fecha correspondiente al día seleccionado
            const startOfWeek = getStartOfWeek(currentWeekDate);
            const appointmentDay = day ? day - 1 : 0; // Convertir de 1-basado a 0-basado
            const appointmentDate = new Date(startOfWeek);
            appointmentDate.setDate(startOfWeek.getDate() + appointmentDay);
            
            // Pre-llenar con la fecha del día seleccionado
            dateInput.value = formatDate(appointmentDate);
            
            // Pre-llenar hora si se proporciona
            if (hour) {
                timeInput.value = `${hour.toString().padStart(2, '0')}:00`;
            }
            
            editingAppointmentId = null;
            deleteBtn.style.display = 'none';
            
            // Inicialmente ocultar detalles de recurrencia
            isRecurringCheckbox.checked = false;
            recurringDetails.style.display = 'none';
            
            // Actualizar visibilidad de opciones de recurrencia según tipo de cita seleccionado
            handleAppointmentTypeChange();
        }
        
        appointmentModal.style.display = 'block';
    } catch (error) {
        console.error("Error al abrir modal de cita:", error);
        showStatusMessage("Error al abrir el formulario", "error");
    }
}

// Cerrar modal de citas
function closeAppointmentModal() {
    appointmentModal.style.display = 'none';
    editingAppointmentId = null;
    
    // Limpiar formulario
    document.getElementById('patient-name').value = '';
    document.getElementById('appointment-notes').value = '';
    document.getElementById('is-web').checked = false;
    document.getElementById('is-recurring').checked = false;
    document.getElementById('recurring-details').style.display = 'none';
}

// Guardar cita
// Modificar saveAppointment para incluir los nuevos campos
function saveAppointment() {
    try {
        showSpinner();
        
        const patientName = document.getElementById('patient-name').value;
        if (!patientName || patientName.trim() === '') {
            hideSpinner();
            showStatusMessage('Por favor ingresa el nombre del paciente', 'warning');
            return;
        }
        
        const appointmentTypeSelect = document.getElementById('appointment-type');
        const appointmentType = appointmentTypeSelect.options[appointmentTypeSelect.selectedIndex].text;
        const appointmentTypeClass = appointmentTypeSelect.value;
        const appointmentDate = document.getElementById('appointment-date').value;
        const appointmentTime = document.getElementById('appointment-time').value;
        
        if (!appointmentDate || !appointmentTime) {
            hideSpinner();
            showStatusMessage('Por favor ingresa fecha y hora', 'warning');
            return;
        }
        
        const appointmentDuration = parseInt(document.getElementById('appointment-duration').value);
        const therapist = "estudiante"; // Valor por defecto ya que eliminamos el campo
        const student = document.getElementById('student').value;
        const notes = document.getElementById('appointment-notes').value;
        const isWeb = document.getElementById('is-web').checked;
        
        // Nuevos campos
        const comuna = document.getElementById('patient-comuna').value;
        const phone = document.getElementById('patient-phone').value;
        const email = document.getElementById('patient-email').value;
        
        // Validar comuna
        if (!comuna) {
            hideSpinner();
            showStatusMessage('Por favor selecciona una comuna de residencia', 'warning');
            return;
        }
        
        // Datos de recurrencia
        const isRecurring = document.getElementById('is-recurring').checked;
        let selectedWeekdays = [];
        let recurrenceEndDate = null;
        
        if (isRecurring) {
            // Obtener días de la semana seleccionados
            document.querySelectorAll('input[name="weekday"]:checked').forEach(checkbox => {
                selectedWeekdays.push(parseInt(checkbox.value));
            });
            
            // Fecha de fin de recurrencia
            recurrenceEndDate = document.getElementById('recurrence-end').value;
            if (!recurrenceEndDate) {
                hideSpinner();
                showStatusMessage('Por favor selecciona una fecha de fin para la recurrencia', 'warning');
                return;
            }
            
            if (selectedWeekdays.length === 0) {
                hideSpinner();
                showStatusMessage('Por favor selecciona al menos un día de la semana', 'warning');
                return;
            }
        }
        
        // Crear objeto de fecha
        const [year, month, day] = appointmentDate.split('-');
        const [hours, minutes] = appointmentTime.split(':');
        const date = new Date(year, month - 1, day, hours, minutes);
        
        // Verificar si es feriado
        const dateStr = formatDate(date);
        const holidayMatch = holidays.find(h => h.date === dateStr);
        if (holidayMatch) {
            hideSpinner();
            showStatusMessage(`No se pueden agendar citas en días feriados. ${dateStr} es "${holidayMatch.name}".`, 'warning');
            return;
        }
        
        // Verificar límite de citas simultáneas
        if (!editingAppointmentId) { // Solo verificar para nuevas citas
            const dayOfWeek = date.getDay(); // 0 para domingo, 1 para lunes, etc.
            if (dayOfWeek > 0 && dayOfWeek < 5) { // Solo lunes a jueves
                const hourAppointments = appointments.filter(a => {
                    const appDate = a.fecha;
                    return appDate && appDate.getDay() === dayOfWeek &&
                           appDate.getHours() === date.getHours() &&
                           a.estudiante === student;
                });
                
                if (hourAppointments.length >= 2) {
                    hideSpinner();
                    showStatusMessage('Este estudiante ya tiene 2 citas en este horario.', 'warning');
                    return;
                }
            }
        }
        
        // ID único para citas recurrentes
        const serieRecurrenteId = isRecurring ? `serie_${Date.now()}` : null;
        
        // Datos base de la cita
        const baseAppointmentData = {
            paciente: patientName,
            tipo: appointmentType,
            tipoClase: appointmentTypeClass,
            duracion: appointmentDuration,
            terapeuta: therapist,
            estudiante: student,
            estudianteNombre: studentNames[student] || student,
            notas: notes,
            web: isWeb,
            esRecurrente: isRecurring,
            fecha: date,
            creado: new Date(),
            // Nuevos campos
            comuna: comuna,
            telefono: phone,
            correo: email,
            historial: [{
                accion: editingAppointmentId ? 'modificacion' : 'creacion',
                usuario: currentUser.email,
                usuarioId: currentUser.uid,
                fecha: new Date()
            }]
        };
        
        // Si es cita recurrente, agregar patrón
        if (isRecurring) {
            baseAppointmentData.serieRecurrenteId = serieRecurrenteId;
            baseAppointmentData.patronRecurrencia = {
                diasSemana: selectedWeekdays,
                fechaFin: new Date(recurrenceEndDate)
            };
        }
        
        if (editingAppointmentId) {
            // Actualizar cita existente
            db.collection('citas').doc(editingAppointmentId).set(baseAppointmentData)
                .then(() => {
                    closeAppointmentModal();
                    showStatusMessage('Cita actualizada correctamente', 'success');
                    loadAppointments();
                })
                .catch((error) => {
                    console.error("Error al actualizar cita:", error);
                    hideSpinner();
                    alert('Error al actualizar la cita: ' + error.message);
                });
        } else if (isRecurring) {
            // Crear citas recurrentes usando batch
            const batch = db.batch();
            const endDate = new Date(recurrenceEndDate);
            
            // Generar todas las fechas según patrón
            const createdDates = [];
            const currentDate = new Date(date);
            while (currentDate <= endDate) {
                const currentDay = currentDate.getDay(); // 0 = domingo, 1 = lunes, ...
                
                // Si el día actual está en los días seleccionados
                if (selectedWeekdays.includes(currentDay)) {
                    const apptData = {...baseAppointmentData};
                    apptData.fecha = new Date(currentDate); // Copia de la fecha
                    
                    // Crear documento con ID automático
                    const newDocRef = db.collection('citas').doc();
                    batch.set(newDocRef, apptData);
                    
                    createdDates.push(formatDate(currentDate));
                }
                
                // Avanzar al siguiente día
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Ejecutar el batch
            batch.commit()
                .then(() => {
                    closeAppointmentModal();
                    showStatusMessage(`Creadas ${createdDates.length} citas recurrentes`, 'success');
                    loadAppointments();
                })
                .catch((error) => {
                    console.error("Error al crear citas recurrentes:", error);
                    hideSpinner();
                    alert('Error al crear citas recurrentes: ' + error.message);
                });
        } else {
            // Crear una cita simple
            db.collection('citas').add(baseAppointmentData)
                .then((docRef) => {
                    console.log("Cita creada con ID:", docRef.id);
                    closeAppointmentModal();
                    showStatusMessage('Cita creada correctamente', 'success');
                    loadAppointments();
                })
                .catch((error) => {
                    console.error("Error al crear cita:", error);
                    hideSpinner();
                    alert('Error al crear la cita: ' + error.message);
                });
        }
    } catch (error) {
        console.error("Error crítico al guardar cita:", error);
        hideSpinner();
        alert('Error crítico al guardar: ' + error.message);
    }
}


// Modificar la función deleteAppointment para manejar citas recurrentes
function deleteAppointment() {
    if (!editingAppointmentId) {
        showStatusMessage("No hay ninguna cita seleccionada para eliminar", "warning");
        return;
    }
    
    // Obtener la cita actual
    const currentAppointment = appointments.find(a => a.id === editingAppointmentId);
    
    // Verificar si es una cita recurrente
    if (currentAppointment && currentAppointment.esRecurrente && currentAppointment.serieRecurrenteId) {
        // Mostrar opciones para citas recurrentes
        const deleteOption = window.confirm('Esta es una cita recurrente. ¿Deseas eliminar todas las citas de esta serie?');
        
        if (deleteOption) {
            // Eliminar todas las citas de la serie
            showSpinner();
            
            db.collection('citas')
                .where('serieRecurrenteId', '==', currentAppointment.serieRecurrenteId)
                .get()
                .then((querySnapshot) => {
                    const batch = db.batch();
                    
                    querySnapshot.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    
                    return batch.commit();
                })
                .then(() => {
                    closeAppointmentModal();
                    showStatusMessage(`Se han eliminado todas las citas recurrentes de esta serie`, 'success');
                    loadAppointments();
                })
                .catch((error) => {
                    console.error("Error al eliminar citas recurrentes:", error);
                    hideSpinner();
                    showStatusMessage("Error al eliminar las citas recurrentes", "error");
                });
        } else {
            // Eliminar solo esta cita
            deleteSpecificAppointment(editingAppointmentId);
        }
    } else {
        // Para citas no recurrentes, eliminar normalmente
        deleteSpecificAppointment(editingAppointmentId);
    }
}

// Función para eliminar una cita específica
function deleteSpecificAppointment(appointmentId) {
    showSpinner();
    
    db.collection('citas').doc(appointmentId).delete()
        .then(() => {
            closeAppointmentModal();
            showStatusMessage('Cita eliminada correctamente', 'success');
            loadAppointments();
        })
        .catch((error) => {
            console.error("Error al eliminar cita:", error);
            hideSpinner();
            showStatusMessage("Error al eliminar la cita", "error");
        });
}

// Actualizar estadísticas de estudiantes
function updateStudentStats(uniquePatients, totalSessions) {
    const statsPanel = document.querySelector('.stats-panel');
    if (!statsPanel) return;
    
    // Eliminar gráfico anterior si existe
    const oldChartContainer = document.getElementById('student-chart');
    const oldChartLabels = document.getElementById('student-chart-labels');
    if (oldChartContainer) oldChartContainer.innerHTML = '';
    if (oldChartLabels) oldChartLabels.innerHTML = '';
    
    // Crear nueva tabla
    const statsTable = document.createElement('table');
    statsTable.className = 'student-stats-table';
    
    // Crear encabezado
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    
    ['Estudiante', 'Pacientes Únicos', 'Total Sesiones'].forEach(text => {
        const th = document.createElement('th');
        th.textContent = text;
        headerRow.appendChild(th);
    });
    
    thead.appendChild(headerRow);
    statsTable.appendChild(thead);
    
    // Crear cuerpo de tabla
    const tbody = document.createElement('tbody');
    
    // Ordenar estudiantes por número de pacientes
    const sortedStudents = Object.keys(uniquePatients || {}).sort((a, b) => 
        (uniquePatients[b] || 0) - (uniquePatients[a] || 0)
    );
    
    sortedStudents.forEach(student => {
        const row = document.createElement('tr');
        
        // Nombre del estudiante
        const nameCell = document.createElement('td');
        nameCell.textContent = studentNames[student] || student;
        
        // Número de pacientes únicos
        const patientsCell = document.createElement('td');
        patientsCell.textContent = uniquePatients[student] || 0;
        
        // Número total de sesiones
        const sessionsCell = document.createElement('td');
        sessionsCell.textContent = totalSessions[student] || 0;
        
        row.appendChild(nameCell);
        row.appendChild(patientsCell);
        row.appendChild(sessionsCell);
        tbody.appendChild(row);
    });
    
    statsTable.appendChild(tbody);
    
    // Añadir la tabla al contenedor
    if (oldChartContainer) {
        oldChartContainer.appendChild(statsTable);
        
        // Añadir botones de exportación
        const exportContainer = document.createElement('div');
        exportContainer.className = 'export-container';
        
        const exportExcelBtn = document.createElement('button');
        exportExcelBtn.className = 'button save-btn';
        exportExcelBtn.textContent = 'Exportar a Excel';
        exportExcelBtn.onclick = function() { exportStatisticsToExcel(); };
        
        const exportPdfBtn = document.createElement('button');
        exportPdfBtn.className = 'button save-btn';
        exportPdfBtn.textContent = 'Exportar a PDF';
        exportPdfBtn.onclick = function() { exportStatisticsToPdf(); };
        
        exportContainer.appendChild(exportExcelBtn);
        exportContainer.appendChild(exportPdfBtn);
        
        oldChartContainer.appendChild(exportContainer);
    }
}

// Crear gráfico circular para tipos de cita
function createAppointmentTypeChart(typesData) {
    // Verificar si existe la sección para este gráfico, si no, crearla
    let chartSection = document.getElementById('treatment-types-section');
    
    if (!chartSection) {
        const statsPanel = document.querySelector('.stats-panel');
        if (!statsPanel) return;
        
        chartSection = document.createElement('div');
        chartSection.id = 'treatment-types-section';
        chartSection.className = 'stats-section';
        chartSection.style.marginTop = '30px';
        
        const sectionTitle = document.createElement('h4');
        sectionTitle.className = 'therapist-stats-title';
        sectionTitle.textContent = 'Distribución de Tipos de Tratamiento';
        chartSection.appendChild(sectionTitle);
        
        const chartCanvas = document.createElement('div');
        chartCanvas.id = 'treatment-types-chart';
        chartCanvas.style.height = '250px';
        chartCanvas.style.position = 'relative';
        chartCanvas.style.margin = '20px auto';
        chartCanvas.style.width = '250px';
        
        chartSection.appendChild(chartCanvas);
        statsPanel.appendChild(chartSection);
    }
    
    const chartContainer = document.getElementById('treatment-types-chart');
    if (!chartContainer) return;
    
    chartContainer.innerHTML = '';
    
    // Datos para el gráfico
    const types = Object.keys(typesData);
    const counts = Object.values(typesData);
    const total = counts.reduce((sum, count) => sum + count, 0);
    
    // Si no hay datos, mostrar mensaje
    if (total === 0) {
        const noDataMsg = document.createElement('div');
        noDataMsg.textContent = 'No hay datos disponibles';
        noDataMsg.style.textAlign = 'center';
        noDataMsg.style.padding = '20px';
        noDataMsg.style.color = 'var(--text-secondary)';
        chartContainer.appendChild(noDataMsg);
        return;
    }
    
    // Colores para el gráfico
    const colors = [
        '#2D3FE0', '#00BFA5', '#FF6B6B', '#9B59B6', 
        '#3498DB', '#E67E22', '#27AE60', '#F1C40F'
    ];
    
    // Crear el gráfico circular (pie chart)
    let cumulativeAngle = 0;
    const centerX = 125;
    const centerY = 125;
    const radius = 100;
    
    // Crear un SVG
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', '100%');
    svg.setAttribute('height', '100%');
    svg.setAttribute('viewBox', '0 0 250 250');
    
    types.forEach((type, index) => {
        const count = typesData[type];
        const percentage = (count / total) * 100;
        const angleSize = (percentage / 100) * 360;
        
        // Calcular coordenadas para el arco
        const startAngle = cumulativeAngle * Math.PI / 180;
        const endAngle = (cumulativeAngle + angleSize) * Math.PI / 180;
        
        const x1 = centerX + radius * Math.cos(startAngle);
        const y1 = centerY + radius * Math.sin(startAngle);
        const x2 = centerX + radius * Math.cos(endAngle);
        const y2 = centerY + radius * Math.sin(endAngle);
        
        // Determinar si el arco es mayor a 180 grados
        const largeArcFlag = angleSize > 180 ? 1 : 0;
        
        // Crear el path para el segmento del círculo
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        const d = [
            `M ${centerX} ${centerY}`,
            `L ${x1} ${y1}`,
            `A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2}`,
            'Z'
        ].join(' ');
        
        path.setAttribute('d', d);
        path.setAttribute('fill', colors[index % colors.length]);
        
        // Agregar título con información al pasar el mouse
        const title = document.createElementNS('http://www.w3.org/2000/svg', 'title');
        title.textContent = `${getAppointmentTypeName(type)}: ${count} (${percentage.toFixed(1)}%)`;
        path.appendChild(title);
        
        svg.appendChild(path);
        
        // Actualizar ángulo acumulado
        cumulativeAngle += angleSize;
    });
    
    chartContainer.appendChild(svg);
    
    // Crear leyenda
    const legend = document.createElement('div');
    legend.className = 'chart-legend';
    legend.style.display = 'flex';
    legend.style.flexWrap = 'wrap';
    legend.style.justifyContent = 'center';
    legend.style.marginTop = '20px';
    
    types.forEach((type, index) => {
        const count = typesData[type];
        const percentage = (count / total) * 100;
        
        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item';
        legendItem.style.display = 'flex';
        legendItem.style.alignItems = 'center';
        legendItem.style.margin = '5px 10px';
        
        const colorBox = document.createElement('div');
        colorBox.style.width = '12px';
        colorBox.style.height = '12px';
        colorBox.style.backgroundColor = colors[index % colors.length];
        colorBox.style.marginRight = '5px';
        
        const label = document.createElement('span');
        label.textContent = `${getAppointmentTypeName(type)}: ${count} (${percentage.toFixed(1)}%)`;
        
        legendItem.appendChild(colorBox);
        legendItem.appendChild(label);
        legend.appendChild(legendItem);
    });
    
    chartContainer.appendChild(legend);
}

// Función para obtener nombre legible del tipo de cita
function getAppointmentTypeName(typeClass) {
    switch(typeClass) {
        case 'evaluacion-msk': return 'Evaluación MSK';
        case 'evaluacion-deportiva': return 'Evaluación Deportiva';
        case 'sesion-msk': return 'Sesión MSK';
        case 'sesion-deportiva': return 'Sesión Deportiva';
        default: return typeClass;
    }
}

// Crear tabla de evolución de pacientes
function createPatientEvolutionTable(sessionsData) {
    // Verificar si existe la sección para esta tabla, si no, crearla
    let evolutionSection = document.getElementById('patient-evolution-section');
    
    if (!evolutionSection) {
        const statsPanel = document.querySelector('.stats-panel');
        if (!statsPanel) return;
        
        evolutionSection = document.createElement('div');
        evolutionSection.id = 'patient-evolution-section';
        evolutionSection.className = 'stats-section';
        evolutionSection.style.marginTop = '30px';
        
        const sectionTitle = document.createElement('h4');
        sectionTitle.className = 'therapist-stats-title';
        sectionTitle.textContent = 'Evolución de Pacientes';
        evolutionSection.appendChild(sectionTitle);
        
        statsPanel.appendChild(evolutionSection);
    }
    
    // Convertir el objeto de sesiones por paciente a un array para ordenar
    const patientsArray = Object.keys(sessionsData).map(patient => ({
        name: patient,
        sessions: sessionsData[patient]
    }));
    
    // Ordenar por número de sesiones (descendente)
    patientsArray.sort((a, b) => b.sessions - a.sessions);
    
    // Crear tabla
    const table = document.createElement('table');
    table.className = 'student-stats-table';
    
    // Encabezado
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    
    ['Paciente', 'Número de Sesiones', 'Estado de Evolución'].forEach(text => {
        const th = document.createElement('th');
        th.textContent = text;
        headerRow.appendChild(th);
    });
    
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // Cuerpo de la tabla
    const tbody = document.createElement('tbody');
    
    patientsArray.forEach(patient => {
        const row = document.createElement('tr');
        
        // Nombre del paciente (con primera letra capitalizada)
        const nameCell = document.createElement('td');
        nameCell.textContent = patient.name.charAt(0).toUpperCase() + patient.name.slice(1);
        
        // Número de sesiones
        const sessionsCell = document.createElement('td');
        sessionsCell.textContent = patient.sessions;
        
        // Estado de evolución basado en número de sesiones
        const evolutionCell = document.createElement('td');
        let evolutionStatus = '';
        let statusColor = '';
        
        if (patient.sessions === 1) {
            evolutionStatus = 'Evaluación Inicial';
            statusColor = '#FFC107'; // Amarillo
        } else if (patient.sessions >= 2 && patient.sessions <= 4) {
            evolutionStatus = 'En Tratamiento';
            statusColor = '#2196F3'; // Azul
        } else if (patient.sessions >= 5 && patient.sessions <= 8) {
            evolutionStatus = 'Avanzado';
            statusColor = '#4CAF50'; // Verde
        } else if (patient.sessions > 8) {
            evolutionStatus = 'Fase Final';
            statusColor = '#9C27B0'; // Púrpura
        }
        
        const statusIndicator = document.createElement('span');
        statusIndicator.textContent = evolutionStatus;
        statusIndicator.style.display = 'inline-block';
        statusIndicator.style.padding = '3px 8px';
        statusIndicator.style.borderRadius = '4px';
        statusIndicator.style.backgroundColor = statusColor;
        statusIndicator.style.color = 'white';
        statusIndicator.style.fontWeight = '500';
        statusIndicator.style.fontSize = '12px';
        
        evolutionCell.appendChild(statusIndicator);
        
        row.appendChild(nameCell);
        row.appendChild(sessionsCell);
        row.appendChild(evolutionCell);
        tbody.appendChild(row);
    });
    
    table.appendChild(tbody);
    
    // Reemplazar contenido anterior
    evolutionSection.innerHTML = '';
    const sectionTitle = document.createElement('h4');
    sectionTitle.className = 'therapist-stats-title';
    sectionTitle.textContent = 'Evolución de Pacientes';
    evolutionSection.appendChild(sectionTitle);
    evolutionSection.appendChild(table);
    }       
        
// Función para eliminar una cita específica
function deleteSpecificAppointment(appointmentId) {
    showSpinner();
    
    db.collection('citas').doc(appointmentId).delete()
        .then(() => {
            closeAppointmentModal();
            showStatusMessage('Cita eliminada correctamente', 'success');
            loadAppointments();
        })
        .catch((error) => {
            console.error("Error al eliminar cita:", error);
            hideSpinner();
            showStatusMessage("Error al eliminar la cita", "error");
        });
}

// Mover una cita a una fecha y hora específicas
function moveAppointmentToDate(appointmentId, targetDate, hour) {
    if (!isAdmin) return;
    
    const appointment = appointments.find(a => a.id === appointmentId);
    if (!appointment) {
        showStatusMessage("No se encontró la cita para mover", "error");
        return;
    }
    
    showSpinner();
    
    try {
        // Conservar minutos, pero cambiar fecha y hora
        const newDate = new Date(targetDate);
        newDate.setHours(hour, appointment.fecha.getMinutes(), 0, 0);
        
        // Actualizar fecha
        db.collection('citas').doc(appointmentId).update({
            fecha: newDate,
            historial: firebase.firestore.FieldValue.arrayUnion({
                accion: 'movimiento',
                usuario: currentUser.email,
                usuarioId: currentUser.uid,
                fecha: new Date()
            })
        })
        .then(() => {
            showStatusMessage('Cita movida correctamente', 'success');
            loadAppointments();
        })
        .catch((error) => {
            console.error("Error al mover cita:", error);
            hideSpinner();
            alert('Error al mover la cita: ' + error.message);
        });
    } catch (error) {
        console.error("Error crítico al mover cita:", error);
        hideSpinner();
        alert("Error crítico al mover: " + error.message);
    }
}

// Abrir modal de asistencia
function openAttendanceModal(appointment) {
    if (!isAdmin) return;
    
    try {
        const patientEl = document.getElementById('attendance-patient');
        const dateEl = document.getElementById('attendance-date');
        const timeEl = document.getElementById('attendance-time');
        
        patientEl.textContent = appointment.paciente || 'Sin nombre';
        
        const fecha = appointment.fecha;
        const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
        dateEl.textContent = fecha ? fecha.toLocaleDateString('es-ES', options) : 'Fecha no disponible';
        
        if (fecha) {
            const horaInicio = `${fecha.getHours().toString().padStart(2, '0')}:${fecha.getMinutes().toString().padStart(2, '0')}`;
            const fechaFin = new Date(fecha);
            fechaFin.setMinutes(fecha.getMinutes() + (appointment.duracion || 60));
            const horaFin = `${fechaFin.getHours().toString().padStart(2, '0')}:${fechaFin.getMinutes().toString().padStart(2, '0')}`;
            timeEl.textContent = `${horaInicio} - ${horaFin}`;
        } else {
            timeEl.textContent = 'Hora no disponible';
        }
        
        // Resetear selección de estado
        document.querySelectorAll('.attendance-btn').forEach(btn => {
            btn.classList.remove('selected');
        });
        
        // Seleccionar el estado actual si existe
        if (appointment.estado) {
            const currentStatusBtn = document.querySelector(`.attendance-btn[data-status="${appointment.estado}"]`);
            if (currentStatusBtn) {
                currentStatusBtn.classList.add('selected');
            }
        }
        
        // Notas de asistencia
        document.getElementById('attendance-notes').value = appointment.notasAsistencia || '';
        
        // Guardar referencia a la cita actual
        attendanceModal.dataset.appointmentId = appointment.id;
        
        // Mostrar modal
        attendanceModal.style.display = 'block';
    } catch (error) {
        console.error("Error al abrir modal de asistencia:", error);
        showStatusMessage("Error al abrir el formulario de asistencia", "error");
    }
}

// Cerrar modal de asistencia
function closeAttendanceModal() {
    attendanceModal.style.display = 'none';
}

// Guardar asistencia
function saveAttendance() {
    const appointmentId = attendanceModal.dataset.appointmentId;
    if (!appointmentId) {
        showStatusMessage("No se encontró la cita para registrar asistencia", "error");
        return;
    }
    
    const selectedBtn = document.querySelector('.attendance-btn.selected');
    
    if (!selectedBtn) {
        showStatusMessage('Por favor selecciona un estado de asistencia', 'warning');
        return;
    }
    
    const status = selectedBtn.dataset.status;
    const notes = document.getElementById('attendance-notes').value;
    
    showSpinner();
    
    try {
        // Actualizar en Firestore
        db.collection('citas').doc(appointmentId).update({
            estado: status,
            notasAsistencia: notes,
            ultimaActualizacion: new Date()
        })
        .then(() => {
            closeAttendanceModal();
            showStatusMessage('Asistencia registrada correctamente', 'success');
            loadAppointments();
        })
        .catch((error) => {
            console.error("Error al registrar asistencia:", error);
            hideSpinner();
            alert('Error al registrar la asistencia: ' + error.message);
        });
    } catch (error) {
        console.error("Error crítico al guardar asistencia:", error);
        hideSpinner();
        alert("Error crítico al guardar asistencia: " + error.message);
    }
}

// Mostrar/ocultar spinner de carga
function showSpinner() {
    spinner.style.display = 'flex';
}

function hideSpinner() {
    spinner.style.display = 'none';
}

// Mostrar mensaje de estado
function showStatusMessage(message, type = 'success') {
    statusMessage.textContent = message;
    statusMessage.className = 'status-message ' + type;
    statusMessage.style.display = 'block';
    
    // Ocultar después de 5 segundos
    setTimeout(() => {
        statusMessage.style.display = 'none';
    }, 5000);
}

        // Función de búsqueda de pacientes
function setupPatientSearch() {
    const searchInput = document.getElementById('patient-search');
    const searchBtn = document.getElementById('search-btn');
    const clearBtn = document.getElementById('clear-search-btn');
    
    if (!searchInput || !searchBtn || !clearBtn) return;
    
    searchBtn.addEventListener('click', function() {
        const searchTerm = searchInput.value.trim().toLowerCase();
        if (!searchTerm) {
            showStatusMessage('Por favor ingresa un nombre para buscar', 'warning');
            return;
        }
        
        // Buscar citas que coincidan
        const matchingAppointments = appointments.filter(app => 
            app.paciente && app.paciente.toLowerCase().includes(searchTerm)
        );
        
        if (matchingAppointments.length === 0) {
            showStatusMessage(`No se encontraron citas para "${searchTerm}"`, 'warning');
        } else {
            // Resaltar visualmente las citas encontradas
            document.querySelectorAll('.appointment').forEach(el => {
                el.classList.remove('highlighted');
            });
            
            matchingAppointments.forEach(app => {
                const appointmentEl = document.querySelector(`.appointment[data-id="${app.id}"]`);
                if (appointmentEl) {
                    appointmentEl.classList.add('highlighted');
                    // Hacer scroll hacia la primera cita encontrada
                    if (appointmentEl === document.querySelector('.appointment.highlighted')) {
                        appointmentEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            });
            
            showStatusMessage(`Se encontraron ${matchingAppointments.length} citas para "${searchTerm}"`, 'success');
        }
    });
    
    clearBtn.addEventListener('click', function() {
        searchInput.value = '';
        document.querySelectorAll('.appointment').forEach(el => {
            el.classList.remove('highlighted');
        });
    });
    
    // Permitir búsqueda al presionar Enter
    searchInput.addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
            searchBtn.click();
        }
    });
}

        // Crear gráfico de asistencia
function createAttendanceChart(attended, missed, rescheduled) {
    // Verificar si existe la sección para este gráfico, si no, crearla
    let chartSection = document.getElementById('attendance-chart-section');
    
    if (!chartSection) {
        const statsPanel = document.querySelector('.stats-panel');
        if (!statsPanel) return;
        
        chartSection = document.createElement('div');
        chartSection.id = 'attendance-chart-section';
        chartSection.className = 'stats-section';
        chartSection.style.marginTop = '30px';
        
        const sectionTitle = document.createElement('h4');
        sectionTitle.className = 'therapist-stats-title';
        sectionTitle.textContent = 'Distribución de Asistencia';
        chartSection.appendChild(sectionTitle);
        
        const chartContainer = document.createElement('div');
        chartContainer.id = 'attendance-chart';
        chartContainer.style.height = '250px';
        chartContainer.style.position = 'relative';
        chartContainer.style.margin = '20px auto';
        chartContainer.style.display = 'flex';
        chartContainer.style.justifyContent = 'center';
        chartContainer.style.gap = '30px';
        
        chartSection.appendChild(chartContainer);
        statsPanel.appendChild(chartSection);
    }
    
    const chartContainer = document.getElementById('attendance-chart');
    if (!chartContainer) return;
    
    chartContainer.innerHTML = '';
    
    // Si no hay datos, mostrar mensaje
    const total = attended + missed + rescheduled;
    if (total === 0) {
        const noDataMsg = document.createElement('div');
        noDataMsg.textContent = 'No hay datos de asistencia disponibles';
        noDataMsg.style.textAlign = 'center';
        noDataMsg.style.padding = '20px';
        noDataMsg.style.color = 'var(--text-secondary)';
        chartContainer.appendChild(noDataMsg);
        return;
    }
    
    // Crear barras para el gráfico
    const data = [
        { label: 'Asistieron', value: attended, color: 'var(--success)' },
        { label: 'No asistieron', value: missed, color: 'var(--error)' },
        { label: 'Reprogramadas', value: rescheduled, color: 'var(--warning)' }
    ];
    
    // Encontrar el valor máximo para escalar las barras
    const maxValue = Math.max(attended, missed, rescheduled);
    
    data.forEach(item => {
        const barContainer = document.createElement('div');
        barContainer.style.display = 'flex';
        barContainer.style.flexDirection = 'column';
        barContainer.style.alignItems = 'center';
        barContainer.style.width = '80px';
        
        // Valor numérico arriba de la barra
        const valueLabel = document.createElement('div');
        valueLabel.textContent = item.value;
        valueLabel.style.fontWeight = 'bold';
        valueLabel.style.fontSize = '16px';
        valueLabel.style.marginBottom = '10px';
        barContainer.appendChild(valueLabel);
        
        // Barra
        const bar = document.createElement('div');
        const height = maxValue > 0 ? (item.value / maxValue) * 200 : 0;
        bar.style.height = `${height}px`;
        bar.style.width = '60px';
        bar.style.backgroundColor = item.color;
        bar.style.borderRadius = '4px 4px 0 0';
        barContainer.appendChild(bar);
        
        // Etiqueta debajo de la barra
        const label = document.createElement('div');
        label.textContent = item.label;
        label.style.marginTop = '10px';
        label.style.textAlign = 'center';
        label.style.fontSize = '14px';
        barContainer.appendChild(label);
        
        chartContainer.appendChild(barContainer);
    });
    
    // Añadir porcentajes debajo del gráfico
    const percentagesContainer = document.createElement('div');
    percentagesContainer.style.display = 'flex';
    percentagesContainer.style.justifyContent = 'center';
    percentagesContainer.style.gap = '20px';
    percentagesContainer.style.marginTop = '20px';
    
    data.forEach(item => {
        const percent = total > 0 ? Math.round((item.value / total) * 100) : 0;
        
        const percentBox = document.createElement('div');
        percentBox.style.padding = '8px 12px';
        percentBox.style.backgroundColor = item.color;
        percentBox.style.color = 'white';
        percentBox.style.borderRadius = '4px';
        percentBox.style.fontWeight = 'bold';
        percentBox.textContent = `${percent}%`;
        
        percentagesContainer.appendChild(percentBox);
    });
    
    chartSection.appendChild(percentagesContainer);
}

// Actualizar tabla de estudiantes con datos de asistencia
function updateStudentStats(uniquePatients, totalSessions, attendanceRates) {
    const chartContainer = document.getElementById('student-chart');
    const chartLabels = document.getElementById('student-chart-labels');
    
    if (chartContainer && chartLabels) {
        chartContainer.innerHTML = '';
        chartLabels.innerHTML = '';
        
        // Crear tabla de estadísticas en lugar de gráfico
        const statsTable = document.createElement('table');
        statsTable.className = 'student-stats-table';
        statsTable.style.width = '100%';
        statsTable.style.borderCollapse = 'collapse';
        statsTable.style.marginTop = '20px';
        
        // Crear encabezado
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        
        ['Estudiante', 'Pacientes Únicos', 'Total Sesiones', 'Tasa de Asistencia'].forEach(text => {
            const th = document.createElement('th');
            th.textContent = text;
            th.style.padding = '10px';
            th.style.textAlign = 'left';
            th.style.borderBottom = '2px solid var(--border)';
            headerRow.appendChild(th);
        });
        
        thead.appendChild(headerRow);
        statsTable.appendChild(thead);
        
        // Crear cuerpo de tabla
        const tbody = document.createElement('tbody');
        
        // Ordenar estudiantes por número de pacientes
        const sortedStudents = Object.keys(uniquePatients || {}).sort((a, b) => 
            (uniquePatients[b] || 0) - (uniquePatients[a] || 0)
        );
        
        sortedStudents.forEach(student => {
            const row = document.createElement('tr');
            
            // Nombre del estudiante
            const nameCell = document.createElement('td');
            nameCell.textContent = studentNames[student] || student;
            nameCell.style.padding = '10px';
            nameCell.style.borderBottom = '1px solid var(--border)';
            
            // Número de pacientes únicos
            const patientsCell = document.createElement('td');
            patientsCell.textContent = uniquePatients[student] || 0;
            patientsCell.style.padding = '10px';
            patientsCell.style.borderBottom = '1px solid var(--border)';
            
            // Número total de sesiones
            const sessionsCell = document.createElement('td');
            sessionsCell.textContent = totalSessions[student] || 0;
            sessionsCell.style.padding = '10px';
            sessionsCell.style.borderBottom = '1px solid var(--border)';
            
            // Tasa de asistencia
            const attendanceCell = document.createElement('td');
            const attendanceRate = attendanceRates[student] || 0;
            
            // Crear indicador visual de tasa de asistencia
            const attendanceIndicator = document.createElement('div');
            attendanceIndicator.style.display = 'flex';
            attendanceIndicator.style.alignItems = 'center';
            
            const attendanceBar = document.createElement('div');
            attendanceBar.style.height = '10px';
            attendanceBar.style.width = `${attendanceRate}%`;
            attendanceBar.style.backgroundColor = getAttendanceColor(attendanceRate);
            attendanceBar.style.borderRadius = '5px';
            attendanceBar.style.marginRight = '10px';
            
            const attendanceText = document.createElement('span');
            attendanceText.textContent = `${attendanceRate}%`;
            
            attendanceIndicator.appendChild(attendanceBar);
            attendanceIndicator.appendChild(attendanceText);
            attendanceCell.appendChild(attendanceIndicator);
            attendanceCell.style.padding = '10px';
            attendanceCell.style.borderBottom = '1px solid var(--border)';
            
            row.appendChild(nameCell);
            row.appendChild(patientsCell);
            row.appendChild(sessionsCell);
            row.appendChild(attendanceCell);
            tbody.appendChild(row);
        });
        
        statsTable.appendChild(tbody);
        
        // Reemplazar el gráfico con la tabla
        chartContainer.appendChild(statsTable);
        
        // Añadir un botón para exportar estadísticas
        const exportContainer = document.createElement('div');
        exportContainer.className = 'export-container';
        exportContainer.style.marginTop = '20px';
        exportContainer.style.textAlign = 'center';
        
        const exportExcelBtn = document.createElement('button');
        exportExcelBtn.className = 'button save-btn';
        exportExcelBtn.style.marginRight = '10px';
        exportExcelBtn.textContent = 'Exportar a Excel';
        exportExcelBtn.onclick = function() { exportStatisticsToExcel(); };
        
        const exportPdfBtn = document.createElement('button');
        exportPdfBtn.className = 'button save-btn';
        exportPdfBtn.textContent = 'Exportar a PDF';
        exportPdfBtn.onclick = function() { exportStatisticsToPdf(); };
        
        exportContainer.appendChild(exportExcelBtn);
        exportContainer.appendChild(exportPdfBtn);
        
        chartContainer.appendChild(exportContainer);
    }
}

// Obtener color según tasa de asistencia
function getAttendanceColor(rate) {
    if (rate >= 90) return 'var(--success)';
    if (rate >= 70) return '#8BC34A'; // Verde-amarillo
    if (rate >= 50) return 'var(--warning)';
    return 'var(--error)';
}
</script>

<!-- Librerías para exportar -->
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/jspdf-autotable@latest/dist/jspdf.plugin.autotable.js"></script>  
</body>
</html>
