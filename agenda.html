<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMAKINE - Agenda</title>
    <style>
        /* Estilos b√°sicos */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f9f9f9;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .week-navigation {
            display: flex;
            align-items: center;
        }
        
        .week-navigation button {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px 10px;
        }
        
        .therapist-header {
            display: grid;
            grid-template-columns: 60px repeat(3, 1fr);
            text-align: center;
            margin-bottom: 10px;
        }
        
        .therapist-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0 auto 5px;
            background-color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .schedule-grid {
            display: grid;
            grid-template-columns: 60px repeat(3, 1fr);
            grid-auto-rows: 60px;
            border: 1px solid #ddd;
        }
        
        .time-cell {
            border-right: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }
        
        .schedule-cell {
            border-right: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            padding: 5px;
            position: relative;
            cursor: pointer;
        }
        
        .appointment {
            background-color: #90ee90;
            border-radius: 4px;
            padding: 5px;
            font-size: 0.9rem;
            height: 100%;
            overflow: hidden;
            position: relative;
        }
        
        .appointment.consulta-general { background-color: #ffb6c1; }
        .appointment.consulta-especializada { background-color: #90ee90; }
        .appointment.consulta-dermatologia { background-color: #ffa500; }
        .appointment.examen-cardiologico { background-color: #ffd700; }
        .appointment.evaluacion-fisica { background-color: #87cefa; }
        
        .appointment-title {
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .appointment-type {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .appointment-time {
            font-size: 0.8rem;
            position: absolute;
            bottom: 5px;
            left: 5px;
        }
        
        .stats-panel {
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .stats-title {
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
            font-size: 1.2rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .charts-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 200px;
            margin-top: 20px;
        }
        
        .chart-bar {
            width: 60px;
            background-color: #4caf50;
            margin: 0 15px;
            border-radius: 5px 5px 0 0;
            position: relative;
        }
        
        .chart-value {
            position: absolute;
            top: -25px;
            width: 100%;
            text-align: center;
            font-weight: bold;
        }
        
        .chart-labels {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        
        .chart-label {
            width: 90px;
            text-align: center;
            font-size: 0.9rem;
        }
        
        /* Estilos para los modales y formularios */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            width: 90%;
            max-width: 500px;
            margin: 10% auto;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .modal-header {
            padding: 15px 20px;
            background-color: #f5f5f5;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }
        
        .close {
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
        }
        
        form {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group input[type="time"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .form-group textarea {
            height: 80px;
            resize: vertical;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }
        
        .save-btn {
            background-color: #4caf50;
            color: white;
        }
        
        .save-btn:hover {
            background-color: #388e3c;
        }
        
        .cancel-btn {
            background-color: #777;
            color: white;
        }
        
        .cancel-btn:hover {
            background-color: #555;
        }
        
        .delete-btn {
            background-color: #f44336;
            color: white;
        }
        
        .delete-btn:hover {
            background-color: #d32f2f;
        }
        
        /* Estilos para el modal de asistencia */
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #ddd;
            text-align: right;
        }
        
        .attendance-options {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }
        
        .attendance-btn {
            padding: 10px;
            border: 1px solid #ddd;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
            flex: 1;
            margin: 0 5px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .attendance-btn[data-status="attended"] {
            border-color: #4caf50;
            color: #4caf50;
        }
        
        .attendance-btn[data-status="attended"].selected {
            background-color: #4caf50;
            color: white;
        }
        
        .attendance-btn[data-status="missed"] {
            border-color: #f44336;
            color: #f44336;
        }
        
        .attendance-btn[data-status="missed"].selected {
            background-color: #f44336;
            color: white;
        }
        
        .attendance-btn[data-status="rescheduled"] {
            border-color: #ff9800;
            color: #ff9800;
        }
        
        .attendance-btn[data-status="rescheduled"].selected {
            background-color: #ff9800;
            color: white;
        }
        
        /* Estilos para arrastrar y soltar */
        .schedule-cell.drag-over {
            background-color: rgba(76, 175, 80, 0.2);
        }
        
        .appointment {
            cursor: grab;
        }
        
        .appointment:active {
            cursor: grabbing;
        }
        
        /* Estado de asistencia para las citas */
        .appointment-status {
            position: absolute;
            right: 5px;
            bottom: 5px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .appointment-status.attended {
            background-color: #4caf50;
        }
        
        .appointment-status.missed {
            background-color: #f44336;
        }
        
        .appointment-status.rescheduled {
            background-color: #ff9800;
        }
        
        /* Indicador de cita web */
        .web-indicator {
            position: absolute;
            right: 5px;
            top: 5px;
            font-size: 0.8rem;
            color: #555;
        }
        
        /* Spinner de carga */
        .spinner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .spinner-content {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4caf50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Mensajes de estado */
        .status-message {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            background-color: #4caf50;
            color: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1500;
        }
        
        .status-message.error {
            background-color: #f44336;
        }
        
        .status-message.warning {
            background-color: #ff9800;
        }
        
        /* Login */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .login-title {
            text-align: center;
            margin-bottom: 20px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
    header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .week-navigation {
        margin-top: 10px;
        width: 100%;
        justify-content: space-between;
    }
    
    .days-header, .dates-header, .schedule-grid {
        grid-template-columns: 60px repeat(4, 1fr);
        overflow-x: auto;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .charts-container {
        flex-direction: column;
        height: auto;
        align-items: center;
    }
    
    .chart-bar {
        width: 100%;
        height: 40px !important;
        margin: 10px 0;
        border-radius: 0 5px 5px 0;
    }
    
    .chart-value {
        top: 10px;
        right: -25px;
        left: auto;
    }
    
    .chart-labels {
        flex-direction: column;
    }
}

    /* Estilos para la nueva estructura de agenda */
.days-header, .dates-header {
    display: grid;
    grid-template-columns: 60px repeat(4, 1fr);
    text-align: center;
    font-weight: bold;
    border-bottom: 1px solid #ddd;
}

.day-header, .date-header {
    padding: 10px;
    border-right: 1px solid #ddd;
    background-color: #f5f5f5;
}

.date-header {
    font-size: 0.9rem;
    color: #555;
}

.time-column-header {
    border-right: 1px solid #ddd;
}

/* Estilos para m√∫ltiples citas en una celda */
.schedule-cell {
    border-right: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
    padding: 5px;
    position: relative;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    gap: 5px;
    min-height: 60px;
    max-height: none; /* Permitir que crezca seg√∫n el contenido */
    overflow-y: auto; /* Permitir scroll si hay muchas citas */
}

/* Estilos para los tipos de cita */
.appointment.evaluacion-msk { background-color: #ffb6c1; }
.appointment.evaluacion-deportiva { background-color: #90ee90; }
.appointment.sesion-msk { background-color: #ffa500; }
.appointment.sesion-deportiva { background-color: #87cefa; }

/* Estilos para el selector de d√≠as de la semana */
.weekday-selector {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.weekday-selector label {
    display: flex;
    align-items: center;
    margin-right: 10px;
}

/* Estilos para citas recurrentes */
.appointment.recurring {
    border-left: 3px solid #4caf50;
}

/* Estilos para indicar el estudiante asignado */
.student-indicator {
    position: absolute;
    right: 20px;
    top: 5px;
    font-size: 0.8rem;
    font-weight: bold;
    color: #333;
}

/* D√≠a actual resaltado */
.current-day {
    background-color: #e0f7fa !important;
}    
    </style>
</head>
<body>
    <!-- Spinner de carga -->
    <div class="spinner" id="spinner">
        <div class="spinner-content"></div>
    </div>
    
    <!-- Mensaje de estado -->
    <div class="status-message" id="status-message"></div>
    
    <!-- Contenedor de login (se muestra solo si el usuario no est√° autenticado) -->
    <div class="login-container" id="login-container" style="display: none;">
        <h2 class="login-title">SISTEMAKINE - Agenda</h2>
        <form id="login-form">
            <div class="form-group">
                <label for="email">Correo electr√≥nico:</label>
                <input type="email" id="email" required>
            </div>
            <div class="form-group">
                <label for="password">Contrase√±a:</label>
                <input type="password" id="password" required>
            </div>
            <div class="form-actions">
                <button type="submit" class="button save-btn">Iniciar sesi√≥n</button>
            </div>
            <p style="margin-top: 20px; text-align: center;">
                <small>Si eres estudiante, solicita las credenciales a tu profesor.</small>
            </p>
        </form>
    </div>
    
    <!-- Contenedor principal (se muestra solo si el usuario est√° autenticado) -->
    <div class="container" id="main-container" style="display: none;">
        <header>
            <h1>Agenda SISTEMAKINE</h1>
            <div class="week-navigation">
                <button id="prev-week">‚óÄ</button>
                <h2 id="current-week">Semana del 17 al 23 de marzo de 2025</h2>
                <button id="next-week">‚ñ∂</button>
            </div>
            <div id="user-info" style="margin-left: auto; display: flex; align-items: center;">
                <span id="user-name" style="margin-right: 10px;"></span>
                <button id="logout-btn" class="button cancel-btn" style="padding: 5px 10px; font-size: 0.8rem;">Cerrar sesi√≥n</button>
            </div>
        </header>
        
        <!-- Encabezado de la semana con d√≠as -->
<div class="days-header">
    <div class="time-column-header"></div>
    <div class="day-header" id="day-header-1">Lunes</div>
    <div class="day-header" id="day-header-2">Martes</div>
    <div class="day-header" id="day-header-3">Mi√©rcoles</div>
    <div class="day-header" id="day-header-4">Jueves</div>
</div>

<!-- Encabezado con fechas -->
<div class="dates-header">
    <div class="time-column-header"></div>
    <div class="date-header" id="date-header-1">18/03</div>
    <div class="date-header" id="date-header-2">19/03</div>
    <div class="date-header" id="date-header-3">20/03</div>
    <div class="date-header" id="date-header-4">21/03</div>
</div>

<!-- Cuadr√≠cula de la agenda -->
<div class="schedule-grid">
    <!-- Horas -->
    <div class="time-cell">09:00</div>
    <div class="schedule-cell" data-hour="9" data-day="1"></div>
    <div class="schedule-cell" data-hour="9" data-day="2"></div>
    <div class="schedule-cell" data-hour="9" data-day="3"></div>
    <div class="schedule-cell" data-hour="9" data-day="4"></div>
    
    <div class="time-cell">10:00</div>
    <div class="schedule-cell" data-hour="10" data-day="1"></div>
    <div class="schedule-cell" data-hour="10" data-day="2"></div>
    <div class="schedule-cell" data-hour="10" data-day="3"></div>
    <div class="schedule-cell" data-hour="10" data-day="4"></div>
    
    <div class="time-cell">11:00</div>
    <div class="schedule-cell" data-hour="11" data-day="1"></div>
    <div class="schedule-cell" data-hour="11" data-day="2"></div>
    <div class="schedule-cell" data-hour="11" data-day="3"></div>
    <div class="schedule-cell" data-hour="11" data-day="4"></div>
    
    <div class="time-cell">12:00</div>
    <div class="schedule-cell" data-hour="12" data-day="1"></div>
    <div class="schedule-cell" data-hour="12" data-day="2"></div>
    <div class="schedule-cell" data-hour="12" data-day="3"></div>
    <div class="schedule-cell" data-hour="12" data-day="4"></div>
    
    <div class="time-cell">13:00</div>
    <div class="schedule-cell" data-hour="13" data-day="1"></div>
    <div class="schedule-cell" data-hour="13" data-day="2"></div>
    <div class="schedule-cell" data-hour="13" data-day="3"></div>
    <div class="schedule-cell" data-hour="13" data-day="4"></div>
    
    <div class="time-cell">14:00</div>
    <div class="schedule-cell" data-hour="14" data-day="1"></div>
    <div class="schedule-cell" data-hour="14" data-day="2"></div>
    <div class="schedule-cell" data-hour="14" data-day="3"></div>
    <div class="schedule-cell" data-hour="14" data-day="4"></div>
    
    <div class="time-cell">15:00</div>
    <div class="schedule-cell" data-hour="15" data-day="1"></div>
    <div class="schedule-cell" data-hour="15" data-day="2"></div>
    <div class="schedule-cell" data-hour="15" data-day="3"></div>
    <div class="schedule-cell" data-hour="15" data-day="4"></div>
    
    <div class="time-cell">16:00</div>
    <div class="schedule-cell" data-hour="16" data-day="1"></div>
    <div class="schedule-cell" data-hour="16" data-day="2"></div>
    <div class="schedule-cell" data-hour="16" data-day="3"></div>
    <div class="schedule-cell" data-hour="16" data-day="4"></div>
</div>
        
        <div class="stats-panel">
            <h3 class="stats-title">Estad√≠sticas</h3>
            
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">Asistencia semanal</div>
                    <div class="stat-value" id="attendance-rate">85%</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Citas totales</div>
                    <div class="stat-value" id="total-appointments">32</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Hora m√°s ocupada</div>
                    <div class="stat-value" id="busiest-hour">10:00 - 11:00</div>
                </div>
            </div>
            
            <h4>Citas por kinesi√≥logo</h4>
            
            <div class="charts-container" id="therapist-chart">
                <div class="chart-bar" style="height: 80%;">
                    <div class="chart-value">14</div>
                </div>
                <div class="chart-bar" style="height: 50%;">
                    <div class="chart-value">9</div>
                </div>
                <div class="chart-bar" style="height: 50%;">
                    <div class="chart-value">9</div>
                </div>
            </div>
            
            <div class="chart-labels">
                <div class="chart-label">Nicol√°s</div>
                <div class="chart-label">Ana Mar√≠a</div>
                <div class="chart-label">Gustavo</div>
            </div>
        </div>
    </div>
    
    <!-- Modal para agregar/editar citas -->
    <div class="modal" id="appointment-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">Agregar Nueva Cita</h3>
            <span class="close">&times;</span>
        </div>
        <form id="appointment-form">
       <!-- Modal para agregar/editar citas -->
<div class="modal" id="appointment-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">Agregar Nueva Cita</h3>
            <span class="close">&times;</span>
        </div>
        <form id="appointment-form">
            <div class="form-group">
                <label for="patient-name">Paciente:</label>
                <input type="text" id="patient-name" required>
            </div>
            <div class="form-group">
                <label for="appointment-type">Tipo de consulta:</label>
                <select id="appointment-type" required onchange="handleAppointmentTypeChange()">
                    <option value="evaluacion-msk">Evaluaci√≥n kinesiolog√≠a msk</option>
                    <option value="evaluacion-deportiva">Evaluaci√≥n kinesiolog√≠a deportiva</option>
                    <option value="sesion-msk">Sesi√≥n kinesiolog√≠a msk</option>
                    <option value="sesion-deportiva">Sesi√≥n kinesiolog√≠a deportiva</option>
                </select>
            </div>
            <div class="form-group">
                <label for="therapist">Kinesi√≥logo:</label>
                <select id="therapist" required>
                    <option value="nicolas">Nicol√°s</option>
                    <option value="ana-maria">Ana Mar√≠a</option>
                    <option value="gustavo">Gustavo</option>
                </select>
            </div>
            <div class="form-group">
                <label for="student">Estudiante asignado:</label>
                <select id="student" required>
                    <option value="estudiante1">Estudiante 1</option>
                    <option value="estudiante2">Estudiante 2</option>
                    <option value="estudiante3">Estudiante 3</option>
                    <option value="estudiante4">Estudiante 4</option>
                    <option value="estudiante5">Estudiante 5</option>
                    <option value="estudiante6">Estudiante 6</option>
                    <option value="estudiante7">Estudiante 7</option>
                    <option value="estudiante8">Estudiante 8</option>
                </select>
            </div>
            <div class="form-group">
                <label for="appointment-date">Fecha:</label>
                <input type="date" id="appointment-date" required>
            </div>
            <div class="form-group">
                <label for="appointment-time">Hora inicio:</label>
                <input type="time" id="appointment-time" required>
            </div>
            <div class="form-group">
                <label for="appointment-duration">Duraci√≥n:</label>
                <select id="appointment-duration" required>
                    <option value="60">1 hora</option>
                    <option value="120">2 horas</option>
                    <option value="30">30 minutos</option>
                    <option value="90">1 hora 30 minutos</option>
                </select>
            </div>

            <!-- Secci√≥n para citas recurrentes -->
            <div id="recurrence-options" style="display: none;">
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="is-recurring"> Cita recurrente
                    </label>
                </div>
                <div id="recurring-details" style="display: none; padding-left: 20px;">
                    <div class="form-group">
                        <label>D√≠as de la semana:</label>
                        <div class="weekday-selector">
                            <label><input type="checkbox" name="weekday" value="1"> Lunes</label>
                            <label><input type="checkbox" name="weekday" value="2"> Martes</label>
                            <label><input type="checkbox" name="weekday" value="3"> Mi√©rcoles</label>
                            <label><input type="checkbox" name="weekday" value="4"> Jueves</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="recurrence-end">Fecha fin:</label>
                        <input type="date" id="recurrence-end">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="appointment-notes">Notas:</label>
                <textarea id="appointment-notes"></textarea>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="is-web"> V√≠a web
                </label>
            </div>
            <div class="form-actions">
                <button type="submit" class="button save-btn">Guardar</button>
                <button type="button" class="button cancel-btn" id="cancel-appointment">Cancelar</button>
                <button type="button" class="button delete-btn" id="delete-appointment" style="display: none;">Eliminar</button>
            </div>
        </form>
    </div>
</div>
    
    <!-- Modal para confirmar asistencia -->
    <div class="modal" id="attendance-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirmar Asistencia</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <p>Paciente: <span id="attendance-patient"></span></p>
                <p>Fecha: <span id="attendance-date"></span></p>
                <p>Hora: <span id="attendance-time"></span></p>
                <div class="attendance-options">
                    <button class="attendance-btn" data-status="attended">Asisti√≥</button>
                    <button class="attendance-btn" data-status="missed">No asisti√≥</button>
                    <button class="attendance-btn" data-status="rescheduled">Reprogramada</button>
                </div>
                <div class="form-group">
                    <label for="attendance-notes">Notas:</label>
                    <textarea id="attendance-notes"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="button save-btn" id="save-attendance">Guardar</button>
                <button class="button cancel-btn" id="cancel-attendance">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script>
    // Configuraci√≥n de Firebase - REEMPLAZA ESTOS VALORES CON LOS DE TU PROYECTO FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyA8fY-L1r3nBq61CFPOAFRI6TlS9A5GNTA",
        authDomain: "agendapoli-13963.firebaseapp.com",
        projectId: "agendapoli-13963",
        storageBucket: "agendapoli-13963.firebasestorage.app",
        messagingSenderId: "265927768586",
        appId: "1:265927768586:web:c7e37e6a561bd996687df3"
    };
    
    // Inicializar Firebase (con manejo de errores)
try {
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
        console.log("[DEBUG] Firebase inicializado correctamente");
    } else {
        console.log("[DEBUG] Firebase ya estaba inicializado");
    }
} catch (error) {
    console.error("[DEBUG] Error al inicializar Firebase:", error);
}

// Referencias a Firebase
const auth = firebase.auth();
const db = firebase.firestore();
console.log("[DEBUG] Referencias a auth y db creadas");
    
    // Variables globales
    let currentUser = null;
    let isAdmin = false;
    let appointments = [];
    let editingAppointmentId = null;
    let holidays = [];
    let currentWeekDate = new Date();
    
    // Elementos DOM
    const spinner = document.getElementById('spinner');
    const statusMessage = document.getElementById('status-message');
    const loginContainer = document.getElementById('login-container');
    const mainContainer = document.getElementById('main-container');
    const appointmentModal = document.getElementById('appointment-modal');
    const appointmentForm = document.getElementById('appointment-form');
    const attendanceModal = document.getElementById('attendance-modal');
    const currentWeekDisplay = document.getElementById('current-week');
    const loginForm = document.getElementById('login-form');
    const userNameDisplay = document.getElementById('user-name');
    const logoutBtn = document.getElementById('logout-btn');
    
    // Inicializar la aplicaci√≥n
    document.addEventListener('DOMContentLoaded', function() {
        // Mostrar spinner mientras carga
        showSpinner();
        
        // Verificar estado de autenticaci√≥n
auth.onAuthStateChanged(function(user) {
    console.log("[DEBUG] Estado de autenticaci√≥n cambiado");
    
    if (user) {
        // Usuario autenticado
        currentUser = user;
        console.log("[DEBUG] Usuario autenticado:", user.email);
        console.log("[DEBUG] UID del usuario:", user.uid);
        userNameDisplay.textContent = user.email;
        
        // Esperar un momento antes de verificar el rol (para asegurar que Firebase est√© listo)
        setTimeout(() => {
            checkUserRole(user.uid);
        }, 1000);
    } else {
        // Usuario no autenticado
        console.log("[DEBUG] No hay usuario autenticado");
        showLoginScreen();
        hideSpinner();
    }
});
        
        // Configurar event listeners
        setupEventListeners();
    });
    
    function checkUserRole(userId) {
    console.log("[DEBUG] Usuario autenticado:", userId);
    
    // Tratar a todos los usuarios como administradores
    isAdmin = true;
    document.body.classList.remove('student-view');
    
    // Obtener informaci√≥n del usuario para el historial
    db.collection('usuarios').doc(userId).get()
        .then((doc) => {
            if (doc.exists) {
                // Guardar informaci√≥n del usuario para el historial
                const userData = doc.data();
                console.log("[DEBUG] Informaci√≥n del usuario:", userData);
                
                // Puedes almacenar m√°s informaci√≥n del usuario si lo deseas
                // currentUserName = userData.nombre || userData.email || currentUser.email;
            } else {
                // Si no existe el documento del usuario, crearlo con timestamp
                db.collection('usuarios').doc(userId).set({
                    email: currentUser.email,
                    ultimoAcceso: firebase.firestore.FieldValue.serverTimestamp()
                })
                .then(() => {
                    console.log("[DEBUG] Documento de usuario creado");
                })
                .catch(error => {
                    console.error("[DEBUG] Error al crear documento de usuario:", error);
                });
            }
            
            // Inicializar la agenda
            initializeApp();
        })
        .catch((error) => {
            console.error("[DEBUG] Error al obtener informaci√≥n del usuario:", error);
            
            // De todos modos inicializar la aplicaci√≥n
            isAdmin = true;
            document.body.classList.remove('student-view');
            initializeApp();
        });
}
    
    // Inicializar la aplicaci√≥n
    function initializeApp() {
        loadHolidays();
        updateWeekDisplay();
        loadAppointments();
        
        // Mostrar la interfaz principal
        loginContainer.style.display = 'none';
        mainContainer.style.display = 'block';
        
        hideSpinner();
    }
    
    // Mostrar pantalla de login
    function showLoginScreen() {
        loginContainer.style.display = 'block';
        mainContainer.style.display = 'none';
    }
    
    // Cargar los feriados chilenos
    function loadHolidays() {
        holidays = [
            { date: '2025-01-01', name: 'A√±o Nuevo' },
            { date: '2025-04-18', name: 'Viernes Santo' },
            { date: '2025-04-19', name: 'S√°bado Santo' },
            { date: '2025-05-01', name: 'D√≠a del Trabajo' },
            { date: '2025-05-21', name: 'D√≠a de las Glorias Navales' },
            { date: '2025-06-29', name: 'San Pedro y San Pablo' },
            { date: '2025-07-16', name: 'Virgen del Carmen' },
            { date: '2025-08-15', name: 'Asunci√≥n de la Virgen' },
            { date: '2025-09-18', name: 'Independencia Nacional' },
            { date: '2025-09-19', name: 'D√≠a de las Glorias del Ej√©rcito' },
            { date: '2025-10-12', name: 'Encuentro de Dos Mundos' },
            { date: '2025-10-31', name: 'D√≠a de las Iglesias Evang√©licas' },
            { date: '2025-11-01', name: 'D√≠a de Todos los Santos' },
            { date: '2025-12-08', name: 'Inmaculada Concepci√≥n' },
            { date: '2025-12-25', name: 'Navidad' }
        ];
    }
    
    // Actualizar la visualizaci√≥n de la semana actual
function updateWeekDisplay() {
    const startOfWeek = getStartOfWeek(currentWeekDate);
    
    // Actualizar el texto principal de la semana
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 3); // Solo hasta jueves (4 d√≠as)
    
    const startDay = startOfWeek.getDate();
    const endDay = endOfWeek.getDate();
    const startMonthName = getMonthName(startOfWeek.getMonth());
    const endMonthName = getMonthName(endOfWeek.getMonth());
    const year = startOfWeek.getFullYear();
    
    currentWeekDisplay.textContent = `Semana del ${startDay} al ${endDay} de ${endMonthName} de ${year}`;
    
    // Actualizar los encabezados de d√≠as con las fechas correspondientes
    for (let i = 1; i <= 4; i++) {
        const dayDate = new Date(startOfWeek);
        dayDate.setDate(startOfWeek.getDate() + (i - 1));
        
        const dayHeader = document.getElementById(`day-header-${i}`);
        const dateHeader = document.getElementById(`date-header-${i}`);
        
        const dayNames = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
        dayHeader.textContent = dayNames[dayDate.getDay()];
        dateHeader.textContent = `${dayDate.getDate()}/${dayDate.getMonth() + 1}`;
        
        // Resaltar el d√≠a actual si est√° en la semana mostrada
        const today = new Date();
        if (dayDate.toDateString() === today.toDateString()) {
            dayHeader.classList.add('current-day');
            dateHeader.classList.add('current-day');
            // Tambi√©n resaltar las celdas del d√≠a actual
            document.querySelectorAll(`.schedule-cell[data-day="${i}"]`).forEach(cell => {
                cell.classList.add('current-day');
            });
        } else {
            dayHeader.classList.remove('current-day');
            dateHeader.classList.remove('current-day');
            document.querySelectorAll(`.schedule-cell[data-day="${i}"]`).forEach(cell => {
                cell.classList.remove('current-day');
            });
        }
    }
}
    
    // Obtener el primer d√≠a de la semana (lunes)
    function getStartOfWeek(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Ajusta cuando el d√≠a es domingo
        const monday = new Date(d.setDate(diff));
        monday.setHours(0, 0, 0, 0);
        return monday;
    }
    
    // Obtener nombre del mes en espa√±ol
    function getMonthName(month) {
        const months = [
            'enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 
            'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'
        ];
        return months[month];
    }
    
    // Cargar citas desde Firestore
   function loadAppointments() {
    showSpinner();
    
    // Obtener fecha de inicio y fin de la semana
    const startOfWeek = getStartOfWeek(currentWeekDate);
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 4); // Un d√≠a despu√©s del jueves
    
    // Convertir a Timestamp para consulta
    const startTimestamp = firebase.firestore.Timestamp.fromDate(startOfWeek);
    const endTimestamp = firebase.firestore.Timestamp.fromDate(endOfWeek);
    
    // Consulta a Firestore
    db.collection('citas')
        .where('fecha', '>=', startTimestamp)
        .where('fecha', '<', endTimestamp)
        .get()
        .then((querySnapshot) => {
            appointments = [];
            
            querySnapshot.forEach((doc) => {
                // Convertir Timestamp a Date
                const data = doc.data();
                const appointment = {
                    id: doc.id,
                    ...data,
                    fecha: data.fecha.toDate()
                };
                
                appointments.push(appointment);
            });
            
            // Renderizar citas y actualizar estad√≠sticas
            renderAppointments();
            updateStatistics();
            hideSpinner();
        })
        .catch((error) => {
            console.error("Error al cargar citas:", error);
            showStatusMessage("Error al cargar citas. Intenta nuevamente.", "error");
            hideSpinner();
        });
}
    
    // Cargar citas de ejemplo (en caso de error o para la primera vez)
    function loadSampleAppointments() {
        // Fecha de referencia (lunes de la semana actual)
        const startOfWeek = getStartOfWeek(currentWeekDate);
        
        appointments = [
            {
                id: '1',
                paciente: 'Mar√≠a Gonz√°lez',
                tipo: 'Consulta especializada',
                tipoClase: 'consulta-especializada',
                fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate(), 9, 0),
                duracion: 60,
                terapeuta: 'nicolas'
            },
            {
                id: '2',
                paciente: 'Ana Mart√≠nez',
                tipo: 'Consulta general',
                tipoClase: 'consulta-general',
                fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate(), 11, 0),
                duracion: 60,
                terapeuta: 'ana-maria'
            },
            {
                id: '3',
                paciente: 'Laura P√©rez',
                tipo: 'Examen cardiol√≥gico',
                tipoClase: 'examen-cardiologico',
                fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate(), 13, 0),
                duracion: 60,
                terapeuta: 'nicolas'
            },
            {
                id: '4',
                paciente: 'Isabel Rodr√≠guez',
                tipo: 'Consulta general',
                tipoClase: 'consulta-general',
                fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate(), 10, 0),
                duracion: 60,
                terapeuta: 'ana-maria'
            },
            {
                id: '5',
                paciente: 'Julia L√≥pez',
                tipo: 'Consulta general',
                tipoClase: 'consulta-general',
                fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate(), 14, 0),
                duracion: 60,
                terapeuta: 'ana-maria'
            },
            {
                id: '6',
                paciente: 'Elena Castro',
                tipo: 'Evaluaci√≥n f√≠sica',
                tipoClase: 'evaluacion-fisica',
                fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate(), 9, 0),
                duracion: 60,
                terapeuta: 'gustavo'
            },
            {
                id: '7',
                paciente: 'Sandra D√≠az',
                tipo: 'Evaluaci√≥n f√≠sica',
                tipoClase: 'evaluacion-fisica',
                fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate(), 15, 0),
                duracion: 60,
                terapeuta: 'ana-maria'
            },
            {
                id: '8',
                paciente: 'Beatriz S√°nchez',
                tipo: 'Consulta general',
                tipoClase: 'consulta-general',
                fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate(), 15, 0),
                duracion: 60,
                terapeuta: 'ana-maria'
            },
            {
                id: '9',
                paciente: 'Carolina Garc√≠a',
                tipo: 'Consulta dermatolog√≠a',
                tipoClase: 'consulta-dermatologia',
                fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate(), 12, 0),
                duracion: 60,
                terapeuta: 'gustavo'
            }
        ];
        
        renderAppointments();
        updateStatistics();
    }
    
    // Renderizar las citas en la cuadr√≠cula
function renderAppointments() {
    // Limpiar citas existentes
    document.querySelectorAll('.appointment').forEach(el => el.remove());
    
    // Fecha de referencia (lunes de la semana actual)
    const startOfWeek = getStartOfWeek(currentWeekDate);
    
    // Renderizar cada cita de la semana actual
    appointments.forEach(appointment => {
        const appointmentDate = appointment.fecha;
        const dayDiff = Math.floor((appointmentDate - startOfWeek) / (24 * 60 * 60 * 1000));
        
        // Solo mostrar citas de lunes a jueves (0-3)
        if (dayDiff >= 0 && dayDiff < 4) {
            const hour = appointmentDate.getHours();
            const dayIndex = dayDiff + 1; // 1 para lunes, 2 para martes, etc.
            
            // Encontrar la celda correcta
            const cell = document.querySelector(`.schedule-cell[data-hour="${hour}"][data-day="${dayIndex}"]`);
            
            if (cell) {
                // Crear elemento de cita
                const appointmentEl = document.createElement('div');
                appointmentEl.className = `appointment ${appointment.tipoClase}`;
                appointmentEl.dataset.id = appointment.id;
                
                // A√±adir clase si es recurrente
                if (appointment.esRecurrente) {
                    appointmentEl.classList.add('recurring');
                }
                
                // Contenido de la cita
                appointmentEl.innerHTML = `
                    <div class="appointment-title">${appointment.paciente}</div>
                    <div class="appointment-type">${appointment.tipo}</div>
                    <div class="student-indicator">${appointment.estudiante || 'Sin asignar'}</div>
                `;
                
                // Indicador de estado si existe
                if (appointment.estado) {
                    const statusEl = document.createElement('div');
                    statusEl.className = `appointment-status ${appointment.estado}`;
                    appointmentEl.appendChild(statusEl);
                }
                
                // Indicador web si aplica
                if (appointment.web) {
                    const webEl = document.createElement('div');
                    webEl.className = 'web-indicator';
                    webEl.innerHTML = 'üåê';
                    appointmentEl.appendChild(webEl);
                }
                
                // Agregar a la celda
                cell.appendChild(appointmentEl);
                
                // Eventos para la cita
                appointmentEl.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const app = appointments.find(a => a.id === this.dataset.id);
                    if (app) {
                        // Si la cita ya pas√≥, mostrar modal de asistencia
                        const today = new Date();
                        if (app.fecha < today) {
                            if (isAdmin) {
                                openAttendanceModal(app);
                            } else {
                                viewAppointmentDetails(app);
                            }
                        } else {
                            // Si es una cita futura
                            if (isAdmin) {
                                openAppointmentModal(app);
                            } else {
                                viewAppointmentDetails(app);
                            }
                        }
                    }
                });
                
                // Hacer que las citas sean arrastrables para administradores
                if (isAdmin) {
                    appointmentEl.setAttribute('draggable', 'true');
                    appointmentEl.addEventListener('dragstart', function(e) {
                        e.dataTransfer.setData('text/plain', this.dataset.id);
                    });
                }
            }
        }
    });
}
    
    // Mostrar detalles de la cita (para estudiantes)
    function viewAppointmentDetails(appointment) {
        const options = { 
            weekday: 'long', 
            day: 'numeric', 
            month: 'long', 
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        };
        
        alert(`
            Paciente: ${appointment.paciente}
            Tipo: ${appointment.tipo}
            Fecha: ${appointment.fecha.toLocaleDateString('es-ES', options)}
            Kinesi√≥logo: ${getTherapistName(appointment.terapeuta)}
            ${appointment.estado ? 'Estado: ' + getStatusText(appointment.estado) : ''}
        `);
    }
    
    // Obtener nombre completo del terapeuta
    function getTherapistName(therapistId) {
        switch(therapistId) {
            case 'nicolas': return 'Nicol√°s';
            case 'ana-maria': return 'Ana Mar√≠a';
            case 'gustavo': return 'Gustavo';
            default: return therapistId;
        }
    }
    
    // Obtener texto del estado
    function getStatusText(status) {
        switch(status) {
            case 'attended': return 'Asisti√≥';
            case 'missed': return 'No asisti√≥';
            case 'rescheduled': return 'Reprogramada';
            default: return status;
        }
    }
    
    // Actualizar estad√≠sticas
    function updateStatistics() {
        // Calcular asistencia semanal
        const totalPastAppointments = appointments.filter(a => {
            const now = new Date();
            return a.fecha < now;
        }).length;
        
        const attendedAppointments = appointments.filter(a => a.estado === 'attended').length;
        
        const attendanceRate = totalPastAppointments > 0 
            ? Math.round((attendedAppointments / totalPastAppointments) * 100) 
            : 0;
        
        // Citas por hora
        const appointmentsByHour = {};
        appointments.forEach(a => {
            const hour = a.fecha.getHours();
            appointmentsByHour[hour] = (appointmentsByHour[hour] || 0) + 1;
        });
        
        // Encontrar la hora m√°s ocupada
        let busiestHour = 9; // Por defecto 9:00
        let maxAppointments = 0;
        
        for (const hour in appointmentsByHour) {
            if (appointmentsByHour[hour] > maxAppointments) {
                busiestHour = parseInt(hour);
                maxAppointments = appointmentsByHour[hour];
            }
        }
        
        // Citas por terapeuta
        const appointmentsByTherapist = {
            'nicolas': 0,
            'ana-maria': 0,
            'gustavo': 0
        };
        
        appointments.forEach(a => {
            const therapist = a.terapeuta;
            if (appointmentsByTherapist[therapist] !== undefined) {
                appointmentsByTherapist[therapist]++;
            }
        });
        
        // Actualizar DOM
        document.getElementById('attendance-rate').textContent = `${attendanceRate}%`;
        document.getElementById('total-appointments').textContent = appointments.length;
        document.getElementById('busiest-hour').textContent = `${busiestHour}:00 - ${busiestHour + 1}:00`;
        
        // Actualizar gr√°fico de terapeutas
        const chartContainer = document.getElementById('therapist-chart');
        chartContainer.innerHTML = '';
        
        const maxValue = Math.max(
            appointmentsByTherapist['nicolas'], 
            appointmentsByTherapist['ana-maria'], 
            appointmentsByTherapist['gustavo'],
            1 // Evita divisi√≥n por cero
        );
        
        const therapists = ['nicolas', 'ana-maria', 'gustavo'];
        
        therapists.forEach(therapist => {
            const value = appointmentsByTherapist[therapist];
            const height = Math.max((value / maxValue) * 100, 5); // Al menos 5% de altura
            
            const barEl = document.createElement('div');
            barEl.className = 'chart-bar';
            barEl.style.height = `${height}%`;
            
            const valueEl = document.createElement('div');
            valueEl.className = 'chart-value';
            valueEl.textContent = value;
            
            barEl.appendChild(valueEl);
            chartContainer.appendChild(barEl);
        });
    }

    // Funci√≥n para eliminar citas recurrentes a partir de una fecha
function deleteRecurringAppointments(appointmentId, fromDate) {
    return new Promise((resolve, reject) => {
        // Primero obtener los datos de la cita para encontrar la serie
        db.collection('citas').doc(appointmentId).get()
            .then((doc) => {
                if (!doc.exists) {
                    reject(new Error("Cita no encontrada"));
                    return;
                }
                
                const appointmentData = doc.data();
                if (!appointmentData.esRecurrente || !appointmentData.serieRecurrenteId) {
                    resolve(); // No es recurrente, nada que eliminar
                    return;
                }
                
                // Buscar todas las citas futuras de la misma serie
                return db.collection('citas')
                    .where('serieRecurrenteId', '==', appointmentData.serieRecurrenteId)
                    .where('fecha', '>=', firebase.firestore.Timestamp.fromDate(fromDate))
                    .get();
            })
            .then((querySnapshot) => {
                if (!querySnapshot) return;
                
                const deletePromises = [];
                
                querySnapshot.forEach((doc) => {
                    // Registrar la eliminaci√≥n en el historial
                    const deletePromise = db.collection('historial_citas').add({
                        citaId: doc.id,
                        accion: 'eliminacion_recurrente',
                        usuario: currentUser.email,
                        usuarioId: currentUser.uid,
                        fecha: firebase.firestore.FieldValue.serverTimestamp(),
                        datosCita: doc.data()
                    }).then(() => {
                        // Luego eliminar la cita
                        return db.collection('citas').doc(doc.id).delete();
                    });
                    
                    deletePromises.push(deletePromise);
                });
                
                return Promise.all(deletePromises);
            })
            .then(() => {
                resolve();
            })
            .catch((error) => {
                console.error("Error al eliminar citas recurrentes:", error);
                reject(error);
            });
    });
}
        
    // Funci√≥n para manejar cambios en el tipo de cita (mostrar opciones de recurrencia)
function handleAppointmentTypeChange() {
    const appointmentType = document.getElementById('appointment-type').value;
    const recurrenceOptions = document.getElementById('recurrence-options');
    
    // Solo mostrar opciones de recurrencia para sesiones, no para evaluaciones
    if (appointmentType.startsWith('sesion-')) {
        recurrenceOptions.style.display = 'block';
    } else {
        recurrenceOptions.style.display = 'none';
        document.getElementById('is-recurring').checked = false;
        document.getElementById('recurring-details').style.display = 'none';
    }
}
        
    // Configurar event listeners
    function setupEventListeners() {
        // Login
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            showSpinner();
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Login exitoso
                    hideSpinner();
                })
                .catch((error) => {
                    console.error("Error de login:", error);
                    hideSpinner();
                    showStatusMessage("Error de inicio de sesi√≥n. Verifica tus credenciales.", "error");
                });
        });
        
        // Logout
        logoutBtn.addEventListener('click', function() {
            auth.signOut()
                .then(() => {
                    // Logout exitoso
                    showLoginScreen();
                })
                .catch((error) => {
                    console.error("Error al cerrar sesi√≥n:", error);
                    showStatusMessage("Error al cerrar sesi√≥n.", "error");
                });
        });
        
        // Navegaci√≥n de semanas
        // Evento para mostrar/ocultar detalles de recurrencia
document.getElementById('is-recurring').addEventListener('change', function() {
    document.getElementById('recurring-details').style.display = this.checked ? 'block' : 'none';
});
        document.getElementById('prev-week').addEventListener('click', function() {
            navigateWeek(-1);
        });
        
        document.getElementById('next-week').addEventListener('click', function() {
            navigateWeek(1);
        });
        
        // Clic en celdas de la agenda (para agregar citas)
// Clic en celdas de la agenda (para agregar citas)
document.querySelectorAll('.schedule-cell').forEach(cell => {
    cell.addEventListener('click', function() {
        if (isAdmin) {
            const hour = parseInt(this.dataset.hour);
            const day = parseInt(this.dataset.day);
            
            openAppointmentModal(null, hour, day);
        }
    });
            
    // Configuraci√≥n para arrastrar y soltar
    if (isAdmin) {
        cell.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        });
        
        cell.addEventListener('dragleave', function() {
            this.classList.remove('drag-over');
        });
        
        cell.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            const appointmentId = e.dataTransfer.getData('text/plain');
            const hour = parseInt(this.dataset.hour);
            const day = parseInt(this.dataset.day);
            
            // Obtener fecha correspondiente a este d√≠a
            const startOfWeek = getStartOfWeek(currentWeekDate);
            const targetDate = new Date(startOfWeek);
            targetDate.setDate(startOfWeek.getDate() + (day - 1));
            
            // Mover la cita a esta fecha y hora
            moveAppointmentToDate(appointmentId, targetDate, hour);
        });
    }
});
        
        // Formulario de citas
        appointmentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            if (isAdmin) {
                saveAppointment();
            }
        });
        
        document.getElementById('cancel-appointment').addEventListener('click', function() {
            closeAppointmentModal();
        });
        
        document.getElementById('delete-appointment').addEventListener('click', function() {
            if (isAdmin && confirm('¬øEst√°s seguro de que deseas eliminar esta cita?')) {
                deleteAppointment();
            }
        });
        
        // Cerrar modales con la X
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.addEventListener('click', function() {
                this.closest('.modal').style.display = 'none';
            });
        });
        
        // Eventos para asistencia
        document.querySelectorAll('.attendance-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.attendance-btn').forEach(b => {
                    b.classList.remove('selected');
                });
                this.classList.add('selected');
            });
        });
        
        document.getElementById('save-attendance').addEventListener('click', function() {
            if (isAdmin) {
                saveAttendance();
            }
        });
        
        document.getElementById('cancel-attendance').addEventListener('click', function() {
            closeAttendanceModal();
        });
    }
    
    // Navegar entre semanas
    function navigateWeek(direction) {
        currentWeekDate.setDate(currentWeekDate.getDate() + (direction * 7));
        updateWeekDisplay();
        loadAppointments();
    }
    
    // Formatear fecha como YYYY-MM-DD
    function formatDate(date) {
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    // Abrir modal para agregar/editar cita
   function openAppointmentModal(appointment, hour, day) {
    if (!isAdmin) return;
    
    const modalTitle = document.getElementById('modal-title');
    const dateInput = document.getElementById('appointment-date');
    const timeInput = document.getElementById('appointment-time');
    const deleteBtn = document.getElementById('delete-appointment');
    const isRecurringCheckbox = document.getElementById('is-recurring');
    const recurringDetails = document.getElementById('recurring-details');
    
    // Ocultar opciones de recurrencia por defecto
    document.getElementById('recurrence-options').style.display = 'none';
    
    if (appointment) {
        // Editar cita existente
        modalTitle.textContent = 'Editar Cita';
        
        document.getElementById('patient-name').value = appointment.paciente;
        document.getElementById('appointment-type').value = appointment.tipoClase;
        
        // Mostrar opciones de recurrencia solo para sesiones
        if (appointment.tipoClase.startsWith('sesion-')) {
            document.getElementById('recurrence-options').style.display = 'block';
        }
        
        // Si es una cita recurrente, mostrar los detalles
        if (appointment.esRecurrente) {
            isRecurringCheckbox.checked = true;
            recurringDetails.style.display = 'block';
            
            // Marcar los d√≠as de la semana
            if (appointment.patronRecurrencia && appointment.patronRecurrencia.diasSemana) {
                const weekdays = appointment.patronRecurrencia.diasSemana;
                document.querySelectorAll('input[name="weekday"]').forEach(checkbox => {
                    checkbox.checked = weekdays.includes(parseInt(checkbox.value));
                });
            }
            
            // Establecer fecha fin
            if (appointment.patronRecurrencia && appointment.patronRecurrencia.fechaFin) {
                let endDate;
                if (appointment.patronRecurrencia.fechaFin instanceof firebase.firestore.Timestamp) {
                    endDate = appointment.patronRecurrencia.fechaFin.toDate();
                } else if (appointment.patronRecurrencia.fechaFin instanceof Date) {
                    endDate = appointment.patronRecurrencia.fechaFin;
                } else if (typeof appointment.patronRecurrencia.fechaFin === 'string') {
                    endDate = new Date(appointment.patronRecurrencia.fechaFin);
                }
                
                if (endDate) {
                    document.getElementById('recurrence-end').value = formatDate(endDate);
                }
            }
        } else {
            isRecurringCheckbox.checked = false;
            recurringDetails.style.display = 'none';
        }
        
        const fecha = appointment.fecha;
        dateInput.value = formatDate(fecha);
        timeInput.value = `${fecha.getHours().toString().padStart(2, '0')}:${fecha.getMinutes().toString().padStart(2, '0')}`;
        
        document.getElementById('appointment-duration').value = appointment.duracion;
        document.getElementById('therapist').value = appointment.terapeuta;
        document.getElementById('student').value = appointment.estudiante || 'estudiante1';
        document.getElementById('appointment-notes').value = appointment.notas || '';
        document.getElementById('is-web').checked = appointment.web || false;
        
        editingAppointmentId = appointment.id;
        deleteBtn.style.display = 'block';
    } else {
        // Nueva cita
        modalTitle.textContent = 'Agregar Nueva Cita';
        appointmentForm.reset();
        
        // Obtener la fecha correspondiente al d√≠a seleccionado
        const startOfWeek = getStartOfWeek(currentWeekDate);
        const appointmentDay = day ? day - 1 : 0; // Convertir de 1-basado a 0-basado
        const appointmentDate = new Date(startOfWeek);
        appointmentDate.setDate(startOfWeek.getDate() + appointmentDay);
        
        // Pre-llenar con la fecha del d√≠a seleccionado
        dateInput.value = formatDate(appointmentDate);
        
        // Pre-llenar hora si se proporciona
        if (hour) {
            timeInput.value = `${hour.toString().padStart(2, '0')}:00`;
        }
        
        editingAppointmentId = null;
        deleteBtn.style.display = 'none';
        
        // Inicialmente ocultar detalles de recurrencia
        isRecurringCheckbox.checked = false;
        recurringDetails.style.display = 'none';
        
        // Actualizar visibilidad de opciones de recurrencia seg√∫n tipo de cita seleccionado
        handleAppointmentTypeChange();
    }
    
    appointmentModal.style.display = 'block';
}
    
    // Cerrar modal de citas
    function closeAppointmentModal() {
        appointmentModal.style.display = 'none';
        appointmentForm.reset();
        editingAppointmentId = null;
    }
    function saveAppointment() {
    showSpinner();
    
    const patientName = document.getElementById('patient-name').value;
    const appointmentTypeSelect = document.getElementById('appointment-type');
    const appointmentType = appointmentTypeSelect.options[appointmentTypeSelect.selectedIndex].text;
    const appointmentTypeClass = appointmentTypeSelect.value;
    const appointmentDate = document.getElementById('appointment-date').value;
    const appointmentTime = document.getElementById('appointment-time').value;
    const appointmentDuration = parseInt(document.getElementById('appointment-duration').value);
    const therapist = document.getElementById('therapist').value;
    const student = document.getElementById('student').value;
    const notes = document.getElementById('appointment-notes').value;
    const isWeb = document.getElementById('is-web').checked;
    
    // Datos de recurrencia
    const isRecurring = document.getElementById('is-recurring').checked;
    let recurrencePattern = null;
    let recurrenceEndDate = null;
    let selectedWeekdays = [];
    
    if (isRecurring) {
        // Obtener d√≠as de la semana seleccionados
        document.querySelectorAll('input[name="weekday"]:checked').forEach(checkbox => {
            selectedWeekdays.push(parseInt(checkbox.value));
        });
        
        // Fecha de fin de recurrencia
        recurrenceEndDate = document.getElementById('recurrence-end').value;
        if (!recurrenceEndDate) {
            hideSpinner();
            showStatusMessage('Por favor selecciona una fecha de fin para la recurrencia', 'warning');
            return;
        }
        
        if (selectedWeekdays.length === 0) {
            hideSpinner();
            showStatusMessage('Por favor selecciona al menos un d√≠a de la semana', 'warning');
            return;
        }
        
        recurrencePattern = {
            diasSemana: selectedWeekdays,
            fechaFin: recurrenceEndDate
        };
    }
    
    // Crear objeto de fecha
    const [year, month, day] = appointmentDate.split('-');
    const [hours, minutes] = appointmentTime.split(':');
    const date = new Date(year, month - 1, day, hours, minutes);
    
    // Verificar si es feriado
    const dateStr = formatDate(date);
    if (holidays.some(h => h.date === dateStr)) {
        hideSpinner();
        showStatusMessage('No se pueden agendar citas en d√≠as feriados.', 'warning');
        return;
    }
    
    // Verificar l√≠mite de citas simult√°neas
    if (!editingAppointmentId) { // Solo verificar para nuevas citas
        const dayOfWeek = date.getDay(); // 0 para domingo, 1 para lunes, etc.
        if (dayOfWeek > 0 && dayOfWeek < 5) { // Solo lunes a jueves
            const hourAppointments = appointments.filter(a => {
                const appDate = a.fecha;
                return appDate.getDay() === dayOfWeek &&
                       appDate.getHours() === date.getHours() &&
                       a.estudiante === student;
            });
            
            if (hourAppointments.length >= 2) {
                hideSpinner();
                showStatusMessage('Este estudiante ya tiene 2 citas en este horario.', 'warning');
                return;
            }
        }
    }
    
    // Datos base de la cita
    const baseAppointmentData = {
        paciente: patientName,
        tipo: appointmentType,
        tipoClase: appointmentTypeClass,
        duracion: appointmentDuration,
        terapeuta: therapist,
        estudiante: student,
        notas: notes,
        web: isWeb,
        esRecurrente: isRecurring,
        // Historial mejorado
        historial: firebase.firestore.FieldValue.arrayUnion({
            accion: editingAppointmentId ? 'modificacion' : 'creacion',
            usuario: currentUser.email,
            usuarioId: currentUser.uid,
            fecha: firebase.firestore.FieldValue.serverTimestamp()
        }),
        ultimaEdicion: {
            usuario: currentUser.email,
            usuarioId: currentUser.uid,
            fecha: firebase.firestore.FieldValue.serverTimestamp()
        }
    };
    
    // Generar un ID √∫nico para la serie recurrente si es necesario
    const serieRecurrenteId = isRecurring ? (editingAppointmentId || `serie_${Date.now()}`) : null;
    
    if (isRecurring && recurrencePattern) {
        // Para citas recurrentes, crear m√∫ltiples citas
        const endDate = new Date(recurrencePattern.fechaFin);
        const weekdays = recurrencePattern.diasSemana;
        
        // Si estamos editando, primero eliminar todas las citas futuras de esta serie
        if (editingAppointmentId) {
            deleteRecurringAppointments(editingAppointmentId, date);
        }
        
        // Array para almacenar todas las promesas de creaci√≥n de citas
        const appointmentPromises = [];
        
        // Crear citas para cada d√≠a seleccionado hasta la fecha de fin
        const currentDate = new Date(date);
        while (currentDate <= endDate) {
            const currentDay = currentDate.getDay(); // 0 = domingo, 1 = lunes, ...
            
            // Si el d√≠a actual est√° en los d√≠as seleccionados, crear una cita
            if (weekdays.includes(currentDay)) {
                const appointmentData = {
                    ...baseAppointmentData,
                    fecha: firebase.firestore.Timestamp.fromDate(new Date(currentDate)),
                    esRecurrente: true,
                    serieRecurrenteId: serieRecurrenteId,
                    patronRecurrencia: {
                        diasSemana: weekdays,
                        fechaFin: firebase.firestore.Timestamp.fromDate(endDate)
                    }
                };
                
                // Crear nueva cita
                const promise = db.collection('citas').add(appointmentData);
                appointmentPromises.push(promise);
            }
            
            // Avanzar al siguiente d√≠a
            currentDate.setDate(currentDate.getDate() + 1);
        }
        
        // Esperar a que todas las citas sean creadas
        Promise.all(appointmentPromises)
            .then(() => {
                closeAppointmentModal();
                showStatusMessage('Citas recurrentes creadas correctamente', 'success');
                loadAppointments();
            })
            .catch((error) => {
                console.error("Error al crear citas recurrentes:", error);
                hideSpinner();
                showStatusMessage('Error al crear las citas recurrentes', 'error');
            });
    } else {
        // Para citas no recurrentes o edici√≥n de una cita individual
        const appointmentData = {
            ...baseAppointmentData,
            fecha: firebase.firestore.Timestamp.fromDate(date)
        };
        
        if (editingAppointmentId) {
            // Actualizar cita existente
            db.collection('citas').doc(editingAppointmentId).get()
                .then((doc) => {
                    const currentData = doc.data();
                    
                    // Si la cita era parte de una serie recurrente y se est√° modificando individualmente
                    if (currentData.esRecurrente && !isRecurring) {
                        // Eliminar vinculaci√≥n con la serie
                        appointmentData.esRecurrente = false;
                        appointmentData.serieRecurrenteId = null;
                        appointmentData.patronRecurrencia = null;
                    }
                    
                    // Actualizar la cita
                    return db.collection('citas').doc(editingAppointmentId).update(appointmentData);
                })
                .then(() => {
                    closeAppointmentModal();
                    showStatusMessage('Cita actualizada correctamente', 'success');
                    loadAppointments();
                })
                .catch((error) => {
                    console.error("Error al actualizar cita:", error);
                    hideSpinner();
                    showStatusMessage('Error al actualizar la cita', 'error');
                });
        } else {
            // Crear nueva cita
            db.collection('citas').add(appointmentData)
                .then(() => {
                    closeAppointmentModal();
                    showStatusMessage('Cita creada correctamente', 'success');
                    loadAppointments();
                })
                .catch((error) => {
                    console.error("Error al crear cita:", error);
                    hideSpinner();
                    showStatusMessage('Error al crear la cita', 'error');
                });
        }
    }
}
    
    // 2. Funci√≥n para eliminar cita (registra qui√©n la elimin√≥)
function deleteAppointment() {
    if (!editingAppointmentId) return;
    
    showSpinner();
    
    // Obtener informaci√≥n de la cita actual
    db.collection('citas').doc(editingAppointmentId).get()
        .then((doc) => {
            if (!doc.exists) {
                throw new Error("Cita no encontrada");
            }
            
            const appointmentData = doc.data();
            const isRecurring = appointmentData.esRecurrente;
            const recurrenceId = appointmentData.serieRecurrenteId;
            const appointmentDate = appointmentData.fecha.toDate();
            
            // Preguntar si desea eliminar solo esta cita o todas las futuras
            let deleteMode = 'single';
            if (isRecurring) {
                const userChoice = confirm(
                    'Esta es una cita recurrente. ¬øDeseas eliminar solo esta cita o todas las citas futuras de esta serie?\n\n' +
                    'Presiona "Aceptar" para eliminar todas las citas futuras.\n' +
                    'Presiona "Cancelar" para eliminar solo esta cita.'
                );
                
                deleteMode = userChoice ? 'future' : 'single';
            }
            
            // Registrar la eliminaci√≥n en el historial
            return db.collection('historial_citas').add({
                citaId: editingAppointmentId,
                accion: 'eliminacion',
                tipoEliminacion: deleteMode,
                usuario: currentUser.email,
                usuarioId: currentUser.uid,
                fecha: firebase.firestore.FieldValue.serverTimestamp(),
                datosCita: {
                    paciente: appointmentData.paciente,
                    tipo: appointmentData.tipo,
                    fecha: appointmentData.fecha
                }
            }).then(() => {
                // Eliminar seg√∫n el modo seleccionado
                if (deleteMode === 'future' && isRecurring) {
                    // Eliminar todas las citas futuras de la serie
                    return deleteRecurringAppointments(editingAppointmentId, appointmentDate)
                        .then(() => {
                            // Tambi√©n eliminar la cita actual si no est√° en el pasado
                            const today = new Date();
                            if (appointmentDate >= today) {
                                return db.collection('citas').doc(editingAppointmentId).delete();
                            }
                        });
                } else {
                    // Eliminar solo esta cita
                    return db.collection('citas').doc(editingAppointmentId).delete();
                }
            });
        })
        .then(() => {
            closeAppointmentModal();
            showStatusMessage('Cita(s) eliminada(s) correctamente', 'success');
            loadAppointments();
        })
        .catch((error) => {
            console.error("Error al eliminar cita:", error);
            hideSpinner();
            showStatusMessage('Error al eliminar la cita', 'error');
        });
}
    
    // Mover una cita (arrastrar y soltar)
    function moveAppointment(appointmentId, hour, therapist) {
        if (!isAdmin) return;
        
        const appointment = appointments.find(a => a.id === appointmentId);
        if (!appointment) return;
        
        showSpinner();
        
        // Conservar la fecha pero cambiar la hora y el terapeuta
        const newDate = new Date(appointment.fecha);
        newDate.setHours(hour, 0, 0, 0);
        
        // Actualizar en Firestore
        db.collection('citas').doc(appointmentId).update({
            fecha: firebase.firestore.Timestamp.fromDate(newDate),
            terapeuta: therapist
        })
        .then(() => {
            showStatusMessage('Cita movida correctamente', 'success');
            loadAppointments();
        })
        .catch((error) => {
            console.error("Error al mover cita:", error);
            hideSpinner();
            showStatusMessage('Error al mover la cita', 'error');
        });
    }

// Mover una cita a una fecha y hora espec√≠ficas
function moveAppointmentToDate(appointmentId, targetDate, hour) {
    if (!isAdmin) return;
    
    const appointment = appointments.find(a => a.id === appointmentId);
    if (!appointment) return;
    
    showSpinner();
    
    // Conservar minutos, pero cambiar fecha y hora
    const newDate = new Date(targetDate);
    newDate.setHours(hour, appointment.fecha.getMinutes(), 0, 0);
    
    // Si es una cita recurrente, preguntar qu√© hacer
    if (appointment.esRecurrente) {
        const userChoice = confirm(
            'Esta es una cita recurrente. ¬øC√≥mo deseas moverla?\n\n' +
            'Presiona "Aceptar" para mover solo esta cita.\n' +
            'Presiona "Cancelar" para cancelar la operaci√≥n.'
        );
        
        if (!userChoice) {
            hideSpinner();
            return; // Cancelar la operaci√≥n
        }
        
        // Si decide mover solo esta, desvinculamos de la serie
        db.collection('citas').doc(appointmentId).update({
            fecha: firebase.firestore.Timestamp.fromDate(newDate),
            esRecurrente: false,
            serieRecurrenteId: null,
            patronRecurrencia: null,
            historial: firebase.firestore.FieldValue.arrayUnion({
                accion: 'movimiento_desvinculacion',
                usuario: currentUser.email,
                usuarioId: currentUser.uid,
                fecha: firebase.firestore.FieldValue.serverTimestamp()
            })
        })
        .then(() => {
            showStatusMessage('Cita movida correctamente', 'success');
            loadAppointments();
        })
        .catch((error) => {
            console.error("Error al mover cita:", error);
            hideSpinner();
            showStatusMessage('Error al mover la cita', 'error');
        });
    } else {
        // Para citas normales, simplemente actualizar la fecha
        db.collection('citas').doc(appointmentId).update({
            fecha: firebase.firestore.Timestamp.fromDate(newDate),
            historial: firebase.firestore.FieldValue.arrayUnion({
                accion: 'movimiento',
                usuario: currentUser.email,
                usuarioId: currentUser.uid,
                fecha: firebase.firestore.FieldValue.serverTimestamp()
            })
        })
        .then(() => {
            showStatusMessage('Cita movida correctamente', 'success');
            loadAppointments();
        })
        .catch((error) => {
            console.error("Error al mover cita:", error);
            hideSpinner();
            showStatusMessage('Error al mover la cita', 'error');
        });
    }
}
        
    // Abrir modal de asistencia
    function openAttendanceModal(appointment) {
        if (!isAdmin) return;
        
        const patientEl = document.getElementById('attendance-patient');
        const dateEl = document.getElementById('attendance-date');
        const timeEl = document.getElementById('attendance-time');
        
        patientEl.textContent = appointment.paciente;
        
        const fecha = appointment.fecha;
        const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
        dateEl.textContent = fecha.toLocaleDateString('es-ES', options);
        
        const horaInicio = `${fecha.getHours().toString().padStart(2, '0')}:${fecha.getMinutes().toString().padStart(2, '0')}`;
        const fechaFin = new Date(fecha);
        fechaFin.setMinutes(fecha.getMinutes() + appointment.duracion);
        const horaFin = `${fechaFin.getHours().toString().padStart(2, '0')}:${fechaFin.getMinutes().toString().padStart(2, '0')}`;
        timeEl.textContent = `${horaInicio} - ${horaFin}`;
        
        // Resetear selecci√≥n de estado
        document.querySelectorAll('.attendance-btn').forEach(btn => {
            btn.classList.remove('selected');
        });
        
        // Seleccionar el estado actual si existe
        if (appointment.estado) {
            const currentStatusBtn = document.querySelector(`.attendance-btn[data-status="${appointment.estado}"]`);
            if (currentStatusBtn) {
                currentStatusBtn.classList.add('selected');
            }
        }
        
        // Notas de asistencia
        document.getElementById('attendance-notes').value = appointment.notasAsistencia || '';
        
        // Guardar referencia a la cita actual
        attendanceModal.dataset.appointmentId = appointment.id;
        
        // Mostrar modal
        attendanceModal.style.display = 'block';
    }
    
    // Cerrar modal de asistencia
    function closeAttendanceModal() {
        attendanceModal.style.display = 'none';
    }
    
    function saveAttendance() {
    const appointmentId = attendanceModal.dataset.appointmentId;
    const selectedBtn = document.querySelector('.attendance-btn.selected');
    
    if (!selectedBtn) {
        showStatusMessage('Por favor selecciona un estado de asistencia', 'warning');
        return;
    }
    
    const status = selectedBtn.dataset.status;
    const notes = document.getElementById('attendance-notes').value;
    
    showSpinner();
    
    // Actualizar en Firestore con historial mejorado
    db.collection('citas').doc(appointmentId).update({
        estado: status,
        notasAsistencia: notes,
        historialAsistencia: firebase.firestore.FieldValue.arrayUnion({
            estado: status,
            usuario: currentUser.email,
            usuarioId: currentUser.uid,
            fecha: firebase.firestore.FieldValue.serverTimestamp(),
            notas: notes
        }),
        ultimaActualizacion: {
            usuario: currentUser.email,
            usuarioId: currentUser.uid,
            fecha: firebase.firestore.FieldValue.serverTimestamp(),
            estado: status
        }
    })
    .then(() => {
        closeAttendanceModal();
        showStatusMessage('Asistencia registrada correctamente', 'success');
        loadAppointments();
    })
    .catch((error) => {
        console.error("Error al registrar asistencia:", error);
        hideSpinner();
        showStatusMessage('Error al registrar la asistencia', 'error');
    });
}
    
    // Mostrar/ocultar spinner de carga
    function showSpinner() {
        spinner.style.display = 'flex';
    }
    
    function hideSpinner() {
        spinner.style.display = 'none';
    }
    
    // Mostrar mensaje de estado
    function showStatusMessage(message, type = 'success') {
        statusMessage.textContent = message;
        statusMessage.className = 'status-message ' + type;
        statusMessage.style.display = 'block';
        
        // Ocultar despu√©s de 3 segundos
        setTimeout(() => {
            statusMessage.style.display = 'none';
        }, 3000);
    }
    </script>
</body>
</html>
