<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMAKINE - Agenda</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Paleta de colores base clara con acentos vibrantes */
            --background: #F5F7FA;
            --surface: #FFFFFF;
            --surface-hover: #F9FAFC;
            --border: #E2E8F0;
            --text-primary: #2D3748;
            --text-secondary: #718096;
            --accent-blue: #2D3FE0;
            --accent-teal: #00BFA5;
            --accent-coral: #FF6B6B;
            --accent-purple: #9B59B6;
            --shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            --shadow-elevated: 0 10px 25px rgba(0, 0, 0, 0.1);
            
            /* Tipos de cita */
            --eval-msk: #FFD3E0;
            --eval-deportiva: #C4F2E0;
            --sesion-msk: #FFEAA7;
            --sesion-deportiva: #BEE3F8;

            /* Colores por estudiante */
            .appointment.estudiante1 { background-color: #FFD3E0; }
            .appointment.estudiante2 { background-color: #C4F2E0; }
            .appointment.estudiante3 { background-color: #FFEAA7; }
            .appointment.estudiante4 { background-color: #BEE3F8; }
            .appointment.estudiante5 { background-color: #E9D8FD; }
            .appointment.estudiante6 { background-color: #FED7D7; }
            .appointment.estudiante7 { background-color: #C6F6D5; }
            .appointment.estudiante8 { background-color: #FEEBC8; }
            .appointment.estudiante9 { background-color: #B2F5EA; }
            .appointment.estudiante10 { background-color: #D6BCFA; }
            
            /* Estados */
            --success: #4CAF50;
            --warning: #FF9800;
            --error: #F44336;
            
            /* Animaciones */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.25s ease;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 14px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }
        
        .app-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-blue);
        }
        
        .week-navigation {
            display: flex;
            align-items: center;
            background: var(--surface);
            padding: 8px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        
        .week-navigation button {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 8px 12px;
            color: var(--accent-blue);
            transition: var(--transition-fast);
            border-radius: 4px;
        }
        
        .week-navigation button:hover {
            background-color: rgba(45, 63, 224, 0.1);
        }
        
        #current-week {
            margin: 0 12px;
            font-weight: 600;
            font-size: 16px;
        }
        
        #user-info {
            display: flex;
            align-items: center;
            background: var(--surface);
            padding: 8px 16px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        
        #user-name {
            font-weight: 500;
            margin-right: 16px;
        }
        
        /* Estructura de la agenda */
        .scheduler-container {
            background: var(--surface);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        .days-header, .dates-header {
            display: grid;
            grid-template-columns: 80px repeat(4, 1fr);
            text-align: center;
            background-color: var(--surface);
        }
        
        .days-header {
            border-bottom: 1px solid var(--border);
        }
        
        .day-header, .date-header {
            padding: 14px 10px;
            font-weight: 600;
        }
        
        .day-header {
            font-size: 16px;
            color: var(--text-primary);
        }
        
        .date-header {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .time-column-header {
            border-right: 1px solid var(--border);
        }
        
        .schedule-grid {
            display: grid;
            grid-template-columns: 80px repeat(4, 1fr);
            position: relative;
        }
        
        .time-cell {
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: var(--text-secondary);
            padding: 10px;
            font-weight: 500;
        }
        
        .schedule-cell {
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            padding: 6px;
            position: relative;
            min-height: 100px;
            transition: var(--transition-fast);
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-content: flex-start;
        }
        
        .schedule-cell:hover {
            background-color: var(--surface-hover);
        }
        
        .current-day {
            background-color: rgba(45, 63, 224, 0.05);
        }
        
        /* Diseño de las citas */
        .appointment {
            position: relative;
            border-radius: 6px;
            padding: 8px 10px;
            font-size: 13px;
            overflow: hidden;
            transition: var(--transition-fast);
            box-shadow: var(--shadow);
            flex: 0 0 calc(50% - 3px); /* Dos citas por fila */
            max-width: calc(50% - 3px);
            cursor: pointer;
            height: auto;
        }
        
        .appointment:hover {
            box-shadow: var(--shadow-elevated);
            transform: translateY(-2px);
        }
        
        .appointment.evaluacion-msk { 
            background-color: var(--eval-msk); 
        }
        
        .appointment.evaluacion-deportiva { 
            background-color: var(--eval-deportiva); 
        }
        
        .appointment.sesion-msk { 
            background-color: var(--sesion-msk); 
        }
        
        .appointment.sesion-deportiva { 
            background-color: var(--sesion-deportiva); 
        }
        
        .appointment.recurring {
            border-left: 3px solid var(--success);
        }
        
        .appointment-title {
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .appointment-type {
            font-size: 11px;
            opacity: 0.8;
            margin-bottom: 3px;
        }
        
        .appointment-therapist {
            font-size: 11px;
            font-weight: 500;
            margin-top: 4px;
        }
        
        .student-badge {
            position: absolute;
            right: 6px;
            top: 6px;
            font-size: 10px;
            font-weight: 600;
            color: var(--accent-blue);
            background: rgba(45, 63, 224, 0.1);
            padding: 2px 4px;
            border-radius: 4px;
        }
        
        .appointment-status {
            position: absolute;
            right: 8px;
            bottom: 8px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .appointment-status.attended {
            background-color: var(--success);
        }
        
        .appointment-status.missed {
            background-color: var(--error);
        }
        
        .appointment-status.rescheduled {
            background-color: var(--warning);
        }
        
        .web-indicator {
            position: absolute;
            left: 8px;
            bottom: 6px;
            font-size: 10px;
            color: var(--accent-teal);
        }
        
        /* Estadísticas */
        .stats-panel {
            background-color: var(--surface);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .stats-title {
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-box {
            background-color: var(--surface-hover);
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-blue);
        }
        
        .therapist-stats-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
        }
        
        .charts-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 200px;
            margin: 30px 0;
        }
        
        .chart-bar {
            width: 80px;
            background-color: var(--accent-blue);
            margin: 0 30px;
            border-radius: 8px 8px 0 0;
            position: relative;
            transition: var(--transition-normal);
        }
        
        .chart-bar:nth-child(2) {
            background-color: var(--accent-teal);
        }
        
        .chart-bar:nth-child(3) {
            background-color: var(--accent-coral);
        }
        
        .chart-value {
            position: absolute;
            top: -30px;
            width: 100%;
            text-align: center;
            font-weight: 700;
            font-size: 18px;
            color: var(--text-primary);
        }
        
        .chart-labels {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        
        .chart-label {
            width: 140px;
            text-align: center;
            font-size: 15px;
            font-weight: 500;
        }
        
        /* Modales */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
            overflow-y: auto; /* Permitir scroll */
        }
        
        .modal-content {
            background-color: var(--surface);
            width: 90%;
            max-width: 550px;
            margin: 40px auto;
            border-radius: 12px;
            box-shadow: var(--shadow-elevated);
            overflow: hidden;
            animation: modalFadeIn 0.3s ease;
            position: relative;
            max-height: 90vh; /* Altura máxima */
            display: flex;
            flex-direction: column;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            padding: 20px;
            background-color: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 20px;
            color: var(--accent-blue);
        }
        
        .close {
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: var(--transition-fast);
        }
        
        .close:hover {
            color: var(--accent-coral);
        }
        
        form {
            padding: 20px;
            overflow-y: auto; /* Permitir scroll en el formulario */
            flex: 1;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group input[type="time"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            transition: var(--transition-fast);
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(45, 63, 224, 0.1);
        }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
        }
        
        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .weekday-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 8px;
        }
        
        .weekday-selector label {
            display: flex;
            align-items: center;
            font-weight: normal;
            margin-right: 12px;
            cursor: pointer;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 30px;
            position: sticky;
            bottom: 0;
            background-color: var(--surface);
            padding: 10px 0;
            border-top: 1px solid var(--border);
        }
        
        .button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition-fast);
        }
        
        .save-btn {
            background-color: var(--accent-blue);
            color: white;
        }
        
        .save-btn:hover {
            background-color: #2235C0;
        }
        
        .cancel-btn {
            background-color: #E2E8F0;
            color: var(--text-primary);
        }
        
        .cancel-btn:hover {
            background-color: #CBD5E0;
        }
        
        .delete-btn {
            background-color: var(--error);
            color: white;
        }
        
        .delete-btn:hover {
            background-color: #D32F2F;
        }
        
        /* Modal de asistencia */
        .modal-body {
            padding: 20px;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            text-align: right;
            position: sticky;
            bottom: 0;
            background-color: var(--surface);
        }
        
        .attendance-options {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            gap: 10px;
        }
        
        .attendance-btn {
            padding: 12px;
            border: 1px solid var(--border);
            background-color: var(--surface);
            border-radius: 6px;
            cursor: pointer;
            flex: 1;
            text-align: center;
            transition: var(--transition-fast);
            font-weight: 500;
        }
        
        .attendance-btn[data-status="attended"] {
            border-color: var(--success);
            color: var(--success);
        }
        
        .attendance-btn[data-status="attended"].selected {
            background-color: var(--success);
            color: white;
        }
        
        .attendance-btn[data-status="missed"] {
            border-color: var(--error);
            color: var(--error);
        }
        
        .attendance-btn[data-status="missed"].selected {
            background-color: var(--error);
            color: white;
        }
        
        .attendance-btn[data-status="rescheduled"] {
            border-color: var(--warning);
            color: var(--warning);
        }
        
        .attendance-btn[data-status="rescheduled"].selected {
            background-color: var(--warning);
            color: white;
        }
        
        /* Arrastrar y soltar */
        .schedule-cell.drag-over {
            background-color: rgba(45, 63, 224, 0.1);
        }
        
        /* Spinner de carga */
        .spinner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }
        
        .spinner-content {
            width: 40px;
            height: 40px;
            border: 3px solid #E2E8F0;
            border-top: 3px solid var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Mensajes de estado */
        .status-message {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: var(--shadow-elevated);
            display: none;
            z-index: 1500;
            font-weight: 500;
            animation: fadeIn 0.3s ease;
        }
        
        .status-message.success {
            background-color: var(--success);
            color: white;
        }
        
        .status-message.error {
            background-color: var(--error);
            color: white;
        }
        
        .status-message.warning {
            background-color: var(--warning);
            color: white;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Login */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background-color: var(--surface);
            border-radius: 12px;
            box-shadow: var(--shadow-elevated);
        }
        
        .login-title {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
            color: var(--accent-blue);
        }
        
        /* Responsive */
        @media (max-width: 900px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
            
            .week-navigation, #user-info {
                width: 100%;
            }
            
            .days-header, .dates-header, .schedule-grid {
                grid-template-columns: 60px repeat(4, 1fr);
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-container {
                flex-direction: column;
                height: auto;
                align-items: center;
            }
            
            .chart-bar {
                width: 100%;
                height: 40px !important;
                margin: 10px 0;
                border-radius: 0 5px 5px 0;
            }
            
            .chart-value {
                top: 10px;
                right: -25px;
                left: auto;
            }
            
            .chart-labels {
                flex-direction: column;
            }
            
            .appointment {
                flex: 0 0 100%;
                max-width: 100%;
            }
            
            .modal-content {
                width: 95%;
                margin: 20px auto;
                max-height: 85vh;
            }
        }
        
        @media (min-width: 901px) and (max-width: 1200px) {
            .appointment {
                flex: 0 0 calc(50% - 3px);
                max-width: calc(50% - 3px);
            }
        }
        
        @media (min-width: 1201px) {
            .appointment {
                flex: 0 0 calc(33.333% - 4px);
                max-width: calc(33.333% - 4px);
            }
        }

        /* Panel de administración de estudiantes */
.admin-panel {
    background-color: var(--surface);
    border-radius: 12px;
    box-shadow: var(--shadow);
    padding: 20px;
    margin-bottom: 30px;
}

.admin-title {
    margin-bottom: 20px;
    font-size: 20px;
    font-weight: 600;
    color: var(--text-primary);
}

.student-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
}

.student-item {
    background-color: var(--surface-hover);
    padding: 15px;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.student-code {
    font-weight: 600;
    color: var(--text-primary);
}

.student-name {
    padding: 8px;
    border: 1px solid var(--border);
    border-radius: 6px;
}

.save-student-btn {
    background-color: var(--accent-blue);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    margin-top: 5px;
}

.save-student-btn:hover {
    background-color: #2235C0;
}

/* Estilos para días feriados */
.holiday-cell {
    background-color: rgba(255, 107, 107, 0.1);
    position: relative;
}

.holiday-cell::after {
    content: "Feriado";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: var(--error);
    font-size: 14px;
    font-weight: 600;
    opacity: 0.7;
}
    </style>
</head>
<body>
    <!-- Spinner de carga -->
    <div class="spinner" id="spinner">
        <div class="spinner-content"></div>
    </div>
    
    <!-- Mensaje de estado -->
    <div class="status-message" id="status-message"></div>
    
    <!-- Contenedor de login (se muestra solo si el usuario no está autenticado) -->
    <div class="login-container" id="login-container" style="display: none;">
        <h2 class="login-title">SISTEMAKINE - Agenda</h2>
        <form id="login-form">
            <div class="form-group">
                <label for="email">Correo electrónico:</label>
                <input type="email" id="email" required>
            </div>
            <div class="form-group">
                <label for="password">Contraseña:</label>
                <input type="password" id="password" required>
            </div>
            <div class="form-actions">
                <button type="submit" class="button save-btn">Iniciar sesión</button>
            </div>
            <p style="margin-top: 20px; text-align: center; color: var(--text-secondary);">
                <small>Si eres estudiante, solicita las credenciales a tu profesor.</small>
            </p>
        </form>
    </div>
    
    <!-- Contenedor principal (se muestra solo si el usuario está autenticado) -->
    <div class="container" id="main-container" style="display: none;">
        <header>
            <h1 class="app-title">SISTEMAKINE</h1>
            <div class="week-navigation">
                <button id="prev-week">◀</button>
                <h2 id="current-week">Semana del 17 al 20 de marzo de 2025</h2>
                <button id="next-week">▶</button>
            </div>
            <div id="user-info">
                <span id="user-name"></span>
                <button id="logout-btn" class="button cancel-btn" style="padding: 6px 12px; font-size: 13px;">Cerrar sesión</button>
            </div>
        </header>
        
        <!-- Panel de Administración de Estudiantes -->
        <div class="admin-panel">
            <h3 class="admin-title">Administración de Estudiantes</h3>
            <div class="student-list" id="student-list">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>

        <div class="scheduler-container">
            <!-- Encabezado de la semana con días -->
            <div class="days-header">
                <div class="time-column-header"></div>
                <div class="day-header" id="day-header-1">Lunes</div>
                <div class="day-header" id="day-header-2">Martes</div>
                <div class="day-header" id="day-header-3">Miércoles</div>
                <div class="day-header" id="day-header-4">Jueves</div>
            </div>

            <!-- Encabezado con fechas -->
            <div class="dates-header">
                <div class="time-column-header"></div>
                <div class="date-header" id="date-header-1">17/3</div>
                <div class="date-header" id="date-header-2">18/3</div>
                <div class="date-header" id="date-header-3">19/3</div>
                <div class="date-header" id="date-header-4">20/3</div>
            </div>

            <!-- Cuadrícula de la agenda -->
            <div class="schedule-grid">
                <!-- Horas -->
                <div class="time-cell">09:00</div>
                <div class="schedule-cell" data-hour="9" data-day="1"></div>
                <div class="schedule-cell" data-hour="9" data-day="2"></div>
                <div class="schedule-cell" data-hour="9" data-day="3"></div>
                <div class="schedule-cell" data-hour="9" data-day="4"></div>
                
                <div class="time-cell">10:00</div>
                <div class="schedule-cell" data-hour="10" data-day="1"></div>
                <div class="schedule-cell" data-hour="10" data-day="2"></div>
                <div class="schedule-cell" data-hour="10" data-day="3"></div>
                <div class="schedule-cell" data-hour="10" data-day="4"></div>
                
                <div class="time-cell">11:00</div>
                <div class="schedule-cell" data-hour="11" data-day="1"></div>
                <div class="schedule-cell" data-hour="11" data-day="2"></div>
                <div class="schedule-cell" data-hour="11" data-day="3"></div>
                <div class="schedule-cell" data-hour="11" data-day="4"></div>
                
                <div class="time-cell">12:00</div>
                <div class="schedule-cell" data-hour="12" data-day="1"></div>
                <div class="schedule-cell" data-hour="12" data-day="2"></div>
                <div class="schedule-cell" data-hour="12" data-day="3"></div>
                <div class="schedule-cell" data-hour="12" data-day="4"></div>
                
                <div class="time-cell">13:00</div>
                <div class="schedule-cell" data-hour="13" data-day="1"></div>
                <div class="schedule-cell" data-hour="13" data-day="2"></div>
                <div class="schedule-cell" data-hour="13" data-day="3"></div>
                <div class="schedule-cell" data-hour="13" data-day="4"></div>
                
                <div class="time-cell">14:00</div>
                <div class="schedule-cell" data-hour="14" data-day="1"></div>
                <div class="schedule-cell" data-hour="14" data-day="2"></div>
                <div class="schedule-cell" data-hour="14" data-day="3"></div>
                <div class="schedule-cell" data-hour="14" data-day="4"></div>
                
                <div class="time-cell">15:00</div>
                <div class="schedule-cell" data-hour="15" data-day="1"></div>
                <div class="schedule-cell" data-hour="15" data-day="2"></div>
                <div class="schedule-cell" data-hour="15" data-day="3"></div>
                <div class="schedule-cell" data-hour="15" data-day="4"></div>
                
                <div class="time-cell">16:00</div>
                <div class="schedule-cell" data-hour="16" data-day="1"></div>
                <div class="schedule-cell" data-hour="16" data-day="2"></div>
                <div class="schedule-cell" data-hour="16" data-day="3"></div>
                <div class="schedule-cell" data-hour="16" data-day="4"></div>
            </div>
        </div>
        
        <div class="stats-panel">
            <h3 class="stats-title">Estadísticas</h3>
            
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">Asistencia semanal</div>
                    <div class="stat-value" id="attendance-rate">85%</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Citas totales</div>
                    <div class="stat-value" id="total-appointments">32</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Hora más ocupada</div>
                    <div class="stat-value" id="busiest-hour">10:00</div>
                </div>
            </div>
            
            <h4 class="therapist-stats-title">Pacientes por estudiante</h4>
            
            <div class="charts-container" id="student-chart">
                <!-- Se llenará dinámicamente -->
            </div>
            
            <div class="chart-labels" id="student-chart-labels">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>
    </div>
    
    <!-- Modal para agregar/editar citas -->
    <div class="modal" id="appointment-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Agregar Nueva Cita</h3>
                <span class="close">&times;</span>
            </div>
            <form id="appointment-form">
                <div class="form-group">
                    <label for="patient-name">Paciente:</label>
                    <input type="text" id="patient-name" required>
                </div>
                <div class="form-group">
                    <label for="appointment-type">Tipo de consulta:</label>
                    <select id="appointment-type" required onchange="handleAppointmentTypeChange()">
                        <option value="evaluacion-msk">Evaluación kinesiología MSK</option>
                        <option value="evaluacion-deportiva">Evaluación kinesiología deportiva</option>
                        <option value="sesion-msk">Sesión kinesiología MSK</option>
                        <option value="sesion-deportiva">Sesión kinesiología deportiva</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="student">Estudiante asignado:</label>
                    <select id="student" required>
                        <option value="estudiante1">Estudiante 1</option>
                        <option value="estudiante2">Estudiante 2</option>
                        <option value="estudiante3">Estudiante 3</option>
                        <option value="estudiante4">Estudiante 4</option>
                        <option value="estudiante5">Estudiante 5</option>
                        <option value="estudiante6">Estudiante 6</option>
                        <option value="estudiante7">Estudiante 7</option>
                        <option value="estudiante8">Estudiante 8</option>
                        <option value="estudiante9">Estudiante 9</option>
                        <option value="estudiante10">Estudiante 10</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="appointment-date">Fecha:</label>
                    <input type="date" id="appointment-date" required>
                </div>
                <div class="form-group">
                    <label for="appointment-time">Hora inicio:</label>
                    <input type="time" id="appointment-time" required>
                </div>
                <div class="form-group">
                    <label for="appointment-duration">Duración:</label>
                    <select id="appointment-duration" required>
                        <option value="60">1 hora</option>
                        <option value="120">2 horas</option>
                        <option value="30">30 minutos</option>
                        <option value="90">1 hora 30 minutos</option>
                    </select>
                </div>

                <!-- Sección para citas recurrentes -->
                <div id="recurrence-options" style="display: none;">
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="is-recurring">
                            <label for="is-recurring">Cita recurrente</label>
                        </div>
                    </div>
                    <div id="recurring-details" style="display: none; padding-left: 20px; margin-top: 10px;">
                        <div class="form-group">
                            <label>Días de la semana:</label>
                            <div class="weekday-selector">
                                <label><input type="checkbox" name="weekday" value="1"> Lunes</label>
                                <label><input type="checkbox" name="weekday" value="2"> Martes</label>
                                <label><input type="checkbox" name="weekday" value="3"> Miércoles</label>
                                <label><input type="checkbox" name="weekday" value="4"> Jueves</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="recurrence-end">Fecha fin:</label>
                            <input type="date" id="recurrence-end">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="appointment-notes">Notas:</label>
                    <textarea id="appointment-notes"></textarea>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="is-web">
                        <label for="is-web">Vía web</label>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="button delete-btn" id="delete-appointment" style="display: none; margin-right: auto;">Eliminar</button>
                    <button type="button" class="button cancel-btn" id="cancel-appointment">Cancelar</button>
                    <button type="submit" class="button save-btn">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal para confirmar asistencia -->
    <div class="modal" id="attendance-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirmar Asistencia</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <p><strong>Paciente:</strong> <span id="attendance-patient"></span></p>
                <p><strong>Fecha:</strong> <span id="attendance-date"></span></p>
                <p><strong>Hora:</strong> <span id="attendance-time"></span></p>
                <div class="attendance-options">
                    <button class="attendance-btn" data-status="attended">Asistió</button>
                    <button class="attendance-btn" data-status="missed">No asistió</button>
                    <button class="attendance-btn" data-status="rescheduled">Reprogramada</button>
                </div>
                <div class="form-group">
                    <label for="attendance-notes">Notas:</label>
                    <textarea id="attendance-notes"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="button cancel-btn" id="cancel-attendance">Cancelar</button>
                <button class="button save-btn" id="save-attendance">Guardar</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>


    <script>
  // Configuración de Firebase - REEMPLAZA ESTOS VALORES CON LOS DE TU PROYECTO FIREBASE
const firebaseConfig = {
    apiKey: "AIzaSyA8fY-L1r3nBq61CFPOAFRI6TlS9A5GNTA",
    authDomain: "agendapoli-13963.firebaseapp.com",
    projectId: "agendapoli-13963",
    storageBucket: "agendapoli-13963.firebasestorage.app",
    messagingSenderId: "265927768586",
    appId: "1:265927768586:web:c7e37e6a561bd996687df3"
};

// Inicializar Firebase (con manejo de errores)
try {
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
        console.log("[DEBUG] Firebase inicializado correctamente");
    } else {
        console.log("[DEBUG] Firebase ya estaba inicializado");
    }
} catch (error) {
    console.error("[DEBUG] Error al inicializar Firebase:", error);
    alert("Error al inicializar Firebase. Por favor revisa la consola para detalles.");
}

// Referencias a Firebase
let auth, db;
try {
    auth = firebase.auth();
    db = firebase.firestore();
    console.log("[DEBUG] Referencias a auth y db creadas");
} catch (error) {
    console.error("[DEBUG] Error al crear referencias:", error);
    alert("Error al conectar con Firebase. Verifica tu conexión a internet.");
}

// Variables globales
let currentUser = null;
let isAdmin = false;
let appointments = [];
let editingAppointmentId = null;
let holidays = [];
let currentWeekDate = new Date();
let studentNames = {}; // Para guardar los nombres reales de los estudiantes
let uniquePatientsByStudent = {}; // Para estadísticas

// Elementos DOM
const spinner = document.getElementById('spinner');
const statusMessage = document.getElementById('status-message');
const loginContainer = document.getElementById('login-container');
const mainContainer = document.getElementById('main-container');
const appointmentModal = document.getElementById('appointment-modal');
const appointmentForm = document.getElementById('appointment-form');
const attendanceModal = document.getElementById('attendance-modal');
const currentWeekDisplay = document.getElementById('current-week');
const loginForm = document.getElementById('login-form');
const userNameDisplay = document.getElementById('user-name');
const logoutBtn = document.getElementById('logout-btn');

// Inicializar la aplicación
document.addEventListener('DOMContentLoaded', function() {
    // Mostrar spinner mientras carga
    showSpinner();
    
    // Verificar estado de autenticación
    auth.onAuthStateChanged(function(user) {
        console.log("[DEBUG] Estado de autenticación cambiado");
        
        if (user) {
            // Usuario autenticado
            currentUser = user;
            console.log("[DEBUG] Usuario autenticado:", user.email);
            console.log("[DEBUG] UID del usuario:", user.uid);
            userNameDisplay.textContent = user.email;
            
            // Esperar un momento antes de verificar el rol (para asegurar que Firebase esté listo)
            setTimeout(() => {
                checkUserRole(user.uid);
            }, 1000);
        } else {
            // Usuario no autenticado
            console.log("[DEBUG] No hay usuario autenticado");
            showLoginScreen();
            hideSpinner();
        }
    });
    
    // Configurar event listeners
    setupEventListeners();
    
    // Solución temporal: si después de 10 segundos sigue mostrando spinner, ocultarlo
    setTimeout(() => {
        if (spinner.style.display === 'flex') {
            hideSpinner();
            showStatusMessage('Carga completada', 'success');
        }
    }, 10000);
});

function checkUserRole(userId) {
    console.log("[DEBUG] Usuario autenticado:", userId);
    
    // Tratar a todos los usuarios como administradores
    isAdmin = true;
    document.body.classList.remove('student-view');
    
    try {
        // Obtener información del usuario para el historial
        db.collection('usuarios').doc(userId).get()
            .then((doc) => {
                if (doc.exists) {
                    // Guardar información del usuario para el historial
                    const userData = doc.data();
                    console.log("[DEBUG] Información del usuario:", userData);
                } else {
                    // Si no existe el documento del usuario, crearlo con timestamp
                    db.collection('usuarios').doc(userId).set({
                        email: currentUser.email,
                        ultimoAcceso: new Date().toISOString()
                    })
                    .then(() => {
                        console.log("[DEBUG] Documento de usuario creado");
                    })
                    .catch(error => {
                        console.error("[DEBUG] Error al crear documento de usuario:", error);
                        showStatusMessage("Error al guardar información de usuario", "error");
                    });
                }
                
                // Inicializar la agenda
                initializeApp();
            })
            .catch((error) => {
                console.error("[DEBUG] Error al obtener información del usuario:", error);
                showStatusMessage("Error al cargar datos de usuario", "error");
                
                // De todos modos inicializar la aplicación
                isAdmin = true;
                document.body.classList.remove('student-view');
                initializeApp();
            });
    } catch (error) {
        console.error("Error crítico al acceder a la base de datos:", error);
        showStatusMessage("Error de conexión con la base de datos", "error");
        
        // Fallback para permitir al usuario ver al menos algo
        isAdmin = true;
        document.body.classList.remove('student-view');
        initializeApp();
    }
}

// Inicializar la aplicación
function initializeApp() {
    loadHolidays();
    updateWeekDisplay();
    
    // Cargar nombres de estudiantes primero
    loadStudentNames()
        .then(() => {
            try {
                loadAppointments();
            } catch (error) {
                console.error("Error al cargar citas:", error);
                showStatusMessage("Error al cargar citas. Usando datos de ejemplo.", "warning");
                loadSampleAppointments();
            }
        });
    
    // Mostrar la interfaz principal
    loginContainer.style.display = 'none';
    mainContainer.style.display = 'block';
    
    hideSpinner();
}

// Cargar nombres de estudiantes
function loadStudentNames() {
    return new Promise((resolve) => {
        const defaultStudents = {
            'estudiante1': 'Estudiante 1',
            'estudiante2': 'Estudiante 2',
            'estudiante3': 'Estudiante 3',
            'estudiante4': 'Estudiante 4',
            'estudiante5': 'Estudiante 5',
            'estudiante6': 'Estudiante 6',
            'estudiante7': 'Estudiante 7',
            'estudiante8': 'Estudiante 8',
            'estudiante9': 'Estudiante 9',
            'estudiante10': 'Estudiante 10'
        };
        
        db.collection('configuracion').doc('estudiantes').get()
            .then((doc) => {
                if (doc.exists) {
                    studentNames = doc.data();
                    // Combinar con estudiantes por defecto (para asegurar que todos existan)
                    studentNames = {...defaultStudents, ...studentNames};
                } else {
                    // Si no existe el documento, usar los nombres por defecto
                    studentNames = defaultStudents;
                    // Y crear el documento
                    db.collection('configuracion').doc('estudiantes').set(studentNames);
                }
                
                // Generar la lista de estudiantes en el panel de administración
                generateStudentsList();
                resolve();
            })
            .catch((error) => {
                console.error("Error al cargar nombres de estudiantes:", error);
                studentNames = defaultStudents;
                generateStudentsList();
                resolve();
            });
    });
}

// Generar la lista de estudiantes en el panel de administración
function generateStudentsList() {
    const studentList = document.getElementById('student-list');
    if (!studentList) return;
    
    studentList.innerHTML = '';
    
    // Actualizar el selector de estudiantes en el formulario
    const studentSelect = document.getElementById('student');
    if (studentSelect) {
        studentSelect.innerHTML = '';
    }
    
    for (const code in studentNames) {
        // Añadir al panel de administración
        const item = document.createElement('div');
        item.className = 'student-item';
        item.dataset.code = code;
        
        item.innerHTML = `
            <div class="student-code">${code}</div>
            <input type="text" class="student-name" placeholder="Nombre real" value="${studentNames[code]}">
            <button class="save-student-btn">Guardar</button>
        `;
        
        studentList.appendChild(item);
        
        // Configurar el botón de guardar
        const saveBtn = item.querySelector('.save-student-btn');
        saveBtn.addEventListener('click', function() {
            const input = item.querySelector('.student-name');
            saveStudentName(code, input.value);
        });
        
        // Actualizar el selector de estudiantes
        if (studentSelect) {
            const option = document.createElement('option');
            option.value = code;
            option.textContent = studentNames[code];
            studentSelect.appendChild(option);
        }
    }
}

// Guardar nombre de estudiante
function saveStudentName(code, name) {
    if (!name || name.trim() === '') {
        showStatusMessage('Por favor ingresa un nombre válido', 'warning');
        return;
    }
    
    showSpinner();
    console.log(`Guardando nombre para ${code}: ${name}`);
    
    const updateData = {};
    updateData[code] = name;
    
    db.collection('configuracion').doc('estudiantes').update(updateData)
        .then(() => {
            const oldName = studentNames[code] || code;
            studentNames[code] = name; // Actualizar en memoria
            showStatusMessage(`Nombre de ${code} actualizado a "${name}"`, 'success');
            console.log(`Nombre actualizado en configuración: ${oldName} → ${name}`);
            
            // Primero actualizar las referencias visuales y luego recargar
            updateStudentReferences(code, name);
        })
        .catch((error) => {
            console.error("Error al guardar nombre de estudiante:", error);
            showStatusMessage("Error al guardar el nombre", "error");
            hideSpinner();
        });
}

// Actualizar referencias visuales del estudiante y en la base de datos
function updateStudentReferences(code, name) {
    showSpinner();
    
    console.log(`Actualizando estudiante: ${code} a nombre: ${name}`);
    
    // Actualizar las tarjetas de cita visualmente
    document.querySelectorAll(`.appointment`).forEach(el => {
        const badgeEl = el.querySelector('.student-badge');
        if (badgeEl && (badgeEl.textContent === code || badgeEl.textContent === studentNames[code])) {
            badgeEl.textContent = name;
        }
    });
    
    // Actualizar las opciones del formulario
    const option = document.querySelector(`#student option[value="${code}"]`);
    if (option) {
        option.textContent = name;
    }
    
    // Actualizar todas las citas en la base de datos que tienen este estudiante
    db.collection('citas').where('estudiante', '==', code).get()
        .then((querySnapshot) => {
            console.log(`Encontradas ${querySnapshot.size} citas para actualizar`);
            
            // Si hay citas para actualizar
            if (!querySnapshot.empty) {
                const batch = db.batch();
                querySnapshot.forEach((doc) => {
                    batch.update(doc.ref, { 
                        estudianteNombre: name,
                        historial: firebase.firestore.FieldValue.arrayUnion({
                            accion: 'actualizacion_nombre_estudiante',
                            usuario: currentUser ? currentUser.email : 'sistema',
                            usuarioId: currentUser ? currentUser.uid : 'sistema',
                            fecha: new Date(),
                            detalles: `Nombre cambiado de ${studentNames[code]} a ${name}`
                        })
                    });
                });
                
                // Ejecutar todas las actualizaciones en un lote
                batch.commit()
                    .then(() => {
                        showStatusMessage(`Se actualizaron ${querySnapshot.size} citas con el nuevo nombre de estudiante`, 'success');
                        loadAppointments(); // Recargar citas
                    })
                    .catch((error) => {
                        console.error("Error al actualizar citas:", error);
                        showStatusMessage("Error al actualizar citas", "error");
                        hideSpinner();
                    });
            } else {
                showStatusMessage(`No se encontraron citas para el estudiante ${code}`, 'info');
                loadAppointments(); // Recargar citas de todos modos
                hideSpinner();
            }
        })
        .catch((error) => {
            console.error("Error al buscar citas para actualizar:", error);
            showStatusMessage("Error al buscar citas para actualizar", "error");
            hideSpinner();
        });
}

// Mostrar pantalla de login
function showLoginScreen() {
    loginContainer.style.display = 'block';
    mainContainer.style.display = 'none';
}

// Cargar los feriados chilenos
function loadHolidays() {
    holidays = [
        { date: '2025-01-01', name: 'Año Nuevo' },
        { date: '2025-04-18', name: 'Viernes Santo' },
        { date: '2025-04-19', name: 'Sábado Santo' },
        { date: '2025-05-01', name: 'Día del Trabajo' },
        { date: '2025-05-21', name: 'Día de las Glorias Navales' },
        { date: '2025-06-29', name: 'San Pedro y San Pablo' },
        { date: '2025-07-16', name: 'Virgen del Carmen' },
        { date: '2025-08-15', name: 'Asunción de la Virgen' },
        { date: '2025-09-18', name: 'Independencia Nacional' },
        { date: '2025-09-19', name: 'Día de las Glorias del Ejército' },
        { date: '2025-10-12', name: 'Encuentro de Dos Mundos' },
        { date: '2025-10-31', name: 'Día de las Iglesias Evangélicas' },
        { date: '2025-11-01', name: 'Día de Todos los Santos' },
        { date: '2025-12-08', name: 'Inmaculada Concepción' },
        { date: '2025-12-25', name: 'Navidad' }
    ];
}

// Actualizar la visualización de la semana actual
function updateWeekDisplay() {
    const startOfWeek = getStartOfWeek(currentWeekDate);
    
    // Actualizar el texto principal de la semana
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 3); // Solo hasta jueves (4 días)
    
    const startDay = startOfWeek.getDate();
    const endDay = endOfWeek.getDate();
    const startMonthName = getMonthName(startOfWeek.getMonth());
    const endMonthName = getMonthName(endOfWeek.getMonth());
    const year = startOfWeek.getFullYear();
    
    currentWeekDisplay.textContent = `Semana del ${startDay} al ${endDay} de ${endMonthName} de ${year}`;
    
    // Marcar feriados y días actuales
    const holidayDates = holidays.map(h => h.date);
    
    // Actualizar los encabezados de días con las fechas correspondientes
    for (let i = 1; i <= 4; i++) {
        const dayDate = new Date(startOfWeek);
        dayDate.setDate(startOfWeek.getDate() + (i - 1));
        
        const dayHeader = document.getElementById(`day-header-${i}`);
        const dateHeader = document.getElementById(`date-header-${i}`);
        
        if (dayHeader && dateHeader) {
            const dayNames = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
            dayHeader.textContent = dayNames[dayDate.getDay()];
            dateHeader.textContent = `${dayDate.getDate()}/${dayDate.getMonth() + 1}`;
            
            // Verificar si es feriado
            const dateStr = formatDate(dayDate);
            const isHoliday = holidayDates.includes(dateStr);
            
            // Resaltar el día actual si está en la semana mostrada
            const today = new Date();
            const isToday = dayDate.toDateString() === today.toDateString();
            
            // Aplicar clases según el caso
            if (isHoliday) {
                dayHeader.style.color = 'var(--error)';
                dateHeader.style.color = 'var(--error)';
                document.querySelectorAll(`.schedule-cell[data-day="${i}"]`).forEach(cell => {
                    cell.classList.add('holiday-cell');
                    cell.title = "Feriado: " + holidays.find(h => h.date === dateStr).name;
                });
            } else {
                dayHeader.style.color = '';
                dateHeader.style.color = '';
                document.querySelectorAll(`.schedule-cell[data-day="${i}"]`).forEach(cell => {
                    cell.classList.remove('holiday-cell');
                    cell.title = "";
                });
            }
            
            if (isToday) {
                dayHeader.classList.add('current-day');
                dateHeader.classList.add('current-day');
                document.querySelectorAll(`.schedule-cell[data-day="${i}"]`).forEach(cell => {
                    cell.classList.add('current-day');
                });
            } else {
                dayHeader.classList.remove('current-day');
                dateHeader.classList.remove('current-day');
                document.querySelectorAll(`.schedule-cell[data-day="${i}"]`).forEach(cell => {
                    cell.classList.remove('current-day');
                });
            }
        }
    }
}

// Obtener el primer día de la semana (lunes)
function getStartOfWeek(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Ajusta cuando el día es domingo
    const monday = new Date(d.setDate(diff));
    monday.setHours(0, 0, 0, 0);
    return monday;
}

// Obtener nombre del mes en español
function getMonthName(month) {
    const months = [
        'enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 
        'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'
    ];
    return months[month];
}

// Cargar citas desde Firestore
function loadAppointments() {
    showSpinner();
    
    // Obtener fecha de inicio y fin de la semana
    const startOfWeek = getStartOfWeek(currentWeekDate);
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 4); // Un día después del jueves
    
    try {
        // Consulta a Firestore
        db.collection('citas').get()
            .then((querySnapshot) => {
                appointments = [];
                
                querySnapshot.forEach((doc) => {
                    try {
                        // Convertir datos a formato utilizable
                        const data = doc.data();
                        
                        // Convertir el campo fecha a un objeto Date
                        let appointmentDate;
                        if (data.fecha && data.fecha.toDate) {
                            appointmentDate = data.fecha.toDate();
                        } else if (data.fecha) {
                            appointmentDate = new Date(data.fecha);
                        } else {
                            // Si no hay fecha, saltarse esta cita
                            console.warn("Cita sin fecha encontrada, ID:", doc.id);
                            return;
                        }
                        
                        // Filtrar solo las citas de esta semana
                        if (appointmentDate >= startOfWeek && appointmentDate < endOfWeek) {
                            const appointment = {
                                id: doc.id,
                                ...data,
                                fecha: appointmentDate
                            };
                            
                            appointments.push(appointment);
                        }
                    } catch (error) {
                        console.error("Error procesando cita individual:", error);
                    }
                });
                
                // Renderizar citas y actualizar estadísticas
                renderAppointments();
                updateStatistics();
                hideSpinner();
            })
            .catch((error) => {
                console.error("Error al cargar citas:", error);
                showStatusMessage("Error al cargar citas. Cargando datos de ejemplo.", "warning");
                loadSampleAppointments(); // Cargar datos de ejemplo en caso de error
                hideSpinner();
            });
    } catch (error) {
        console.error("Error crítico al cargar citas:", error);
        showStatusMessage("Error de conexión. Cargando datos de ejemplo.", "error");
        loadSampleAppointments();
        hideSpinner();
    }
}

// Cargar citas de ejemplo (en caso de error o para la primera vez)
function loadSampleAppointments() {
    // Fecha de referencia (lunes de la semana actual)
    const startOfWeek = getStartOfWeek(currentWeekDate);
    
    appointments = [
        {
            id: '1',
            paciente: 'María González',
            tipo: 'Evaluación kinesiología MSK',
            tipoClase: 'evaluacion-msk',
            fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate(), 9, 0),
            duracion: 60,
            terapeuta: 'nicolas',
            estudiante: 'estudiante1'
        },
        {
            id: '2',
            paciente: 'Ana Martínez',
            tipo: 'Sesión kinesiología MSK',
            tipoClase: 'sesion-msk',
            fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate(), 11, 0),
            duracion: 60,
            terapeuta: 'ana-maria',
            estudiante: 'estudiante2'
        },
        {
            id: '3',
            paciente: 'Laura Pérez',
            tipo: 'Evaluación kinesiología deportiva',
            tipoClase: 'evaluacion-deportiva',
            fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate(), 13, 0),
            duracion: 60,
            terapeuta: 'nicolas',
            estudiante: 'estudiante3'
        },
        {
            id: '4',
            paciente: 'Isabel Rodríguez',
            tipo: 'Sesión kinesiología deportiva',
            tipoClase: 'sesion-deportiva',
            fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate() + 1, 10, 0),
            duracion: 60,
            terapeuta: 'ana-maria',
            estudiante: 'estudiante4',
            esRecurrente: true
        }
    ];
    
    renderAppointments();
    updateStatistics();
}

// Renderizar las citas en la cuadrícula
function renderAppointments() {
    try {
        // Limpiar citas existentes
        document.querySelectorAll('.appointment').forEach(el => el.remove());
        
        // Fecha de referencia (lunes de la semana actual)
        const startOfWeek = getStartOfWeek(currentWeekDate);
        
        // Renderizar cada cita de la semana actual
        appointments.forEach(appointment => {
            try {
                if (!appointment.fecha) {
                    console.error("Cita sin fecha:", appointment);
                    return;
                }
                
                const appointmentDate = appointment.fecha;
                const dayDiff = Math.floor((appointmentDate - startOfWeek) / (24 * 60 * 60 * 1000));
                
                // Solo mostrar citas de lunes a jueves (0-3)
                if (dayDiff >= 0 && dayDiff < 4) {
                    const hour = appointmentDate.getHours();
                    const dayIndex = dayDiff + 1; // 1 para lunes, 2 para martes, etc.
                    
                    // Encontrar la celda correcta
                    const cell = document.querySelector(`.schedule-cell[data-hour="${hour}"][data-day="${dayIndex}"]`);
                    
                    if (cell) {
                        // Crear elemento de cita
                        const appointmentEl = document.createElement('div');
                        appointmentEl.className = `appointment ${appointment.estudiante || 'estudiante1'}`;
                        appointmentEl.dataset.id = appointment.id;
                        
                        // Añadir clase si es recurrente
                        if (appointment.esRecurrente) {
                            appointmentEl.classList.add('recurring');
                        }
                        
                        // Determinar si mostrar el kinesiólogo (solo para sesiones)
                        const showTherapist = appointment.tipoClase && appointment.tipoClase.startsWith('sesion-');
                        
                        // Contenido de la cita con icono
                        let content = `
                            <div class="appointment-title">${appointment.paciente || 'Sin nombre'}</div>
                            <div class="appointment-type">${getAppointmentTypeIcon(appointment.tipoClase)} ${appointment.tipo || 'Sin tipo'}</div>
                        `;
                        
                        if (showTherapist) {
                            content += `<div class="appointment-therapist">${getTherapistName(appointment.terapeuta)}</div>`;
                        }
                        
                        // Estudiante asignado - mostrar nombre completo en lugar del código
                        const studentCode = appointment.estudiante || 'Sin asignar';
                        const studentName = studentNames[studentCode] || studentCode;
                        content += `<div class="student-badge">${studentName}</div>`;
                        
                        appointmentEl.innerHTML = content;
                        
                        // Indicador de estado si existe
                        if (appointment.estado) {
                            const statusEl = document.createElement('div');
                            statusEl.className = `appointment-status ${appointment.estado}`;
                            appointmentEl.appendChild(statusEl);
                        }
                        
                        // Indicador web si aplica
                        if (appointment.web) {
                            const webEl = document.createElement('div');
                            webEl.className = 'web-indicator';
                            webEl.innerHTML = '🌐';
                            appointmentEl.appendChild(webEl);
                        }
                        
                        // Agregar a la celda
                        cell.appendChild(appointmentEl);
                        
                        // Eventos para la cita
                        appointmentEl.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const app = appointments.find(a => a.id === this.dataset.id);
                            if (app) {
                                // Si la cita ya pasó, mostrar modal de asistencia
                                const today = new Date();
                                if (app.fecha < today) {
                                    if (isAdmin) {
                                        openAttendanceModal(app);
                                    } else {
                                        viewAppointmentDetails(app);
                                    }
                                } else {
                                    // Si es una cita futura
                                    if (isAdmin) {
                                        openAppointmentModal(app);
                                    } else {
                                        viewAppointmentDetails(app);
                                    }
                                }
                            }
                        });
                        
                        // Hacer que las citas sean arrastrables para administradores
                        if (isAdmin) {
                            appointmentEl.setAttribute('draggable', 'true');
                            appointmentEl.addEventListener('dragstart', function(e) {
                                e.dataTransfer.setData('text/plain', this.dataset.id);
                            });
                        }
                    }
                }
            } catch (error) {
                console.error("Error al renderizar cita individual:", error, appointment);
            }
        });
    } catch (error) {
        console.error("Error al renderizar citas:", error);
        showStatusMessage("Error al mostrar las citas", "error");
    }
}

// Mostrar detalles de la cita (para estudiantes)
function viewAppointmentDetails(appointment) {
    const options = { 
        weekday: 'long', 
        day: 'numeric', 
        month: 'long', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    };
    
    let details = `
        Paciente: ${appointment.paciente || 'Sin nombre'}
        Tipo: ${appointment.tipo || 'Sin especificar'}
        Fecha: ${appointment.fecha ? appointment.fecha.toLocaleDateString('es-ES', options) : 'Fecha no disponible'}
        Kinesiólogo: ${getTherapistName(appointment.terapeuta)}
        Estudiante: ${appointment.estudiante || 'Sin asignar'}
    `;
    
    if (appointment.estado) {
        details += `\nEstado: ${getStatusText(appointment.estado)}`;
    }
    
    alert(details);
}

// Obtener nombre completo del terapeuta
function getTherapistName(therapistId) {
    switch(therapistId) {
        case 'nicolas': return 'Nicolás';
        case 'ana-maria': return 'Ana María';
        case 'gustavo': return 'Gustavo';
        default: return therapistId || 'Sin asignar';
    }
}

// Obtener texto del estado
function getStatusText(status) {
    switch(status) {
        case 'attended': return 'Asistió';
        case 'missed': return 'No asistió';
        case 'rescheduled': return 'Reprogramada';
        default: return status;
    }
}

// Obtener icono según tipo de cita
function getAppointmentTypeIcon(typeClass) {
    switch(typeClass) {
        case 'evaluacion-msk': return '📋'; // Portapapeles para evaluación MSK
        case 'evaluacion-deportiva': return '📕'; // Persona corriendo para evaluación deportiva
        case 'sesion-msk': return '💪'; // Músculo para sesión MSK
        case 'sesion-deportiva': return '🏋️‍♀️'; // Trofeo para sesión deportiva
        default: return '📅'; // Calendario como icono por defecto
    }
}
        
// Actualizar estadísticas
// Actualizar estadísticas
function updateStatistics() {
    try {
        // Calcular asistencia semanal
        const totalPastAppointments = appointments.filter(a => {
            const now = new Date();
            return a.fecha && a.fecha < now;
        }).length;
        
        const attendedAppointments = appointments.filter(a => a.estado === 'attended').length;
        
        const attendanceRate = totalPastAppointments > 0 
            ? Math.round((attendedAppointments / totalPastAppointments) * 100) 
            : 0;
        
        // Citas por hora
        const appointmentsByHour = {};
        appointments.forEach(a => {
            if (a.fecha) {
                const hour = a.fecha.getHours();
                appointmentsByHour[hour] = (appointmentsByHour[hour] || 0) + 1;
            }
        });
        
        // Encontrar la hora más ocupada
        let busiestHour = 9; // Por defecto 9:00
        let maxAppointments = 0;
        
        for (const hour in appointmentsByHour) {
            if (appointmentsByHour[hour] > maxAppointments) {
                busiestHour = parseInt(hour);
                maxAppointments = appointmentsByHour[hour];
            }
        }
        
        // NUEVO: Calcular pacientes únicos por estudiante (NO sesiones)
        uniquePatientsByStudent = {};
        const patientsByStudent = {};
        
        appointments.forEach(a => {
            if (!a.estudiante || !a.paciente) return;
            
            // Inicializar arrays si no existen
            if (!patientsByStudent[a.estudiante]) {
                patientsByStudent[a.estudiante] = [];
            }
            
            // Añadir paciente si no está ya (para evitar duplicados)
            if (!patientsByStudent[a.estudiante].includes(a.paciente)) {
                patientsByStudent[a.estudiante].push(a.paciente);
            }
        });
        
        // Contar pacientes únicos
        for (const student in patientsByStudent) {
            uniquePatientsByStudent[student] = patientsByStudent[student].length;
        }
        
        // Actualizar DOM
        document.getElementById('attendance-rate').textContent = `${attendanceRate}%`;
        document.getElementById('total-appointments').textContent = appointments.length;
        document.getElementById('busiest-hour').textContent = `${busiestHour}:00`;
        
        // Actualizar gráfico de estudiantes
        const chartContainer = document.getElementById('student-chart');
        const chartLabels = document.getElementById('student-chart-labels');
        
        if (chartContainer && chartLabels) {
            chartContainer.innerHTML = '';
            chartLabels.innerHTML = '';
            
            // Obtener el valor máximo para escalar el gráfico
            const maxValue = Math.max(...Object.values(uniquePatientsByStudent), 1);
            
            // Ordenar para mostrar primero los que tienen más pacientes
            const sortedStudents = Object.keys(uniquePatientsByStudent).sort((a, b) => 
                uniquePatientsByStudent[b] - uniquePatientsByStudent[a]
            );
            
            sortedStudents.forEach(student => {
                const value = uniquePatientsByStudent[student];
                const height = Math.max((value / maxValue) * 100, 5); // Al menos 5% de altura
                
                // Crear barra
                const barEl = document.createElement('div');
                barEl.className = 'chart-bar';
                barEl.style.height = `${height}%`;
                
                // Número de pacientes
                const valueEl = document.createElement('div');
                valueEl.className = 'chart-value';
                valueEl.textContent = value;
                barEl.appendChild(valueEl);
                
                chartContainer.appendChild(barEl);
                
                // Crear etiqueta
                const labelEl = document.createElement('div');
                labelEl.className = 'chart-label';
                labelEl.textContent = studentNames[student] || student;
                chartLabels.appendChild(labelEl);
            });
        }
    } catch (error) {
        console.error("Error al actualizar estadísticas:", error);
    }
}

// Función para manejar cambios en el tipo de cita (mostrar opciones de recurrencia)
function handleAppointmentTypeChange() {
    try {
        const appointmentType = document.getElementById('appointment-type').value;
        const recurrenceOptions = document.getElementById('recurrence-options');
        
        // Solo mostrar opciones de recurrencia para sesiones, no para evaluaciones
        if (appointmentType && appointmentType.startsWith('sesion-')) {
            recurrenceOptions.style.display = 'block';
        } else {
            recurrenceOptions.style.display = 'none';
            document.getElementById('is-recurring').checked = false;
            document.getElementById('recurring-details').style.display = 'none';
        }
    } catch (error) {
        console.error("Error al cambiar tipo de cita:", error);
    }
}

// Configurar event listeners
function setupEventListeners() {
    try {
        // Login
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            showSpinner();
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Login exitoso
                    hideSpinner();
                    showStatusMessage('Sesión iniciada correctamente', 'success');
                })
                .catch((error) => {
                    console.error("Error de login:", error);
                    hideSpinner();
                    showStatusMessage("Error de inicio de sesión. Verifica tus credenciales.", "error");
                });
        });
        
        // Logout
        logoutBtn.addEventListener('click', function() {
            auth.signOut()
                .then(() => {
                    // Logout exitoso
                    showLoginScreen();
                    showStatusMessage('Sesión cerrada', 'success');
                })
                .catch((error) => {
                    console.error("Error al cerrar sesión:", error);
                    showStatusMessage("Error al cerrar sesión.", "error");
                });
        });
        
        // Navegación de semanas
        document.getElementById('prev-week').addEventListener('click', function() {
            navigateWeek(-1);
        });
        
        document.getElementById('next-week').addEventListener('click', function() {
            navigateWeek(1);
        });
        
        // Evento para mostrar/ocultar detalles de recurrencia
        const isRecurringCheckbox = document.getElementById('is-recurring');
        if (isRecurringCheckbox) {
            isRecurringCheckbox.addEventListener('change', function() {
                document.getElementById('recurring-details').style.display = this.checked ? 'block' : 'none';
            });
        }
        
        // Clic en celdas de la agenda (para agregar citas)
        document.querySelectorAll('.schedule-cell').forEach(cell => {
            cell.addEventListener('click', function() {
                if (isAdmin) {
                    const hour = parseInt(this.dataset.hour);
                    const day = parseInt(this.dataset.day);
                    
                    openAppointmentModal(null, hour, day);
                }
            });
            
            // Configuración para arrastrar y soltar
            if (isAdmin) {
                cell.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('drag-over');
                });
                
                cell.addEventListener('dragleave', function() {
                    this.classList.remove('drag-over');
                });
                
                cell.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');
                    
                    const appointmentId = e.dataTransfer.getData('text/plain');
                    const hour = parseInt(this.dataset.hour);
                    const day = parseInt(this.dataset.day);
                    
                    // Obtener fecha correspondiente a este día
                    const startOfWeek = getStartOfWeek(currentWeekDate);
                    const targetDate = new Date(startOfWeek);
                    targetDate.setDate(startOfWeek.getDate() + (day - 1));
                    
                    // Mover la cita a esta fecha y hora
                    moveAppointmentToDate(appointmentId, targetDate, hour);
                });
            }
        });
        
        // Formulario de citas
        appointmentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            if (isAdmin) {
                saveAppointment();
            }
        });
        
        document.getElementById('cancel-appointment').addEventListener('click', function() {
            closeAppointmentModal();
        });
        
        document.getElementById('delete-appointment').addEventListener('click', function() {
            if (isAdmin) {
                if (confirm('¿Estás seguro de que deseas eliminar esta cita?')) {
                    try {
                        deleteAppointment();
                    } catch (error) {
                        console.error("Error al eliminar cita:", error);
                        showStatusMessage("Error al eliminar la cita", "error");
                    }
                }
            }
        });
        
        // Cerrar modales con la X
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.addEventListener('click', function() {
                this.closest('.modal').style.display = 'none';
            });
        });
        
        // Eventos para asistencia
        document.querySelectorAll('.attendance-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.attendance-btn').forEach(b => {
                    b.classList.remove('selected');
                });
                this.classList.add('selected');
            });
        });
        
        document.getElementById('save-attendance').addEventListener('click', function() {
            if (isAdmin) {
                try {
                    saveAttendance();
                } catch (error) {
                    console.error("Error al guardar asistencia:", error);
                    showStatusMessage("Error al guardar asistencia", "error");
                }
            }
        });
        
        document.getElementById('cancel-attendance').addEventListener('click', function() {
            closeAttendanceModal();
        });
        
        // Evitar que el modal se cierre si se hace clic en él
        document.querySelectorAll('.modal-content').forEach(content => {
            content.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        });
        
        // Cerrar el modal si se hace clic fuera de él
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function() {
                this.style.display = 'none';
            });
        });
    } catch (error) {
        console.error("Error al configurar eventos:", error);
        showStatusMessage("Error al inicializar la interfaz", "error");
    }
}

// Navegar entre semanas
function navigateWeek(direction) {
    currentWeekDate.setDate(currentWeekDate.getDate() + (direction * 7));
    updateWeekDisplay();
    loadAppointments();
}

// Formatear fecha como YYYY-MM-DD
function formatDate(date) {
    if (!date) return '';
    
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Abrir modal para agregar/editar cita
function openAppointmentModal(appointment, hour, day) {
    if (!isAdmin) return;
    
    try {
        const modalTitle = document.getElementById('modal-title');
        const dateInput = document.getElementById('appointment-date');
        const timeInput = document.getElementById('appointment-time');
        const deleteBtn = document.getElementById('delete-appointment');
        const isRecurringCheckbox = document.getElementById('is-recurring');
        const recurringDetails = document.getElementById('recurring-details');
        
        // Ocultar opciones de recurrencia por defecto
        document.getElementById('recurrence-options').style.display = 'none';
        
        if (appointment) {
            // Editar cita existente
            modalTitle.textContent = 'Editar Cita';
            
            document.getElementById('patient-name').value = appointment.paciente || '';
            
            const typeSelect = document.getElementById('appointment-type');
            if (appointment.tipoClase && typeSelect) {
                typeSelect.value = appointment.tipoClase;
                
                // Mostrar opciones de recurrencia solo para sesiones
                if (appointment.tipoClase.startsWith('sesion-')) {
                    document.getElementById('recurrence-options').style.display = 'block';
                }
            }
            
            // Si es una cita recurrente, mostrar los detalles
            if (appointment.esRecurrente) {
                isRecurringCheckbox.checked = true;
                recurringDetails.style.display = 'block';
                
                // Marcar los días de la semana
                if (appointment.patronRecurrencia && appointment.patronRecurrencia.diasSemana) {
                    const weekdays = appointment.patronRecurrencia.diasSemana;
                    document.querySelectorAll('input[name="weekday"]').forEach(checkbox => {
                        checkbox.checked = weekdays.includes(parseInt(checkbox.value));
                    });
                }
                
                // Establecer fecha fin
                if (appointment.patronRecurrencia && appointment.patronRecurrencia.fechaFin) {
                    let endDate;
                    try {
                        if (typeof appointment.patronRecurrencia.fechaFin === 'object' && 
                            appointment.patronRecurrencia.fechaFin.toDate) {
                            endDate = appointment.patronRecurrencia.fechaFin.toDate();
                        } else if (typeof appointment.patronRecurrencia.fechaFin === 'string') {
                            endDate = new Date(appointment.patronRecurrencia.fechaFin);
                        }
                    } catch (error) {
                        console.error("Error al convertir fecha fin:", error);
                    }
                    
                    if (endDate) {
                        document.getElementById('recurrence-end').value = formatDate(endDate);
                    }
                }
            } else {
                isRecurringCheckbox.checked = false;
                recurringDetails.style.display = 'none';
            }
            
            const fecha = appointment.fecha;
            if (fecha) {
                dateInput.value = formatDate(fecha);
                timeInput.value = `${fecha.getHours().toString().padStart(2, '0')}:${fecha.getMinutes().toString().padStart(2, '0')}`;
            }
            
            if (appointment.duracion) {
                document.getElementById('appointment-duration').value = appointment.duracion;
            }
            
            // Ya no necesitamos establecer el valor del terapeuta porque eliminamos ese campo
            // if (appointment.terapeuta) {
            //     document.getElementById('therapist').value = appointment.terapeuta;
            // }
            
            document.getElementById('student').value = appointment.estudiante || 'estudiante1';
            document.getElementById('appointment-notes').value = appointment.notas || '';
            document.getElementById('is-web').checked = appointment.web || false;
            
            editingAppointmentId = appointment.id;
            deleteBtn.style.display = 'block';
        } else {
            // Nueva cita
            modalTitle.textContent = 'Agregar Nueva Cita';
            
            // Limpiar formulario
            document.getElementById('patient-name').value = '';
            document.getElementById('appointment-notes').value = '';
            document.getElementById('is-web').checked = false;
            
            // Obtener la fecha correspondiente al día seleccionado
            const startOfWeek = getStartOfWeek(currentWeekDate);
            const appointmentDay = day ? day - 1 : 0; // Convertir de 1-basado a 0-basado
            const appointmentDate = new Date(startOfWeek);
            appointmentDate.setDate(startOfWeek.getDate() + appointmentDay);
            
            // Pre-llenar con la fecha del día seleccionado
            dateInput.value = formatDate(appointmentDate);
            
            // Pre-llenar hora si se proporciona
            if (hour) {
                timeInput.value = `${hour.toString().padStart(2, '0')}:00`;
            }
            
            editingAppointmentId = null;
            deleteBtn.style.display = 'none';
            
            // Inicialmente ocultar detalles de recurrencia
            isRecurringCheckbox.checked = false;
            recurringDetails.style.display = 'none';
            
            // Actualizar visibilidad de opciones de recurrencia según tipo de cita seleccionado
            handleAppointmentTypeChange();
        }
        
        appointmentModal.style.display = 'block';
    } catch (error) {
        console.error("Error al abrir modal de cita:", error);
        showStatusMessage("Error al abrir el formulario", "error");
    }
}

// Cerrar modal de citas
function closeAppointmentModal() {
    appointmentModal.style.display = 'none';
    editingAppointmentId = null;
    
    // Limpiar formulario
    document.getElementById('patient-name').value = '';
    document.getElementById('appointment-notes').value = '';
    document.getElementById('is-web').checked = false;
    document.getElementById('is-recurring').checked = false;
    document.getElementById('recurring-details').style.display = 'none';
}

// Guardar cita
function saveAppointment() {
    try {
        showSpinner();
        
        const patientName = document.getElementById('patient-name').value;
        if (!patientName || patientName.trim() === '') {
            hideSpinner();
            showStatusMessage('Por favor ingresa el nombre del paciente', 'warning');
            return;
        }
        
        const appointmentTypeSelect = document.getElementById('appointment-type');
        const appointmentType = appointmentTypeSelect.options[appointmentTypeSelect.selectedIndex].text;
        const appointmentTypeClass = appointmentTypeSelect.value;
        const appointmentDate = document.getElementById('appointment-date').value;
        const appointmentTime = document.getElementById('appointment-time').value;
        
        if (!appointmentDate || !appointmentTime) {
            hideSpinner();
            showStatusMessage('Por favor ingresa fecha y hora', 'warning');
            return;
        }
        
        const appointmentDuration = parseInt(document.getElementById('appointment-duration').value);
        const therapist = "estudiante"; // Valor por defecto ya que eliminamos el campo
        const student = document.getElementById('student').value;
        const notes = document.getElementById('appointment-notes').value;
        const isWeb = document.getElementById('is-web').checked;
        
        // Datos de recurrencia
        const isRecurring = document.getElementById('is-recurring').checked;
        let selectedWeekdays = [];
        let recurrenceEndDate = null;
        
        if (isRecurring) {
            // Obtener días de la semana seleccionados
            document.querySelectorAll('input[name="weekday"]:checked').forEach(checkbox => {
                selectedWeekdays.push(parseInt(checkbox.value));
            });
            
            // Fecha de fin de recurrencia
            recurrenceEndDate = document.getElementById('recurrence-end').value;
            if (!recurrenceEndDate) {
                hideSpinner();
                showStatusMessage('Por favor selecciona una fecha de fin para la recurrencia', 'warning');
                return;
            }
            
            if (selectedWeekdays.length === 0) {
                hideSpinner();
                showStatusMessage('Por favor selecciona al menos un día de la semana', 'warning');
                return;
            }
        }
        
        // Crear objeto de fecha
        const [year, month, day] = appointmentDate.split('-');
        const [hours, minutes] = appointmentTime.split(':');
        const date = new Date(year, month - 1, day, hours, minutes);
        
        // Verificar si es feriado
        // Verificar si es feriado
        const dateStr = formatDate(date);
        const holidayMatch = holidays.find(h => h.date === dateStr);
        if (holidayMatch) {
            hideSpinner();
            showStatusMessage(`No se pueden agendar citas en días feriados. ${dateStr} es "${holidayMatch.name}".`, 'warning');
            return;
        }
        
        // Verificar límite de citas simultáneas
        if (!editingAppointmentId) { // Solo verificar para nuevas citas
            const dayOfWeek = date.getDay(); // 0 para domingo, 1 para lunes, etc.
            if (dayOfWeek > 0 && dayOfWeek < 5) { // Solo lunes a jueves
                const hourAppointments = appointments.filter(a => {
                    const appDate = a.fecha;
                    return appDate && appDate.getDay() === dayOfWeek &&
                           appDate.getHours() === date.getHours() &&
                           a.estudiante === student;
                });
                
                if (hourAppointments.length >= 2) {
                    hideSpinner();
                    showStatusMessage('Este estudiante ya tiene 2 citas en este horario.', 'warning');
                    return;
                }
            }
        }
        
        // ID único para citas recurrentes
        const serieRecurrenteId = isRecurring ? `serie_${Date.now()}` : null;
        
        // Datos base de la cita
        const baseAppointmentData = {
            paciente: patientName,
            tipo: appointmentType,
            tipoClase: appointmentTypeClass,
            duracion: appointmentDuration,
            terapeuta: therapist,
            estudiante: student,
            notas: notes,
            web: isWeb,
            esRecurrente: isRecurring,
            fecha: date,
            creado: new Date(),
            historial: [{
                accion: editingAppointmentId ? 'modificacion' : 'creacion',
                usuario: currentUser.email,
                usuarioId: currentUser.uid,
                fecha: new Date()
            }]
        };
        
        // Si es cita recurrente, agregar patrón
        if (isRecurring) {
            baseAppointmentData.serieRecurrenteId = serieRecurrenteId;
            baseAppointmentData.patronRecurrencia = {
                diasSemana: selectedWeekdays,
                fechaFin: new Date(recurrenceEndDate)
            };
        }
        
        if (editingAppointmentId) {
            // Actualizar cita existente
            db.collection('citas').doc(editingAppointmentId).set(baseAppointmentData)
                .then(() => {
                    closeAppointmentModal();
                    showStatusMessage('Cita actualizada correctamente', 'success');
                    loadAppointments();
                })
                .catch((error) => {
                    console.error("Error al actualizar cita:", error);
                    hideSpinner();
                    alert('Error al actualizar la cita: ' + error.message);
                });
        } else if (isRecurring) {
            // Crear citas recurrentes usando batch
            const batch = db.batch();
            const endDate = new Date(recurrenceEndDate);
            
            // Generar todas las fechas según patrón
            const createdDates = [];
            const currentDate = new Date(date);
            while (currentDate <= endDate) {
                const currentDay = currentDate.getDay(); // 0 = domingo, 1 = lunes, ...
                
                // Si el día actual está en los días seleccionados
                if (selectedWeekdays.includes(currentDay)) {
                    const apptData = {...baseAppointmentData};
                    apptData.fecha = new Date(currentDate); // Copia de la fecha
                    
                    // Crear documento con ID automático
                    const newDocRef = db.collection('citas').doc();
                    batch.set(newDocRef, apptData);
                    
                    createdDates.push(formatDate(currentDate));
                }
                
                // Avanzar al siguiente día
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Ejecutar el batch
            batch.commit()
                .then(() => {
                    closeAppointmentModal();
                    showStatusMessage(`Creadas ${createdDates.length} citas recurrentes`, 'success');
                    loadAppointments();
                })
                .catch((error) => {
                    console.error("Error al crear citas recurrentes:", error);
                    hideSpinner();
                    alert('Error al crear citas recurrentes: ' + error.message);
                });
        } else {
            // Crear una cita simple
            db.collection('citas').add(baseAppointmentData)
                .then((docRef) => {
                    console.log("Cita creada con ID:", docRef.id);
                    closeAppointmentModal();
                    showStatusMessage('Cita creada correctamente', 'success');
                    loadAppointments();
                })
                .catch((error) => {
                    console.error("Error al crear cita:", error);
                    hideSpinner();
                    alert('Error al crear la cita: ' + error.message);
                });
        }
    } catch (error) {
        console.error("Error crítico al guardar cita:", error);
        hideSpinner();
        alert('Error crítico al guardar: ' + error.message);
    }
}

// Eliminar cita
function deleteAppointment() {
    if (!editingAppointmentId) {
        showStatusMessage("No hay ninguna cita seleccionada para eliminar", "warning");
        return;
    }
    
    showSpinner();
    
    try {
        // Para simplificar, eliminamos directamente la cita
        db.collection('citas').doc(editingAppointmentId).delete()
            .then(() => {
                closeAppointmentModal();
                showStatusMessage('Cita eliminada correctamente', 'success');
                loadAppointments();
            })
            .catch((error) => {
                console.error("Error al eliminar cita:", error);
                hideSpinner();
                alert('Error al eliminar: ' + error.message);
            });
    } catch (error) {
        console.error("Error crítico al eliminar cita:", error);
        hideSpinner();
        alert("Error crítico al eliminar: " + error.message);
    }
}

// Mover una cita a una fecha y hora específicas
function moveAppointmentToDate(appointmentId, targetDate, hour) {
    if (!isAdmin) return;
    
    const appointment = appointments.find(a => a.id === appointmentId);
    if (!appointment) {
        showStatusMessage("No se encontró la cita para mover", "error");
        return;
    }
    
    showSpinner();
    
    try {
        // Conservar minutos, pero cambiar fecha y hora
        const newDate = new Date(targetDate);
        newDate.setHours(hour, appointment.fecha.getMinutes(), 0, 0);
        
        // Actualizar fecha
        db.collection('citas').doc(appointmentId).update({
            fecha: newDate,
            historial: firebase.firestore.FieldValue.arrayUnion({
                accion: 'movimiento',
                usuario: currentUser.email,
                usuarioId: currentUser.uid,
                fecha: new Date()
            })
        })
        .then(() => {
            showStatusMessage('Cita movida correctamente', 'success');
            loadAppointments();
        })
        .catch((error) => {
            console.error("Error al mover cita:", error);
            hideSpinner();
            alert('Error al mover la cita: ' + error.message);
        });
    } catch (error) {
        console.error("Error crítico al mover cita:", error);
        hideSpinner();
        alert("Error crítico al mover: " + error.message);
    }
}

// Abrir modal de asistencia
function openAttendanceModal(appointment) {
    if (!isAdmin) return;
    
    try {
        const patientEl = document.getElementById('attendance-patient');
        const dateEl = document.getElementById('attendance-date');
        const timeEl = document.getElementById('attendance-time');
        
        patientEl.textContent = appointment.paciente || 'Sin nombre';
        
        const fecha = appointment.fecha;
        const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
        dateEl.textContent = fecha ? fecha.toLocaleDateString('es-ES', options) : 'Fecha no disponible';
        
        if (fecha) {
            const horaInicio = `${fecha.getHours().toString().padStart(2, '0')}:${fecha.getMinutes().toString().padStart(2, '0')}`;
            const fechaFin = new Date(fecha);
            fechaFin.setMinutes(fecha.getMinutes() + (appointment.duracion || 60));
            const horaFin = `${fechaFin.getHours().toString().padStart(2, '0')}:${fechaFin.getMinutes().toString().padStart(2, '0')}`;
            timeEl.textContent = `${horaInicio} - ${horaFin}`;
        } else {
            timeEl.textContent = 'Hora no disponible';
        }
        
        // Resetear selección de estado
        document.querySelectorAll('.attendance-btn').forEach(btn => {
            btn.classList.remove('selected');
        });
        
        // Seleccionar el estado actual si existe
        if (appointment.estado) {
            const currentStatusBtn = document.querySelector(`.attendance-btn[data-status="${appointment.estado}"]`);
            if (currentStatusBtn) {
                currentStatusBtn.classList.add('selected');
            }
        }
        
        // Notas de asistencia
        document.getElementById('attendance-notes').value = appointment.notasAsistencia || '';
        
        // Guardar referencia a la cita actual
        attendanceModal.dataset.appointmentId = appointment.id;
        
        // Mostrar modal
        attendanceModal.style.display = 'block';
    } catch (error) {
        console.error("Error al abrir modal de asistencia:", error);
        showStatusMessage("Error al abrir el formulario de asistencia", "error");
    }
}

// Cerrar modal de asistencia
function closeAttendanceModal() {
    attendanceModal.style.display = 'none';
}

// Guardar asistencia
function saveAttendance() {
    const appointmentId = attendanceModal.dataset.appointmentId;
    if (!appointmentId) {
        showStatusMessage("No se encontró la cita para registrar asistencia", "error");
        return;
    }
    
    const selectedBtn = document.querySelector('.attendance-btn.selected');
    
    if (!selectedBtn) {
        showStatusMessage('Por favor selecciona un estado de asistencia', 'warning');
        return;
    }
    
    const status = selectedBtn.dataset.status;
    const notes = document.getElementById('attendance-notes').value;
    
    showSpinner();
    
    try {
        // Actualizar en Firestore
        db.collection('citas').doc(appointmentId).update({
            estado: status,
            notasAsistencia: notes,
            ultimaActualizacion: new Date()
        })
        .then(() => {
            closeAttendanceModal();
            showStatusMessage('Asistencia registrada correctamente', 'success');
            loadAppointments();
        })
        .catch((error) => {
            console.error("Error al registrar asistencia:", error);
            hideSpinner();
            alert('Error al registrar la asistencia: ' + error.message);
        });
    } catch (error) {
        console.error("Error crítico al guardar asistencia:", error);
        hideSpinner();
        alert("Error crítico al guardar asistencia: " + error.message);
    }
}

// Mostrar/ocultar spinner de carga
function showSpinner() {
    spinner.style.display = 'flex';
}

function hideSpinner() {
    spinner.style.display = 'none';
}

// Mostrar mensaje de estado
function showStatusMessage(message, type = 'success') {
    statusMessage.textContent = message;
    statusMessage.className = 'status-message ' + type;
    statusMessage.style.display = 'block';
    
    // Ocultar después de 5 segundos
    setTimeout(() => {
        statusMessage.style.display = 'none';
    }, 5000);
}
</script>

</body>
</html>
