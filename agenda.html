<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMAKINE - Agenda</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Paleta de colores base clara con acentos vibrantes */
            --background: #F5F7FA;
            --surface: #FFFFFF;
            --surface-hover: #F9FAFC;
            --border: #E2E8F0;
            --text-primary: #2D3748;
            --text-secondary: #718096;
            --accent-blue: #2D3FE0;
            --accent-teal: #00BFA5;
            --accent-coral: #FF6B6B;
            --accent-purple: #9B59B6;
            --shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            --shadow-elevated: 0 10px 25px rgba(0, 0, 0, 0.1);
            
            /* Tipos de cita */
            --eval-msk: #FFD3E0;
            --eval-deportiva: #C4F2E0;
            --sesion-msk: #FFEAA7;
            --sesion-deportiva: #BEE3F8;

            /* Colores más distinguibles por estudiante */
            .appointment.estudiante1 { background-color: #FF5252; } /* Rojo */
            .appointment.estudiante2 { background-color: #4CAF50; } /* Verde */
            .appointment.estudiante3 { background-color: #2196F3; } /* Azul */
            .appointment.estudiante4 { background-color: #FFC107; } /* Amarillo */
            .appointment.estudiante5 { background-color: #9C27B0; } /* Púrpura */
            .appointment.estudiante6 { background-color: #FF9800; } /* Naranja */
            .appointment.estudiante7 { background-color: #00BCD4; } /* Cian */
            .appointment.estudiante8 { background-color: #795548; } /* Marrón */
            .appointment.estudiante9 { background-color: #607D8B; } /* Azul grisáceo */
            .appointment.estudiante10 { background-color: #E91E63; } /* Rosa */
            
            /* Asegurarse que el texto sea legible en fondos oscuros */
            .appointment.estudiante1, .appointment.estudiante5, .appointment.estudiante8, 
            .appointment.estudiante9, .appointment.estudiante10 {
                color: white;
            }
            
            /* Estados */
            --success: #4CAF50;
            --warning: #FF9800;
            --error: #F44336;
            
            /* Animaciones */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.25s ease;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 14px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }
        
        .app-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-blue);
        }
        
        .week-navigation {
            display: flex;
            align-items: center;
            background: var(--surface);
            padding: 8px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        
        .week-navigation button {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 8px 12px;
            color: var(--accent-blue);
            transition: var(--transition-fast);
            border-radius: 4px;
        }
        
        .week-navigation button:hover {
            background-color: rgba(45, 63, 224, 0.1);
        }
        
        #current-week {
            margin: 0 12px;
            font-weight: 600;
            font-size: 16px;
        }
        
        #user-info {
            display: flex;
            align-items: center;
            background: var(--surface);
            padding: 8px 16px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        
        #user-name {
            font-weight: 500;
            margin-right: 16px;
        }
        
        /* Estructura de la agenda */
        .scheduler-container {
            background: var(--surface);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        .days-header, .dates-header {
            display: grid;
            grid-template-columns: 80px repeat(4, 1fr);
            text-align: center;
            background-color: var(--surface);
        }
        
        .days-header {
            border-bottom: 1px solid var(--border);
        }
        
        .day-header, .date-header {
            padding: 14px 10px;
            font-weight: 600;
        }
        
        .day-header {
            font-size: 16px;
            color: var(--text-primary);
        }
        
        .date-header {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .time-column-header {
            border-right: 1px solid var(--border);
        }
        
        .schedule-grid {
            display: grid;
            grid-template-columns: 80px repeat(4, 1fr);
            position: relative;
        }
        
        .time-cell {
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: var(--text-secondary);
            padding: 10px;
            font-weight: 500;
        }
        
        .schedule-cell {
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            padding: 6px;
            position: relative;
            min-height: 100px;
            transition: var(--transition-fast);
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-content: flex-start;
        }
        
        .schedule-cell:hover {
            background-color: var(--surface-hover);
        }
        
        .current-day {
            background-color: rgba(45, 63, 224, 0.05);
        }
        
        /* Diseño de las citas */
        .appointment {
            position: relative;
            border-radius: 6px;
            padding: 8px 10px;
            font-size: 13px;
            overflow: hidden;
            transition: var(--transition-fast);
            box-shadow: var(--shadow);
            flex: 0 0 calc(50% - 3px); /* Dos citas por fila */
            max-width: calc(50% - 3px);
            cursor: pointer;
            height: auto;
        }
        
        .appointment:hover {
            box-shadow: var(--shadow-elevated);
            transform: translateY(-2px);
        }
        
        .appointment.evaluacion-msk { 
            background-color: var(--eval-msk); 
        }
        
        .appointment.evaluacion-deportiva { 
            background-color: var(--eval-deportiva); 
        }
        
        .appointment.sesion-msk { 
            background-color: var(--sesion-msk); 
        }
        
        .appointment.sesion-deportiva { 
            background-color: var(--sesion-deportiva); 
        }
        
        .appointment.recurring {
            border-left: 3px solid var(--success);
        }
        
        .appointment-title {
            font-weight: 600;
            margin-bottom: 4px;
            margin-right: 20px; /* Añadir margen derecho para evitar solapamiento */
            padding-top: 15px; /* Espacio para la etiqueta de estudiante */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .appointment-type {
            font-size: 11px;
            opacity: 0.8;
            margin-bottom: 3px;
        }
        
        .appointment-therapist {
            font-size: 11px;
            font-weight: 500;
            margin-top: 4px;
        }
        
        .student-badge {
            position: absolute;
            right: 6px;
            top: 6px;
            font-size: 10px;
            font-weight: 600;
            color: white;
            background: rgba(0, 0, 0, 0.5);
            padding: 3px 6px;
            border-radius: 4px;
            z-index: 5;
            max-width: 90px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .appointment-status {
            position: absolute;
            right: 8px;
            bottom: 8px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .appointment-status.attended {
            background-color: var(--success);
        }
        
        .appointment-status.missed {
            background-color: var(--error);
        }
        
        .appointment-status.rescheduled {
            background-color: var(--warning);
        }
        
        .web-indicator {
            position: absolute;
            left: 8px;
            bottom: 6px;
            font-size: 10px;
            color: var(--accent-teal);
        }
        
        /* Estadísticas */
        .stats-panel {
            background-color: var(--surface);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .stats-title {
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-box {
            background-color: var(--surface-hover);
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-blue);
        }
        
        .therapist-stats-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
        }
        
        .charts-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 200px;
            margin: 30px 0;
        }
        
        .chart-bar {
            width: 80px;
            background-color: var(--accent-blue);
            margin: 0 30px;
            border-radius: 8px 8px 0 0;
            position: relative;
            transition: var(--transition-normal);
        }
        
        .chart-bar:nth-child(2) {
            background-color: var(--accent-teal);
        }
        
        .chart-bar:nth-child(3) {
            background-color: var(--accent-coral);
        }
        
        .chart-value {
            position: absolute;
            top: -30px;
            width: 100%;
            text-align: center;
            font-weight: 700;
            font-size: 18px;
            color: var(--text-primary);
        }
        
        .chart-labels {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        
        .chart-label {
            width: 140px;
            text-align: center;
            font-size: 15px;
            font-weight: 500;
        }
        
        /* Modales */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
            overflow-y: auto; /* Permitir scroll */
        }
        
        .modal-content {
            background-color: var(--surface);
            width: 90%;
            max-width: 550px;
            margin: 40px auto;
            border-radius: 12px;
            box-shadow: var(--shadow-elevated);
            overflow: hidden;
            animation: modalFadeIn 0.3s ease;
            position: relative;
            max-height: 90vh; /* Altura máxima */
            display: flex;
            flex-direction: column;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            padding: 20px;
            background-color: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 20px;
            color: var(--accent-blue);
        }
        
        .close {
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: var(--transition-fast);
        }
        
        .close:hover {
            color: var(--accent-coral);
        }
        
        form {
            padding: 20px;
            overflow-y: auto; /* Permitir scroll en el formulario */
            flex: 1;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group input[type="time"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            transition: var(--transition-fast);
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(45, 63, 224, 0.1);
        }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
        }
        
        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .weekday-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 8px;
        }
        
        .weekday-selector label {
            display: flex;
            align-items: center;
            font-weight: normal;
            margin-right: 12px;
            cursor: pointer;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 30px;
            position: sticky;
            bottom: 0;
            background-color: var(--surface);
            padding: 10px 0;
            border-top: 1px solid var(--border);
        }
        
        .button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition-fast);
        }
        
        .save-btn {
            background-color: var(--accent-blue);
            color: white;
        }
        
        .save-btn:hover {
            background-color: #2235C0;
        }
        
        .cancel-btn {
            background-color: #E2E8F0;
            color: var(--text-primary);
        }
        
        .cancel-btn:hover {
            background-color: #CBD5E0;
        }
        
        .delete-btn {
            background-color: var(--error);
            color: white;
        }
        
        .delete-btn:hover {
            background-color: #D32F2F;
        }
        
        /* Modal de asistencia */
        .modal-body {
            padding: 20px;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            text-align: right;
            position: sticky;
            bottom: 0;
            background-color: var(--surface);
        }
        
        .attendance-options {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            gap: 10px;
        }
        
        .attendance-btn {
            padding: 12px;
            border: 1px solid var(--border);
            background-color: var(--surface);
            border-radius: 6px;
            cursor: pointer;
            flex: 1;
            text-align: center;
            transition: var(--transition-fast);
            font-weight: 500;
        }
        
        .attendance-btn[data-status="attended"] {
            border-color: var(--success);
            color: var(--success);
        }
        
        .attendance-btn[data-status="attended"].selected {
            background-color: var(--success);
            color: white;
        }
        
        .attendance-btn[data-status="missed"] {
            border-color: var(--error);
            color: var(--error);
        }
        
        .attendance-btn[data-status="missed"].selected {
            background-color: var(--error);
            color: white;
        }
        
        .attendance-btn[data-status="rescheduled"] {
            border-color: var(--warning);
            color: var(--warning);
        }
        
        .attendance-btn[data-status="rescheduled"].selected {
            background-color: var(--warning);
            color: white;
        }
        
        /* Arrastrar y soltar */
        .schedule-cell.drag-over {
            background-color: rgba(45, 63, 224, 0.1);
        }
        
        /* Spinner de carga */
        .spinner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }
        
        .spinner-content {
            width: 40px;
            height: 40px;
            border: 3px solid #E2E8F0;
            border-top: 3px solid var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Mensajes de estado */
        .status-message {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: var(--shadow-elevated);
            display: none;
            z-index: 1500;
            font-weight: 500;
            animation: fadeIn 0.3s ease;
        }
        
        .status-message.success {
            background-color: var(--success);
            color: white;
        }
        
        .status-message.error {
            background-color: var(--error);
            color: white;
        }
        
        .status-message.warning {
            background-color: var(--warning);
            color: white;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Login */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background-color: var(--surface);
            border-radius: 12px;
            box-shadow: var(--shadow-elevated);
        }
        
        .login-title {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
            color: var(--accent-blue);
        }
        
        /* Responsive */
        @media (max-width: 900px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
            
            .week-navigation, #user-info {
                width: 100%;
            }
            
            .days-header, .dates-header, .schedule-grid {
                grid-template-columns: 60px repeat(4, 1fr);
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-container {
                flex-direction: column;
                height: auto;
                align-items: center;
            }
            
            .chart-bar {
                width: 100%;
                height: 40px !important;
                margin: 10px 0;
                border-radius: 0 5px 5px 0;
            }
            
            .chart-value {
                top: 10px;
                right: -25px;
                left: auto;
            }
            
            .chart-labels {
                flex-direction: column;
            }
            
            .appointment {
                flex: 0 0 100%;
                max-width: 100%;
            }
            
            .modal-content {
                width: 95%;
                margin: 20px auto;
                max-height: 85vh;
            }
        }
        
        @media (min-width: 901px) and (max-width: 1200px) {
            .appointment {
                flex: 0 0 calc(50% - 3px);
                max-width: calc(50% - 3px);
            }
        }
        
        @media (min-width: 1201px) {
            .appointment {
                flex: 0 0 calc(33.333% - 4px);
                max-width: calc(33.333% - 4px);
            }
        }


        /* Buscador de pacientes */
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: var(--surface);
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        
        .search-container input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
        }
        
        .search-container button {
            padding: 8px 15px;
        }

        
        /* Panel de administración de estudiantes */
.admin-panel {
    background-color: var(--surface);
    border-radius: 12px;
    box-shadow: var(--shadow);
    padding: 20px;
    margin-bottom: 30px;
}

.admin-title {
    margin-bottom: 20px;
    font-size: 20px;
    font-weight: 600;
    color: var(--text-primary);
}

.student-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
}

.student-item {
    background-color: var(--surface-hover);
    padding: 15px;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.student-code {
    font-weight: 600;
    color: var(--text-primary);
}

.student-name {
    padding: 8px;
    border: 1px solid var(--border);
    border-radius: 6px;
}

.save-student-btn {
    background-color: var(--accent-blue);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    margin-top: 5px;
}

.save-student-btn:hover {
    background-color: #2235C0;
}

/* Estilos para días feriados */
.holiday-cell {
    background-color: rgba(255, 107, 107, 0.1);
    position: relative;
}

.holiday-cell::after {
    content: "Feriado";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: var(--error);
    font-size: 14px;
    font-weight: 600;
    opacity: 0.7;
}

    /* Mejorar formato de la tabla de estadísticas */
.student-stats-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    box-shadow: var(--shadow);
    border-radius: 8px;
    overflow: hidden;
}

.student-stats-table thead th {
    background-color: var(--accent-blue);
    color: white;
    padding: 12px 15px;
    text-align: left;
    font-weight: 600;
}

.student-stats-table tbody td {
    padding: 12px 15px;
    border-bottom: 1px solid var(--border);
}

.student-stats-table tbody tr:last-child td {
    border-bottom: none;
}

.student-stats-table tbody tr:hover {
    background-color: var(--surface-hover);
}

/* Contenedor de exportación */
.export-container {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}

/* Resaltado para búsqueda de pacientes */
.appointment.highlighted {
    box-shadow: 0 0 0 3px var(--accent-blue);
    transform: translateY(-3px);
    z-index: 10;
}

/* Gráfico circular */
.chart-legend {
    margin-top: 15px;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
}

.legend-item {
    display: flex;
    align-items: center;
    margin: 5px 10px;
}

.legend-item div {
    width: 12px;
    height: 12px;
    margin-right: 5px;
    border-radius: 2px;
}

/* Mejorar espaciado en estadísticas */
.stats-section {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid var(--border);
}

.therapist-stats-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 20px;
    color: var(--text-primary);
}

/* Buscador de pacientes */
.search-container {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    background: var(--surface);
    padding: 15px;
    border-radius: 8px;
    box-shadow: var(--shadow);
}

.search-container input {
    flex: 1;
    padding: 10px;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 14px;
}

.search-container button {
    padding: 8px 15px;
}  
        /* Añadir estos estilos al final de la sección de CSS */
.stats-panel {
    position: relative;
    overflow: visible;
    padding-bottom: 50px; /* Añadir espacio adicional abajo */
}

.student-stats-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin-top: 20px;
    box-shadow: var(--shadow);
    border-radius: 8px;
    overflow: hidden;
    position: relative;
    z-index: 10; /* Aumentar para evitar solapamientos */
}

/* Mejorar separación entre secciones de estadísticas */
.stats-section {
    margin-top: 50px;
    padding-top: 30px;
    border-top: 1px solid var(--border);
    clear: both; /* Evitar solapamientos con elementos flotantes */
}

h4.therapist-stats-title {
    margin-top: 30px;
    margin-bottom: 20px;
    padding-top: 10px;
    clear: both;
}

/* Botones de exportación */
.export-container {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 30px;
    position: relative;
    z-index: 20; /* Asegurar que los botones estén encima */
}

        /* Mejoras para dispositivos móviles */
@media (max-width: 767px) {
    /* Reducir espaciado y tamaños en general */
    .container {
        padding: 10px;
    }
    
    header {
        margin-bottom: 15px;
        padding-bottom: 10px;
    }
    
    .app-title {
        font-size: 20px;
    }
    
    /* Mejorar visualización de la agenda */
    .days-header, .dates-header, .schedule-grid {
        grid-template-columns: 40px repeat(4, 1fr);
    }
    
    .time-cell {
        font-size: 11px;
        padding: 5px;
    }
    
    .schedule-cell {
        min-height: 80px;
        padding: 3px;
        gap: 3px;
    }
    
    /* Hacer las citas más legibles */
    .appointment {
        padding: 5px;
        font-size: 11px;
        flex: 0 0 100%;
        max-width: 100%;
    }
    
    .appointment-title {
        font-size: 11px;
        margin-bottom: 2px;
        padding-top: 12px;
    }
    
    .appointment-type {
        font-size: 9px;
    }
    
    .appointment-therapist {
        font-size: 9px;
    }
    
    .student-badge {
        font-size: 8px;
        right: 3px;
        top: 3px;
        padding: 2px 4px;
    }
    
    /* Mejorar la visualización de los modales */
    .modal-content {
        width: 95%;
        margin: 10px auto;
        max-height: 90vh;
    }
    
    .form-group {
        margin-bottom: 10px;
    }
    
    /* Mejorar las estadísticas */
    .stats-grid {
        gap: 10px;
    }
    
    .stat-box {
        padding: 10px;
    }
    
    .stat-value {
        font-size: 22px;
    }
    
    /* Optimizar la tabla de estudiantes */
    .student-stats-table th,
    .student-stats-table td {
        padding: 8px 6px;
        font-size: 11px;
    }
    
    /* Optimizar sección de búsqueda */
    .search-container {
        padding: 10px;
    }
}

        /* Estilos para filtros */
.filters-container {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    background: var(--surface);
    padding: 15px;
    border-radius: 8px;
    box-shadow: var(--shadow);
    flex-wrap: wrap;
}

.filter-select {
    flex: 1;
    min-width: 150px;
    padding: 10px;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 14px;
}

@media (max-width: 767px) {
    .filters-container {
        padding: 10px;
    }
    
    .filter-select, 
    .filters-container button {
        flex: 1 1 100%;
        margin-bottom: 5px;
    }
}
    </style>
</head>
<body>
    <!-- Spinner de carga -->
    <div class="spinner" id="spinner">
        <div class="spinner-content"></div>
    </div>
    
    <!-- Mensaje de estado -->
    <div class="status-message" id="status-message"></div>
    
    <!-- Contenedor de login (se muestra solo si el usuario no está autenticado) -->
    <div class="login-container" id="login-container" style="display: none;">
        <h2 class="login-title">SISTEMAKINE - Agenda</h2>
        <form id="login-form">
            <div class="form-group">
                <label for="email">Correo electrónico:</label>
                <input type="email" id="email" required>
            </div>
            <div class="form-group">
                <label for="password">Contraseña:</label>
                <input type="password" id="password" required>
            </div>
            <div class="form-actions">
                <button type="submit" class="button save-btn">Iniciar sesión</button>
            </div>
            <p style="margin-top: 20px; text-align: center; color: var(--text-secondary);">
                <small>Si eres estudiante, solicita las credenciales a tu profesor.</small>
            </p>
        </form>
    </div>
    
    <!-- Contenedor principal (se muestra solo si el usuario está autenticado) -->
    <div class="container" id="main-container" style="display: none;">
        <header>
            <h1 class="app-title">SISTEMAKINE</h1>
            <div class="week-navigation">
                <button id="prev-week">◀</button>
                <h2 id="current-week">Semana del 17 al 20 de marzo de 2025</h2>
                <button id="next-week">▶</button>
            </div>
            <div id="user-info">
                <span id="user-name"></span>
                <button id="logout-btn" class="button cancel-btn" style="padding: 6px 12px; font-size: 13px;">Cerrar sesión</button>
            </div>
        </header>

        <!-- Buscador de pacientes -->
        <div class="search-container">
                        <!-- Filtros -->
            <div class="filters-container">
                <select id="student-filter" class="filter-select">
                    <option value="">Todos los estudiantes</option>
                    <!-- Se llenará dinámicamente -->
                </select>
                <select id="type-filter" class="filter-select">
                    <option value="">Todos los tipos</option>
                    <option value="evaluacion-msk">Evaluación MSK</option>
                    <option value="evaluacion-deportiva">Evaluación Deportiva</option>
                    <option value="sesion-msk">Sesión MSK</option>
                    <option value="sesion-deportiva">Sesión Deportiva</option>
                </select>
                <button id="apply-filters-btn" class="button save-btn">Aplicar Filtros</button>
                <button id="clear-filters-btn" class="button cancel-btn">Limpiar Filtros</button>
            </div>
            <input type="text" id="patient-search" placeholder="Buscar paciente...">
            <button id="search-btn" class="button save-btn">Buscar</button>
            <button id="clear-search-btn" class="button cancel-btn">Limpiar</button>
        </div>
        
        <div class="scheduler-container">
            <!-- Encabezado de la semana con días -->
            <div class="days-header">
                <div class="time-column-header"></div>
                <div class="day-header" id="day-header-1">Lunes</div>
                <div class="day-header" id="day-header-2">Martes</div>
                <div class="day-header" id="day-header-3">Miércoles</div>
                <div class="day-header" id="day-header-4">Jueves</div>
            </div>

            <!-- Encabezado con fechas -->
            <div class="dates-header">
                <div class="time-column-header"></div>
                <div class="date-header" id="date-header-1">17/3</div>
                <div class="date-header" id="date-header-2">18/3</div>
                <div class="date-header" id="date-header-3">19/3</div>
                <div class="date-header" id="date-header-4">20/3</div>
            </div>

            <!-- Cuadrícula de la agenda -->
            <div class="schedule-grid">
                <!-- Horas -->
                <div class="time-cell">09:00</div>
                <div class="schedule-cell" data-hour="9" data-day="1"></div>
                <div class="schedule-cell" data-hour="9" data-day="2"></div>
                <div class="schedule-cell" data-hour="9" data-day="3"></div>
                <div class="schedule-cell" data-hour="9" data-day="4"></div>
                
                <div class="time-cell">10:00</div>
                <div class="schedule-cell" data-hour="10" data-day="1"></div>
                <div class="schedule-cell" data-hour="10" data-day="2"></div>
                <div class="schedule-cell" data-hour="10" data-day="3"></div>
                <div class="schedule-cell" data-hour="10" data-day="4"></div>
                
                <div class="time-cell">11:00</div>
                <div class="schedule-cell" data-hour="11" data-day="1"></div>
                <div class="schedule-cell" data-hour="11" data-day="2"></div>
                <div class="schedule-cell" data-hour="11" data-day="3"></div>
                <div class="schedule-cell" data-hour="11" data-day="4"></div>
                
                <div class="time-cell">12:00</div>
                <div class="schedule-cell" data-hour="12" data-day="1"></div>
                <div class="schedule-cell" data-hour="12" data-day="2"></div>
                <div class="schedule-cell" data-hour="12" data-day="3"></div>
                <div class="schedule-cell" data-hour="12" data-day="4"></div>
                
                <div class="time-cell">13:00</div>
                <div class="schedule-cell" data-hour="13" data-day="1"></div>
                <div class="schedule-cell" data-hour="13" data-day="2"></div>
                <div class="schedule-cell" data-hour="13" data-day="3"></div>
                <div class="schedule-cell" data-hour="13" data-day="4"></div>
                
                <div class="time-cell">14:00</div>
                <div class="schedule-cell" data-hour="14" data-day="1"></div>
                <div class="schedule-cell" data-hour="14" data-day="2"></div>
                <div class="schedule-cell" data-hour="14" data-day="3"></div>
                <div class="schedule-cell" data-hour="14" data-day="4"></div>
                
                <div class="time-cell">15:00</div>
                <div class="schedule-cell" data-hour="15" data-day="1"></div>
                <div class="schedule-cell" data-hour="15" data-day="2"></div>
                <div class="schedule-cell" data-hour="15" data-day="3"></div>
                <div class="schedule-cell" data-hour="15" data-day="4"></div>
                
                <div class="time-cell">16:00</div>
                <div class="schedule-cell" data-hour="16" data-day="1"></div>
                <div class="schedule-cell" data-hour="16" data-day="2"></div>
                <div class="schedule-cell" data-hour="16" data-day="3"></div>
                <div class="schedule-cell" data-hour="16" data-day="4"></div>
            </div>
        </div>
        
        <div class="stats-panel">
            <h3 class="stats-title">Estadísticas</h3>
            
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">Asistencia semanal</div>
                    <div class="stat-value" id="attendance-rate">85%</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Citas totales</div>
                    <div class="stat-value" id="total-appointments">32</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Hora más ocupada</div>
                    <div class="stat-value" id="busiest-hour">10:00</div>
                </div>
            </div>
            
            <h4 class="therapist-stats-title">Pacientes por estudiante</h4>
            
            <div class="charts-container" id="student-chart">
                <!-- Se llenará dinámicamente -->
            </div>
            
            <div class="chart-labels" id="student-chart-labels">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>
    </div>

     <!-- Panel de Administración de Estudiantes -->
        <div class="admin-panel">
            <h3 class="admin-title">Administración de Estudiantes</h3>
            <div class="student-list" id="student-list">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>
    
    <!-- Modal para agregar/editar citas -->
    <div class="modal" id="appointment-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Agregar Nueva Cita</h3>
                <span class="close">&times;</span>
            </div>
            <form id="appointment-form">
                <div class="form-group">
                    <label for="patient-name">Paciente:</label>
                    <input type="text" id="patient-name" required>
                </div>
                <div class="form-group">
                    <label for="appointment-type">Tipo de consulta:</label>
                    <select id="appointment-type" required onchange="handleAppointmentTypeChange()">
                        <option value="evaluacion-msk">Evaluación kinesiología MSK</option>
                        <option value="evaluacion-deportiva">Evaluación kinesiología deportiva</option>
                        <option value="sesion-msk">Sesión kinesiología MSK</option>
                        <option value="sesion-deportiva">Sesión kinesiología deportiva</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="student">Estudiante asignado:</label>
                    <select id="student" required>
                        <option value="estudiante1">Estudiante 1</option>
                        <option value="estudiante2">Estudiante 2</option>
                        <option value="estudiante3">Estudiante 3</option>
                        <option value="estudiante4">Estudiante 4</option>
                        <option value="estudiante5">Estudiante 5</option>
                        <option value="estudiante6">Estudiante 6</option>
                        <option value="estudiante7">Estudiante 7</option>
                        <option value="estudiante8">Estudiante 8</option>
                        <option value="estudiante9">Estudiante 9</option>
                        <option value="estudiante10">Estudiante 10</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="appointment-date">Fecha:</label>
                    <input type="date" id="appointment-date" required>
                </div>
                <div class="form-group">
                    <label for="appointment-time">Hora inicio:</label>
                    <input type="time" id="appointment-time" required>
                </div>
                <div class="form-group">
                    <label for="appointment-duration">Duración:</label>
                    <select id="appointment-duration" required>
                        <option value="60">1 hora</option>
                        <option value="120">2 horas</option>
                        <option value="30">30 minutos</option>
                        <option value="90">1 hora 30 minutos</option>
                    </select>
                </div>

                <!-- Sección para citas recurrentes -->
                <div id="recurrence-options" style="display: none;">
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="is-recurring">
                            <label for="is-recurring">Cita recurrente</label>
                        </div>
                    </div>
                    <div id="recurring-details" style="display: none; padding-left: 20px; margin-top: 10px;">
                        <div class="form-group">
                            <label>Días de la semana:</label>
                            <div class="weekday-selector">
                                <label><input type="checkbox" name="weekday" value="1"> Lunes</label>
                                <label><input type="checkbox" name="weekday" value="2"> Martes</label>
                                <label><input type="checkbox" name="weekday" value="3"> Miércoles</label>
                                <label><input type="checkbox" name="weekday" value="4"> Jueves</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="recurrence-end">Fecha fin:</label>
                            <input type="date" id="recurrence-end">
                        </div>
                    </div>
                </div>

                <!-- Comuna de residencia -->
<div class="form-group">
    <label for="patient-comuna">Comuna de residencia:</label>
    <select id="patient-comuna" required>
        <option value="">Seleccionar comuna</option>
        <option value="Santiago">Santiago</option>
        <option value="Providencia">Providencia</option>
        <option value="Las Condes">Las Condes</option>
        <option value="Ñuñoa">Ñuñoa</option>
        <option value="La Reina">La Reina</option>
        <option value="Vitacura">Vitacura</option>
        <option value="Lo Barnechea">Lo Barnechea</option>
        <option value="Maipú">Maipú</option>
        <option value="La Florida">La Florida</option>
        <option value="Puente Alto">Puente Alto</option>
        <option value="San Bernardo">San Bernardo</option>
        <option value="Peñalolén">Peñalolén</option>
        <option value="Macul">Macul</option>
        <option value="Estación Central">Estación Central</option>
        <option value="Quinta Normal">Quinta Normal</option>
        <option value="Recoleta">Recoleta</option>
        <option value="Independencia">Independencia</option>
        <option value="Conchalí">Conchalí</option>
        <option value="Huechuraba">Huechuraba</option>
        <option value="Quilicura">Quilicura</option>
        <option value="Renca">Renca</option>
        <option value="Cerrillos">Cerrillos</option>
        <option value="Pedro Aguirre Cerda">Pedro Aguirre Cerda</option>
        <option value="Lo Espejo">Lo Espejo</option>
        <option value="San Joaquín">San Joaquín</option>
        <option value="La Cisterna">La Cisterna</option>
        <option value="San Miguel">San Miguel</option>
        <option value="San Ramón">San Ramón</option>
        <option value="La Granja">La Granja</option>
        <option value="El Bosque">El Bosque</option>
        <option value="La Pintana">La Pintana</option>
        <option value="Cerro Navia">Cerro Navia</option>
        <option value="Lo Prado">Lo Prado</option>
        <option value="Pudahuel">Pudahuel</option>
        <option value="Otro">Otro</option>
    </select>
</div>

<!-- Teléfono -->
<div class="form-group">
    <label for="patient-phone">Teléfono:</label>
    <input type="tel" id="patient-phone" placeholder="+56 9 XXXX XXXX">
</div>

<!-- Correo electrónico -->
<div class="form-group">
    <label for="patient-email">Correo electrónico:</label>
    <input type="email" id="patient-email" placeholder="ejemplo@correo.cl">
</div>
                
                <div class="form-group">
                    <label for="appointment-notes">Notas:</label>
                    <textarea id="appointment-notes"></textarea>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="is-web">
                        <label for="is-web">Vía web</label>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="button delete-btn" id="delete-appointment" style="display: none; margin-right: auto;">Eliminar</button>
                    <button type="button" class="button cancel-btn" id="cancel-appointment">Cancelar</button>
                    <button type="submit" class="button save-btn">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal para confirmar asistencia -->
    <div class="modal" id="attendance-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirmar Asistencia</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <p><strong>Paciente:</strong> <span id="attendance-patient"></span></p>
                <p><strong>Fecha:</strong> <span id="attendance-date"></span></p>
                <p><strong>Hora:</strong> <span id="attendance-time"></span></p>
                <div class="attendance-options">
                    <button class="attendance-btn" data-status="attended">Asistió</button>
                    <button class="attendance-btn" data-status="missed">No asistió</button>
                    <button class="attendance-btn" data-status="rescheduled">Reprogramada</button>
                </div>
                <div class="form-group">
                    <label for="attendance-notes">Notas:</label>
                    <textarea id="attendance-notes"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="button cancel-btn" id="cancel-attendance">Cancelar</button>
                <button class="button save-btn" id="save-attendance">Guardar</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>


    <script>
  // Configuración de Firebase - REEMPLAZA ESTOS VALORES CON LOS DE TU PROYECTO FIREBASE
const firebaseConfig = {
    apiKey: "AIzaSyA8fY-L1r3nBq61CFPOAFRI6TlS9A5GNTA",
    authDomain: "agendapoli-13963.firebaseapp.com",
    projectId: "agendapoli-13963",
    storageBucket: "agendapoli-13963.firebasestorage.app",
    messagingSenderId: "265927768586",
    appId: "1:265927768586:web:c7e37e6a561bd996687df3"
};

// Inicializar Firebase (con manejo de errores)
try {
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
        console.log("[DEBUG] Firebase inicializado correctamente");
    } else {
        console.log("[DEBUG] Firebase ya estaba inicializado");
    }
} catch (error) {
    console.error("[DEBUG] Error al inicializar Firebase:", error);
    alert("Error al inicializar Firebase. Por favor revisa la consola para detalles.");
}

// Referencias a Firebase
let auth, db;
try {
    auth = firebase.auth();
    db = firebase.firestore();
    console.log("[DEBUG] Referencias a auth y db creadas");
} catch (error) {
    console.error("[DEBUG] Error al crear referencias:", error);
    alert("Error al conectar con Firebase. Verifica tu conexión a internet.");
}

// Variables globales
let currentUser = null;
let isAdmin = false;
let appointments = [];
let editingAppointmentId = null;
let holidays = [];
let currentWeekDate = new Date();
let studentNames = {}; // Para guardar los nombres reales de los estudiantes
let uniquePatientsByStudent = {}; // Para estadísticas

// Elementos DOM
const spinner = document.getElementById('spinner');
const statusMessage = document.getElementById('status-message');
const loginContainer = document.getElementById('login-container');
const mainContainer = document.getElementById('main-container');
const appointmentModal = document.getElementById('appointment-modal');
const appointmentForm = document.getElementById('appointment-form');
const attendanceModal = document.getElementById('attendance-modal');
const currentWeekDisplay = document.getElementById('current-week');
const loginForm = document.getElementById('login-form');
const userNameDisplay = document.getElementById('user-name');
const logoutBtn = document.getElementById('logout-btn');

// Inicializar la aplicación
document.addEventListener('DOMContentLoaded', function() {
    // Mostrar spinner mientras carga
    showSpinner();
    
    // Verificar estado de autenticación
    auth.onAuthStateChanged(function(user) {
        console.log("[DEBUG] Estado de autenticación cambiado");
        
        if (user) {
            // Usuario autenticado
            currentUser = user;
            console.log("[DEBUG] Usuario autenticado:", user.email);
            console.log("[DEBUG] UID del usuario:", user.uid);
            userNameDisplay.textContent = user.email;
            
            // Esperar un momento antes de verificar el rol (para asegurar que Firebase esté listo)
            setTimeout(() => {
                checkUserRole(user.uid);
            }, 1000);
        } else {
            // Usuario no autenticado
            console.log("[DEBUG] No hay usuario autenticado");
            showLoginScreen();
            hideSpinner();
        }
    });
    
    // Configurar event listeners
    setupEventListeners();
    
    // Solución temporal: si después de 10 segundos sigue mostrando spinner, ocultarlo
    setTimeout(() => {
        if (spinner.style.display === 'flex') {
            hideSpinner();
            showStatusMessage('Carga completada', 'success');
        }
    }, 10000);
});

function checkUserRole(userId) {
    console.log("[DEBUG] Usuario autenticado:", userId);
    
    // Tratar a todos los usuarios como administradores
    isAdmin = true;
    document.body.classList.remove('student-view');
    
    try {
        // Obtener información del usuario para el historial
        db.collection('usuarios').doc(userId).get()
            .then((doc) => {
                if (doc.exists) {
                    // Guardar información del usuario para el historial
                    const userData = doc.data();
                    console.log("[DEBUG] Información del usuario:", userData);
                } else {
                    // Si no existe el documento del usuario, crearlo con timestamp
                    db.collection('usuarios').doc(userId).set({
                        email: currentUser.email,
                        ultimoAcceso: new Date().toISOString()
                    })
                    .then(() => {
                        console.log("[DEBUG] Documento de usuario creado");
                    })
                    .catch(error => {
                        console.error("[DEBUG] Error al crear documento de usuario:", error);
                        showStatusMessage("Error al guardar información de usuario", "error");
                    });
                }
                
                // Inicializar la agenda
                initializeApp();
            })
            .catch((error) => {
                console.error("[DEBUG] Error al obtener información del usuario:", error);
                showStatusMessage("Error al cargar datos de usuario", "error");
                
                // De todos modos inicializar la aplicación
                isAdmin = true;
                document.body.classList.remove('student-view');
                initializeApp();
            });
    } catch (error) {
        console.error("Error crítico al acceder a la base de datos:", error);
        showStatusMessage("Error de conexión con la base de datos", "error");
        
        // Fallback para permitir al usuario ver al menos algo
        isAdmin = true;
        document.body.classList.remove('student-view');
        initializeApp();
    }
}

// Inicializar la aplicación
// Inicializar la aplicación
function initializeApp() {
    loadHolidays();
    updateWeekDisplay();
    
    // Mostrar la interfaz principal
    loginContainer.style.display = 'none';
    mainContainer.style.display = 'block';
    
    // Optimizar la carga de datos
    optimizeInitialLoad();
    
    hideSpinner();
}

// Cargar nombres de estudiantes
function loadStudentNames() {
    return new Promise((resolve) => {
        const defaultStudents = {
            'estudiante1': 'Estudiante 1',
            'estudiante2': 'Estudiante 2',
            'estudiante3': 'Estudiante 3',
            'estudiante4': 'Estudiante 4',
            'estudiante5': 'Estudiante 5',
            'estudiante6': 'Estudiante 6',
            'estudiante7': 'Estudiante 7',
            'estudiante8': 'Estudiante 8',
            'estudiante9': 'Estudiante 9',
            'estudiante10': 'Estudiante 10'
        };
        
        db.collection('configuracion').doc('estudiantes').get()
            .then((doc) => {
                if (doc.exists) {
                    studentNames = doc.data();
                    // Combinar con estudiantes por defecto (para asegurar que todos existan)
                    studentNames = {...defaultStudents, ...studentNames};
                } else {
                    // Si no existe el documento, usar los nombres por defecto
                    studentNames = defaultStudents;
                    // Y crear el documento
                    db.collection('configuracion').doc('estudiantes').set(studentNames);
                }
                
                // Generar la lista de estudiantes en el panel de administración
                generateStudentsList();
                resolve();
            })
            .catch((error) => {
                console.error("Error al cargar nombres de estudiantes:", error);
                studentNames = defaultStudents;
                generateStudentsList();
                resolve();
            });
    });
}

// Generar la lista de estudiantes en el panel de administración
function generateStudentsList() {
    const studentList = document.getElementById('student-list');
    if (!studentList) return;
    
    studentList.innerHTML = '';
    
    // Actualizar el selector de estudiantes en el formulario
    const studentSelect = document.getElementById('student');
    if (studentSelect) {
        studentSelect.innerHTML = '';
    }
    
    for (const code in studentNames) {
        // Añadir al panel de administración
        const item = document.createElement('div');
        item.className = 'student-item';
        item.dataset.code = code;
        
        item.innerHTML = `
            <div class="student-code">${code}</div>
            <input type="text" class="student-name" placeholder="Nombre real" value="${studentNames[code]}">
            <button class="save-student-btn">Guardar</button>
        `;
        
        studentList.appendChild(item);
        
        // Configurar el botón de guardar
        const saveBtn = item.querySelector('.save-student-btn');
        saveBtn.addEventListener('click', function() {
            const input = item.querySelector('.student-name');
            saveStudentName(code, input.value);
        });
        
        // Actualizar el selector de estudiantes
        if (studentSelect) {
            const option = document.createElement('option');
            option.value = code;
            option.textContent = studentNames[code];
            studentSelect.appendChild(option);
        }
    }
}

// Guardar nombre de estudiante
function saveStudentName(code, name) {
    if (!name || name.trim() === '') {
        showStatusMessage('Por favor ingresa un nombre válido', 'warning');
        return;
    }
    
    showSpinner();
    console.log(`Guardando nombre para ${code}: ${name}`);
    
    const updateData = {};
    updateData[code] = name;
    
    db.collection('configuracion').doc('estudiantes').update(updateData)
        .then(() => {
            const oldName = studentNames[code] || code;
            studentNames[code] = name; // Actualizar en memoria
            showStatusMessage(`Nombre de ${code} actualizado a "${name}"`, 'success');
            console.log(`Nombre actualizado en configuración: ${oldName} → ${name}`);
            
            // Primero actualizar las referencias visuales y luego recargar
            updateStudentReferences(code, name);
        })
        .catch((error) => {
            console.error("Error al guardar nombre de estudiante:", error);
            showStatusMessage("Error al guardar el nombre", "error");
            hideSpinner();
        });
}

// Actualizar referencias visuales del estudiante y en la base de datos
function updateStudentReferences(code, name) {
    showSpinner();
    
    console.log(`Actualizando estudiante: ${code} a nombre: ${name}`);
    
    // Actualizar las tarjetas de cita visualmente
    document.querySelectorAll(`.appointment`).forEach(el => {
        const badgeEl = el.querySelector('.student-badge');
        if (badgeEl && (badgeEl.textContent === code || badgeEl.textContent === studentNames[code])) {
            badgeEl.textContent = name;
        }
    });
    
    // Actualizar las opciones del formulario
    const option = document.querySelector(`#student option[value="${code}"]`);
    if (option) {
        option.textContent = name;
    }
    
    // Actualizar todas las citas en la base de datos que tienen este estudiante
    db.collection('citas').where('estudiante', '==', code).get()
        .then((querySnapshot) => {
            console.log(`Encontradas ${querySnapshot.size} citas para actualizar`);
            
            // Si hay citas para actualizar
            if (!querySnapshot.empty) {
                const batch = db.batch();
                querySnapshot.forEach((doc) => {
                    batch.update(doc.ref, { 
                        estudianteNombre: name,
                        historial: firebase.firestore.FieldValue.arrayUnion({
                            accion: 'actualizacion_nombre_estudiante',
                            usuario: currentUser ? currentUser.email : 'sistema',
                            usuarioId: currentUser ? currentUser.uid : 'sistema',
                            fecha: new Date(),
                            detalles: `Nombre cambiado de ${studentNames[code]} a ${name}`
                        })
                    });
                });
                
                // Ejecutar todas las actualizaciones en un lote
                batch.commit()
                    .then(() => {
                        showStatusMessage(`Se actualizaron ${querySnapshot.size} citas con el nuevo nombre de estudiante`, 'success');
                        loadAppointments(); // Recargar citas
                    })
                    .catch((error) => {
                        console.error("Error al actualizar citas:", error);
                        showStatusMessage("Error al actualizar citas", "error");
                        hideSpinner();
                    });
            } else {
                showStatusMessage(`No se encontraron citas para el estudiante ${code}`, 'info');
                loadAppointments(); // Recargar citas de todos modos
                hideSpinner();
            }
        })
        .catch((error) => {
            console.error("Error al buscar citas para actualizar:", error);
            showStatusMessage("Error al buscar citas para actualizar", "error");
            hideSpinner();
        });
}

// Mostrar pantalla de login
function showLoginScreen() {
    loginContainer.style.display = 'block';
    mainContainer.style.display = 'none';
}

// Cargar los feriados chilenos
function loadHolidays() {
    holidays = [
        { date: '2025-01-01', name: 'Año Nuevo' },
        { date: '2025-04-18', name: 'Viernes Santo' },
        { date: '2025-04-19', name: 'Sábado Santo' },
        { date: '2025-05-01', name: 'Día del Trabajo' },
        { date: '2025-05-21', name: 'Día de las Glorias Navales' },
        { date: '2025-06-29', name: 'San Pedro y San Pablo' },
        { date: '2025-07-16', name: 'Virgen del Carmen' },
        { date: '2025-08-15', name: 'Asunción de la Virgen' },
        { date: '2025-09-18', name: 'Independencia Nacional' },
        { date: '2025-09-19', name: 'Día de las Glorias del Ejército' },
        { date: '2025-10-12', name: 'Encuentro de Dos Mundos' },
        { date: '2025-10-31', name: 'Día de las Iglesias Evangélicas' },
        { date: '2025-11-01', name: 'Día de Todos los Santos' },
        { date: '2025-12-08', name: 'Inmaculada Concepción' },
        { date: '2025-12-25', name: 'Navidad' }
    ];
}

// Actualizar la visualización de la semana actual
function updateWeekDisplay() {
    const startOfWeek = getStartOfWeek(currentWeekDate);
    
    // Actualizar el texto principal de la semana
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 3); // Solo hasta jueves (4 días)
    
    const startDay = startOfWeek.getDate();
    const endDay = endOfWeek.getDate();
    const startMonthName = getMonthName(startOfWeek.getMonth());
    const endMonthName = getMonthName(endOfWeek.getMonth());
    const year = startOfWeek.getFullYear();
    
    currentWeekDisplay.textContent = `Semana del ${startDay} al ${endDay} de ${endMonthName} de ${year}`;
    
    // Marcar feriados y días actuales
    const holidayDates = holidays.map(h => h.date);
    
    // Actualizar los encabezados de días con las fechas correspondientes
    for (let i = 1; i <= 4; i++) {
        const dayDate = new Date(startOfWeek);
        dayDate.setDate(startOfWeek.getDate() + (i - 1));
        
        const dayHeader = document.getElementById(`day-header-${i}`);
        const dateHeader = document.getElementById(`date-header-${i}`);
        
        if (dayHeader && dateHeader) {
            const dayNames = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
            dayHeader.textContent = dayNames[dayDate.getDay()];
            dateHeader.textContent = `${dayDate.getDate()}/${dayDate.getMonth() + 1}`;
            
            // Verificar si es feriado
            const dateStr = formatDate(dayDate);
            const isHoliday = holidayDates.includes(dateStr);
            
            // Resaltar el día actual si está en la semana mostrada
            const today = new Date();
            const isToday = dayDate.toDateString() === today.toDateString();
            
            // Aplicar clases según el caso
            if (isHoliday) {
                dayHeader.style.color = 'var(--error)';
                dateHeader.style.color = 'var(--error)';
                document.querySelectorAll(`.schedule-cell[data-day="${i}"]`).forEach(cell => {
                    cell.classList.add('holiday-cell');
                    cell.title = "Feriado: " + holidays.find(h => h.date === dateStr).name;
                });
            } else {
                dayHeader.style.color = '';
                dateHeader.style.color = '';
                document.querySelectorAll(`.schedule-cell[data-day="${i}"]`).forEach(cell => {
                    cell.classList.remove('holiday-cell');
                    cell.title = "";
                });
            }
            
            if (isToday) {
                dayHeader.classList.add('current-day');
                dateHeader.classList.add('current-day');
                document.querySelectorAll(`.schedule-cell[data-day="${i}"]`).forEach(cell => {
                    cell.classList.add('current-day');
                });
            } else {
                dayHeader.classList.remove('current-day');
                dateHeader.classList.remove('current-day');
                document.querySelectorAll(`.schedule-cell[data-day="${i}"]`).forEach(cell => {
                    cell.classList.remove('current-day');
                });
            }
        }
    }
}

// Obtener el primer día de la semana (lunes)
function getStartOfWeek(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Ajusta cuando el día es domingo
    const monday = new Date(d.setDate(diff));
    monday.setHours(0, 0, 0, 0);
    return monday;
}

// Obtener nombre del mes en español
function getMonthName(month) {
    const months = [
        'enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 
        'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'
    ];
    return months[month];
}

// Modificar la función loadAppointments() para que funcione correctamente
function loadAppointments() {
    showSpinner();
    
    // Obtener fecha de inicio y fin de la semana
    const startOfWeek = getStartOfWeek(currentWeekDate);
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 4); // Un día después del jueves
    
    try {
        // Consulta a Firestore
        db.collection('citas').get()
            .then((querySnapshot) => {
                appointments = [];
                
                querySnapshot.forEach((doc) => {
                    try {
                        // Convertir datos a formato utilizable
                        const data = doc.data();
                        
                        // Convertir el campo fecha a un objeto Date
                        let appointmentDate;
                        if (data.fecha && data.fecha.toDate) {
                            appointmentDate = data.fecha.toDate();
                        } else if (data.fecha) {
                            appointmentDate = new Date(data.fecha);
                        } else {
                            // Si no hay fecha, saltarse esta cita
                            console.warn("Cita sin fecha encontrada, ID:", doc.id);
                            return;
                        }
                        
                        // Filtrar solo las citas de esta semana
                        if (appointmentDate >= startOfWeek && appointmentDate < endOfWeek) {
                            const appointment = {
                                id: doc.id,
                                ...data,
                                fecha: appointmentDate
                            };
                            
                            appointments.push(appointment);
                        }
                    } catch (error) {
                        console.error("Error procesando cita individual:", error);
                    }
                });
                
                console.log(`Se cargaron ${appointments.length} citas para la semana actual`);
                
                // Renderizar citas y actualizar estadísticas
                renderAppointments();
                updateStatistics();
                
                // Cargar estadísticas históricas (solo una vez aquí)
                loadHistoricalPatientStats();
                
                hideSpinner();
            })
            .catch((error) => {
                console.error("Error al cargar citas:", error);
                showStatusMessage("Error al cargar citas. Cargando datos de ejemplo.", "warning");
                loadSampleAppointments(); // Cargar datos de ejemplo en caso de error
                hideSpinner();
            });
    } catch (error) {
        console.error("Error crítico al cargar citas:", error);
        showStatusMessage("Error de conexión. Cargando datos de ejemplo.", "error");
        loadSampleAppointments();
        hideSpinner();
    }
}

        // Función para normalizar el nombre de un paciente (para comparaciones)
function normalizePatientName(name) {
    return name.toLowerCase().trim().replace(/\s+/g, ' ');
}

// Función para actualizar todas las citas futuras de un paciente
function updateFutureAppointmentsForPatient(patientName, updatedData) {
    if (!patientName) return Promise.resolve();
    
    showSpinner();
    console.log(`Actualizando datos del paciente "${patientName}" en citas futuras...`);
    
    // Normalizar el nombre para búsqueda insensible a mayúsculas/minúsculas
    const normalizedName = normalizePatientName(patientName);
    
    // Obtener fecha actual para filtrar solo citas futuras
    const now = new Date();
    
    // Consultar todas las citas futuras (no podemos filtrar por nombre normalizado en Firestore)
    return db.collection('citas')
        .where('fecha', '>', now)
        .get()
        .then((querySnapshot) => {
            if (querySnapshot.empty) {
                console.log(`No se encontraron citas futuras`);
                return Promise.resolve();
            }
            
            // Filtrar manualmente por nombre normalizado
            const matchingDocs = [];
            querySnapshot.forEach(doc => {
                const data = doc.data();
                if (data.paciente && normalizePatientName(data.paciente) === normalizedName) {
                    matchingDocs.push(doc);
                }
            });
            
            if (matchingDocs.length === 0) {
                console.log(`No se encontraron citas futuras para ${patientName}`);
                return Promise.resolve();
            }
            
            console.log(`Se encontraron ${matchingDocs.length} citas futuras para actualizar`);
            
            // Crear batch para actualización masiva
            const batch = db.batch();
            let updatedCount = 0;
            
            matchingDocs.forEach(doc => {
                // Solo actualizar datos de contacto y detalles personales
                // (no fechas, estudiantes, etc.)
                const updateFields = {};
                
                if (updatedData.telefono !== undefined) updateFields.telefono = updatedData.telefono;
                if (updatedData.correo !== undefined) updateFields.correo = updatedData.correo;
                if (updatedData.comuna !== undefined) updateFields.comuna = updatedData.comuna;
                
                // Añadir registro en historial
                updateFields.historial = firebase.firestore.FieldValue.arrayUnion({
                    accion: 'actualizacion_datos_contacto',
                    usuario: currentUser ? currentUser.email : 'sistema',
                    usuarioId: currentUser ? currentUser.uid : 'sistema',
                    fecha: new Date(),
                    detalles: 'Actualización automática de datos de contacto'
                });
                
                // Solo actualizar si hay campos para actualizar
                if (Object.keys(updateFields).length > 0) {
                    batch.update(doc.ref, updateFields);
                    updatedCount++;
                }
            });
            
            // Ejecutar batch solo si hay actualizaciones
            if (updatedCount > 0) {
                return batch.commit().then(() => {
                    console.log(`Actualizadas ${updatedCount} citas futuras para ${patientName}`);
                    return updatedCount;
                });
            } else {
                console.log('No se requieren actualizaciones');
                return Promise.resolve(0);
            }
        })
        .catch(error => {
            console.error("Error al actualizar citas futuras:", error);
            hideSpinner();
            showStatusMessage("Error al actualizar datos en citas futuras", "error");
            return Promise.reject(error);
        });
}
        
// Cargar citas de ejemplo (en caso de error o para la primera vez)
function loadSampleAppointments() {
    // Fecha de referencia (lunes de la semana actual)
    const startOfWeek = getStartOfWeek(currentWeekDate);
    
    appointments = [
        {
            id: '1',
            paciente: 'María González',
            tipo: 'Evaluación kinesiología MSK',
            tipoClase: 'evaluacion-msk',
            fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate(), 9, 0),
            duracion: 60,
            terapeuta: 'nicolas',
            estudiante: 'estudiante1'
        },
        {
            id: '2',
            paciente: 'Ana Martínez',
            tipo: 'Sesión kinesiología MSK',
            tipoClase: 'sesion-msk',
            fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate(), 11, 0),
            duracion: 60,
            terapeuta: 'ana-maria',
            estudiante: 'estudiante2'
        },
        {
            id: '3',
            paciente: 'Laura Pérez',
            tipo: 'Evaluación kinesiología deportiva',
            tipoClase: 'evaluacion-deportiva',
            fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate(), 13, 0),
            duracion: 60,
            terapeuta: 'nicolas',
            estudiante: 'estudiante3'
        },
        {
            id: '4',
            paciente: 'Isabel Rodríguez',
            tipo: 'Sesión kinesiología deportiva',
            tipoClase: 'sesion-deportiva',
            fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate() + 1, 10, 0),
            duracion: 60,
            terapeuta: 'ana-maria',
            estudiante: 'estudiante4',
            esRecurrente: true
        }
    ];
    
    renderAppointments();
    updateStatistics();
}

// Mejorar la función renderAppointments() con más logs y mejor manejo de errores
function renderAppointments() {
console.log("🔍 Iniciando renderizado de citas...");
    console.log(`📊 Total de citas encontradas: ${appointments.length}`);
    
    try {
        // Primero limpiar todas las citas existentes
        const existingAppointments = document.querySelectorAll('.appointment');
        existingAppointments.forEach(el => el.remove());
        console.log(`🧹 Se eliminaron ${existingAppointments.length} citas existentes del DOM`);
        
        // Si no hay citas, mostrar mensaje y salir
        if (appointments.length === 0) {
            console.log("⚠️ No hay citas para mostrar en esta semana");
            return;
        }
        
        // Fecha de referencia (lunes de la semana actual)
        const startOfWeek = getStartOfWeek(currentWeekDate);
        console.log(`📅 Semana actual comienza: ${startOfWeek.toDateString()}`);
        
        // Renderizar citas
        appointments.forEach((appointment, index) => {
            try {
                if (!appointment.fecha) {
                    console.error(`❌ Cita #${index+1} sin fecha:`, appointment);
                    return;
                }
                
                const appointmentDate = appointment.fecha;
                
                // Calcular diferencia de días desde el inicio de la semana
                const timeDiff = appointmentDate.getTime() - startOfWeek.getTime();
                const dayDiff = Math.floor(timeDiff / (24 * 60 * 60 * 1000));
                
                console.log(`📌 Cita #${index+1} - Paciente: ${appointment.paciente} - Día: ${dayDiff} - Hora: ${appointmentDate.getHours()}`);
                
                // Solo mostrar citas de lunes a jueves (0-3)
                if (dayDiff >= 0 && dayDiff < 4) {
                    const hour = appointmentDate.getHours();
                    const dayIndex = dayDiff + 1; // 1 para lunes, 2 para martes, etc.
                    
                    // Buscar la celda correcta en el DOM
                    const cellSelector = `.schedule-cell[data-hour="${hour}"][data-day="${dayIndex}"]`;
                    const cell = document.querySelector(cellSelector);
                    
                    if (!cell) {
                        console.warn(`⚠️ No se encontró celda para día ${dayIndex}, hora ${hour} (selector: ${cellSelector})`);
                        return;
                    }
                    
                    console.log(`✅ Celda encontrada para día ${dayIndex}, hora ${hour}`);
                    
                    // Crear elemento de cita
                    const appointmentEl = document.createElement('div');
                    appointmentEl.className = `appointment ${appointment.tipoClase || ''}`;
                    
                    // Añadir clase de estudiante
                    if (appointment.estudiante) {
                        appointmentEl.classList.add(appointment.estudiante);
                    } else {
                        appointmentEl.classList.add('estudiante1'); // Estudiante por defecto
                    }
                    
                    // ID de la cita
                    appointmentEl.dataset.id = appointment.id;
                    
                    // Si es recurrente
                    if (appointment.esRecurrente) {
                        appointmentEl.classList.add('recurring');
                    }
                    
                    // Mostrar kinesiólogo para sesiones
                    const showTherapist = appointment.tipoClase && appointment.tipoClase.startsWith('sesion-');
                    
                    // Contenido de la cita
                    let content = `
                        <div class="appointment-title">${appointment.paciente || 'Sin nombre'}</div>
                        <div class="appointment-type">${getAppointmentTypeIcon(appointment.tipoClase)} ${appointment.tipo || 'Sin tipo'}</div>
                    `;
                    
                    if (showTherapist) {
                        content += `<div class="appointment-therapist">${getTherapistName(appointment.terapeuta)}</div>`;
                    }
                    
                    // Estudiante asignado
                    const studentCode = appointment.estudiante || 'Sin asignar';
                    const studentName = studentNames[studentCode] || studentCode;
                    content += `<div class="student-badge">${studentName}</div>`;
                    
                    appointmentEl.innerHTML = content;
                    
                    // Estado de la cita
                    if (appointment.estado) {
                        const statusEl = document.createElement('div');
                        statusEl.className = `appointment-status ${appointment.estado}`;
                        appointmentEl.appendChild(statusEl);
                    }
                    
                    // Indicador web
                    if (appointment.web) {
                        const webEl = document.createElement('div');
                        webEl.className = 'web-indicator';
                        webEl.innerHTML = '🌐';
                        appointmentEl.appendChild(webEl);
                    }
                    
                    // Agregar a la celda
                    cell.appendChild(appointmentEl);
                    console.log(`✅ Cita #${index+1} añadida a la celda`);
                    
                    // Configurar eventos
                    appointmentEl.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const app = appointments.find(a => a.id === this.dataset.id);
                        if (app) {
                            if (isAdmin) {
                                // Si es administrador, siempre permite editar cualquier cita
                                openAppointmentModal(app);
                            } else {
                                // Si no es administrador, solo mostrar detalles
                                viewAppointmentDetails(app);
                            }
                        }
                    });
                    
                    // Arrastrar y soltar
                    if (isAdmin) {
                        appointmentEl.setAttribute('draggable', 'true');
                        appointmentEl.addEventListener('dragstart', function(e) {
                            e.dataTransfer.setData('text/plain', this.dataset.id);
                        });
                    }
                } else {
                    console.log(`⏩ Cita #${index+1} fuera del rango de la semana (dayDiff: ${dayDiff})`);
                }
            } catch (error) {
                console.error(`❌ Error al renderizar cita #${index+1}:`, error, appointment);
            }
        });
        
        console.log("✅ Renderizado de citas completado");
    } catch (error) {
        console.error("❌ Error general al renderizar citas:", error);
        showStatusMessage("Error al mostrar las citas en la agenda", "error");
    }
}

// Mostrar detalles de la cita (para estudiantes)
function viewAppointmentDetails(appointment) {
    const options = { 
        weekday: 'long', 
        day: 'numeric', 
        month: 'long', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    };
    
    let details = `
        Paciente: ${appointment.paciente || 'Sin nombre'}
        Tipo: ${appointment.tipo || 'Sin especificar'}
        Fecha: ${appointment.fecha ? appointment.fecha.toLocaleDateString('es-ES', options) : 'Fecha no disponible'}
        Kinesiólogo: ${getTherapistName(appointment.terapeuta)}
        Estudiante: ${appointment.estudiante || 'Sin asignar'}
    `;
    
    if (appointment.estado) {
        details += `\nEstado: ${getStatusText(appointment.estado)}`;
    }
    
    alert(details);
}

// Obtener nombre completo del terapeuta
function getTherapistName(therapistId) {
    switch(therapistId) {
        case 'nicolas': return 'Nicolás';
        case 'ana-maria': return 'Ana María';
        case 'gustavo': return 'Gustavo';
        default: return therapistId || 'Sin asignar';
    }
}

// Obtener texto del estado
function getStatusText(status) {
    switch(status) {
        case 'attended': return 'Asistió';
        case 'missed': return 'No asistió';
        case 'rescheduled': return 'Reprogramada';
        default: return status;
    }
}

// Obtener icono según tipo de cita
function getAppointmentTypeIcon(typeClass) {
    switch(typeClass) {
        case 'evaluacion-msk': return '📋'; // Portapapeles para evaluación MSK
        case 'evaluacion-deportiva': return '📕'; // Persona corriendo para evaluación deportiva
        case 'sesion-msk': return '💪'; // Músculo para sesión MSK
        case 'sesion-deportiva': return '🏋️‍♀️'; // Trofeo para sesión deportiva
        default: return '📅'; // Calendario como icono por defecto
    }
}
        
// Actualizar estadísticas
// Actualizar estadísticas
// Actualizar estadísticas con clara diferenciación
function updateStatistics() {
    console.log("🔍 Actualizando estadísticas...");
    
    try {
        // Sesiones AGENDADAS vs REALIZADAS
        const totalAppointments = appointments.length;
        const attendedAppointments = appointments.filter(a => a.estado === 'attended').length;
        const missedAppointments = appointments.filter(a => a.estado === 'missed').length;
        const rescheduledAppointments = appointments.filter(a => a.estado === 'rescheduled').length;
        const pendingAppointments = totalAppointments - (attendedAppointments + missedAppointments + rescheduledAppointments);
        
        const attendanceRate = totalAppointments > 0 
            ? Math.round((attendedAppointments / totalAppointments) * 100) 
            : 0;
        
        console.log(`📊 Citas agendadas: ${totalAppointments}, Asistidas: ${attendedAppointments}, Tasa: ${attendanceRate}%`);
        
        // Citas por hora
        const appointmentsByHour = {};
        appointments.forEach(a => {
            if (a.fecha) {
                const hour = a.fecha.getHours();
                appointmentsByHour[hour] = (appointmentsByHour[hour] || 0) + 1;
            }
        });
        
        // Encontrar la hora más ocupada
        let busiestHour = 9; // Por defecto 9:00
        let maxAppointments = 0;
        
        for (const hour in appointmentsByHour) {
            if (appointmentsByHour[hour] > maxAppointments) {
                busiestHour = parseInt(hour);
                maxAppointments = appointmentsByHour[hour];
            }
        }
        
        // Calcular pacientes únicos por estudiante Y sesiones totales
        uniquePatientsByStudent = {};
        const sessionsByStudent = {};
        const attendedSessionsByStudent = {}; // NUEVO: Solo sesiones asistidas
        const patientsByStudent = {};
        
        // NUEVO: Rastrear pacientes únicos que realmente asistieron
        const uniqueAttendedPatientsByStudent = {};
        const attendedPatientsByStudent = {};
        
        // Estadísticas de asistencia por estudiante
        const attendanceByStudent = {};
        const missedByStudent = {};
        
        // Contador de tipos de cita
        const appointmentTypes = {};
        const attendedAppointmentTypes = {}; // NUEVO: Solo tipos asistidos
        
        // NUEVO: Contador de sesiones por paciente (agendadas vs asistidas)
        const sessionsPerPatient = {};
        const attendedSessionsPerPatient = {};
        
        // NUEVO: Contador de comunas por paciente único
        const comunaCounter = {};
        const pacientesComunas = {}; // Para rastrear pacientes ya contados
        appointments.forEach(a => {
            if (!a.estudiante || !a.paciente) return;
            
            // Contar tipos de cita (agendadas)
            const tipoClase = a.tipoClase || 'sin-tipo';
            appointmentTypes[tipoClase] = (appointmentTypes[tipoClase] || 0) + 1;
            
            // NUEVO: Contar comunas si existe
            // NUEVO: Contar comunas solo una vez por paciente
            if (a.comuna) {
                const patientKey = a.paciente.toLowerCase();
                if (!pacientesComunas[patientKey + a.comuna]) {
                    pacientesComunas[patientKey + a.comuna] = true;
                    comunaCounter[a.comuna] = (comunaCounter[a.comuna] || 0) + 1;
                }
            }
            
            // Contar sesiones por paciente (agendadas)
            const patientKey = a.paciente.toLowerCase();
            sessionsPerPatient[patientKey] = (sessionsPerPatient[patientKey] || 0) + 1;
            
            // NUEVO: Contar sesiones asistidas por paciente
            if (a.estado === 'attended') {
                attendedSessionsPerPatient[patientKey] = (attendedSessionsPerPatient[patientKey] || 0) + 1;
                
                // Contar tipos de cita asistidas
                attendedAppointmentTypes[tipoClase] = (attendedAppointmentTypes[tipoClase] || 0) + 1;
            }
            
            // Contar sesiones totales por estudiante (agendadas)
            sessionsByStudent[a.estudiante] = (sessionsByStudent[a.estudiante] || 0) + 1;
            
            // NUEVO: Contar sesiones asistidas por estudiante
            if (a.estado === 'attended') {
                attendedSessionsByStudent[a.estudiante] = (attendedSessionsByStudent[a.estudiante] || 0) + 1;
            }
            
            // Contar asistencias y faltas por estudiante
            if (a.estado === 'attended') {
                attendanceByStudent[a.estudiante] = (attendanceByStudent[a.estudiante] || 0) + 1;
                
                // NUEVO: Registrar pacientes que asistieron
                if (!attendedPatientsByStudent[a.estudiante]) {
                    attendedPatientsByStudent[a.estudiante] = [];
                }
                
                if (!attendedPatientsByStudent[a.estudiante].includes(a.paciente)) {
                    attendedPatientsByStudent[a.estudiante].push(a.paciente);
                }
            } else if (a.estado === 'missed') {
                missedByStudent[a.estudiante] = (missedByStudent[a.estudiante] || 0) + 1;
            }
            
            // Inicializar arrays si no existen
            if (!patientsByStudent[a.estudiante]) {
                patientsByStudent[a.estudiante] = [];
            }
            
            // Añadir paciente si no está ya (para evitar duplicados)
            if (!patientsByStudent[a.estudiante].includes(a.paciente)) {
                patientsByStudent[a.estudiante].push(a.paciente);
            }
        });
        
        // Contar pacientes únicos (agendados)
        for (const student in patientsByStudent) {
            uniquePatientsByStudent[student] = patientsByStudent[student].length;
        }
        
        // NUEVO: Contar pacientes únicos que asistieron
        for (const student in attendedPatientsByStudent) {
            uniqueAttendedPatientsByStudent[student] = attendedPatientsByStudent[student].length;
        }
        
        // Calcular tasa de asistencia por estudiante
        const attendanceRateByStudent = {};
        for (const student in sessionsByStudent) {
            const attended = attendanceByStudent[student] || 0;
            const total = (attendanceByStudent[student] || 0) + (missedByStudent[student] || 0);
            attendanceRateByStudent[student] = total > 0 ? Math.round((attended / total) * 100) : 0;
        }
        
        // Actualizar DOM
        document.getElementById('attendance-rate').textContent = `${attendanceRate}%`;
        document.getElementById('total-appointments').textContent = appointments.length;
        document.getElementById('busiest-hour').textContent = `${busiestHour}:00`;
        
        // Actualizar tabla de estudiantes con datos diferenciados
        updateStudentStatsTable(
            uniquePatientsByStudent, 
            sessionsByStudent, 
            attendanceRateByStudent, 
            uniqueAttendedPatientsByStudent,  // NUEVO
            attendedSessionsByStudent         // NUEVO
        );
        
        // Crear gráfico circular para tipos de cita
        createAppointmentTypeChartFixed(appointmentTypes, attendedAppointmentTypes);
        
        // Añadir tabla de evolución de pacientes
        createPatientEvolutionTableFixed(sessionsPerPatient, attendedSessionsPerPatient);
        
        // Crear gráfico de asistencia vs faltas
        createAttendanceChartFixed(attendedAppointments, missedAppointments, rescheduledAppointments);
        
        // NUEVO: Crear gráfico de comunas
        createComunasChartFixed(comunaCounter);
        
        console.log("✅ Actualización de estadísticas completada");
    } catch (error) {
        console.error("❌ Error al actualizar estadísticas:", error);
    }
}

// Cargar historial de pacientes con estadísticas de asistencia
function loadHistoricalPatientStats() {
    showSpinner();
    
    // Consultar TODAS las citas en Firestore (sin filtro de fecha)
    db.collection('citas').get()
        .then((querySnapshot) => {
            // Contador de sesiones por paciente (histórico)
            const historicalSessionsByPatient = {};
            
            // Contadores para asistencia
            const attendedByPatient = {};
            const missedByPatient = {};
            const rescheduledByPatient = {};
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                if (data.paciente) {
                    const patientKey = data.paciente.toLowerCase();
                    historicalSessionsByPatient[patientKey] = (historicalSessionsByPatient[patientKey] || 0) + 1;
                    
                    // Contabilizar estado de asistencia
                    if (data.estado === 'attended') {
                        attendedByPatient[patientKey] = (attendedByPatient[patientKey] || 0) + 1;
                    } else if (data.estado === 'missed') {
                        missedByPatient[patientKey] = (missedByPatient[patientKey] || 0) + 1;
                    } else if (data.estado === 'rescheduled') {
                        rescheduledByPatient[patientKey] = (rescheduledByPatient[patientKey] || 0) + 1;
                    }
                }
            });
            
            // Crear la sección para estadísticas históricas con datos de asistencia
            createHistoricalPatientStatsSection(
                historicalSessionsByPatient, 
                attendedByPatient, 
                missedByPatient, 
                rescheduledByPatient
            );
            
            hideSpinner();
        })
        .catch((error) => {
            console.error("Error al cargar estadísticas históricas:", error);
            hideSpinner();
            
            // En caso de error, mostrar datos de ejemplo
            const sampleData = {
                'juan pérez': 12,
                'maría garcía': 8,
                'carlos rodríguez': 5,
                'ana martínez': 3,
                'luis gonzález': 9
            };
            
            const sampleAttended = {
                'juan pérez': 10,
                'maría garcía': 7,
                'carlos rodríguez': 4,
                'ana martínez': 2,
                'luis gonzález': 7
            };
            
            const sampleMissed = {
                'juan pérez': 2,
                'maría garcía': 1,
                'carlos rodríguez': 1,
                'ana martínez': 1,
                'luis gonzález': 2
            };
            
            createHistoricalPatientStatsSection(sampleData, sampleAttended, sampleMissed, {});
        });
}

// Función para crear la sección de estadísticas históricas
function createHistoricalPatientStatsSection(historicalData, attendedData, missedData, rescheduledData) {
    // Verificar si existe la sección, si no, crearla
    let historicalSection = document.getElementById('historical-stats-section');
    
    if (!historicalSection) {
        const statsPanel = document.querySelector('.stats-panel');
        if (!statsPanel) return;
        
        historicalSection = document.createElement('div');
        historicalSection.id = 'historical-stats-section';
        historicalSection.className = 'stats-section';
        
        const sectionTitle = document.createElement('h4');
        sectionTitle.className = 'therapist-stats-title';
        sectionTitle.textContent = 'Historial Completo de Sesiones por Paciente';
        historicalSection.appendChild(sectionTitle);
        
        statsPanel.appendChild(historicalSection);
    } else {
        // Limpiar contenido previo pero mantener el título
        const title = historicalSection.querySelector('.therapist-stats-title');
        historicalSection.innerHTML = '';
        if (title) historicalSection.appendChild(title);
    }
    
    // Convertir los datos a un array para poder ordenarlos
    const patientsArray = Object.keys(historicalData).map(patient => ({
        name: patient,
        sessions: historicalData[patient],
        attended: attendedData[patient] || 0,
        missed: missedData[patient] || 0,
        rescheduled: rescheduledData[patient] || 0
    }));
    
    // Ordenar por número de ASISTENCIAS (descendente)
    patientsArray.sort((a, b) => b.attended - a.attended);
    
    // Crear tabla
    const table = document.createElement('table');
    table.className = 'student-stats-table';
    
    // Encabezado
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    
    ['Paciente', 'Total Histórico', 'Asistió', 'No Asistió', 'Estado de Evolución'].forEach(text => {
        const th = document.createElement('th');
        th.textContent = text;
        headerRow.appendChild(th);
    });
    
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // Cuerpo de la tabla
    const tbody = document.createElement('tbody');
    
    patientsArray.forEach(patient => {
        const row = document.createElement('tr');
        
        // Nombre del paciente (con primera letra capitalizada)
        const nameCell = document.createElement('td');
        nameCell.textContent = patient.name
            .split(' ')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
        
        // Número de sesiones
        const sessionsCell = document.createElement('td');
        sessionsCell.textContent = patient.sessions;
        
        // Asistencias
        const attendedCell = document.createElement('td');
        const attendanceRate = patient.sessions > 0 
            ? Math.round((patient.attended / patient.sessions) * 100) 
            : 0;
        
        const attendanceText = document.createElement('div');
        attendanceText.innerHTML = `${patient.attended} <span style="color: #718096;">(${attendanceRate}%)</span>`;
        attendedCell.appendChild(attendanceText);
        
        // Faltas
        const missedCell = document.createElement('td');
        missedCell.textContent = patient.missed;
        
        // Estado de evolución basado en ASISTENCIAS con nuevos umbrales
        const evolutionCell = document.createElement('td');
        let evolutionStatus = '';
        let statusColor = '';
        
        if (patient.attended === 0) {
            evolutionStatus = 'Sin asistencias';
            statusColor = '#B0BEC5'; // Gris
        } else if (patient.attended === 1) {
            evolutionStatus = 'Evaluación Inicial';
            statusColor = '#FFC107'; // Amarillo
        } else if (patient.attended >= 2 && patient.attended <= 14) {
            evolutionStatus = 'En Tratamiento';
            statusColor = '#2196F3'; // Azul
        } else if (patient.attended >= 15 && patient.attended <= 19) {
            evolutionStatus = 'Avanzado';
            statusColor = '#4CAF50'; // Verde
        } else if (patient.attended >= 20) {
            evolutionStatus = 'Fase Final';
            statusColor = '#9C27B0'; // Púrpura
        }
        
        const statusIndicator = document.createElement('span');
        statusIndicator.textContent = evolutionStatus;
        statusIndicator.style.display = 'inline-block';
        statusIndicator.style.padding = '3px 8px';
        statusIndicator.style.borderRadius = '4px';
        statusIndicator.style.backgroundColor = statusColor;
        statusIndicator.style.color = 'white';
        statusIndicator.style.fontWeight = '500';
        statusIndicator.style.fontSize = '12px';
        
        evolutionCell.appendChild(statusIndicator);
        
        row.appendChild(nameCell);
        row.appendChild(sessionsCell);
        row.appendChild(attendedCell);
        row.appendChild(missedCell);
        row.appendChild(evolutionCell);
        tbody.appendChild(row);
    });
    
    table.appendChild(tbody);
    historicalSection.appendChild(table);
    
    // Resumen de evolución de pacientes
    const summaryContainer = document.createElement('div');
    summaryContainer.style.marginTop = '20px';
    summaryContainer.style.display = 'flex';
    summaryContainer.style.flexWrap = 'wrap';
    summaryContainer.style.justifyContent = 'center';
    summaryContainer.style.gap = '15px';
    
    // CORRECCIÓN: Actualizar categorías con nuevos umbrales
    const statusTypes = [
        { name: 'Evaluación Inicial', criteria: 'pacientes con 1 sesión asistida', color: '#FFC107' },
        { name: 'En Tratamiento', criteria: 'pacientes con 2-14 sesiones asistidas', color: '#2196F3' },
        { name: 'Avanzado', criteria: 'pacientes con 15-19 sesiones asistidas', color: '#4CAF50' },
        { name: 'Fase Final', criteria: 'pacientes con 20+ sesiones asistidas', color: '#9C27B0' }
    ];
    
    // Contar pacientes por etapa basado en ASISTENCIAS
    const initialCount = patientsArray.filter(p => p.attended === 1).length;
    const treatmentCount = patientsArray.filter(p => p.attended >= 2 && p.attended <= 14).length;
    const advancedCount = patientsArray.filter(p => p.attended >= 15 && p.attended <= 19).length;
    const finalCount = patientsArray.filter(p => p.attended >= 20).length;
    
    const counts = [initialCount, treatmentCount, advancedCount, finalCount];
    
    statusTypes.forEach((status, index) => {
        const statusBox = document.createElement('div');
        statusBox.style.padding = '10px 15px';
        statusBox.style.backgroundColor = 'white';
        statusBox.style.borderRadius = '8px';
        statusBox.style.boxShadow = 'var(--shadow)';
        statusBox.style.textAlign = 'center';
        statusBox.style.flex = '1';
        statusBox.style.minWidth = '150px';
        statusBox.style.maxWidth = '200px';
        statusBox.style.borderTop = `4px solid ${status.color}`;
        
        const statusTitle = document.createElement('div');
        statusTitle.textContent = status.name;
        statusTitle.style.fontWeight = 'bold';
        statusTitle.style.marginBottom = '5px';
        
        const statusCount = document.createElement('div');
        statusCount.textContent = counts[index];
        statusCount.style.fontSize = '24px';
        statusCount.style.fontWeight = 'bold';
        statusCount.style.color = status.color;
        
        const statusDescription = document.createElement('div');
        statusDescription.textContent = status.criteria;
        statusDescription.style.fontSize = '12px';
        statusDescription.style.color = 'var(--text-secondary)';
        
        statusBox.appendChild(statusTitle);
        statusBox.appendChild(statusCount);
        statusBox.appendChild(statusDescription);
        
        summaryContainer.appendChild(statusBox);
    });
    
    historicalSection.appendChild(summaryContainer);
}
        
// Nueva función para actualizar el gráfico de estudiantes con ambas métricas
function updateStudentChart(uniquePatients, totalSessions) {
    const chartContainer = document.getElementById('student-chart');
    const chartLabels = document.getElementById('student-chart-labels');
    
    if (chartContainer && chartLabels) {
        chartContainer.innerHTML = '';
        chartLabels.innerHTML = '';
        
        // Crear tabla de estadísticas en lugar de gráfico
        const statsTable = document.createElement('table');
        statsTable.className = 'student-stats-table';
        statsTable.style.width = '100%';
        statsTable.style.borderCollapse = 'collapse';
        statsTable.style.marginTop = '20px';
        
        // Crear encabezado
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        
        ['Estudiante', 'Pacientes Únicos', 'Total Sesiones'].forEach(text => {
            const th = document.createElement('th');
            th.textContent = text;
            th.style.padding = '10px';
            th.style.textAlign = 'left';
            th.style.borderBottom = '2px solid var(--border)';
            headerRow.appendChild(th);
        });
        
        thead.appendChild(headerRow);
        statsTable.appendChild(thead);
        
        // Crear cuerpo de tabla
        const tbody = document.createElement('tbody');
        
        // Ordenar estudiantes por número de pacientes
        const sortedStudents = Object.keys(uniquePatients || {}).sort((a, b) => 
            (uniquePatients[b] || 0) - (uniquePatients[a] || 0)
        );
        
        sortedStudents.forEach(student => {
            const row = document.createElement('tr');
            
            // Nombre del estudiante
            const nameCell = document.createElement('td');
            nameCell.textContent = studentNames[student] || student;
            nameCell.style.padding = '10px';
            nameCell.style.borderBottom = '1px solid var(--border)';
            
            // Número de pacientes únicos
            const patientsCell = document.createElement('td');
            patientsCell.textContent = uniquePatients[student] || 0;
            patientsCell.style.padding = '10px';
            patientsCell.style.borderBottom = '1px solid var(--border)';
            
            // Número total de sesiones
            const sessionsCell = document.createElement('td');
            sessionsCell.textContent = totalSessions[student] || 0;
            sessionsCell.style.padding = '10px';
            sessionsCell.style.borderBottom = '1px solid var(--border)';
            
            row.appendChild(nameCell);
            row.appendChild(patientsCell);
            row.appendChild(sessionsCell);
            tbody.appendChild(row);
        });
        
        statsTable.appendChild(tbody);
        
        // Reemplazar el gráfico con la tabla
        chartContainer.appendChild(statsTable);
        
        // Añadir un botón para exportar estadísticas
        const exportContainer = document.createElement('div');
        exportContainer.style.marginTop = '20px';
        exportContainer.style.textAlign = 'center';
        
        const exportExcelBtn = document.createElement('button');
        exportExcelBtn.className = 'button save-btn';
        exportExcelBtn.style.marginRight = '10px';
        exportExcelBtn.textContent = 'Exportar a Excel';
        exportExcelBtn.onclick = function() { exportStatisticsToExcel(); };
        
        const exportPdfBtn = document.createElement('button');
        exportPdfBtn.className = 'button save-btn';
        exportPdfBtn.textContent = 'Exportar a PDF';
        exportPdfBtn.onclick = function() { exportStatisticsToPdf(); };
        
        exportContainer.appendChild(exportExcelBtn);
        exportContainer.appendChild(exportPdfBtn);
        
        chartContainer.appendChild(exportContainer);
    }
}

// Función para exportar estadísticas a Excel
function exportStatisticsToExcel() {
    try {
        showSpinner();
        
        // Crear datos para el Excel
        let data = [['Estudiante', 'Pacientes Únicos', 'Total Sesiones']];
        
        // Resto del código...
        
        // Modificar esta parte para asegurar que XLSX esté disponible
        if (typeof XLSX === 'undefined') {
            throw new Error("La biblioteca XLSX no está cargada correctamente");
        }
        
        // Crear workbook
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);
        
        // Resto del código...
        
    } catch (error) {
        console.error("Error al exportar a Excel:", error);
        hideSpinner();
        showStatusMessage("Error al exportar estadísticas a Excel: " + error.message, "error");
    }
}

function exportStatisticsToPdf() {
    try {
        showSpinner();
        
        // Obtener fechas de la semana actual
        const startOfWeek = getStartOfWeek(currentWeekDate);
        const endDate = new Date(startOfWeek);
        endDate.setDate(startOfWeek.getDate() + 3); // Jueves
        
        const startDateStr = startOfWeek.toLocaleDateString('es-ES', {
            day: '2-digit', month: 'long', year: 'numeric'
        });
        const endDateStr = endDate.toLocaleDateString('es-ES', {
            day: '2-digit', month: 'long', year: 'numeric'
        });
        
        // Crear documento PDF
        const doc = new jspdf.jsPDF();
        
        // Colores
        const primaryColor = [41, 63, 224]; // #2D3FE0
        const secondaryColor = [113, 128, 150]; // #718096
        const successColor = [76, 175, 80]; // #4CAF50
        const errorColor = [244, 67, 54]; // #F44336
        const warningColor = [255, 152, 0]; // #FF9800
        
        // Encabezado con logo
        doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
        doc.rect(0, 0, doc.internal.pageSize.getWidth(), 25, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(18);
        doc.text("SISTEMAKINE", 15, 16);
        
        // Subtítulo
        doc.setTextColor(0, 0, 0);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(16);
        doc.text("Reporte de Estadísticas", 15, 40);
        
        // Información del período
        doc.setFontSize(11);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(secondaryColor[0], secondaryColor[1], secondaryColor[2]);
        doc.text(`Semana del ${startDateStr} al ${endDateStr}`, 15, 50);
        doc.text(`Generado el: ${new Date().toLocaleDateString('es-ES', {
            day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit'
        })}`, 15, 58);
        
        // Resumen de asistencia (círculo dividido)
        doc.setDrawColor(0);
        doc.setLineWidth(0.1);
        
        // Contar citas con asistencia
        const attendedAppointments = appointments.filter(a => a.estado === 'attended').length;
        const missedAppointments = appointments.filter(a => a.estado === 'missed').length;
        const rescheduledAppointments = appointments.filter(a => a.estado === 'rescheduled').length;
        const pendingAppointments = appointments.length - (attendedAppointments + missedAppointments + rescheduledAppointments);
        
        // Panel de estadísticas generales
        doc.setFillColor(245, 247, 250); // #F5F7FA
        doc.roundedRect(15, 65, doc.internal.pageSize.getWidth() - 30, 75, 3, 3, 'F');
        
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text("Resumen de Asistencia", 25, 80);
        
        // Números grandes para asistencia
        doc.setFontSize(14);
        doc.setFont('helvetica', 'normal');
        
        // Asistieron - verde
        doc.setTextColor(successColor[0], successColor[1], successColor[2]);
        doc.text(`${attendedAppointments}`, 30, 95);
        doc.setFontSize(10);
        doc.text("Asistieron", 30, 102);
        
        // No asistieron - rojo
        doc.setFontSize(14);
        doc.setTextColor(errorColor[0], errorColor[1], errorColor[2]);
        doc.text(`${missedAppointments}`, 75, 95);
        doc.setFontSize(10);
        doc.text("No asistieron", 75, 102);
        
        // Reprogramadas - amarillo
        doc.setFontSize(14);
        doc.setTextColor(warningColor[0], warningColor[1], warningColor[2]);
        doc.text(`${rescheduledAppointments}`, 130, 95);
        doc.setFontSize(10);
        doc.text("Reprogramadas", 130, 102);
        
        // Total de citas - azul
        doc.setFontSize(14);
        doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
        doc.text(`${appointments.length}`, 185, 95);
        doc.setFontSize(10);
        doc.text("Total de citas", 185, 102);
        
        // Nota aclaratoria sobre citas agendadas vs asistidas
        doc.setFontSize(9);
        doc.setFont('helvetica', 'italic');
        doc.setTextColor(secondaryColor[0], secondaryColor[1], secondaryColor[2]);
        doc.text("Nota: Las estadísticas de evolución se basan solo en sesiones a las que el paciente realmente asistió.", 25, 115);
        doc.text("Las sesiones agendadas pero no asistidas no cuentan para la evolución del paciente.", 25, 122);
        
        // Tasa de asistencia global
        const attendanceRate = appointments.length > 0 
            ? Math.round((attendedAppointments / appointments.length) * 100) 
            : 0;
            
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 0, 0);
        doc.text(`Tasa de asistencia: ${attendanceRate}%`, 25, 132);
        
        // Tabla de estudiantes
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text("Estadísticas por Estudiante", 15, 155);
        
        // Crear datos para la tabla
        const tableColumn = ["Estudiante", "Pacientes únicos", "Sesiones agendadas", "Sesiones asistidas", "Tasa"];
        let tableRows = [];
        
        // Calcular estadísticas de estudiantes
        const uniquePatientsByStudent = {};
        const totalSessions = {};
        const attendedSessions = {};
        const attendanceRates = {};
        const patientsByStudent = {};
        
        // Contador de asistencia por estudiante
        const attendedByStudent = {};
        const totalByStudent = {};
        
        appointments.forEach(a => {
            if (!a.estudiante || !a.paciente) return;
            
            // Contar sesiones totales
            totalSessions[a.estudiante] = (totalSessions[a.estudiante] || 0) + 1;
            
            // Contabilizar asistencia
            if (a.estado === 'attended') {
                attendedSessions[a.estudiante] = (attendedSessions[a.estudiante] || 0) + 1;
            }
            
            if (a.estado) {
                totalByStudent[a.estudiante] = (totalByStudent[a.estudiante] || 0) + 1;
                
                if (a.estado === 'attended') {
                    attendedByStudent[a.estudiante] = (attendedByStudent[a.estudiante] || 0) + 1;
                }
            }
            
            // Inicializar arrays si no existen
            if (!patientsByStudent[a.estudiante]) {
                patientsByStudent[a.estudiante] = [];
            }
            
            // Añadir paciente si no está ya (para evitar duplicados)
            if (!patientsByStudent[a.estudiante].includes(a.paciente)) {
                patientsByStudent[a.estudiante].push(a.paciente);
            }
        });
        
        // Contar pacientes únicos
        for (const student in patientsByStudent) {
            uniquePatientsByStudent[student] = patientsByStudent[student].length;
        }
        
        // Calcular tasas de asistencia
        for (const student in totalByStudent) {
            attendanceRates[student] = totalByStudent[student] > 0 
                ? Math.round((attendedByStudent[student] || 0) / totalByStudent[student] * 100) 
                : 0;
        }
        
        // Ordenar estudiantes
        const sortedStudents = Object.keys(uniquePatientsByStudent).sort((a, b) => 
            uniquePatientsByStudent[b] - uniquePatientsByStudent[a]
        );
        
        // Añadir datos de cada estudiante
        sortedStudents.forEach(student => {
            tableRows.push([
                studentNames[student] || student,
                uniquePatientsByStudent[student] || 0,
                totalSessions[student] || 0,
                attendedSessions[student] || 0,
                `${attendanceRates[student] || 0}%`
            ]);
        });
        
        // Generar tabla con estilo
        doc.autoTable({
            head: [tableColumn],
            body: tableRows,
            startY: 160,
            styles: { 
                fontSize: 9,
                cellPadding: 3
            },
            headStyles: { 
                fillColor: primaryColor,
                textColor: [255, 255, 255],
                fontStyle: 'bold'
            },
            alternateRowStyles: {
                fillColor: [245, 247, 250]
            },
            margin: { top: 160 }
        });
        
        // Añadir gráfico de tipos de tratamiento
        const typesY = doc.autoTable.previous.finalY + 20;
        
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text("Distribución por Tipo de Tratamiento", 15, typesY);
        
        // Contar tipos de cita
        const appointmentTypes = {};
        const attendedAppointmentTypes = {};
        appointments.forEach(a => {
            const tipoClase = a.tipoClase || 'sin-tipo';
            appointmentTypes[tipoClase] = (appointmentTypes[tipoClase] || 0) + 1;
            
            if (a.estado === 'attended') {
                attendedAppointmentTypes[tipoClase] = (attendedAppointmentTypes[tipoClase] || 0) + 1;
            }
        });
        
        // Crear tabla de tipos (mostrando agendadas vs asistidas)
        const typesTableRows = [];
        for (const type in appointmentTypes) {
            typesTableRows.push([
                getAppointmentTypeName(type),
                appointmentTypes[type],
                attendedAppointmentTypes[type] || 0,
                `${Math.round((appointmentTypes[type] / appointments.length) * 100)}%`
            ]);
        }
        
        // Generar tabla de tipos
        doc.autoTable({
            head: [['Tipo de Tratamiento', 'Agendadas', 'Asistidas', '%']],
            body: typesTableRows,
            startY: typesY + 5,
            styles: { 
                fontSize: 9,
                cellPadding: 3
            },
            headStyles: { 
                fillColor: [0, 191, 165], // #00BFA5
                textColor: [255, 255, 255],
                fontStyle: 'bold'
            },
            alternateRowStyles: {
                fillColor: [245, 247, 250]
            },
            margin: { top: typesY + 5 }
        });
        
        // ----- PÁGINA 2: DATOS DE PACIENTES -----
        doc.addPage();
        
        // Encabezado página 2
        doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
        doc.rect(0, 0, doc.internal.pageSize.getWidth(), 25, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(18);
        doc.text("SISTEMAKINE", 15, 16);
        
        // Título datos de pacientes
        doc.setTextColor(0, 0, 0);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(16);
        doc.text("Información Detallada de Pacientes", 15, 40);
        
        // Información del período (repetir para saber de qué semana es)
        doc.setFontSize(11);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(secondaryColor[0], secondaryColor[1], secondaryColor[2]);
        doc.text(`Semana del ${startDateStr} al ${endDateStr}`, 15, 50);
        
        // Recopilar datos de pacientes
        const patientsData = [];
        const uniquePatients = new Set();
        const pacientesInfo = {};
        const comunaCounter = {};
        
        const pacientesYaComunas = {};
        appointments.forEach(a => {
            if (!a.paciente) return;
            
            const patientKey = a.paciente.toLowerCase();
            
            // Contabilizar comunas solo una vez por paciente
            if (a.comuna && !pacientesYaComunas[patientKey + a.comuna]) {
                pacientesYaComunas[patientKey + a.comuna] = true;
                comunaCounter[a.comuna] = (comunaCounter[a.comuna] || 0) + 1;
            }
            
            // Solo procesar una vez cada paciente
            if (!uniquePatients.has(patientKey)) {
                uniquePatients.add(patientKey);
                
                patientsData.push({
                    nombre: a.paciente,
                    telefono: a.telefono || 'No registrado',
                    correo: a.correo || 'No registrado',
                    comuna: a.comuna || 'No registrada'
                });
                
                // Guardar info para uso posterior
                pacientesInfo[patientKey] = {
                    nombre: a.paciente,
                    telefono: a.telefono || 'No registrado',
                    correo: a.correo || 'No registrado',
                    comuna: a.comuna || 'No registrada'
                };
            }
        });
        
        // Tabla de pacientes
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text(`Datos de Contacto (${patientsData.length} pacientes)`, 15, 65);
        
        const patientTableColumn = ["Paciente", "Teléfono", "Correo", "Comuna"];
        
        // Ordenar alfabéticamente
        patientsData.sort((a, b) => a.nombre.localeCompare(b.nombre));
        
        const patientTableRows = patientsData.map(p => [
            p.nombre,
            p.telefono,
            p.correo,
            p.comuna
        ]);
        
        // Generar tabla de pacientes
        doc.autoTable({
            head: [patientTableColumn],
            body: patientTableRows,
            startY: 70,
            styles: { 
                fontSize: 8,
                cellPadding: 2
            },
            headStyles: { 
                fillColor: primaryColor,
                textColor: [255, 255, 255],
                fontStyle: 'bold'
            },
            alternateRowStyles: {
                fillColor: [245, 247, 250]
            },
            margin: { top: 70 }
        });
        
        // Distribución por comuna
        const comunasY = doc.autoTable.previous.finalY + 20;
        
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text("Distribución por Comuna", 15, comunasY);
        
        // Convertir datos de comuna para la tabla
        const comunasTableRows = [];
        let totalPacientes = 0;
        
        for (const comuna in comunaCounter) {
            const count = comunaCounter[comuna];
            totalPacientes += count;
            comunasTableRows.push([comuna, count]);
        }
        
        // Ordenar por cantidad (mayor a menor)
        comunasTableRows.sort((a, b) => b[1] - a[1]);
        
        // Añadir porcentajes
        comunasTableRows.forEach(row => {
            const percentage = (row[1] / totalPacientes) * 100;
            row.push(`${percentage.toFixed(1)}%`);
        });
        
        // Generar tabla de comunas
        doc.autoTable({
            head: [['Comuna', 'Pacientes Únicos', '%']],
            body: comunasTableRows,
            startY: comunasY + 5,
            styles: { 
                fontSize: 9,
                cellPadding: 3
            },
            headStyles: { 
                fillColor: [155, 89, 182], // Púrpura #9B59B6
                textColor: [255, 255, 255],
                fontStyle: 'bold'
            },
            alternateRowStyles: {
                fillColor: [245, 247, 250]
            },
            margin: { top: comunasY + 5 }
        });
        
        // ----- PÁGINA 3: EVOLUCIÓN DE PACIENTES -----
        doc.addPage();
        
        // Encabezado página 3
        doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
        doc.rect(0, 0, doc.internal.pageSize.getWidth(), 25, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(18);
        doc.text("SISTEMAKINE", 15, 16);
        
        // Título evolución de pacientes
        doc.setTextColor(0, 0, 0);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(16);
        doc.text("Evolución de Pacientes", 15, 40);
        
        // Nota aclaratoria importante
        doc.setFillColor(255, 236, 236); // Color de fondo claro rosado
        doc.roundedRect(15, 50, doc.internal.pageSize.getWidth() - 30, 30, 3, 3, 'F');
        doc.setTextColor(231, 76, 60); // Rojo #E74C3C
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.text("IMPORTANTE:", 25, 60);
        doc.setFont('helvetica', 'normal');
        doc.text("Esta clasificación se basa únicamente en las sesiones a las que el paciente realmente asistió.", 25, 70);
        doc.text("Las sesiones únicamente agendadas NO cuentan para la evolución del paciente.", 25, 78);
        
        // Calcular datos de evolución basados en ASISTENCIA REAL
        const sessionsPerPatient = {};
        const attendedSessionsPerPatient = {};
        
        appointments.forEach(a => {
            if (!a.paciente) return;
            const patientKey = a.paciente.toLowerCase();
            
            // Contar todas las sesiones agendadas
            sessionsPerPatient[patientKey] = (sessionsPerPatient[patientKey] || 0) + 1;
            
            // Contar solo las asistidas
            if (a.estado === 'attended') {
                attendedSessionsPerPatient[patientKey] = (attendedSessionsPerPatient[patientKey] || 0) + 1;
            }
        });
        
        // Convertir a array para procesar
        const patientsArray = Object.keys(attendedSessionsPerPatient).map(patient => ({
            name: patient,
            totalSessions: sessionsPerPatient[patient] || 0,
            attendedSessions: attendedSessionsPerPatient[patient] || 0,
            // Añadir información de contacto
            info: pacientesInfo[patient] || {}
        }));
        
        // Ordenar por número de sesiones asistidas (descendente)
        patientsArray.sort((a, b) => b.attendedSessions - a.attendedSessions);
        
        // Contar por etapa BASADO EN ASISTENCIAS REALES
        const patientStages = {
            evaluation: 0,
            treatment: 0,
            advanced: 0,
            final: 0
        };
        
        patientsArray.forEach(patient => {
            if (patient.attendedSessions === 1) {
                patientStages.evaluation++;
            } else if (patient.attendedSessions >= 2 && patient.attendedSessions <= 14) {
                patientStages.treatment++;
            } else if (patient.attendedSessions >= 15 && patient.attendedSessions <= 19) {
                patientStages.advanced++;
            } else if (patient.attendedSessions >= 20) {
                patientStages.final++;
            }
        });
        
        // Mostrar resumen de evolución
        doc.setFillColor(245, 247, 250);
        doc.roundedRect(15, 90, doc.internal.pageSize.getWidth() - 30, 60, 3, 3, 'F');
        
        doc.setTextColor(0, 0, 0);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(12);
        doc.text("Resumen de Evolución (Basado en Asistencias Reales)", 25, 105);
        
        // Mostrar contadores por etapa
        doc.setFont('helvetica', 'normal');
        
        // Evaluación inicial
        doc.setTextColor(warningColor[0], warningColor[1], warningColor[2]);
        doc.setFontSize(14);
        doc.text(`${patientStages.evaluation}`, 30, 125);
        doc.setFontSize(10);
        doc.text("Evaluación Inicial", 30, 132);
        doc.setFontSize(8);
        doc.text("(1 sesión asistida)", 30, 139);
        
        // En tratamiento
        doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
        doc.setFontSize(14);
        doc.text(`${patientStages.treatment}`, 80, 125);
        doc.setFontSize(10);
        doc.text("En Tratamiento", 80, 132);
        doc.setFontSize(8);
        doc.text("(2-4 sesiones asistidas)", 80, 139);
        
        // Avanzado
        doc.setTextColor(successColor[0], successColor[1], successColor[2]);
        doc.setFontSize(14);
        doc.text(`${patientStages.advanced}`, 130, 125);
        doc.setFontSize(10);
        doc.text("Avanzado", 130, 132);
        doc.setFontSize(8);
        doc.text("(5-8 sesiones asistidas)", 130, 139);
        
        // Fase final
        doc.setTextColor(155, 89, 182); // Púrpura #9B59B6
        doc.setFontSize(14);
        doc.text(`${patientStages.final}`, 180, 125);
        doc.setFontSize(10);
        doc.text("Fase Final", 180, 132);
        doc.setFontSize(8);
        doc.text("(9+ sesiones asistidas)", 180, 139);
        
        // Tabla detallada de pacientes por evolución
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text("Detalle de Pacientes por Etapa", 15, 170);
        
        // Crear datos para la tabla
        const evolutionTableColumn = ["Paciente", "Sesiones Agendadas", "Sesiones Asistidas", "Etapa"];
        const evolutionTableRows = [];
        
        patientsArray.forEach(patient => {
            // Determinar etapa basada en asistencias reales
            let stage;
            
            // Calcular etapa de evolución
            if (patient.attendedSessions === 1) {
                stage = 'Evaluación Inicial';
            } else if (patient.attendedSessions >= 2 && patient.attendedSessions <= 14) {
                stage = 'En Tratamiento';
            } else if (patient.attendedSessions >= 15 && patient.attendedSessions <= 19) {
                stage = 'Avanzado';
            } else if (patient.attendedSessions >= 20) {
                stage = 'Fase Final';
            } else {
                stage = 'Sin asistencias';
            }
            
            evolutionTableRows.push([
                patient.name
                    .split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' '),
                patient.totalSessions,
                patient.attendedSessions,
                stage
            ]);
        });
        
        // Generar tabla de evolución
        doc.autoTable({
            head: [evolutionTableColumn],
            body: evolutionTableRows,
            startY: 175,
            styles: { 
                fontSize: 9,
                cellPadding: 3
            },
            headStyles: { 
                fillColor: [155, 89, 182], // Púrpura #9B59B6
                textColor: [255, 255, 255],
                fontStyle: 'bold'
            },
            alternateRowStyles: {
                fillColor: [245, 247, 250]
            },
            margin: { top: 175 }
        });
        
        // Añadir pie de página a todas las páginas
        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text(`SISTEMAKINE - Página ${i} de ${totalPages}`, 15, doc.internal.pageSize.getHeight() - 10);
            doc.text(`${new Date().toISOString().split('T')[0]}`, doc.internal.pageSize.getWidth() - 30, doc.internal.pageSize.getHeight() - 10);
        }
        
        // Guardar PDF
        doc.save(`Estadisticas_SISTEMAKINE_${startDateStr.replace(/ /g, '_')}.pdf`);
        
        hideSpinner();
        showStatusMessage('Estadísticas exportadas a PDF correctamente', 'success');
    } catch (error) {
        console.error("Error al exportar a PDF:", error);
        hideSpinner();
        showStatusMessage("Error al exportar estadísticas a PDF: " + error.message, "error");
    }
}  

// Función para manejar cambios en el tipo de cita (mostrar opciones de recurrencia)
function handleAppointmentTypeChange() {
    try {
        const appointmentType = document.getElementById('appointment-type').value;
        const recurrenceOptions = document.getElementById('recurrence-options');
        
        // Solo mostrar opciones de recurrencia para sesiones, no para evaluaciones
        if (appointmentType && appointmentType.startsWith('sesion-')) {
            recurrenceOptions.style.display = 'block';
        } else {
            recurrenceOptions.style.display = 'none';
            document.getElementById('is-recurring').checked = false;
            document.getElementById('recurring-details').style.display = 'none';
        }
    } catch (error) {
        console.error("Error al cambiar tipo de cita:", error);
    }
}

// Configurar event listeners
function setupEventListeners() {
    try {
        // Login
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            showSpinner();
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Login exitoso
                    hideSpinner();
                    showStatusMessage('Sesión iniciada correctamente', 'success');
                })
                .catch((error) => {
                    console.error("Error de login:", error);
                    hideSpinner();
                    showStatusMessage("Error de inicio de sesión. Verifica tus credenciales.", "error");
                });
        });
        
        // Logout
        logoutBtn.addEventListener('click', function() {
            auth.signOut()
                .then(() => {
                    // Logout exitoso
                    showLoginScreen();
                    showStatusMessage('Sesión cerrada', 'success');
                })
                .catch((error) => {
                    console.error("Error al cerrar sesión:", error);
                    showStatusMessage("Error al cerrar sesión.", "error");
                });
        });
        
        // Navegación de semanas
        document.getElementById('prev-week').addEventListener('click', function() {
            navigateWeek(-1);
        });
        
        document.getElementById('next-week').addEventListener('click', function() {
            navigateWeek(1);
        });
        
        // Evento para mostrar/ocultar detalles de recurrencia
        const isRecurringCheckbox = document.getElementById('is-recurring');
        if (isRecurringCheckbox) {
            isRecurringCheckbox.addEventListener('change', function() {
                document.getElementById('recurring-details').style.display = this.checked ? 'block' : 'none';
            });
        }
        
        // Clic en celdas de la agenda (para agregar citas)
        document.querySelectorAll('.schedule-cell').forEach(cell => {
            cell.addEventListener('click', function() {
                if (isAdmin) {
                    const hour = parseInt(this.dataset.hour);
                    const day = parseInt(this.dataset.day);
                    
                    openAppointmentModal(null, hour, day);
                }
            });
            
            // Configuración para arrastrar y soltar
            if (isAdmin) {
                cell.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('drag-over');
                });
                
                cell.addEventListener('dragleave', function() {
                    this.classList.remove('drag-over');
                });
                
                cell.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');
                    
                    const appointmentId = e.dataTransfer.getData('text/plain');
                    const hour = parseInt(this.dataset.hour);
                    const day = parseInt(this.dataset.day);
                    
                    // Obtener fecha correspondiente a este día
                    const startOfWeek = getStartOfWeek(currentWeekDate);
                    const targetDate = new Date(startOfWeek);
                    targetDate.setDate(startOfWeek.getDate() + (day - 1));
                    
                    // Mover la cita a esta fecha y hora
                    moveAppointmentToDate(appointmentId, targetDate, hour);
                });
            }
        });
        
        // Formulario de citas
        appointmentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            if (isAdmin) {
                saveAppointment();
            }
        });
        
        document.getElementById('cancel-appointment').addEventListener('click', function() {
            closeAppointmentModal();
        });
        
        document.getElementById('delete-appointment').addEventListener('click', function() {
            if (isAdmin) {
                // Obtener la cita que se está eliminando
                const appointment = appointments.find(a => a.id === editingAppointmentId);
                let confirmMessage = '¿Estás seguro de que deseas eliminar esta cita?';
                
                // Verificar si es una cita pasada
                if (appointment && appointment.fecha < new Date()) {
                    confirmMessage = '⚠️ ADVERTENCIA: Está eliminando una cita PASADA. Esta acción es irreversible y puede afectar las estadísticas históricas. ¿Está completamente seguro?';
                }
                
                if (confirm(confirmMessage)) {
                    try {
                        deleteAppointment();
                    } catch (error) {
                        console.error("Error al eliminar cita:", error);
                        showStatusMessage("Error al eliminar la cita", "error");
                    }
                }
            }
        });
        
        // Cerrar modales con la X
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.addEventListener('click', function() {
                this.closest('.modal').style.display = 'none';
            });
        });
        
        // Eventos para asistencia
        document.querySelectorAll('.attendance-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.attendance-btn').forEach(b => {
                    b.classList.remove('selected');
                });
                this.classList.add('selected');
            });
        });
        
        document.getElementById('save-attendance').addEventListener('click', function() {
            if (isAdmin) {
                try {
                    saveAttendance();
                } catch (error) {
                    console.error("Error al guardar asistencia:", error);
                    showStatusMessage("Error al guardar asistencia", "error");
                }
            }
        });
        
        document.getElementById('cancel-attendance').addEventListener('click', function() {
            closeAttendanceModal();
        });
        
        // Evitar que el modal se cierre si se hace clic en él
        document.querySelectorAll('.modal-content').forEach(content => {
            content.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        });
        
        // Cerrar el modal si se hace clic fuera de él
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function() {
                this.style.display = 'none';
            });
        });
    } catch (error) {
        console.error("Error al configurar eventos:", error);
        showStatusMessage("Error al inicializar la interfaz", "error");
    }
    // Configurar búsqueda de pacientes
    setupPatientSearch();
    // Configurar filtros
    setupFilters();
}

// Navegar entre semanas
function navigateWeek(direction) {
    currentWeekDate.setDate(currentWeekDate.getDate() + (direction * 7));
    updateWeekDisplay();
    loadAppointments();
}

// Formatear fecha como YYYY-MM-DD
function formatDate(date) {
    if (!date) return '';
    
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Modificar openAppointmentModal para mostrar valores de los nuevos campos
function openAppointmentModal(appointment, hour, day) {
    if (!isAdmin) return;
    
    try {
        const modalTitle = document.getElementById('modal-title');
        const dateInput = document.getElementById('appointment-date');
        const timeInput = document.getElementById('appointment-time');
        const deleteBtn = document.getElementById('delete-appointment');
        const isRecurringCheckbox = document.getElementById('is-recurring');
        const recurringDetails = document.getElementById('recurring-details');
        
        // Ocultar opciones de recurrencia por defecto
        document.getElementById('recurrence-options').style.display = 'none';
        
        if (appointment) {
            // Editar cita existente
            modalTitle.textContent = 'Editar Cita';
            
            document.getElementById('patient-name').value = appointment.paciente || '';
            
            const typeSelect = document.getElementById('appointment-type');
            if (appointment.tipoClase && typeSelect) {
                typeSelect.value = appointment.tipoClase;
                
                // Mostrar opciones de recurrencia solo para sesiones
                if (appointment.tipoClase.startsWith('sesion-')) {
                    document.getElementById('recurrence-options').style.display = 'block';
                }
            }
            
            // Si es una cita recurrente, mostrar los detalles
            if (appointment.esRecurrente) {
                isRecurringCheckbox.checked = true;
                recurringDetails.style.display = 'block';
                
                // Marcar los días de la semana
                if (appointment.patronRecurrencia && appointment.patronRecurrencia.diasSemana) {
                    const weekdays = appointment.patronRecurrencia.diasSemana;
                    document.querySelectorAll('input[name="weekday"]').forEach(checkbox => {
                        checkbox.checked = weekdays.includes(parseInt(checkbox.value));
                    });
                }
                
                // Establecer fecha fin
                if (appointment.patronRecurrencia && appointment.patronRecurrencia.fechaFin) {
                    let endDate;
                    try {
                        if (typeof appointment.patronRecurrencia.fechaFin === 'object' && 
                            appointment.patronRecurrencia.fechaFin.toDate) {
                            endDate = appointment.patronRecurrencia.fechaFin.toDate();
                        } else if (typeof appointment.patronRecurrencia.fechaFin === 'string') {
                            endDate = new Date(appointment.patronRecurrencia.fechaFin);
                        }
                    } catch (error) {
                        console.error("Error al convertir fecha fin:", error);
                    }
                    
                    if (endDate) {
                        document.getElementById('recurrence-end').value = formatDate(endDate);
                    }
                }
            } else {
                isRecurringCheckbox.checked = false;
                recurringDetails.style.display = 'none';
            }
            
            const fecha = appointment.fecha;
            if (fecha) {
                dateInput.value = formatDate(fecha);
                timeInput.value = `${fecha.getHours().toString().padStart(2, '0')}:${fecha.getMinutes().toString().padStart(2, '0')}`;
            }
            
            if (appointment.duracion) {
                document.getElementById('appointment-duration').value = appointment.duracion;
            }
            
            // Ya no necesitamos establecer el valor del terapeuta porque eliminamos ese campo
            
            document.getElementById('student').value = appointment.estudiante || 'estudiante1';
            document.getElementById('appointment-notes').value = appointment.notas || '';
            document.getElementById('is-web').checked = appointment.web || false;
            
            // Establecer valores para los nuevos campos
            if (appointment.comuna) {
                document.getElementById('patient-comuna').value = appointment.comuna;
            }
            
            if (appointment.telefono) {
                document.getElementById('patient-phone').value = appointment.telefono;
            }
            
            if (appointment.correo) {
                document.getElementById('patient-email').value = appointment.correo;
            }
            
            editingAppointmentId = appointment.id;
            deleteBtn.style.display = 'block';
        } else {
            // Nueva cita
            modalTitle.textContent = 'Agregar Nueva Cita';
            
            // Limpiar formulario
            document.getElementById('patient-name').value = '';
            document.getElementById('appointment-notes').value = '';
            document.getElementById('is-web').checked = false;
            document.getElementById('patient-comuna').value = '';
            document.getElementById('patient-phone').value = '';
            document.getElementById('patient-email').value = '';
            
            // Obtener la fecha correspondiente al día seleccionado
            const startOfWeek = getStartOfWeek(currentWeekDate);
            const appointmentDay = day ? day - 1 : 0; // Convertir de 1-basado a 0-basado
            const appointmentDate = new Date(startOfWeek);
            appointmentDate.setDate(startOfWeek.getDate() + appointmentDay);
            
            // Pre-llenar con la fecha del día seleccionado
            dateInput.value = formatDate(appointmentDate);
            
            // Pre-llenar hora si se proporciona
            if (hour) {
                timeInput.value = `${hour.toString().padStart(2, '0')}:00`;
            }
            
            editingAppointmentId = null;
            deleteBtn.style.display = 'block'; // Siempre mostrar el botón de eliminar
            
            // Inicialmente ocultar detalles de recurrencia
            isRecurringCheckbox.checked = false;
            recurringDetails.style.display = 'none';
            
            // Actualizar visibilidad de opciones de recurrencia según tipo de cita seleccionado
            handleAppointmentTypeChange();
        }
        
        appointmentModal.style.display = 'block';
    } catch (error) {
        console.error("Error al abrir modal de cita:", error);
        showStatusMessage("Error al abrir el formulario", "error");
    }
}

function closeAppointmentModal() {
    appointmentModal.style.display = 'none';
    editingAppointmentId = null;
    
    // Limpiar TODOS los campos del formulario
    document.getElementById('patient-name').value = '';
    document.getElementById('appointment-notes').value = '';
    document.getElementById('is-web').checked = false;
    document.getElementById('is-recurring').checked = false;
    document.getElementById('recurring-details').style.display = 'none';
    
    // Limpiar campos adicionales que faltaban
    document.getElementById('patient-comuna').value = '';
    document.getElementById('patient-phone').value = '';
    document.getElementById('patient-email').value = '';
    
    // Restablecer tipo de cita al valor predeterminado (primer option)
    const typeSelect = document.getElementById('appointment-type');
    if (typeSelect && typeSelect.options.length > 0) {
        typeSelect.selectedIndex = 0;
    }
    
    // Restablecer duración al valor predeterminado
    const durationSelect = document.getElementById('appointment-duration');
    if (durationSelect && durationSelect.options.length > 0) {
        durationSelect.selectedIndex = 0; // Generalmente 60 minutos
    }
    
    // Restablecer estudiante al valor predeterminado
    const studentSelect = document.getElementById('student');
    if (studentSelect && studentSelect.options.length > 0) {
        studentSelect.selectedIndex = 0;
    }
    
    // Desmarcar todos los días de la semana para recurrencia
    document.querySelectorAll('input[name="weekday"]').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Limpiar la fecha fin de recurrencia
    const recurrenceEndInput = document.getElementById('recurrence-end');
    if (recurrenceEndInput) {
        recurrenceEndInput.value = '';
    }
    
    // Ocultar sección de recurrencia
    const recurrenceOptions = document.getElementById('recurrence-options');
    if (recurrenceOptions) {
        recurrenceOptions.style.display = 'none';
    }
    
    // Esto ayuda a evitar problemas de memoria y referencias persistentes
    console.log("Formulario limpiado completamente");
}

// Guardar cita
function saveAppointment() {
    try {
        showSpinner();
        
        const patientName = document.getElementById('patient-name').value;
        if (!patientName || patientName.trim() === '') {
            hideSpinner();
            showStatusMessage('Por favor ingresa el nombre del paciente', 'warning');
            return;
        }
        
        const appointmentTypeSelect = document.getElementById('appointment-type');
        const appointmentType = appointmentTypeSelect.options[appointmentTypeSelect.selectedIndex].text;
        const appointmentTypeClass = appointmentTypeSelect.value;
        const appointmentDate = document.getElementById('appointment-date').value;
        const appointmentTime = document.getElementById('appointment-time').value;
        
        if (!appointmentDate || !appointmentTime) {
            hideSpinner();
            showStatusMessage('Por favor ingresa fecha y hora', 'warning');
            return;
        }
        
        const appointmentDuration = parseInt(document.getElementById('appointment-duration').value);
        const therapist = "estudiante"; // Valor por defecto ya que eliminamos el campo
        const student = document.getElementById('student').value;
        const notes = document.getElementById('appointment-notes').value;
        const isWeb = document.getElementById('is-web').checked;
        
        // Nuevos campos
        const comuna = document.getElementById('patient-comuna').value;
        const phone = document.getElementById('patient-phone').value;
        const email = document.getElementById('patient-email').value;
        
        // Validar comuna
        if (!comuna) {
            hideSpinner();
            showStatusMessage('Por favor selecciona una comuna de residencia', 'warning');
            return;
        }
        
        // Datos de recurrencia
        const isRecurring = document.getElementById('is-recurring').checked;
        let selectedWeekdays = [];
        let recurrenceEndDate = null;
        
        if (isRecurring) {
            // Obtener días de la semana seleccionados
            document.querySelectorAll('input[name="weekday"]:checked').forEach(checkbox => {
                selectedWeekdays.push(parseInt(checkbox.value));
            });
            
            // Fecha de fin de recurrencia
            recurrenceEndDate = document.getElementById('recurrence-end').value;
            if (!recurrenceEndDate) {
                hideSpinner();
                showStatusMessage('Por favor selecciona una fecha de fin para la recurrencia', 'warning');
                return;
            }
            
            if (selectedWeekdays.length === 0) {
                hideSpinner();
                showStatusMessage('Por favor selecciona al menos un día de la semana', 'warning');
                return;
            }
        }
        
        // Crear objeto de fecha
        const [year, month, day] = appointmentDate.split('-');
        const [hours, minutes] = appointmentTime.split(':');
        const date = new Date(year, month - 1, day, hours, minutes);
        
        // Verificar si es feriado
        const dateStr = formatDate(date);
        const holidayMatch = holidays.find(h => h.date === dateStr);
        if (holidayMatch) {
            hideSpinner();
            showStatusMessage(`No se pueden agendar citas en días feriados. ${dateStr} es "${holidayMatch.name}".`, 'warning');
            return;
        }
        
        // Verificar límite de citas simultáneas
        if (!editingAppointmentId) { // Solo verificar para nuevas citas
            const dayOfWeek = date.getDay(); // 0 para domingo, 1 para lunes, etc.
            if (dayOfWeek > 0 && dayOfWeek < 5) { // Solo lunes a jueves
                const hourAppointments = appointments.filter(a => {
                    const appDate = a.fecha;
                    return appDate && appDate.getDay() === dayOfWeek &&
                           appDate.getHours() === date.getHours() &&
                           a.estudiante === student;
                });
                
                if (hourAppointments.length >= 2) {
                    hideSpinner();
                    showStatusMessage('Este estudiante ya tiene 2 citas en este horario.', 'warning');
                    return;
                }
            }
        }
        
        // ID único para citas recurrentes
        const serieRecurrenteId = isRecurring ? `serie_${Date.now()}` : null;
        
        // Datos base de la cita
        const baseAppointmentData = {
            paciente: patientName,
            tipo: appointmentType,
            tipoClase: appointmentTypeClass,
            duracion: appointmentDuration,
            terapeuta: therapist,
            estudiante: student,
            estudianteNombre: studentNames[student] || student,
            notas: notes,
            web: isWeb,
            esRecurrente: isRecurring,
            fecha: date,
            creado: new Date(),
            // Nuevos campos
            comuna: comuna,
            telefono: phone,
            correo: email,
            historial: [{
                accion: editingAppointmentId ? 'modificacion' : 'creacion',
                usuario: currentUser.email,
                usuarioId: currentUser.uid,
                fecha: new Date()
            }]
        };
        
        // Si es cita recurrente, agregar patrón
        if (isRecurring) {
            baseAppointmentData.serieRecurrenteId = serieRecurrenteId;
            baseAppointmentData.patronRecurrencia = {
                diasSemana: selectedWeekdays,
                fechaFin: new Date(recurrenceEndDate)
            };
        }
        
        if (editingAppointmentId) {
            // Guardar datos actuales para comparar
            const oldAppointmentRef = db.collection('citas').doc(editingAppointmentId);
            
            oldAppointmentRef.get()
                .then((doc) => {
                    if (doc.exists) {
                        const oldData = doc.data();
                        
                        // Normalizar nombres para comparación insensible a mayúsculas/minúsculas
                        const oldPatientNameNormalized = normalizePatientName(oldData.paciente || '');
                        const newPatientNameNormalized = normalizePatientName(patientName);
                        
                        const patientNameChanged = oldPatientNameNormalized !== newPatientNameNormalized;
                        
                        // Primero actualizar la cita actual
                        return oldAppointmentRef.set(baseAppointmentData)
                            .then(() => {
                                // Si se modificaron datos de contacto y el nombre NO cambió (ignorando mayúsculas/minúsculas),
                                // actualizar todas las citas futuras del mismo paciente
                                if (!patientNameChanged && (
                                    oldData.telefono !== phone ||
                                    oldData.correo !== email ||
                                    oldData.comuna !== comuna
                                )) {
                                    // Crear objeto con datos actualizados
                                    const updatedContactData = {
                                        telefono: phone,
                                        correo: email,
                                        comuna: comuna
                                    };
                                    
                                    // Actualizar citas futuras
                                    return updateFutureAppointmentsForPatient(patientName, updatedContactData)
                                        .then((updatedCount) => {
                                            closeAppointmentModal();
                                            if (updatedCount > 0) {
                                                showStatusMessage(`Cita actualizada y ${updatedCount} citas futuras actualizadas`, 'success');
                                            } else {
                                                showStatusMessage('Cita actualizada correctamente', 'success');
                                            }
                                            loadAppointments();
                                        });
                                } else {
                                    // Si el nombre cambió o no hay cambios en datos de contacto
                                    closeAppointmentModal();
                                    showStatusMessage('Cita actualizada correctamente', 'success');
                                    loadAppointments();
                                }
                            });
                    } else {
                        // La cita no existe
                        closeAppointmentModal();
                        showStatusMessage('La cita ya no existe', 'warning');
                        hideSpinner();
                    }
                })
                .catch((error) => {
                    console.error("Error al actualizar cita:", error);
                    hideSpinner();
                    alert('Error al actualizar la cita: ' + error.message);
                });
        } else if (isRecurring) {
            // Crear citas recurrentes usando batch
            const batch = db.batch();
            const endDate = new Date(recurrenceEndDate);
            
            // Generar todas las fechas según patrón
            const createdDates = [];
            const currentDate = new Date(date);
            while (currentDate <= endDate) {
                const currentDay = currentDate.getDay(); // 0 = domingo, 1 = lunes, ...
                
                // Si el día actual está en los días seleccionados
                if (selectedWeekdays.includes(currentDay)) {
                    const apptData = {...baseAppointmentData};
                    apptData.fecha = new Date(currentDate); // Copia de la fecha
                    
                    // Crear documento con ID automático
                    const newDocRef = db.collection('citas').doc();
                    batch.set(newDocRef, apptData);
                    
                    createdDates.push(formatDate(currentDate));
                }
                
                // Avanzar al siguiente día
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Ejecutar el batch
            batch.commit()
                .then(() => {
                    closeAppointmentModal();
                    showStatusMessage(`Creadas ${createdDates.length} citas recurrentes`, 'success');
                    loadAppointments();
                })
                .catch((error) => {
                    console.error("Error al crear citas recurrentes:", error);
                    hideSpinner();
                    alert('Error al crear citas recurrentes: ' + error.message);
                });
        } else {
            // Crear una cita simple
            db.collection('citas').add(baseAppointmentData)
                .then((docRef) => {
                    console.log("Cita creada con ID:", docRef.id);
                    closeAppointmentModal();
                    showStatusMessage('Cita creada correctamente', 'success');
                    loadAppointments();
                })
                .catch((error) => {
                    console.error("Error al crear cita:", error);
                    hideSpinner();
                    alert('Error al crear la cita: ' + error.message);
                });
        }
    } catch (error) {
        console.error("Error crítico al guardar cita:", error);
        hideSpinner();
        alert('Error crítico al guardar: ' + error.message);
    }
}


// Modificar la función deleteAppointment para manejar citas recurrentes
function deleteAppointment() {
    if (!editingAppointmentId) {
        showStatusMessage("No hay ninguna cita seleccionada para eliminar", "warning");
        return;
    }
    
    // Obtener la cita actual
    const currentAppointment = appointments.find(a => a.id === editingAppointmentId);
    
    // Verificar si es una cita recurrente
    if (currentAppointment && currentAppointment.esRecurrente && currentAppointment.serieRecurrenteId) {
        // Mostrar opciones para citas recurrentes
        const deleteOption = window.confirm('Esta es una cita recurrente. ¿Deseas eliminar todas las citas de esta serie?');
        
        if (deleteOption) {
            // Eliminar todas las citas de la serie
            showSpinner();
            
            db.collection('citas')
                .where('serieRecurrenteId', '==', currentAppointment.serieRecurrenteId)
                .get()
                .then((querySnapshot) => {
                    const batch = db.batch();
                    
                    querySnapshot.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    
                    return batch.commit();
                })
                .then(() => {
                    closeAppointmentModal();
                    showStatusMessage(`Se han eliminado todas las citas recurrentes de esta serie`, 'success');
                    loadAppointments();
                })
                .catch((error) => {
                    console.error("Error al eliminar citas recurrentes:", error);
                    hideSpinner();
                    showStatusMessage("Error al eliminar las citas recurrentes", "error");
                });
        } else {
            // Eliminar solo esta cita
            deleteSpecificAppointment(editingAppointmentId);
        }
    } else {
        // Para citas no recurrentes, eliminar normalmente
        deleteSpecificAppointment(editingAppointmentId);
    }
}

// Función para eliminar una cita específica
function deleteSpecificAppointment(appointmentId) {
    showSpinner();
    
    db.collection('citas').doc(appointmentId).delete()
        .then(() => {
            closeAppointmentModal();
            showStatusMessage('Cita eliminada correctamente', 'success');
            loadAppointments();
        })
        .catch((error) => {
            console.error("Error al eliminar cita:", error);
            hideSpinner();
            showStatusMessage("Error al eliminar la cita", "error");
        });
}

// Actualizar estadísticas de estudiantes
function updateStudentStatsTable(uniquePatients, totalSessions, attendanceRates, attendedPatients, attendedSessions) {
    console.log("🔍 Actualizando tabla de estadísticas de estudiantes...");
    
    const chartContainer = document.getElementById('student-chart');
    const chartLabels = document.getElementById('student-chart-labels');
    
    if (!chartContainer || !chartLabels) {
        console.error("❌ No se encontraron los contenedores para la tabla de estudiantes");
        return;
    }
    
    // Limpiar los contenedores
    chartContainer.innerHTML = '';
    chartLabels.innerHTML = '';
    
    // Crear tabla de estadísticas
    const statsTable = document.createElement('table');
    statsTable.className = 'student-stats-table';
    
    // Crear encabezado
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    
    ['Estudiante', 'Pacientes Únicos', 'Sesiones Agendadas', 'Sesiones Asistidas', 'Tasa de Asistencia'].forEach(text => {
        const th = document.createElement('th');
        th.textContent = text;
        headerRow.appendChild(th);
    });
    
    thead.appendChild(headerRow);
    statsTable.appendChild(thead);
    
    // Crear cuerpo de tabla
    const tbody = document.createElement('tbody');
    
    // Ordenar estudiantes por número de pacientes
    const sortedStudents = Object.keys(uniquePatients || {}).sort((a, b) => 
        (uniquePatients[b] || 0) - (uniquePatients[a] || 0)
    );
    
    console.log(`👨‍🎓 Estudiantes a mostrar: ${sortedStudents.length}`);
    
    sortedStudents.forEach(student => {
        const row = document.createElement('tr');
        
        // Nombre del estudiante
        const nameCell = document.createElement('td');
        nameCell.textContent = studentNames[student] || student;
        
        // Número de pacientes únicos
        const patientsCell = document.createElement('td');
        patientsCell.textContent = uniquePatients[student] || 0;
        
        // Número de sesiones agendadas
        const sessionsCell = document.createElement('td');
        sessionsCell.textContent = totalSessions[student] || 0;
        
        // NUEVO: Número de sesiones asistidas
        const attendedCell = document.createElement('td');
        attendedCell.textContent = attendedSessions[student] || 0;
        
        // Tasa de asistencia
        const attendanceCell = document.createElement('td');
        const attendanceRate = attendanceRates[student] || 0;
        
        // Crear indicador visual de tasa de asistencia
        const attendanceIndicator = document.createElement('div');
        attendanceIndicator.style.display = 'flex';
        attendanceIndicator.style.alignItems = 'center';
        
        const attendanceBar = document.createElement('div');
        attendanceBar.style.height = '10px';
        attendanceBar.style.width = `${attendanceRate}%`;
        attendanceBar.style.backgroundColor = getAttendanceColor(attendanceRate);
        attendanceBar.style.borderRadius = '5px';
        attendanceBar.style.marginRight = '10px';
        
        const attendanceText = document.createElement('span');
        attendanceText.textContent = `${attendanceRate}%`;
        
        attendanceIndicator.appendChild(attendanceBar);
        attendanceIndicator.appendChild(attendanceText);
        attendanceCell.appendChild(attendanceIndicator);
        
        row.appendChild(nameCell);
        row.appendChild(patientsCell);
        row.appendChild(sessionsCell);
        row.appendChild(attendedCell);
        row.appendChild(attendanceCell);
        tbody.appendChild(row);
    });
    
    statsTable.appendChild(tbody);
    
    // Añadir tabla al contenedor
    chartContainer.appendChild(statsTable);
    
    // Añadir botones de exportación
    const exportContainer = document.createElement('div');
    exportContainer.className = 'export-container';
    
    const exportExcelBtn = document.createElement('button');
    exportExcelBtn.className = 'button save-btn';
    exportExcelBtn.textContent = 'Exportar a Excel';
    exportExcelBtn.onclick = function() { exportStatisticsToExcel(); };
    
    const exportPdfBtn = document.createElement('button');
    exportPdfBtn.className = 'button save-btn';
    exportPdfBtn.textContent = 'Exportar a PDF';
    exportPdfBtn.onclick = function() { exportStatisticsToPdf(); };
    
    exportContainer.appendChild(exportExcelBtn);
    exportContainer.appendChild(exportPdfBtn);
    
    chartContainer.appendChild(exportContainer);
    
    console.log("✅ Tabla de estadísticas de estudiantes actualizada");
}


// Crear gráfico circular para tipos de cita
function createAppointmentTypeChart(typesData) {
    console.log("🔍 Creando gráfico de tipos de tratamiento...");
    
    // Verificar si existe la sección para este gráfico, si no, crearla
    let chartSection = document.getElementById('treatment-types-section');
    
    if (!chartSection) {
        const statsPanel = document.querySelector('.stats-panel');
        if (!statsPanel) {
            console.error("❌ No se encontró el panel de estadísticas");
            return;
        }
        
        chartSection = document.createElement('div');
        chartSection.id = 'treatment-types-section';
        chartSection.className = 'stats-section';
        
        const sectionTitle = document.createElement('h4');
        sectionTitle.className = 'therapist-stats-title';
        sectionTitle.textContent = 'Distribución de Tipos de Tratamiento';
        chartSection.appendChild(sectionTitle);
        
        const chartCanvas = document.createElement('div');
        chartCanvas.id = 'treatment-types-chart';
        chartCanvas.style.height = '250px';
        chartCanvas.style.position = 'relative';
        chartCanvas.style.margin = '20px auto';
        chartCanvas.style.width = '250px';
        
        chartSection.appendChild(chartCanvas);
        statsPanel.appendChild(chartSection);
    }
    
    const chartContainer = document.getElementById('treatment-types-chart');
    if (!chartContainer) {
        console.error("❌ No se encontró el contenedor para el gráfico de tipos");
        return;
    }
    
    chartContainer.innerHTML = '';
    
    // Datos para el gráfico
    const types = Object.keys(typesData);
    const counts = Object.values(typesData);
    const total = counts.reduce((sum, count) => sum + count, 0);
    
    console.log(`📊 Tipos de tratamiento: ${types.length}, Total de citas: ${total}`);
    
    // Si no hay datos, mostrar mensaje
    if (total === 0) {
        const noDataMsg = document.createElement('div');
        noDataMsg.textContent = 'No hay datos disponibles';
        noDataMsg.style.textAlign = 'center';
        noDataMsg.style.padding = '20px';
        noDataMsg.style.color = 'var(--text-secondary)';
        chartContainer.appendChild(noDataMsg);
        return;
    }
    
    // Colores para el gráfico
    const colors = [
        '#2D3FE0', // Azul principal
        '#00BFA5', // Verde azulado
        '#FF6B6B', // Coral
        '#9B59B6', // Púrpura
        '#3498DB', // Azul claro
        '#E67E22', // Naranja
        '#27AE60', // Verde
        '#F1C40F'  // Amarillo
    ];
    
    // Crear el gráfico circular (pie chart)
    let cumulativeAngle = 0;
    const centerX = 125;
    const centerY = 125;
    const radius = 100;
    
    // Crear un SVG
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', '100%');
    svg.setAttribute('height', '100%');
    svg.setAttribute('viewBox', '0 0 250 250');
    
    // Añadir un círculo blanco como fondo
    const background = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    background.setAttribute('cx', centerX);
    background.setAttribute('cy', centerY);
    background.setAttribute('r', radius);
    background.setAttribute('fill', 'white');
    background.setAttribute('stroke', '#E2E8F0');
    background.setAttribute('stroke-width', '1');
    svg.appendChild(background);
    
    types.forEach((type, index) => {
        const count = typesData[type];
        const percentage = (count / total) * 100;
        const angleSize = (percentage / 100) * 360;
        
        // Calcular coordenadas para el arco
        const startAngle = cumulativeAngle * Math.PI / 180;
        const endAngle = (cumulativeAngle + angleSize) * Math.PI / 180;
        
        const x1 = centerX + radius * Math.cos(startAngle);
        const y1 = centerY + radius * Math.sin(startAngle);
        const x2 = centerX + radius * Math.cos(endAngle);
        const y2 = centerY + radius * Math.sin(endAngle);
        
        // Determinar si el arco es mayor a 180 grados
        const largeArcFlag = angleSize > 180 ? 1 : 0;
        
        // Crear el path para el segmento del círculo
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        const d = [
            `M ${centerX} ${centerY}`,
            `L ${x1} ${y1}`,
            `A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2}`,
            'Z'
        ].join(' ');
        
        path.setAttribute('d', d);
        path.setAttribute('fill', colors[index % colors.length]);
        path.setAttribute('stroke', 'white');
        path.setAttribute('stroke-width', '1');
        
        // Agregar título con información al pasar el mouse
        const title = document.createElementNS('http://www.w3.org/2000/svg', 'title');
        title.textContent = `${getAppointmentTypeName(type)}: ${count} (${percentage.toFixed(1)}%)`;
        path.appendChild(title);
        
        svg.appendChild(path);
        
        // Actualizar ángulo acumulado
        cumulativeAngle += angleSize;
    });
    
    chartContainer.appendChild(svg);
    
    // Crear leyenda
    const legend = document.createElement('div');
    legend.className = 'chart-legend';
    
    types.forEach((type, index) => {
        const count = typesData[type];
        const percentage = (count / total) * 100;
        
        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item';
        
        const colorBox = document.createElement('div');
        colorBox.style.width = '12px';
        colorBox.style.height = '12px';
        colorBox.style.backgroundColor = colors[index % colors.length];
        colorBox.style.marginRight = '5px';
        colorBox.style.borderRadius = '2px';
        
        const label = document.createElement('span');
        label.textContent = `${getAppointmentTypeName(type)}: ${count} (${percentage.toFixed(1)}%)`;
        
        legendItem.appendChild(colorBox);
        legendItem.appendChild(label);
        legend.appendChild(legendItem);
    });
    
    chartContainer.appendChild(legend);
    
    console.log("✅ Gráfico de tipos de tratamiento creado");
}

// Función para obtener nombre legible del tipo de cita
function getAppointmentTypeName(typeClass) {
    switch(typeClass) {
        case 'evaluacion-msk': return 'Evaluación MSK';
        case 'evaluacion-deportiva': return 'Evaluación Deportiva';
        case 'sesion-msk': return 'Sesión MSK';
        case 'sesion-deportiva': return 'Sesión Deportiva';
        default: return typeClass;
    }
}

// Crear tabla de evolución de pacientes
function createPatientEvolutionTable(sessionsData) {
   console.log("🔍 Creando tabla de evolución de pacientes...");
    
    // Verificar si existe la sección para esta tabla, si no, crearla
    let evolutionSection = document.getElementById('patient-evolution-section');
    
    if (!evolutionSection) {
        const statsPanel = document.querySelector('.stats-panel');
        if (!statsPanel) {
            console.error("❌ No se encontró el panel de estadísticas");
            return;
        }
        
        evolutionSection = document.createElement('div');
        evolutionSection.id = 'patient-evolution-section';
        evolutionSection.className = 'stats-section';
        
        const sectionTitle = document.createElement('h4');
        sectionTitle.className = 'therapist-stats-title';
        sectionTitle.textContent = 'Evolución de Pacientes';
        evolutionSection.appendChild(sectionTitle);
        
        statsPanel.appendChild(evolutionSection);
    }
    
    // Convertir el objeto de sesiones por paciente a un array para ordenar
    const patientsArray = Object.keys(sessionsData).map(patient => ({
        name: patient,
        sessions: sessionsData[patient]
    }));
    
    // Ordenar por número de sesiones (descendente)
    patientsArray.sort((a, b) => b.sessions - a.sessions);
    
    console.log(`👨‍⚕️ Pacientes a mostrar: ${patientsArray.length}`);
    
    // Crear tabla
    const table = document.createElement('table');
    table.className = 'student-stats-table';
    
    // Encabezado
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    
    ['Paciente', 'Número de Sesiones', 'Estado de Evolución'].forEach(text => {
        const th = document.createElement('th');
        th.textContent = text;
        headerRow.appendChild(th);
    });
    
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // Cuerpo de la tabla
    const tbody = document.createElement('tbody');
    
    patientsArray.forEach(patient => {
        const row = document.createElement('tr');
        
        // Nombre del paciente (con primera letra capitalizada)
        const nameCell = document.createElement('td');
        nameCell.textContent = patient.name.charAt(0).toUpperCase() + patient.name.slice(1);
        
        // Número de sesiones
        const sessionsCell = document.createElement('td');
        sessionsCell.textContent = patient.sessions;
        
        // Estado de evolución basado en número de sesiones
        const evolutionCell = document.createElement('td');
        let evolutionStatus = '';
        let statusColor = '';
        
        if (patient.sessions === 1) {
            evolutionStatus = 'Evaluación Inicial';
            statusColor = '#FFC107'; // Amarillo
        } else if (patient.sessions >= 2 && patient.sessions <= 4) {
            evolutionStatus = 'En Tratamiento';
            statusColor = '#2196F3'; // Azul
        } else if (patient.sessions >= 5 && patient.sessions <= 8) {
            evolutionStatus = 'Avanzado';
            statusColor = '#4CAF50'; // Verde
        } else if (patient.sessions > 8) {
            evolutionStatus = 'Fase Final';
            statusColor = '#9C27B0'; // Púrpura
        }
        
        const statusIndicator = document.createElement('span');
        statusIndicator.textContent = evolutionStatus;
        statusIndicator.style.display = 'inline-block';
        statusIndicator.style.padding = '3px 8px';
        statusIndicator.style.borderRadius = '4px';
        statusIndicator.style.backgroundColor = statusColor;
        statusIndicator.style.color = 'white';
        statusIndicator.style.fontWeight = '500';
        statusIndicator.style.fontSize = '12px';
        
        evolutionCell.appendChild(statusIndicator);
        
        row.appendChild(nameCell);
        row.appendChild(sessionsCell);
        row.appendChild(evolutionCell);
        tbody.appendChild(row);
    });
    
    table.appendChild(tbody);
    
    // Reemplazar contenido anterior
    evolutionSection.innerHTML = '';
    const sectionTitle = document.createElement('h4');
    sectionTitle.className = 'therapist-stats-title';
    sectionTitle.textContent = 'Evolución de Pacientes';
    evolutionSection.appendChild(sectionTitle);
    evolutionSection.appendChild(table);
    
    console.log("✅ Tabla de evolución de pacientes creada");
}  
// Función para eliminar una cita específica
function deleteSpecificAppointment(appointmentId) {
    showSpinner();
    
    db.collection('citas').doc(appointmentId).delete()
        .then(() => {
            closeAppointmentModal();
            showStatusMessage('Cita eliminada correctamente', 'success');
            loadAppointments();
        })
        .catch((error) => {
            console.error("Error al eliminar cita:", error);
            hideSpinner();
            showStatusMessage("Error al eliminar la cita", "error");
        });
}

// Mover una cita a una fecha y hora específicas
function moveAppointmentToDate(appointmentId, targetDate, hour) {
    if (!isAdmin) return;
    
    const appointment = appointments.find(a => a.id === appointmentId);
    if (!appointment) {
        showStatusMessage("No se encontró la cita para mover", "error");
        return;
    }
    
    showSpinner();
    
    try {
        // Conservar minutos, pero cambiar fecha y hora
        const newDate = new Date(targetDate);
        newDate.setHours(hour, appointment.fecha.getMinutes(), 0, 0);
        
        // Actualizar fecha
        db.collection('citas').doc(appointmentId).update({
            fecha: newDate,
            historial: firebase.firestore.FieldValue.arrayUnion({
                accion: 'movimiento',
                usuario: currentUser.email,
                usuarioId: currentUser.uid,
                fecha: new Date()
            })
        })
        .then(() => {
            showStatusMessage('Cita movida correctamente', 'success');
            loadAppointments();
        })
        .catch((error) => {
            console.error("Error al mover cita:", error);
            hideSpinner();
            alert('Error al mover la cita: ' + error.message);
        });
    } catch (error) {
        console.error("Error crítico al mover cita:", error);
        hideSpinner();
        alert("Error crítico al mover: " + error.message);
    }
}

// Abrir modal de asistencia
function openAttendanceModal(appointment) {
    if (!isAdmin) return;
    
    try {
        const patientEl = document.getElementById('attendance-patient');
        const dateEl = document.getElementById('attendance-date');
        const timeEl = document.getElementById('attendance-time');
        
        patientEl.textContent = appointment.paciente || 'Sin nombre';
        
        const fecha = appointment.fecha;
        const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
        dateEl.textContent = fecha ? fecha.toLocaleDateString('es-ES', options) : 'Fecha no disponible';
        
        if (fecha) {
            const horaInicio = `${fecha.getHours().toString().padStart(2, '0')}:${fecha.getMinutes().toString().padStart(2, '0')}`;
            const fechaFin = new Date(fecha);
            fechaFin.setMinutes(fecha.getMinutes() + (appointment.duracion || 60));
            const horaFin = `${fechaFin.getHours().toString().padStart(2, '0')}:${fechaFin.getMinutes().toString().padStart(2, '0')}`;
            timeEl.textContent = `${horaInicio} - ${horaFin}`;
        } else {
            timeEl.textContent = 'Hora no disponible';
        }
        
        // Resetear selección de estado
        document.querySelectorAll('.attendance-btn').forEach(btn => {
            btn.classList.remove('selected');
        });
        
        // Seleccionar el estado actual si existe
        if (appointment.estado) {
            const currentStatusBtn = document.querySelector(`.attendance-btn[data-status="${appointment.estado}"]`);
            if (currentStatusBtn) {
                currentStatusBtn.classList.add('selected');
            }
        }
        
        // Notas de asistencia
        document.getElementById('attendance-notes').value = appointment.notasAsistencia || '';
        
        // Guardar referencia a la cita actual
        attendanceModal.dataset.appointmentId = appointment.id;
        
        // Mostrar modal
        attendanceModal.style.display = 'block';
    } catch (error) {
        console.error("Error al abrir modal de asistencia:", error);
        showStatusMessage("Error al abrir el formulario de asistencia", "error");
    }
}

// Cerrar modal de asistencia
function closeAttendanceModal() {
    attendanceModal.style.display = 'none';
}

// Guardar asistencia
function saveAttendance() {
    const appointmentId = attendanceModal.dataset.appointmentId;
    if (!appointmentId) {
        showStatusMessage("No se encontró la cita para registrar asistencia", "error");
        return;
    }
    
    const selectedBtn = document.querySelector('.attendance-btn.selected');
    
    if (!selectedBtn) {
        showStatusMessage('Por favor selecciona un estado de asistencia', 'warning');
        return;
    }
    
    const status = selectedBtn.dataset.status;
    const notes = document.getElementById('attendance-notes').value;
    
    showSpinner();
    
    try {
        // Actualizar en Firestore
        db.collection('citas').doc(appointmentId).update({
            estado: status,
            notasAsistencia: notes,
            ultimaActualizacion: new Date()
        })
        .then(() => {
            closeAttendanceModal();
            showStatusMessage('Asistencia registrada correctamente', 'success');
            loadAppointments();
        })
        .catch((error) => {
            console.error("Error al registrar asistencia:", error);
            hideSpinner();
            alert('Error al registrar la asistencia: ' + error.message);
        });
    } catch (error) {
        console.error("Error crítico al guardar asistencia:", error);
        hideSpinner();
        alert("Error crítico al guardar asistencia: " + error.message);
    }
}

// Mostrar/ocultar spinner de carga
function showSpinner() {
    spinner.style.display = 'flex';
}

function hideSpinner() {
    spinner.style.display = 'none';
}

// Mostrar mensaje de estado
function showStatusMessage(message, type = 'success') {
    statusMessage.textContent = message;
    statusMessage.className = 'status-message ' + type;
    statusMessage.style.display = 'block';
    
    // Ocultar después de 5 segundos
    setTimeout(() => {
        statusMessage.style.display = 'none';
    }, 5000);
}

// Función mejorada de búsqueda de pacientes
function setupPatientSearch() {
    const searchInput = document.getElementById('patient-search');
    const searchBtn = document.getElementById('search-btn');
    const clearBtn = document.getElementById('clear-search-btn');
    
    if (!searchInput || !searchBtn || !clearBtn) return;
    
    searchBtn.addEventListener('click', function() {
        performSearch();
    });
    
    clearBtn.addEventListener('click', function() {
        searchInput.value = '';
        document.querySelectorAll('.appointment').forEach(el => {
            el.classList.remove('highlighted');
        });
        
        // Restaurar la visualización normal
        document.querySelectorAll('.schedule-cell').forEach(el => {
            el.style.display = '';
        });
        
        // Mostrar mensaje
        showStatusMessage('Búsqueda limpiada', 'success');
    });
    
    // Permitir búsqueda al presionar Enter
    searchInput.addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });
    
    function performSearch() {
        const searchTerm = searchInput.value.trim().toLowerCase();
        if (!searchTerm) {
            showStatusMessage('Por favor ingresa un nombre para buscar', 'warning');
            return;
        }
        
        // Buscar citas que coincidan
        const matchingAppointments = appointments.filter(app => 
            app.paciente && app.paciente.toLowerCase().includes(searchTerm)
        );
        
        if (matchingAppointments.length === 0) {
            showStatusMessage(`No se encontraron citas para "${searchTerm}"`, 'warning');
        } else {
            // Primero restablecer todas las celdas y citas
            document.querySelectorAll('.appointment').forEach(el => {
                el.classList.remove('highlighted');
            });
            
            document.querySelectorAll('.schedule-cell').forEach(el => {
                el.style.display = '';
            });
            
            // Encontrar celdas que contienen citas coincidentes
            const relevantCells = new Set();
            
            matchingAppointments.forEach(app => {
                const appointmentEl = document.querySelector(`.appointment[data-id="${app.id}"]`);
                if (appointmentEl) {
                    // Resaltar la cita
                    appointmentEl.classList.add('highlighted');
                    
                    // Obtener la celda padre
                    const parentCell = appointmentEl.closest('.schedule-cell');
                    if (parentCell) {
                        relevantCells.add(parentCell);
                    }
                }
            });
            
            // Ocultar todas las celdas que no contienen citas coincidentes
            document.querySelectorAll('.schedule-cell').forEach(cell => {
                if (!relevantCells.has(cell)) {
                    // No ocultar la celda, pero reducir su opacidad
                    cell.style.opacity = '0.3';
                } else {
                    cell.style.opacity = '1';
                }
            });
            
            // Hacer scroll hacia la primera cita encontrada
            if (matchingAppointments.length > 0) {
                const firstAppointment = document.querySelector('.appointment.highlighted');
                if (firstAppointment) {
                    firstAppointment.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
            
            showStatusMessage(`Se encontraron ${matchingAppointments.length} citas para "${searchTerm}"`, 'success');
            
            // Añadir información del paciente
            if (matchingAppointments.length > 0) {
                // Usar el primer resultado para mostrar info del paciente
                const patientName = matchingAppointments[0].paciente;
                const patientSessions = matchingAppointments.length;
                
                const patientInfoMsg = `Paciente: ${patientName} | Total de citas: ${patientSessions}`;
                
                // Mostrar después de un breve retraso
                setTimeout(() => {
                    showStatusMessage(patientInfoMsg, 'info');
                }, 3000);
            }
        }
    }
}

        // Crear gráfico de asistencia
function createAttendanceChart(attended, missed, rescheduled) {
    console.log("🔍 Creando gráfico de asistencia...");
    
    // Verificar si existe la sección para este gráfico, si no, crearla
    let chartSection = document.getElementById('attendance-chart-section');
    
    if (!chartSection) {
        const statsPanel = document.querySelector('.stats-panel');
        if (!statsPanel) {
            console.error("❌ No se encontró el panel de estadísticas");
            return;
        }
        
        chartSection = document.createElement('div');
        chartSection.id = 'attendance-chart-section';
        chartSection.className = 'stats-section';
        
        const sectionTitle = document.createElement('h4');
        sectionTitle.className = 'therapist-stats-title';
        sectionTitle.textContent = 'Distribución de Asistencia';
        chartSection.appendChild(sectionTitle);
        
        const chartContainer = document.createElement('div');
        chartContainer.id = 'attendance-chart';
        chartContainer.style.height = '250px';
        chartContainer.style.position = 'relative';
        chartContainer.style.margin = '20px auto';
        chartContainer.style.display = 'flex';
        chartContainer.style.justifyContent = 'center';
        chartContainer.style.gap = '30px';
        
        chartSection.appendChild(chartContainer);
        statsPanel.appendChild(chartSection);
    }
    
    const chartContainer = document.getElementById('attendance-chart');
    if (!chartContainer) {
        console.error("❌ No se encontró el contenedor para el gráfico de asistencia");
        return;
    }
    
    chartContainer.innerHTML = '';
    
    // Si no hay datos, mostrar mensaje
    const total = attended + missed + rescheduled;
    
    console.log(`📊 Asistencias: ${attended}, Faltas: ${missed}, Reprogramadas: ${rescheduled}`);
    
    if (total === 0) {
        const noDataMsg = document.createElement('div');
        noDataMsg.textContent = 'No hay datos de asistencia disponibles';
        noDataMsg.style.textAlign = 'center';
        noDataMsg.style.padding = '20px';
        noDataMsg.style.color = 'var(--text-secondary)';
        chartContainer.appendChild(noDataMsg);
        return;
    }
    
    // Crear barras para el gráfico
    const data = [
        { label: 'Asistieron', value: attended, color: 'var(--success)' },
        { label: 'No asistieron', value: missed, color: 'var(--error)' },
        { label: 'Reprogramadas', value: rescheduled, color: 'var(--warning)' }
    ];
    
    // Encontrar el valor máximo para escalar las barras
    const maxValue = Math.max(attended, missed, rescheduled);
    
    data.forEach(item => {
        const barContainer = document.createElement('div');
        barContainer.style.display = 'flex';
        barContainer.style.flexDirection = 'column';
        barContainer.style.alignItems = 'center';
        barContainer.style.width = '80px';
        
        // Valor numérico arriba de la barra
        const valueLabel = document.createElement('div');
        valueLabel.textContent = item.value;
        valueLabel.style.fontWeight = 'bold';
        valueLabel.style.fontSize = '16px';
        valueLabel.style.marginBottom = '10px';
        barContainer.appendChild(valueLabel);
        
        // Barra
        const bar = document.createElement('div');
        const height = maxValue > 0 ? (item.value / maxValue) * 200 : 0;
        bar.style.height = `${height}px`;
        bar.style.width = '60px';
        bar.style.backgroundColor = item.color;
        bar.style.borderRadius = '4px 4px 0 0';
        barContainer.appendChild(bar);
        
        // Etiqueta debajo de la barra
        const label = document.createElement('div');
        label.textContent = item.label;
        label.style.marginTop = '10px';
        label.style.textAlign = 'center';
        label.style.fontSize = '14px';
        barContainer.appendChild(label);
        
        chartContainer.appendChild(barContainer);
    });
    
    // Añadir porcentajes debajo del gráfico
    const percentagesContainer = document.createElement('div');
    percentagesContainer.style.display = 'flex';
    percentagesContainer.style.justifyContent = 'center';
    percentagesContainer.style.gap = '20px';
    percentagesContainer.style.marginTop = '20px';
    
    data.forEach(item => {
        const percent = total > 0 ? Math.round((item.value / total) * 100) : 0;
        
        const percentBox = document.createElement('div');
        percentBox.style.padding = '8px 12px';
        percentBox.style.backgroundColor = item.color;
        percentBox.style.color = 'white';
        percentBox.style.borderRadius = '4px';
        percentBox.style.fontWeight = 'bold';
        percentBox.textContent = `${percent}%`;
        
        percentagesContainer.appendChild(percentBox);
    });
    
    chartSection.appendChild(percentagesContainer);
    
    console.log("✅ Gráfico de asistencia creado");
}

// Actualizar tabla de estudiantes con datos de asistencia
function updateStudentStats(uniquePatients, totalSessions, attendanceRates) {
    const chartContainer = document.getElementById('student-chart');
    const chartLabels = document.getElementById('student-chart-labels');
    
    if (chartContainer && chartLabels) {
        chartContainer.innerHTML = '';
        chartLabels.innerHTML = '';
        
        // Crear tabla de estadísticas en lugar de gráfico
        const statsTable = document.createElement('table');
        statsTable.className = 'student-stats-table';
        statsTable.style.width = '100%';
        statsTable.style.borderCollapse = 'collapse';
        statsTable.style.marginTop = '20px';
        
        // Crear encabezado
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        
        ['Estudiante', 'Pacientes Únicos', 'Total Sesiones', 'Tasa de Asistencia'].forEach(text => {
            const th = document.createElement('th');
            th.textContent = text;
            th.style.padding = '10px';
            th.style.textAlign = 'left';
            th.style.borderBottom = '2px solid var(--border)';
            headerRow.appendChild(th);
        });
        
        thead.appendChild(headerRow);
        statsTable.appendChild(thead);
        
        // Crear cuerpo de tabla
        const tbody = document.createElement('tbody');
        
        // Ordenar estudiantes por número de pacientes
        const sortedStudents = Object.keys(uniquePatients || {}).sort((a, b) => 
            (uniquePatients[b] || 0) - (uniquePatients[a] || 0)
        );
        
        sortedStudents.forEach(student => {
            const row = document.createElement('tr');
            
            // Nombre del estudiante
            const nameCell = document.createElement('td');
            nameCell.textContent = studentNames[student] || student;
            nameCell.style.padding = '10px';
            nameCell.style.borderBottom = '1px solid var(--border)';
            
            // Número de pacientes únicos
            const patientsCell = document.createElement('td');
            patientsCell.textContent = uniquePatients[student] || 0;
            patientsCell.style.padding = '10px';
            patientsCell.style.borderBottom = '1px solid var(--border)';
            
            // Número total de sesiones
            const sessionsCell = document.createElement('td');
            sessionsCell.textContent = totalSessions[student] || 0;
            sessionsCell.style.padding = '10px';
            sessionsCell.style.borderBottom = '1px solid var(--border)';
            
            // Tasa de asistencia
            const attendanceCell = document.createElement('td');
            const attendanceRate = attendanceRates[student] || 0;
            
            // Crear indicador visual de tasa de asistencia
            const attendanceIndicator = document.createElement('div');
            attendanceIndicator.style.display = 'flex';
            attendanceIndicator.style.alignItems = 'center';
            
            const attendanceBar = document.createElement('div');
            attendanceBar.style.height = '10px';
            attendanceBar.style.width = `${attendanceRate}%`;
            attendanceBar.style.backgroundColor = getAttendanceColor(attendanceRate);
            attendanceBar.style.borderRadius = '5px';
            attendanceBar.style.marginRight = '10px';
            
            const attendanceText = document.createElement('span');
            attendanceText.textContent = `${attendanceRate}%`;
            
            attendanceIndicator.appendChild(attendanceBar);
            attendanceIndicator.appendChild(attendanceText);
            attendanceCell.appendChild(attendanceIndicator);
            attendanceCell.style.padding = '10px';
            attendanceCell.style.borderBottom = '1px solid var(--border)';
            
            row.appendChild(nameCell);
            row.appendChild(patientsCell);
            row.appendChild(sessionsCell);
            row.appendChild(attendanceCell);
            tbody.appendChild(row);
        });
        
        statsTable.appendChild(tbody);
        
        // Reemplazar el gráfico con la tabla
        chartContainer.appendChild(statsTable);
        
        // Añadir un botón para exportar estadísticas
        const exportContainer = document.createElement('div');
        exportContainer.className = 'export-container';
        exportContainer.style.marginTop = '20px';
        exportContainer.style.textAlign = 'center';
        
        const exportExcelBtn = document.createElement('button');
        exportExcelBtn.className = 'button save-btn';
        exportExcelBtn.style.marginRight = '10px';
        exportExcelBtn.textContent = 'Exportar a Excel';
        exportExcelBtn.onclick = function() { exportStatisticsToExcel(); };
        
        const exportPdfBtn = document.createElement('button');
        exportPdfBtn.className = 'button save-btn';
        exportPdfBtn.textContent = 'Exportar a PDF';
        exportPdfBtn.onclick = function() { exportStatisticsToPdf(); };
        
        exportContainer.appendChild(exportExcelBtn);
        exportContainer.appendChild(exportPdfBtn);
        
        chartContainer.appendChild(exportContainer);
    }
}

// Obtener color según tasa de asistencia
function getAttendanceColor(rate) {
    if (rate >= 90) return 'var(--success)';
    if (rate >= 70) return '#8BC34A'; // Verde-amarillo
    if (rate >= 50) return 'var(--warning)';
    return 'var(--error)';
}

// Gráfico de tipos de cita mejorado
function createAppointmentTypeChartFixed(typesData, attendedTypesData) {
    console.log("🔍 Creando gráfico de tipos de tratamiento...");
    
    // Verificar si existe la sección para este gráfico, si no, crearla
    let chartSection = document.getElementById('treatment-types-section');
    
    if (!chartSection) {
        const statsPanel = document.querySelector('.stats-panel');
        if (!statsPanel) {
            console.error("❌ No se encontró el panel de estadísticas");
            return;
        }
        
        chartSection = document.createElement('div');
        chartSection.id = 'treatment-types-section';
        chartSection.className = 'stats-section';
        
        const sectionTitle = document.createElement('h4');
        sectionTitle.className = 'therapist-stats-title';
        sectionTitle.textContent = 'Distribución de Tipos de Tratamiento';
        chartSection.appendChild(sectionTitle);
        
        statsPanel.appendChild(chartSection);
    } else {
        // Mantener el título pero limpiar el resto
        const title = chartSection.querySelector('.therapist-stats-title');
        chartSection.innerHTML = '';
        if (title) chartSection.appendChild(title);
    }
    
    // Convertir datos a array para procesamiento
    const chartData = [];
    let totalAgendadas = 0;
    let totalAsistidas = 0;
    
    for (const type in typesData) {
        const count = typesData[type];
        const attendedCount = attendedTypesData[type] || 0;
        totalAgendadas += count;
        totalAsistidas += attendedCount;
        
        chartData.push({
            type: type,
            typeName: getAppointmentTypeName(type),
            count: count,
            attendedCount: attendedCount
        });
    }
    
    // Ordenar por cantidad (mayor a menor)
    chartData.sort((a, b) => b.count - a.count);
    
    // NUEVO: Mensaje aclaratorio
    const clarificationMsg = document.createElement('div');
    clarificationMsg.style.padding = '10px 15px';
    clarificationMsg.style.backgroundColor = 'rgba(45, 63, 224, 0.1)';
    clarificationMsg.style.borderRadius = '5px';
    clarificationMsg.style.marginBottom = '20px';
    clarificationMsg.style.fontSize = '13px';
    clarificationMsg.innerHTML = "<strong>Nota:</strong> Se muestra la comparación entre sesiones agendadas y sesiones a las que el paciente realmente asistió.";
    chartSection.appendChild(clarificationMsg);
    
    // Crear contenedor para el gráfico
    const chartContainer = document.createElement('div');
    chartContainer.style.display = 'flex';
    chartContainer.style.flexDirection = 'column';
    chartContainer.style.marginTop = '20px';
    chartContainer.style.backgroundColor = 'white';
    chartContainer.style.borderRadius = '8px';
    chartContainer.style.padding = '20px';
    chartContainer.style.boxShadow = 'var(--shadow)';
    
    // Mostrar total
    const totalContainer = document.createElement('div');
    totalContainer.style.display = 'flex';
    totalContainer.style.justifyContent = 'space-around';
    totalContainer.style.marginBottom = '20px';
    totalContainer.style.padding = '10px';
    totalContainer.style.borderBottom = '1px solid #eee';
    
    // Total agendadas
    const totalAgendadasDiv = document.createElement('div');
    totalAgendadasDiv.style.textAlign = 'center';
    totalAgendadasDiv.innerHTML = `
        <div style="font-size: 24px; font-weight: bold; color: #2D3FE0;">${totalAgendadas}</div>
        <div style="font-size: 14px; color: #718096;">Total Agendadas</div>
    `;
    
    // Total asistidas
    const totalAsistidasDiv = document.createElement('div');
    totalAsistidasDiv.style.textAlign = 'center';
    totalAsistidasDiv.innerHTML = `
        <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">${totalAsistidas}</div>
        <div style="font-size: 14px; color: #718096;">Total Asistidas</div>
    `;
    
    // Tasa de asistencia
    const attendanceRate = totalAgendadas > 0 ? Math.round((totalAsistidas / totalAgendadas) * 100) : 0;
    const tasaDiv = document.createElement('div');
    tasaDiv.style.textAlign = 'center';
    tasaDiv.innerHTML = `
        <div style="font-size: 24px; font-weight: bold; color: #FF6B6B;">${attendanceRate}%</div>
        <div style="font-size: 14px; color: #718096;">Tasa Asistencia</div>
    `;
    
    totalContainer.appendChild(totalAgendadasDiv);
    totalContainer.appendChild(totalAsistidasDiv);
    totalContainer.appendChild(tasaDiv);
    chartContainer.appendChild(totalContainer);
    
    // Leyenda
    const legend = document.createElement('div');
    legend.style.display = 'flex';
    legend.style.justifyContent = 'center';
    legend.style.gap = '20px';
    legend.style.marginBottom = '15px';
    
    // Leyenda agendadas
    const agendadasLegend = document.createElement('div');
    agendadasLegend.style.display = 'flex';
    agendadasLegend.style.alignItems = 'center';
    
    const agendadasColor = document.createElement('div');
    agendadasColor.style.width = '14px';
    agendadasColor.style.height = '14px';
    agendadasColor.style.backgroundColor = '#2D3FE0';
    agendadasColor.style.marginRight = '5px';
    agendadasColor.style.borderRadius = '2px';
    
    agendadasLegend.appendChild(agendadasColor);
    agendadasLegend.appendChild(document.createTextNode('Sesiones Agendadas'));
    
    // Leyenda asistidas
    const asistidasLegend = document.createElement('div');
    asistidasLegend.style.display = 'flex';
    asistidasLegend.style.alignItems = 'center';
    
    const asistidasColor = document.createElement('div');
    asistidasColor.style.width = '14px';
    asistidasColor.style.height = '14px';
    asistidasColor.style.backgroundColor = '#4CAF50';
    asistidasColor.style.marginRight = '5px';
    asistidasColor.style.borderRadius = '2px';
    
    asistidasLegend.appendChild(asistidasColor);
    asistidasLegend.appendChild(document.createTextNode('Sesiones Asistidas'));
    
    legend.appendChild(agendadasLegend);
    legend.appendChild(asistidasLegend);
    chartContainer.appendChild(legend);
    
    // Crear barras para cada tipo
    chartData.forEach(item => {
        const barRow = document.createElement('div');
        barRow.style.marginBottom = '20px';
        
        // Título del tipo
        const typeTitle = document.createElement('div');
        typeTitle.style.marginBottom = '8px';
        typeTitle.style.fontWeight = '500';
        typeTitle.textContent = item.typeName;
        barRow.appendChild(typeTitle);
        
        // Contenedor de barras
        const barsContainer = document.createElement('div');
        barsContainer.style.display = 'flex';
        barsContainer.style.alignItems = 'center';
        barsContainer.style.gap = '10px';
        
        // 1. Barra de agendadas
        const agendadasContainer = document.createElement('div');
        agendadasContainer.style.flex = '1';
        agendadasContainer.style.position = 'relative';
        
        const agendadasBar = document.createElement('div');
        agendadasBar.style.height = '24px';
        agendadasBar.style.backgroundColor = '#f0f0f0';
        agendadasBar.style.borderRadius = '4px';
        agendadasBar.style.overflow = 'hidden';
        
        const agendadasFill = document.createElement('div');
        const percentageAgendadas = totalAgendadas > 0 ? (item.count / totalAgendadas) * 100 : 0;
        agendadasFill.style.width = `${percentageAgendadas}%`;
        agendadasFill.style.height = '100%';
        agendadasFill.style.backgroundColor = '#2D3FE0';
        agendadasFill.style.borderRadius = '4px';
        
        // Etiqueta con número
        const agendadasLabel = document.createElement('div');
        agendadasLabel.style.position = 'absolute';
        agendadasLabel.style.top = '0';
        agendadasLabel.style.left = '10px';
        agendadasLabel.style.height = '100%';
        agendadasLabel.style.display = 'flex';
        agendadasLabel.style.alignItems = 'center';
        agendadasLabel.style.color = percentageAgendadas > 30 ? 'white' : 'black';
        agendadasLabel.style.fontWeight = '500';
        agendadasLabel.style.fontSize = '13px';
        agendadasLabel.textContent = `${item.count} (${Math.round(percentageAgendadas)}%)`;
        
        agendadasBar.appendChild(agendadasFill);
        agendadasContainer.appendChild(agendadasBar);
        agendadasContainer.appendChild(agendadasLabel);
        
        // 2. Barra de asistidas
        const asistidasContainer = document.createElement('div');
        asistidasContainer.style.flex = '1';
        asistidasContainer.style.position = 'relative';
        
        const asistidasBar = document.createElement('div');
        asistidasBar.style.height = '24px';
        asistidasBar.style.backgroundColor = '#f0f0f0';
        asistidasBar.style.borderRadius = '4px';
        asistidasBar.style.overflow = 'hidden';
        
        const asistidasFill = document.createElement('div');
        const percentageAsistidas = totalAsistidas > 0 ? (item.attendedCount / totalAsistidas) * 100 : 0;
        asistidasFill.style.width = `${percentageAsistidas}%`;
        asistidasFill.style.height = '100%';
        asistidasFill.style.backgroundColor = '#4CAF50';
        asistidasFill.style.borderRadius = '4px';
        
        // Etiqueta con número
        const asistidasLabel = document.createElement('div');
        asistidasLabel.style.position = 'absolute';
        asistidasLabel.style.top = '0';
        asistidasLabel.style.left = '10px';
        asistidasLabel.style.height = '100%';
        asistidasLabel.style.display = 'flex';
        asistidasLabel.style.alignItems = 'center';
        asistidasLabel.style.color = percentageAsistidas > 30 ? 'white' : 'black';
        asistidasLabel.style.fontWeight = '500';
        asistidasLabel.style.fontSize = '13px';
        asistidasLabel.textContent = `${item.attendedCount} (${Math.round(percentageAsistidas)}%)`;
        
        asistidasBar.appendChild(asistidasFill);
        asistidasContainer.appendChild(asistidasBar);
        asistidasContainer.appendChild(asistidasLabel);
        
        barsContainer.appendChild(agendadasContainer);
        barsContainer.appendChild(asistidasContainer);
        barRow.appendChild(barsContainer);
        
        // Mostrar tasa de asistencia para este tipo
        const typeAttendanceRate = item.count > 0 ? Math.round((item.attendedCount / item.count) * 100) : 0;
        
        const attendanceRow = document.createElement('div');
        attendanceRow.style.display = 'flex';
        attendanceRow.style.justifyContent = 'flex-end';
        attendanceRow.style.fontSize = '12px';
        attendanceRow.style.marginTop = '4px';
        attendanceRow.style.color = typeAttendanceRate >= 70 ? '#4CAF50' : typeAttendanceRate >= 50 ? '#FF9800' : '#F44336';
        attendanceRow.textContent = `Tasa de asistencia: ${typeAttendanceRate}%`;
        
        barRow.appendChild(attendanceRow);
        chartContainer.appendChild(barRow);
    });
    
    chartSection.appendChild(chartContainer);
    
    console.log("✅ Gráfico de tipos de tratamiento creado");
}
// Tabla de evolución de pacientes basada en sesiones ASISTIDAS
function createPatientEvolutionTableFixed(agendadasData, asistidasData) {
    console.log("🔍 Creando tabla de evolución de pacientes...");
    
    // Verificar si existe la sección para esta tabla
    let evolutionSection = document.getElementById('patient-evolution-section');
    
    if (!evolutionSection) {
        const statsPanel = document.querySelector('.stats-panel');
        if (!statsPanel) {
            console.error("❌ No se encontró el panel de estadísticas");
            return;
        }
        
        evolutionSection = document.createElement('div');
        evolutionSection.id = 'patient-evolution-section';
        evolutionSection.className = 'stats-section';
        
        const sectionTitle = document.createElement('h4');
        sectionTitle.className = 'therapist-stats-title';
        sectionTitle.textContent = 'Evolución de Pacientes (Basada en Asistencias Reales)';
        evolutionSection.appendChild(sectionTitle);
        
        statsPanel.appendChild(evolutionSection);
    } else {
        // Mantener el título pero limpiar el resto
        const title = evolutionSection.querySelector('.therapist-stats-title');
        evolutionSection.innerHTML = '';
        if (title) evolutionSection.appendChild(title);
    }
    
    // Convertir a array para ordenar (basado en sesiones ASISTIDAS)
    const patientsArray = Object.keys(asistidasData).map(patient => ({
        name: patient,
        totalSessions: agendadasData[patient] || 0,
        attendedSessions: asistidasData[patient] || 0
    }));
    
    // Ordenar por número de sesiones ASISTIDAS (descendente)
    patientsArray.sort((a, b) => b.attendedSessions - a.attendedSessions);
    
    // Agrupar pacientes por estado de evolución BASADO EN ASISTENCIAS
    const evolution = {
        'evaluacion': { count: 0, label: 'Evaluación Inicial', info: '1 sesión asistida', color: '#FFC107' },
        'tratamiento': { count: 0, label: 'En Tratamiento', info: '2-14 sesiones asistidas', color: '#2196F3' },
        'avanzado': { count: 0, label: 'Avanzado', info: '15-19 sesiones asistidas', color: '#4CAF50' },
        'final': { count: 0, label: 'Fase Final', info: '20+ sesiones asistidas', color: '#9C27B0' }
    };
    
    // Contar pacientes por categoría BASADO EN ASISTENCIAS
    patientsArray.forEach(patient => {
        if (patient.attendedSessions === 1) {
            evolution.evaluacion.count++;
        } else if (patient.attendedSessions >= 2 && patient.attendedSessions <= 14) {
            evolution.tratamiento.count++;
        } else if (patient.attendedSessions >= 15 && patient.attendedSessions <= 19) {
            evolution.avanzado.count++;
        } else if (patient.attendedSessions >= 20) {
            evolution.final.count++;
        }
    });
    
    // Crear resumen visual de evolución
    const summaryBox = document.createElement('div');
    summaryBox.style.display = 'flex';
    summaryBox.style.justifyContent = 'space-between';
    summaryBox.style.flexWrap = 'wrap';
    summaryBox.style.gap = '15px';
    summaryBox.style.margin = '20px 0';
    
    // Mensaje aclaratorio
    const clarificationMsg = document.createElement('div');
    clarificationMsg.style.flex = '1 1 100%';
    clarificationMsg.style.padding = '10px';
    clarificationMsg.style.backgroundColor = 'rgba(45, 63, 224, 0.1)';
    clarificationMsg.style.borderRadius = '5px';
    clarificationMsg.style.marginBottom = '10px';
    clarificationMsg.style.fontStyle = 'italic';
    clarificationMsg.style.fontSize = '13px';
    clarificationMsg.innerHTML = "<strong>Nota:</strong> Esta clasificación se basa únicamente en las sesiones a las que el paciente realmente asistió, no en las agendadas.";
    summaryBox.appendChild(clarificationMsg);
    
    // Mostrar total de pacientes con al menos una asistencia
    const patientsWithAttendance = patientsArray.filter(p => p.attendedSessions > 0);
    const totalPatients = patientsWithAttendance.length;
    const totalBox = document.createElement('div');
    totalBox.style.textAlign = 'center';
    totalBox.style.flex = '1 1 100%';
    totalBox.style.marginBottom = '10px';
    totalBox.innerHTML = `<span style="font-size: 18px; font-weight: bold;">Total: ${totalPatients} pacientes con asistencias</span>`;
    summaryBox.appendChild(totalBox);
    
    // Crear cuadros para cada estado
    Object.keys(evolution).forEach(key => {
        const category = evolution[key];
        const percentage = totalPatients > 0 ? Math.round((category.count / totalPatients) * 100) : 0;
        
        const box = document.createElement('div');
        box.style.flex = '1';
        box.style.minWidth = '150px';
        box.style.maxWidth = '220px';
        box.style.backgroundColor = 'white';
        box.style.borderRadius = '8px';
        box.style.padding = '15px';
        box.style.boxShadow = 'var(--shadow)';
        box.style.borderTop = `4px solid ${category.color}`;
        box.style.textAlign = 'center';
        
        box.innerHTML = `
            <div style="font-weight: bold;">${category.label}</div>
            <div style="font-size: 24px; font-weight: bold; color: ${category.color}; margin: 10px 0;">${category.count}</div>
            <div style="font-size: 12px; color: var(--text-secondary);">${category.info}</div>
            <div style="font-size: 14px; margin-top: 8px;">${percentage}% del total</div>
        `;
        
        summaryBox.appendChild(box);
    });
    
    evolutionSection.appendChild(summaryBox);
    
    // Si hay pacientes, crear tabla detallada
    if (patientsArray.length > 0) {
        const tableContainer = document.createElement('div');
        tableContainer.style.marginTop = '30px';
        tableContainer.style.backgroundColor = 'white';
        tableContainer.style.borderRadius = '8px';
        tableContainer.style.padding = '20px';
        tableContainer.style.boxShadow = 'var(--shadow)';
        
        const tableTitle = document.createElement('h5');
        tableTitle.style.marginBottom = '15px';
        tableTitle.style.fontSize = '16px';
        tableTitle.style.fontWeight = '600';
        tableTitle.textContent = 'Detalle de Pacientes por Etapa';
        tableContainer.appendChild(tableTitle);
        
        // Crear tabla
        const table = document.createElement('table');
        table.className = 'student-stats-table';
        table.style.width = '100%';
        
        // Encabezado
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        
        ['Paciente', 'Sesiones Agendadas', 'Sesiones Asistidas', 'Etapa de Tratamiento'].forEach(text => {
            const th = document.createElement('th');
            th.textContent = text;
            headerRow.appendChild(th);
        });
        
        thead.appendChild(headerRow);
        table.appendChild(thead);
        
        // Cuerpo de la tabla (mostrar solo los primeros 10 pacientes)
        const tbody = document.createElement('tbody');
        const displayPatients = patientsArray.slice(0, 10); // Limitar a 10 filas
        
        displayPatients.forEach(patient => {
            const row = document.createElement('tr');
            
            // Nombre del paciente (capitalizado)
            const nameCell = document.createElement('td');
            nameCell.textContent = patient.name
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
            
            // Número de sesiones agendadas
            const agendadasCell = document.createElement('td');
            agendadasCell.textContent = patient.totalSessions;
            
            // Número de sesiones asistidas
            const asistidasCell = document.createElement('td');
            asistidasCell.textContent = patient.attendedSessions;
            
            // Etapa de evolución (basada en asistencias reales)
            const stageCell = document.createElement('td');
            let stage, color;
            
            if (patient.attendedSessions === 0) {
                stage = 'Sin asistencias';
                color = '#B0BEC5'; // Gris
            } else if (patient.attendedSessions === 1) {
                stage = 'Evaluación Inicial';
                color = evolution.evaluacion.color;
            } else if (patient.attendedSessions >= 2 && patient.attendedSessions <= 14) {
                stage = 'En Tratamiento';
                color = evolution.tratamiento.color;
            } else if (patient.attendedSessions >= 15 && patient.attendedSessions <= 19) {
                stage = 'Avanzado';
                color = evolution.avanzado.color;
            } else if (patient.attendedSessions >= 20) {
                stage = 'Fase Final';
                color = evolution.final.color;
            }
            
            const badge = document.createElement('span');
            badge.textContent = stage;
            badge.style.backgroundColor = color;
            badge.style.color = 'white';
            badge.style.padding = '4px 8px';
            badge.style.borderRadius = '4px';
            badge.style.fontSize = '12px';
            badge.style.fontWeight = '500';
            
            stageCell.appendChild(badge);
            
            row.appendChild(nameCell);
            row.appendChild(agendadasCell);
            row.appendChild(asistidasCell);
            row.appendChild(stageCell);
            tbody.appendChild(row);
        });
        
        table.appendChild(tbody);
        tableContainer.appendChild(table);
        
        // Mostrar nota si hay más pacientes
        if (patientsArray.length > 10) {
            const note = document.createElement('div');
            note.style.marginTop = '10px';
            note.style.fontSize = '12px';
            note.style.color = 'var(--text-secondary)';
            note.style.textAlign = 'center';
            note.textContent = `Mostrando 10 de ${patientsArray.length} pacientes. Exporta a Excel para ver todos.`;
            tableContainer.appendChild(note);
        }
        
        evolutionSection.appendChild(tableContainer);
    }
    
    console.log("✅ Tabla de evolución de pacientes creada");
}
        // Gráfico de asistencia mejorado
function createAttendanceChartFixed(attended, missed, rescheduled) {
    console.log("🔍 Creando gráfico de asistencia...");
    
    // Verificar si existe la sección para este gráfico
    let chartSection = document.getElementById('attendance-chart-section');
    
    if (!chartSection) {
        const statsPanel = document.querySelector('.stats-panel');
        if (!statsPanel) {
            console.error("❌ No se encontró el panel de estadísticas");
            return;
        }
        
        chartSection = document.createElement('div');
        chartSection.id = 'attendance-chart-section';
        chartSection.className = 'stats-section';
        
        const sectionTitle = document.createElement('h4');
        sectionTitle.className = 'therapist-stats-title';
        sectionTitle.textContent = 'Distribución de Asistencia';
        chartSection.appendChild(sectionTitle);
        
        statsPanel.appendChild(chartSection);
    } else {
        // Mantener el título pero limpiar el resto
        const title = chartSection.querySelector('.therapist-stats-title');
        chartSection.innerHTML = '';
        if (title) chartSection.appendChild(title);
    }
    
    // Calcular totales
    const total = attended + missed + rescheduled;
    
    // Si no hay datos, mostrar mensaje
    if (total === 0) {
        const noDataMsg = document.createElement('div');
        noDataMsg.textContent = 'No hay datos de asistencia disponibles';
        noDataMsg.style.textAlign = 'center';
        noDataMsg.style.padding = '20px';
        noDataMsg.style.color = 'var(--text-secondary)';
        chartSection.appendChild(noDataMsg);
        return;
    }
    
    // Crear el contenedor principal
    const mainContainer = document.createElement('div');
    mainContainer.style.display = 'flex';
    mainContainer.style.flexWrap = 'wrap';
    mainContainer.style.justifyContent = 'space-between';
    mainContainer.style.gap = '20px';
    mainContainer.style.marginTop = '20px';
    
    // 1. PANEL DE NÚMEROS GRANDES
    const numbersPanel = document.createElement('div');
    numbersPanel.style.flex = '1';
    numbersPanel.style.minWidth = '300px';
    numbersPanel.style.backgroundColor = 'white';
    numbersPanel.style.borderRadius = '8px';
    numbersPanel.style.padding = '20px';
    numbersPanel.style.boxShadow = 'var(--shadow)';
    
    // Título del panel
    const panelTitle = document.createElement('div');
    panelTitle.style.fontSize = '16px';
    panelTitle.style.fontWeight = '600';
    panelTitle.style.marginBottom = '15px';
    panelTitle.style.textAlign = 'center';
    panelTitle.textContent = 'Conteo de Asistencia';
    numbersPanel.appendChild(panelTitle);
    
    // Contenedor para los números
    const numbersContainer = document.createElement('div');
    numbersContainer.style.display = 'flex';
    numbersContainer.style.justifyContent = 'space-around';
    numbersContainer.style.flexWrap = 'wrap';
    
    // Datos de asistencia con colores
    const attendanceData = [
        { label: 'Asistieron', value: attended, color: 'var(--success)' },
        { label: 'No asistieron', value: missed, color: 'var(--error)' },
        { label: 'Reprogramadas', value: rescheduled, color: 'var(--warning)' },
        { label: 'Total', value: total, color: 'var(--accent-blue)' }
    ];
    
    // Crear cada contador
    attendanceData.forEach(item => {
        const counterBox = document.createElement('div');
        counterBox.style.textAlign = 'center';
        counterBox.style.margin = '10px';
        counterBox.style.minWidth = '100px';
        
        // Número grande
        const number = document.createElement('div');
        number.style.fontSize = '36px';
        number.style.fontWeight = 'bold';
        number.style.color = item.color;
        number.textContent = item.value;
        
        // Etiqueta
        const label = document.createElement('div');
        label.style.marginTop = '5px';
        label.style.color = 'var(--text-secondary)';
        label.textContent = item.label;
        
        counterBox.appendChild(number);
        counterBox.appendChild(label);
        numbersContainer.appendChild(counterBox);
    });
    
    numbersPanel.appendChild(numbersContainer);
    mainContainer.appendChild(numbersPanel);
    
    // 2. GRÁFICO DE BARRAS
    const chartPanel = document.createElement('div');
    chartPanel.style.flex = '1';
    chartPanel.style.minWidth = '300px';
    chartPanel.style.backgroundColor = 'white';
    chartPanel.style.borderRadius = '8px';
    chartPanel.style.padding = '20px';
    chartPanel.style.boxShadow = 'var(--shadow)';
    
    // Título del gráfico
    const chartTitle = document.createElement('div');
    chartTitle.style.fontSize = '16px';
    chartTitle.style.fontWeight = '600';
    chartTitle.style.marginBottom = '15px';
    chartTitle.style.textAlign = 'center';
    chartTitle.textContent = 'Porcentajes de Asistencia';
    chartPanel.appendChild(chartTitle);
    
    // Contenedor para el gráfico
    const barChartContainer = document.createElement('div');
    barChartContainer.style.display = 'flex';
    barChartContainer.style.height = '200px';
    barChartContainer.style.alignItems = 'flex-end';
    barChartContainer.style.justifyContent = 'center';
    barChartContainer.style.gap = '40px';
    barChartContainer.style.marginTop = '20px';
    barChartContainer.style.marginBottom = '20px';
    
    // Excluir el total para el gráfico de barras
    const barData = attendanceData.slice(0, 3);
    
    // Valor máximo para escalar las barras
    const maxValue = Math.max(...barData.map(item => item.value));
    
    // Crear cada barra
    barData.forEach(item => {
        const barContainer = document.createElement('div');
        barContainer.style.display = 'flex';
        barContainer.style.flexDirection = 'column';
        barContainer.style.alignItems = 'center';
        barContainer.style.width = '60px';
        
        // Porcentaje
        const percentage = total > 0 ? Math.round((item.value / total) * 100) : 0;
        const percentLabel = document.createElement('div');
        percentLabel.style.marginBottom = '10px';
        percentLabel.style.fontWeight = 'bold';
        percentLabel.textContent = `${percentage}%`;
        barContainer.appendChild(percentLabel);
        
        // Barra
        const barWrapper = document.createElement('div');
        barWrapper.style.width = '60px';
        barWrapper.style.height = '160px';
        barWrapper.style.display = 'flex';
        barWrapper.style.alignItems = 'flex-end';
        
        const bar = document.createElement('div');
        const height = maxValue > 0 ? (item.value / maxValue) * 160 : 0;
        bar.style.height = `${height}px`;
        bar.style.width = '100%';
        bar.style.backgroundColor = item.color;
        bar.style.borderRadius = '4px 4px 0 0';
        bar.style.transition = 'height 1s ease-in-out';
        barWrapper.appendChild(bar);
        barContainer.appendChild(barWrapper);
        
        // Etiqueta
        const label = document.createElement('div');
        label.style.marginTop = '10px';
        label.style.textAlign = 'center';
        label.style.fontSize = '12px';
        label.style.maxWidth = '70px';
        label.textContent = item.label;
        barContainer.appendChild(label);
        
        barChartContainer.appendChild(barContainer);
    });
    
    chartPanel.appendChild(barChartContainer);
    mainContainer.appendChild(chartPanel);
    
    // Añadir el contenedor principal a la sección
    chartSection.appendChild(mainContainer);
    
    console.log("✅ Gráfico de asistencia creado");
}

        // Optimizar la carga inicial de datos
function optimizeInitialLoad() {
    // Mostrar una versión esqueleto mientras cargan los datos
    console.log("Optimizando carga inicial...");
    
    // Primero mostrar la interfaz sin datos
    mainContainer.style.display = 'block';
    
    // Cargar datos en segundo plano
    setTimeout(() => {
        try {
            loadStudentNames()
                .then(() => {
                    loadAppointments();
                    console.log("Carga optimizada completada");
                });
        } catch (error) {
            console.error("Error en carga optimizada:", error);
            loadSampleAppointments();
        }
    }, 100);
}

        // Configurar filtros de citas
function setupFilters() {
    const studentFilter = document.getElementById('student-filter');
    const typeFilter = document.getElementById('type-filter');
    const applyBtn = document.getElementById('apply-filters-btn');
    const clearBtn = document.getElementById('clear-filters-btn');
    
    if (!studentFilter || !typeFilter || !applyBtn || !clearBtn) return;
    
    // Llenar el filtro de estudiantes
    for (const code in studentNames) {
        const option = document.createElement('option');
        option.value = code;
        option.textContent = studentNames[code];
        studentFilter.appendChild(option);
    }
    
    // Aplicar filtros
    applyBtn.addEventListener('click', function() {
        const selectedStudent = studentFilter.value;
        const selectedType = typeFilter.value;
        
        // Ocultar todas las citas primero
        document.querySelectorAll('.appointment').forEach(el => {
            el.style.display = 'none';
        });
        
        // Mostrar sólo las que cumplen los filtros
        document.querySelectorAll('.appointment').forEach(el => {
            const matchesStudent = !selectedStudent || el.classList.contains(selectedStudent);
            const matchesType = !selectedType || el.classList.contains(selectedType);
            
            if (matchesStudent && matchesType) {
                el.style.display = '';
            }
        });
        
        showStatusMessage('Filtros aplicados', 'success');
    });
    
    // Limpiar filtros
    clearBtn.addEventListener('click', function() {
        studentFilter.value = '';
        typeFilter.value = '';
        
        // Mostrar todas las citas
        document.querySelectorAll('.appointment').forEach(el => {
            el.style.display = '';
        });
        
        showStatusMessage('Filtros limpiados', 'success');
    });
}

        // Gráfico circular de distribución por comunas
function createComunasChartFixed(comunasData) {
    console.log("🔍 Creando gráfico de distribución por comunas...");
    
    // Verificar si existe la sección para este gráfico
    let chartSection = document.getElementById('comunas-chart-section');
    
    if (!chartSection) {
        const statsPanel = document.querySelector('.stats-panel');
        if (!statsPanel) {
            console.error("❌ No se encontró el panel de estadísticas");
            return;
        }
        
        chartSection = document.createElement('div');
        chartSection.id = 'comunas-chart-section';
        chartSection.className = 'stats-section';
        
        const sectionTitle = document.createElement('h4');
        sectionTitle.className = 'therapist-stats-title';
        sectionTitle.textContent = 'Distribución de Pacientes Únicos por Comuna';
        chartSection.appendChild(sectionTitle);
        
        statsPanel.appendChild(chartSection);
    } else {
        // Mantener el título pero limpiar el resto
        const title = chartSection.querySelector('.therapist-stats-title');
        chartSection.innerHTML = '';
        if (title) chartSection.appendChild(title);
    }
    
    // Convertir a array para procesamiento
    const chartData = [];
    let total = 0;
    
    for (const comuna in comunasData) {
        const count = comunasData[comuna];
        total += count;
        chartData.push({
            comuna: comuna,
            count: count
        });
    }
    
    // Si no hay datos, mostrar mensaje
    if (total === 0) {
        const noDataMsg = document.createElement('div');
        noDataMsg.textContent = 'No hay datos de comunas disponibles';
        noDataMsg.style.textAlign = 'center';
        noDataMsg.style.padding = '20px';
        noDataMsg.style.color = 'var(--text-secondary)';
        chartSection.appendChild(noDataMsg);
        return;
    }
    
    // Ordenar por cantidad (mayor a menor)
    chartData.sort((a, b) => b.count - a.count);
    
    // Contenedor principal para gráfico y tabla
    const mainContainer = document.createElement('div');
    mainContainer.style.display = 'flex';
    mainContainer.style.flexWrap = 'wrap';
    mainContainer.style.justifyContent = 'space-between';
    mainContainer.style.gap = '20px';
    mainContainer.style.marginTop = '20px';
    
    // 1. GRÁFICO CIRCULAR
    const chartContainer = document.createElement('div');
    chartContainer.style.flex = '1';
    chartContainer.style.minWidth = '300px';
    chartContainer.style.backgroundColor = 'white';
    chartContainer.style.borderRadius = '8px';
    chartContainer.style.padding = '20px';
    chartContainer.style.boxShadow = 'var(--shadow)';
    chartContainer.style.display = 'flex';
    chartContainer.style.flexDirection = 'column';
    chartContainer.style.alignItems = 'center';
    
    // Título del gráfico
    const chartTitle = document.createElement('div');
    chartTitle.style.fontSize = '16px';
    chartTitle.style.fontWeight = '600';
    chartTitle.style.marginBottom = '15px';
    chartTitle.style.textAlign = 'center';
    chartTitle.textContent = 'Representación gráfica';
    chartContainer.appendChild(chartTitle);
    
    // SVG para el gráfico circular
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', '250');
    svg.setAttribute('height', '250');
    svg.setAttribute('viewBox', '0 0 250 250');
    
    // Fondo del círculo
    const background = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    background.setAttribute('cx', '125');
    background.setAttribute('cy', '125');
    background.setAttribute('r', '100');
    background.setAttribute('fill', 'white');
    background.setAttribute('stroke', '#E2E8F0');
    background.setAttribute('stroke-width', '1');
    svg.appendChild(background);
    
    // Colores para el gráfico
    const colors = [
        '#2D3FE0', '#00BFA5', '#FF6B6B', '#9B59B6', '#3498DB', 
        '#E67E22', '#27AE60', '#F1C40F', '#E74C3C', '#1ABC9C',
        '#8E44AD', '#16A085', '#D35400', '#2980B9', '#C0392B'
    ];
    
    // Crear segmentos del gráfico
    let startAngle = 0;
    chartData.forEach((item, index) => {
        const percentage = (item.count / total) * 100;
        const angle = (percentage / 100) * 360;
        
        // Calcular puntos del arco
        const endAngle = startAngle + angle;
        const startRad = (startAngle - 90) * Math.PI / 180;
        const endRad = (endAngle - 90) * Math.PI / 180;
        
        const x1 = 125 + 100 * Math.cos(startRad);
        const y1 = 125 + 100 * Math.sin(startRad);
        const x2 = 125 + 100 * Math.cos(endRad);
        const y2 = 125 + 100 * Math.sin(endRad);
        
        // Determinar si es arco mayor o menor
        const largeArc = angle > 180 ? 1 : 0;
        
        // Crear path
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        const d = [
            `M 125 125`,
            `L ${x1} ${y1}`,
            `A 100 100 0 ${largeArc} 1 ${x2} ${y2}`,
            `Z`
        ].join(' ');
        
        path.setAttribute('d', d);
        path.setAttribute('fill', colors[index % colors.length]);
        path.setAttribute('stroke', 'white');
        path.setAttribute('stroke-width', '1');
        
        // Tooltip
        const title = document.createElementNS('http://www.w3.org/2000/svg', 'title');
        title.textContent = `${item.comuna}: ${item.count} (${percentage.toFixed(1)}%)`;
        path.appendChild(title);
        
        svg.appendChild(path);
        
        // Actualizar ángulo inicial para siguiente segmento
        startAngle = endAngle;
    });
    
    chartContainer.appendChild(svg);
    
    // 2. TABLA DE DATOS
    const tableContainer = document.createElement('div');
    tableContainer.style.flex = '1';
    tableContainer.style.minWidth = '300px';
    tableContainer.style.backgroundColor = 'white';
    tableContainer.style.borderRadius = '8px';
    tableContainer.style.padding = '20px';
    tableContainer.style.boxShadow = 'var(--shadow)';
    
    // Título de la tabla
    const tableTitle = document.createElement('div');
    tableTitle.style.fontSize = '16px';
    tableTitle.style.fontWeight = '600';
    tableTitle.style.marginBottom = '15px';
    tableTitle.style.textAlign = 'center';
    tableTitle.textContent = 'Detalle por comuna (pacientes únicos)';
    tableContainer.appendChild(tableTitle);
    
    // Tabla
    const table = document.createElement('table');
    table.className = 'student-stats-table';
    table.style.width = '100%';
    
    // Encabezado
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    
    ['Comuna', 'Pacientes Únicos', '%'].forEach(text => {
        const th = document.createElement('th');
        th.textContent = text;
        headerRow.appendChild(th);
    });
    
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // Contenido
    const tbody = document.createElement('tbody');
    
    chartData.forEach((item, index) => {
        const row = document.createElement('tr');
        
        // Comuna
        const comunaCell = document.createElement('td');
        comunaCell.style.fontWeight = '500';
        
        // Crear un indicador de color
        const colorIndicator = document.createElement('span');
        colorIndicator.style.display = 'inline-block';
        colorIndicator.style.width = '12px';
        colorIndicator.style.height = '12px';
        colorIndicator.style.backgroundColor = colors[index % colors.length];
        colorIndicator.style.borderRadius = '2px';
        colorIndicator.style.marginRight = '8px';
        
        comunaCell.appendChild(colorIndicator);
        comunaCell.appendChild(document.createTextNode(item.comuna));
        
        // Cantidad
        const countCell = document.createElement('td');
        countCell.textContent = item.count;
        
        // Porcentaje
        const percentCell = document.createElement('td');
        const percentage = (item.count / total) * 100;
        percentCell.textContent = `${percentage.toFixed(1)}%`;
        
        row.appendChild(comunaCell);
        row.appendChild(countCell);
        row.appendChild(percentCell);
        tbody.appendChild(row);
    });
    
    table.appendChild(tbody);
    tableContainer.appendChild(table);
    
    // Total
    const totalRow = document.createElement('div');
    totalRow.style.marginTop = '15px';
    totalRow.style.textAlign = 'right';
    totalRow.style.fontWeight = 'bold';
    totalRow.textContent = `Total: ${total} pacientes`;
    tableContainer.appendChild(totalRow);
    
    // Añadir contenedores al principal
    mainContainer.appendChild(chartContainer);
    mainContainer.appendChild(tableContainer);
    chartSection.appendChild(mainContainer);
    
    console.log("✅ Gráfico de comunas creado");
}
</script>

<!-- Librerías para exportar -->
<!-- Reemplaza las líneas existentes por estas -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.7.0/jspdf.plugin.autotable.min.js"></script>
</body>
</html>
