<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMAKINE - Agenda</title>
    <style>
        /* Estilos b√°sicos */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f9f9f9;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .week-navigation {
            display: flex;
            align-items: center;
        }
        
        .week-navigation button {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px 10px;
        }
        
        .therapist-header {
            display: grid;
            grid-template-columns: 60px repeat(3, 1fr);
            text-align: center;
            margin-bottom: 10px;
        }
        
        .therapist-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0 auto 5px;
            background-color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .schedule-grid {
            display: grid;
            grid-template-columns: 60px repeat(3, 1fr);
            grid-auto-rows: 60px;
            border: 1px solid #ddd;
        }
        
        .time-cell {
            border-right: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }
        
        .schedule-cell {
            border-right: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            padding: 5px;
            position: relative;
            cursor: pointer;
        }
        
        .appointment {
            background-color: #90ee90;
            border-radius: 4px;
            padding: 5px;
            font-size: 0.9rem;
            height: 100%;
            overflow: hidden;
            position: relative;
        }
        
        .appointment.consulta-general { background-color: #ffb6c1; }
        .appointment.consulta-especializada { background-color: #90ee90; }
        .appointment.consulta-dermatologia { background-color: #ffa500; }
        .appointment.examen-cardiologico { background-color: #ffd700; }
        .appointment.evaluacion-fisica { background-color: #87cefa; }
        
        .appointment-title {
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .appointment-type {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .appointment-time {
            font-size: 0.8rem;
            position: absolute;
            bottom: 5px;
            left: 5px;
        }
        
        .stats-panel {
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .stats-title {
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
            font-size: 1.2rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .charts-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 200px;
            margin-top: 20px;
        }
        
        .chart-bar {
            width: 60px;
            background-color: #4caf50;
            margin: 0 15px;
            border-radius: 5px 5px 0 0;
            position: relative;
        }
        
        .chart-value {
            position: absolute;
            top: -25px;
            width: 100%;
            text-align: center;
            font-weight: bold;
        }
        
        .chart-labels {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        
        .chart-label {
            width: 90px;
            text-align: center;
            font-size: 0.9rem;
        }
        
        /* Estilos para los modales y formularios */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            width: 90%;
            max-width: 500px;
            margin: 10% auto;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .modal-header {
            padding: 15px 20px;
            background-color: #f5f5f5;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }
        
        .close {
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
        }
        
        form {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group input[type="time"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .form-group textarea {
            height: 80px;
            resize: vertical;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }
        
        .save-btn {
            background-color: #4caf50;
            color: white;
        }
        
        .save-btn:hover {
            background-color: #388e3c;
        }
        
        .cancel-btn {
            background-color: #777;
            color: white;
        }
        
        .cancel-btn:hover {
            background-color: #555;
        }
        
        .delete-btn {
            background-color: #f44336;
            color: white;
        }
        
        .delete-btn:hover {
            background-color: #d32f2f;
        }
        
        /* Estilos para el modal de asistencia */
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #ddd;
            text-align: right;
        }
        
        .attendance-options {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }
        
        .attendance-btn {
            padding: 10px;
            border: 1px solid #ddd;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
            flex: 1;
            margin: 0 5px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .attendance-btn[data-status="attended"] {
            border-color: #4caf50;
            color: #4caf50;
        }
        
        .attendance-btn[data-status="attended"].selected {
            background-color: #4caf50;
            color: white;
        }
        
        .attendance-btn[data-status="missed"] {
            border-color: #f44336;
            color: #f44336;
        }
        
        .attendance-btn[data-status="missed"].selected {
            background-color: #f44336;
            color: white;
        }
        
        .attendance-btn[data-status="rescheduled"] {
            border-color: #ff9800;
            color: #ff9800;
        }
        
        .attendance-btn[data-status="rescheduled"].selected {
            background-color: #ff9800;
            color: white;
        }
        
        /* Estilos para arrastrar y soltar */
        .schedule-cell.drag-over {
            background-color: rgba(76, 175, 80, 0.2);
        }
        
        .appointment {
            cursor: grab;
        }
        
        .appointment:active {
            cursor: grabbing;
        }
        
        /* Estado de asistencia para las citas */
        .appointment-status {
            position: absolute;
            right: 5px;
            bottom: 5px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .appointment-status.attended {
            background-color: #4caf50;
        }
        
        .appointment-status.missed {
            background-color: #f44336;
        }
        
        .appointment-status.rescheduled {
            background-color: #ff9800;
        }
        
        /* Indicador de cita web */
        .web-indicator {
            position: absolute;
            right: 5px;
            top: 5px;
            font-size: 0.8rem;
            color: #555;
        }
        
        /* Spinner de carga */
        .spinner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .spinner-content {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4caf50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Mensajes de estado */
        .status-message {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            background-color: #4caf50;
            color: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1500;
        }
        
        .status-message.error {
            background-color: #f44336;
        }
        
        .status-message.warning {
            background-color: #ff9800;
        }
        
        /* Login */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .login-title {
            text-align: center;
            margin-bottom: 20px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .week-navigation {
                margin-top: 10px;
                width: 100%;
                justify-content: space-between;
            }
            
            .therapist-header, .schedule-grid {
                grid-template-columns: 60px 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-container {
                flex-direction: column;
                height: auto;
                align-items: center;
            }
            
            .chart-bar {
                width: 100%;
                height: 40px !important;
                margin: 10px 0;
                border-radius: 0 5px 5px 0;
            }
            
            .chart-value {
                top: 10px;
                right: -25px;
                left: auto;
            }
            
            .chart-labels {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Spinner de carga -->
    <div class="spinner" id="spinner">
        <div class="spinner-content"></div>
    </div>
    
    <!-- Mensaje de estado -->
    <div class="status-message" id="status-message"></div>
    
    <!-- Contenedor de login (se muestra solo si el usuario no est√° autenticado) -->
    <div class="login-container" id="login-container" style="display: none;">
        <h2 class="login-title">SISTEMAKINE - Agenda</h2>
        <form id="login-form">
            <div class="form-group">
                <label for="email">Correo electr√≥nico:</label>
                <input type="email" id="email" required>
            </div>
            <div class="form-group">
                <label for="password">Contrase√±a:</label>
                <input type="password" id="password" required>
            </div>
            <div class="form-actions">
                <button type="submit" class="button save-btn">Iniciar sesi√≥n</button>
            </div>
            <p style="margin-top: 20px; text-align: center;">
                <small>Si eres estudiante, solicita las credenciales a tu profesor.</small>
            </p>
        </form>
    </div>
    
    <!-- Contenedor principal (se muestra solo si el usuario est√° autenticado) -->
    <div class="container" id="main-container" style="display: none;">
        <header>
            <h1>Agenda SISTEMAKINE</h1>
            <div class="week-navigation">
                <button id="prev-week">‚óÄ</button>
                <h2 id="current-week">Semana del 17 al 23 de marzo de 2025</h2>
                <button id="next-week">‚ñ∂</button>
            </div>
            <div id="user-info" style="margin-left: auto; display: flex; align-items: center;">
                <span id="user-name" style="margin-right: 10px;"></span>
                <button id="logout-btn" class="button cancel-btn" style="padding: 5px 10px; font-size: 0.8rem;">Cerrar sesi√≥n</button>
            </div>
        </header>
        
        <div class="therapist-header">
            <div></div>
            <div>
                <div class="therapist-photo">N</div>
                <div>Nicol√°s</div>
            </div>
            <div>
                <div class="therapist-photo">A</div>
                <div>Ana Mar√≠a</div>
            </div>
            <div>
                <div class="therapist-photo">G</div>
                <div>Gustavo</div>
            </div>
        </div>
        
        <div class="schedule-grid">
            <!-- Horas -->
            <div class="time-cell">09:00</div>
            <div class="schedule-cell" data-hour="9" data-therapist="nicolas"></div>
            <div class="schedule-cell" data-hour="9" data-therapist="ana-maria"></div>
            <div class="schedule-cell" data-hour="9" data-therapist="gustavo"></div>
            
            <div class="time-cell">10:00</div>
            <div class="schedule-cell" data-hour="10" data-therapist="nicolas"></div>
            <div class="schedule-cell" data-hour="10" data-therapist="ana-maria"></div>
            <div class="schedule-cell" data-hour="10" data-therapist="gustavo"></div>
            
            <div class="time-cell">11:00</div>
            <div class="schedule-cell" data-hour="11" data-therapist="nicolas"></div>
            <div class="schedule-cell" data-hour="11" data-therapist="ana-maria"></div>
            <div class="schedule-cell" data-hour="11" data-therapist="gustavo"></div>
            
            <div class="time-cell">12:00</div>
            <div class="schedule-cell" data-hour="12" data-therapist="nicolas"></div>
            <div class="schedule-cell" data-hour="12" data-therapist="ana-maria"></div>
            <div class="schedule-cell" data-hour="12" data-therapist="gustavo"></div>
            
            <div class="time-cell">13:00</div>
            <div class="schedule-cell" data-hour="13" data-therapist="nicolas"></div>
            <div class="schedule-cell" data-hour="13" data-therapist="ana-maria"></div>
            <div class="schedule-cell" data-hour="13" data-therapist="gustavo"></div>
            
            <div class="time-cell">14:00</div>
            <div class="schedule-cell" data-hour="14" data-therapist="nicolas"></div>
            <div class="schedule-cell" data-hour="14" data-therapist="ana-maria"></div>
            <div class="schedule-cell" data-hour="14" data-therapist="gustavo"></div>
            
            <div class="time-cell">15:00</div>
            <div class="schedule-cell" data-hour="15" data-therapist="nicolas"></div>
            <div class="schedule-cell" data-hour="15" data-therapist="ana-maria"></div>
            <div class="schedule-cell" data-hour="15" data-therapist="gustavo"></div>
            
            <div class="time-cell">16:00</div>
            <div class="schedule-cell" data-hour="16" data-therapist="nicolas"></div>
            <div class="schedule-cell" data-hour="16" data-therapist="ana-maria"></div>
            <div class="schedule-cell" data-hour="16" data-therapist="gustavo"></div>
        </div>
        
        <div class="stats-panel">
            <h3 class="stats-title">Estad√≠sticas</h3>
            
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">Asistencia semanal</div>
                    <div class="stat-value" id="attendance-rate">85%</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Citas totales</div>
                    <div class="stat-value" id="total-appointments">32</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Hora m√°s ocupada</div>
                    <div class="stat-value" id="busiest-hour">10:00 - 11:00</div>
                </div>
            </div>
            
            <h4>Citas por kinesi√≥logo</h4>
            
            <div class="charts-container" id="therapist-chart">
                <div class="chart-bar" style="height: 80%;">
                    <div class="chart-value">14</div>
                </div>
                <div class="chart-bar" style="height: 50%;">
                    <div class="chart-value">9</div>
                </div>
                <div class="chart-bar" style="height: 50%;">
                    <div class="chart-value">9</div>
                </div>
            </div>
            
            <div class="chart-labels">
                <div class="chart-label">Nicol√°s</div>
                <div class="chart-label">Ana Mar√≠a</div>
                <div class="chart-label">Gustavo</div>
            </div>
        </div>
    </div>
    
    <!-- Modal para agregar/editar citas -->
    <div class="modal" id="appointment-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Agregar Nueva Cita</h3>
                <span class="close">&times;</span>
            </div>
            <form id="appointment-form">
                <div class="form-group">
                    <label for="patient-name">Paciente:</label>
                    <input type="text" id="patient-name" required>
                </div>
                <div class="form-group">
                    <label for="appointment-type">Tipo de consulta:</label>
                    <select id="appointment-type" required>
                        <option value="consulta-general">Consulta general</option>
                        <option value="consulta-especializada">Consulta especializada</option>
                        <option value="consulta-dermatologia">Consulta dermatolog√≠a</option>
                        <option value="examen-cardiologico">Examen cardiol√≥gico</option>
                        <option value="evaluacion-fisica">Evaluaci√≥n f√≠sica</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="appointment-date">Fecha:</label>
                    <input type="date" id="appointment-date" required>
                </div>
                <div class="form-group">
                    <label for="appointment-time">Hora inicio:</label>
                    <input type="time" id="appointment-time" required>
                </div>
                <div class="form-group">
                    <label for="appointment-duration">Duraci√≥n:</label>
                    <select id="appointment-duration" required>
                        <option value="60">1 hora</option>
                        <option value="120">2 horas</option>
                        <option value="30">30 minutos</option>
                        <option value="90">1 hora 30 minutos</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="therapist">Kinesi√≥logo:</label>
                    <select id="therapist" required>
                        <option value="nicolas">Nicol√°s</option>
                        <option value="ana-maria">Ana Mar√≠a</option>
                        <option value="gustavo">Gustavo</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="appointment-notes">Notas:</label>
                    <textarea id="appointment-notes"></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="is-web"> V√≠a web
                    </label>
                </div>
                <div class="form-actions">
                    <button type="submit" class="button save-btn">Guardar</button>
                    <button type="button" class="button cancel-btn" id="cancel-appointment">Cancelar</button>
                    <button type="button" class="button delete-btn" id="delete-appointment" style="display: none;">Eliminar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal para confirmar asistencia -->
    <div class="modal" id="attendance-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirmar Asistencia</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <p>Paciente: <span id="attendance-patient"></span></p>
                <p>Fecha: <span id="attendance-date"></span></p>
                <p>Hora: <span id="attendance-time"></span></p>
                <div class="attendance-options">
                    <button class="attendance-btn" data-status="attended">Asisti√≥</button>
                    <button class="attendance-btn" data-status="missed">No asisti√≥</button>
                    <button class="attendance-btn" data-status="rescheduled">Reprogramada</button>
                </div>
                <div class="form-group">
                    <label for="attendance-notes">Notas:</label>
                    <textarea id="attendance-notes"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="button save-btn" id="save-attendance">Guardar</button>
                <button class="button cancel-btn" id="cancel-attendance">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script>
    // Configuraci√≥n de Firebase - REEMPLAZA ESTOS VALORES CON LOS DE TU PROYECTO FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyA8fY-L1r3nBq61CFPOAFRI6TlS9A5GNTA",
        authDomain: "agendapoli-13963.firebaseapp.com",
        projectId: "agendapoli-13963",
        storageBucket: "agendapoli-13963.firebasestorage.app",
        messagingSenderId: "265927768586",
        appId: "1:265927768586:web:c7e37e6a561bd996687df3"
    };
    
    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    
    // Referencias a Firebase
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // Variables globales
    let currentUser = null;
    let isAdmin = false;
    let appointments = [];
    let editingAppointmentId = null;
    let holidays = [];
    let currentWeekDate = new Date();
    
    // Elementos DOM
    const spinner = document.getElementById('spinner');
    const statusMessage = document.getElementById('status-message');
    const loginContainer = document.getElementById('login-container');
    const mainContainer = document.getElementById('main-container');
    const appointmentModal = document.getElementById('appointment-modal');
    const appointmentForm = document.getElementById('appointment-form');
    const attendanceModal = document.getElementById('attendance-modal');
    const currentWeekDisplay = document.getElementById('current-week');
    const loginForm = document.getElementById('login-form');
    const userNameDisplay = document.getElementById('user-name');
    const logoutBtn = document.getElementById('logout-btn');
    
    // Inicializar la aplicaci√≥n
    document.addEventListener('DOMContentLoaded', function() {
        // Mostrar spinner mientras carga
        showSpinner();
        
        // Verificar estado de autenticaci√≥n
        auth.onAuthStateChanged(function(user) {
            if (user) {
                // Usuario autenticado
                currentUser = user;
                userNameDisplay.textContent = user.email;
                checkUserRole(user.uid);
            } else {
                // Usuario no autenticado, mostrar pantalla de login
                showLoginScreen();
                hideSpinner();
            }
        });
        
        // Configurar event listeners
        setupEventListeners();
    });
    
    // Verificar el rol del usuario (admin o estudiante)
    function checkUserRole(userId) {
        db.collection('usuarios').doc(userId).get()
            .then((doc) => {
                if (doc.exists && doc.data().rol === 'admin') {
                    isAdmin = true;
                    document.body.classList.remove('student-view');
                } else {
                    isAdmin = false;
                    document.body.classList.add('student-view');
                }
                
                // Inicializar la agenda
                initializeApp();
            })
            .catch((error) => {
                console.error("Error al verificar rol de usuario:", error);
                isAdmin = false;
                document.body.classList.add('student-view');
                
                // Inicializar la agenda de todos modos
                initializeApp();
            });
    }
    
    // Inicializar la aplicaci√≥n
    function initializeApp() {
        loadHolidays();
        updateWeekDisplay();
        loadAppointments();
        
        // Mostrar la interfaz principal
        loginContainer.style.display = 'none';
        mainContainer.style.display = 'block';
        
        hideSpinner();
    }
    
    // Mostrar pantalla de login
    function showLoginScreen() {
        loginContainer.style.display = 'block';
        mainContainer.style.display = 'none';
    }
    
    // Cargar los feriados chilenos
    function loadHolidays() {
        holidays = [
            { date: '2025-01-01', name: 'A√±o Nuevo' },
            { date: '2025-04-18', name: 'Viernes Santo' },
            { date: '2025-04-19', name: 'S√°bado Santo' },
            { date: '2025-05-01', name: 'D√≠a del Trabajo' },
            { date: '2025-05-21', name: 'D√≠a de las Glorias Navales' },
            { date: '2025-06-29', name: 'San Pedro y San Pablo' },
            { date: '2025-07-16', name: 'Virgen del Carmen' },
            { date: '2025-08-15', name: 'Asunci√≥n de la Virgen' },
            { date: '2025-09-18', name: 'Independencia Nacional' },
            { date: '2025-09-19', name: 'D√≠a de las Glorias del Ej√©rcito' },
            { date: '2025-10-12', name: 'Encuentro de Dos Mundos' },
            { date: '2025-10-31', name: 'D√≠a de las Iglesias Evang√©licas' },
            { date: '2025-11-01', name: 'D√≠a de Todos los Santos' },
            { date: '2025-12-08', name: 'Inmaculada Concepci√≥n' },
            { date: '2025-12-25', name: 'Navidad' }
        ];
    }
    
    // Actualizar la visualizaci√≥n de la semana actual
    function updateWeekDisplay() {
        const startOfWeek = getStartOfWeek(currentWeekDate);
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6);
        
        const startDay = startOfWeek.getDate();
        const endDay = endOfWeek.getDate();
        const startMonthName = getMonthName(startOfWeek.getMonth());
        const endMonthName = getMonthName(endOfWeek.getMonth());
        const year = startOfWeek.getFullYear();
        
        currentWeekDisplay.textContent = `Semana del ${startDay} al ${endDay} de ${endMonthName} de ${year}`;
    }
    
    // Obtener el primer d√≠a de la semana (lunes)
    function getStartOfWeek(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Ajusta cuando el d√≠a es domingo
        const monday = new Date(d.setDate(diff));
        monday.setHours(0, 0, 0, 0);
        return monday;
    }
    
    // Obtener nombre del mes en espa√±ol
    function getMonthName(month) {
        const months = [
            'enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 
            'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'
        ];
        return months[month];
    }
    
    // Cargar citas desde Firestore
    function loadAppointments() {
        showSpinner();
        
        // Obtener fecha de inicio y fin de la semana
        const startOfWeek = getStartOfWeek(currentWeekDate);
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 7); // Un d√≠a despu√©s del fin para incluir todo el √∫ltimo d√≠a
        
        // Convertir a Timestamp para consulta
        const startTimestamp = firebase.firestore.Timestamp.fromDate(startOfWeek);
        const endTimestamp = firebase.firestore.Timestamp.fromDate(endOfWeek);
        
        // Consulta a Firestore
        db.collection('citas')
            .where('fecha', '>=', startTimestamp)
            .where('fecha', '<', endTimestamp)
            .get()
            .then((querySnapshot) => {
                appointments = [];
                
                querySnapshot.forEach((doc) => {
                    // Convertir Timestamp a Date
                    const data = doc.data();
                    const appointment = {
                        id: doc.id,
                        ...data,
                        fecha: data.fecha.toDate()
                    };
                    
                    appointments.push(appointment);
                });
                
                // Renderizar citas y actualizar estad√≠sticas
                renderAppointments();
                updateStatistics();
                hideSpinner();
            })
            .catch((error) => {
                console.error("Error al cargar citas:", error);
                showStatusMessage("Error al cargar citas. Intenta nuevamente.", "error");
                loadSampleAppointments(); // Cargar datos de ejemplo en caso de error
                hideSpinner();
            });
    }
    
    // Cargar citas de ejemplo (en caso de error o para la primera vez)
    function loadSampleAppointments() {
        // Fecha de referencia (lunes de la semana actual)
        const startOfWeek = getStartOfWeek(currentWeekDate);
        
        appointments = [
            {
                id: '1',
                paciente: 'Mar√≠a Gonz√°lez',
                tipo: 'Consulta especializada',
                tipoClase: 'consulta-especializada',
                fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate(), 9, 0),
                duracion: 60,
                terapeuta: 'nicolas'
            },
            {
                id: '2',
                paciente: 'Ana Mart√≠nez',
                tipo: 'Consulta general',
                tipoClase: 'consulta-general',
                fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate(), 11, 0),
                duracion: 60,
                terapeuta: 'ana-maria'
            },
            {
                id: '3',
                paciente: 'Laura P√©rez',
                tipo: 'Examen cardiol√≥gico',
                tipoClase: 'examen-cardiologico',
                fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate(), 13, 0),
                duracion: 60,
                terapeuta: 'nicolas'
            },
            {
                id: '4',
                paciente: 'Isabel Rodr√≠guez',
                tipo: 'Consulta general',
                tipoClase: 'consulta-general',
                fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate(), 10, 0),
                duracion: 60,
                terapeuta: 'ana-maria'
            },
            {
                id: '5',
                paciente: 'Julia L√≥pez',
                tipo: 'Consulta general',
                tipoClase: 'consulta-general',
                fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate(), 14, 0),
                duracion: 60,
                terapeuta: 'ana-maria'
            },
            {
                id: '6',
                paciente: 'Elena Castro',
                tipo: 'Evaluaci√≥n f√≠sica',
                tipoClase: 'evaluacion-fisica',
                fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate(), 9, 0),
                duracion: 60,
                terapeuta: 'gustavo'
            },
            {
                id: '7',
                paciente: 'Sandra D√≠az',
                tipo: 'Evaluaci√≥n f√≠sica',
                tipoClase: 'evaluacion-fisica',
                fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate(), 15, 0),
                duracion: 60,
                terapeuta: 'ana-maria'
            },
            {
                id: '8',
                paciente: 'Beatriz S√°nchez',
                tipo: 'Consulta general',
                tipoClase: 'consulta-general',
                fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate(), 15, 0),
                duracion: 60,
                terapeuta: 'ana-maria'
            },
            {
                id: '9',
                paciente: 'Carolina Garc√≠a',
                tipo: 'Consulta dermatolog√≠a',
                tipoClase: 'consulta-dermatologia',
                fecha: new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate(), 12, 0),
                duracion: 60,
                terapeuta: 'gustavo'
            }
        ];
        
        renderAppointments();
        updateStatistics();
    }
    
    // Renderizar las citas en la cuadr√≠cula
    function renderAppointments() {
        // Limpiar citas existentes
        document.querySelectorAll('.appointment').forEach(el => el.remove());
        
        // Fecha de referencia (lunes de la semana actual)
        const startOfWeek = getStartOfWeek(currentWeekDate);
        
        // Renderizar cada cita de la semana actual
        appointments.forEach(appointment => {
            const appointmentDate = appointment.fecha;
            const dayDiff = Math.floor((appointmentDate - startOfWeek) / (24 * 60 * 60 * 1000));
            
            // Solo mostrar citas de lunes a viernes (0-4)
            if (dayDiff >= 0 && dayDiff < 5) {
                const hour = appointmentDate.getHours();
                const therapist = appointment.terapeuta;
                
                // Encontrar la celda correcta
                const cell = document.querySelector(`.schedule-cell[data-hour="${hour}"][data-therapist="${therapist}"]`);
                
                if (cell) {
                    // Crear elemento de cita
                    const appointmentEl = document.createElement('div');
                    appointmentEl.className = `appointment ${appointment.tipoClase}`;
                    appointmentEl.dataset.id = appointment.id;
                    
                    // Contenido de la cita
                    appointmentEl.innerHTML = `
                        <div class="appointment-title">${appointment.paciente}</div>
                        <div class="appointment-type">${appointment.tipo}</div>
                    `;
                    
                    // Indicador de estado si existe
                    if (appointment.estado) {
                        const statusEl = document.createElement('div');
                        statusEl.className = `appointment-status ${appointment.estado}`;
                        appointmentEl.appendChild(statusEl);
                    }
                    
                    // Indicador web si aplica
                    if (appointment.web) {
                        const webEl = document.createElement('div');
                        webEl.className = 'web-indicator';
                        webEl.innerHTML = 'üåê';
                        appointmentEl.appendChild(webEl);
                    }
                    
                    // Agregar a la celda
                    cell.appendChild(appointmentEl);
                    
                    // Eventos para la cita
                    appointmentEl.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const app = appointments.find(a => a.id === this.dataset.id);
                        if (app) {
                            // Si la cita ya pas√≥, mostrar modal de asistencia
                            const today = new Date();
                            if (app.fecha < today) {
                                if (isAdmin) {
                                    openAttendanceModal(app);
                                } else {
                                    viewAppointmentDetails(app);
                                }
                            } else {
                                // Si es una cita futura
                                if (isAdmin) {
                                    openAppointmentModal(app);
                                } else {
                                    viewAppointmentDetails(app);
                                }
                            }
                        }
                    });
                    
                    // Hacer que las citas sean arrastrables para administradores
                    if (isAdmin) {
                        appointmentEl.setAttribute('draggable', 'true');
                        appointmentEl.addEventListener('dragstart', function(e) {
                            e.dataTransfer.setData('text/plain', this.dataset.id);
                        });
                    }
                }
            }
        });
    }
    
    // Mostrar detalles de la cita (para estudiantes)
    function viewAppointmentDetails(appointment) {
        const options = { 
            weekday: 'long', 
            day: 'numeric', 
            month: 'long', 
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        };
        
        alert(`
            Paciente: ${appointment.paciente}
            Tipo: ${appointment.tipo}
            Fecha: ${appointment.fecha.toLocaleDateString('es-ES', options)}
            Kinesi√≥logo: ${getTherapistName(appointment.terapeuta)}
            ${appointment.estado ? 'Estado: ' + getStatusText(appointment.estado) : ''}
        `);
    }
    
    // Obtener nombre completo del terapeuta
    function getTherapistName(therapistId) {
        switch(therapistId) {
            case 'nicolas': return 'Nicol√°s';
            case 'ana-maria': return 'Ana Mar√≠a';
            case 'gustavo': return 'Gustavo';
            default: return therapistId;
        }
    }
    
    // Obtener texto del estado
    function getStatusText(status) {
        switch(status) {
            case 'attended': return 'Asisti√≥';
            case 'missed': return 'No asisti√≥';
            case 'rescheduled': return 'Reprogramada';
            default: return status;
        }
    }
    
    // Actualizar estad√≠sticas
    function updateStatistics() {
        // Calcular asistencia semanal
        const totalPastAppointments = appointments.filter(a => {
            const now = new Date();
            return a.fecha < now;
        }).length;
        
        const attendedAppointments = appointments.filter(a => a.estado === 'attended').length;
        
        const attendanceRate = totalPastAppointments > 0 
            ? Math.round((attendedAppointments / totalPastAppointments) * 100) 
            : 0;
        
        // Citas por hora
        const appointmentsByHour = {};
        appointments.forEach(a => {
            const hour = a.fecha.getHours();
            appointmentsByHour[hour] = (appointmentsByHour[hour] || 0) + 1;
        });
        
        // Encontrar la hora m√°s ocupada
        let busiestHour = 9; // Por defecto 9:00
        let maxAppointments = 0;
        
        for (const hour in appointmentsByHour) {
            if (appointmentsByHour[hour] > maxAppointments) {
                busiestHour = parseInt(hour);
                maxAppointments = appointmentsByHour[hour];
            }
        }
        
        // Citas por terapeuta
        const appointmentsByTherapist = {
            'nicolas': 0,
            'ana-maria': 0,
            'gustavo': 0
        };
        
        appointments.forEach(a => {
            const therapist = a.terapeuta;
            if (appointmentsByTherapist[therapist] !== undefined) {
                appointmentsByTherapist[therapist]++;
            }
        });
        
        // Actualizar DOM
        document.getElementById('attendance-rate').textContent = `${attendanceRate}%`;
        document.getElementById('total-appointments').textContent = appointments.length;
        document.getElementById('busiest-hour').textContent = `${busiestHour}:00 - ${busiestHour + 1}:00`;
        
        // Actualizar gr√°fico de terapeutas
        const chartContainer = document.getElementById('therapist-chart');
        chartContainer.innerHTML = '';
        
        const maxValue = Math.max(
            appointmentsByTherapist['nicolas'], 
            appointmentsByTherapist['ana-maria'], 
            appointmentsByTherapist['gustavo'],
            1 // Evita divisi√≥n por cero
        );
        
        const therapists = ['nicolas', 'ana-maria', 'gustavo'];
        
        therapists.forEach(therapist => {
            const value = appointmentsByTherapist[therapist];
            const height = Math.max((value / maxValue) * 100, 5); // Al menos 5% de altura
            
            const barEl = document.createElement('div');
            barEl.className = 'chart-bar';
            barEl.style.height = `${height}%`;
            
            const valueEl = document.createElement('div');
            valueEl.className = 'chart-value';
            valueEl.textContent = value;
            
            barEl.appendChild(valueEl);
            chartContainer.appendChild(barEl);
        });
    }
    
    // Configurar event listeners
    function setupEventListeners() {
        // Login
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            showSpinner();
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Login exitoso
                    hideSpinner();
                })
                .catch((error) => {
                    console.error("Error de login:", error);
                    hideSpinner();
                    showStatusMessage("Error de inicio de sesi√≥n. Verifica tus credenciales.", "error");
                });
        });
        
        // Logout
        logoutBtn.addEventListener('click', function() {
            auth.signOut()
                .then(() => {
                    // Logout exitoso
                    showLoginScreen();
                })
                .catch((error) => {
                    console.error("Error al cerrar sesi√≥n:", error);
                    showStatusMessage("Error al cerrar sesi√≥n.", "error");
                });
        });
        
        // Navegaci√≥n de semanas
        document.getElementById('prev-week').addEventListener('click', function() {
            navigateWeek(-1);
        });
        
        document.getElementById('next-week').addEventListener('click', function() {
            navigateWeek(1);
        });
        
        // Clic en celdas de la agenda (para agregar citas)
        document.querySelectorAll('.schedule-cell').forEach(cell => {
            cell.addEventListener('click', function() {
                if (isAdmin) {
                    const hour = parseInt(this.dataset.hour);
                    const therapist = this.dataset.therapist;
                    
                    openAppointmentModal(null, hour, therapist);
                }
            });
            
            // Configuraci√≥n para arrastrar y soltar
            if (isAdmin) {
                cell.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('drag-over');
                });
                
                cell.addEventListener('dragleave', function() {
                    this.classList.remove('drag-over');
                });
                
                cell.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');
                    
                    const appointmentId = e.dataTransfer.getData('text/plain');
                    const hour = parseInt(this.dataset.hour);
                    const therapist = this.dataset.therapist;
                    
                    moveAppointment(appointmentId, hour, therapist);
                });
            }
        });
        
        // Formulario de citas
        appointmentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            if (isAdmin) {
                saveAppointment();
            }
        });
        
        document.getElementById('cancel-appointment').addEventListener('click', function() {
            closeAppointmentModal();
        });
        
        document.getElementById('delete-appointment').addEventListener('click', function() {
            if (isAdmin && confirm('¬øEst√°s seguro de que deseas eliminar esta cita?')) {
                deleteAppointment();
            }
        });
        
        // Cerrar modales con la X
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.addEventListener('click', function() {
                this.closest('.modal').style.display = 'none';
            });
        });
        
        // Eventos para asistencia
        document.querySelectorAll('.attendance-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.attendance-btn').forEach(b => {
                    b.classList.remove('selected');
                });
                this.classList.add('selected');
            });
        });
        
        document.getElementById('save-attendance').addEventListener('click', function() {
            if (isAdmin) {
                saveAttendance();
            }
        });
        
        document.getElementById('cancel-attendance').addEventListener('click', function() {
            closeAttendanceModal();
        });
    }
    
    // Navegar entre semanas
    function navigateWeek(direction) {
        currentWeekDate.setDate(currentWeekDate.getDate() + (direction * 7));
        updateWeekDisplay();
        loadAppointments();
    }
    
    // Formatear fecha como YYYY-MM-DD
    function formatDate(date) {
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    // Abrir modal para agregar/editar cita
    function openAppointmentModal(appointment, hour, therapist) {
        if (!isAdmin) return;
        
        const modalTitle = document.getElementById('modal-title');
        const dateInput = document.getElementById('appointment-date');
        const timeInput = document.getElementById('appointment-time');
        const therapistInput = document.getElementById('therapist');
        const deleteBtn = document.getElementById('delete-appointment');
        
        if (appointment) {
            // Editar cita existente
            modalTitle.textContent = 'Editar Cita';
            
            document.getElementById('patient-name').value = appointment.paciente;
            document.getElementById('appointment-type').value = appointment.tipoClase;
            
            const fecha = appointment.fecha;
            dateInput.value = formatDate(fecha);
            timeInput.value = `${fecha.getHours().toString().padStart(2, '0')}:${fecha.getMinutes().toString().padStart(2, '0')}`;
            
            document.getElementById('appointment-duration').value = appointment.duracion;
            therapistInput.value = appointment.terapeuta;
            document.getElementById('appointment-notes').value = appointment.notas || '';
            document.getElementById('is-web').checked = appointment.web || false;
            
            editingAppointmentId = appointment.id;
            deleteBtn.style.display = 'block';
        } else {
            // Nueva cita
            modalTitle.textContent = 'Agregar Nueva Cita';
            appointmentForm.reset();
            
            // Pre-llenar con la fecha actual
            const today = new Date();
            dateInput.value = formatDate(today);
            
            // Pre-llenar hora y terapeuta si se proporcionan
            if (hour) {
                timeInput.value = `${hour.toString().padStart(2, '0')}:00`;
            }
            if (therapist) {
                therapistInput.value = therapist;
            }
            
            editingAppointmentId = null;
            deleteBtn.style.display = 'none';
        }
        
        appointmentModal.style.display = 'block';
    }
    
    // Cerrar modal de citas
    function closeAppointmentModal() {
        appointmentModal.style.display = 'none';
        appointmentForm.reset();
        editingAppointmentId = null;
    }
    
    // Guardar cita (nueva o editada)
    function saveAppointment() {
        if (!isAdmin) return;
        
        showSpinner();
        
        const patientName = document.getElementById('patient-name').value;
        const appointmentTypeSelect = document.getElementById('appointment-type');
        const appointmentType = appointmentTypeSelect.options[appointmentTypeSelect.selectedIndex].text;
        const appointmentTypeClass = appointmentTypeSelect.value;
        const appointmentDate = document.getElementById('appointment-date').value;
        const appointmentTime = document.getElementById('appointment-time').value;
        const appointmentDuration = parseInt(document.getElementById('appointment-duration').value);
        const therapist = document.getElementById('therapist').value;
        const notes = document.getElementById('appointment-notes').value;
        const isWeb = document.getElementById('is-web').checked;
        
        // Crear objeto de fecha
        const [year, month, day] = appointmentDate.split('-');
        const [hours, minutes] = appointmentTime.split(':');
        const date = new Date(year, month - 1, day, hours, minutes);
        
        // Verificar si es feriado
        const dateStr = formatDate(date);
        if (holidays.some(h => h.date === dateStr)) {
            hideSpinner();
            showStatusMessage('No se pueden agendar citas en d√≠as feriados.', 'warning');
            return;
        }
        
        // Datos de la cita
        const appointmentData = {
            paciente: patientName,
            tipo: appointmentType,
            tipoClase: appointmentTypeClass,
            fecha: firebase.firestore.Timestamp.fromDate(date),
            duracion: appointmentDuration,
            terapeuta: therapist,
            notas: notes,
            web: isWeb,
            creado: firebase.firestore.FieldValue.serverTimestamp(),
            creadoPor: currentUser.uid
        };
        
        // Guardar en Firestore
        if (editingAppointmentId) {
            // Actualizar cita existente
            db.collection('citas').doc(editingAppointmentId).update(appointmentData)
                .then(() => {
                    closeAppointmentModal();
                    showStatusMessage('Cita actualizada correctamente', 'success');
                    loadAppointments();
                })
                .catch((error) => {
                    console.error("Error al actualizar cita:", error);
                    hideSpinner();
                    showStatusMessage('Error al actualizar la cita', 'error');
                });
        } else {
            // Crear nueva cita
            db.collection('citas').add(appointmentData)
                .then(() => {
                    closeAppointmentModal();
                    showStatusMessage('Cita creada correctamente', 'success');
                    loadAppointments();
                })
                .catch((error) => {
                    console.error("Error al crear cita:", error);
                    hideSpinner();
                    showStatusMessage('Error al crear la cita', 'error');
                });
        }
    }
    
    // Eliminar cita
    function deleteAppointment() {
        if (!isAdmin || !editingAppointmentId) return;
        
        showSpinner();
        
        db.collection('citas').doc(editingAppointmentId).delete()
            .then(() => {
                closeAppointmentModal();
                showStatusMessage('Cita eliminada correctamente', 'success');
                loadAppointments();
            })
            .catch((error) => {
                console.error("Error al eliminar cita:", error);
                hideSpinner();
                showStatusMessage('Error al eliminar la cita', 'error');
            });
    }
    
    // Mover una cita (arrastrar y soltar)
    function moveAppointment(appointmentId, hour, therapist) {
        if (!isAdmin) return;
        
        const appointment = appointments.find(a => a.id === appointmentId);
        if (!appointment) return;
        
        showSpinner();
        
        // Conservar la fecha pero cambiar la hora y el terapeuta
        const newDate = new Date(appointment.fecha);
        newDate.setHours(hour, 0, 0, 0);
        
        // Actualizar en Firestore
        db.collection('citas').doc(appointmentId).update({
            fecha: firebase.firestore.Timestamp.fromDate(newDate),
            terapeuta: therapist
        })
        .then(() => {
            showStatusMessage('Cita movida correctamente', 'success');
            loadAppointments();
        })
        .catch((error) => {
            console.error("Error al mover cita:", error);
            hideSpinner();
            showStatusMessage('Error al mover la cita', 'error');
        });
    }
    
    // Abrir modal de asistencia
    function openAttendanceModal(appointment) {
        if (!isAdmin) return;
        
        const patientEl = document.getElementById('attendance-patient');
        const dateEl = document.getElementById('attendance-date');
        const timeEl = document.getElementById('attendance-time');
        
        patientEl.textContent = appointment.paciente;
        
        const fecha = appointment.fecha;
        const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
        dateEl.textContent = fecha.toLocaleDateString('es-ES', options);
        
        const horaInicio = `${fecha.getHours().toString().padStart(2, '0')}:${fecha.getMinutes().toString().padStart(2, '0')}`;
        const fechaFin = new Date(fecha);
        fechaFin.setMinutes(fecha.getMinutes() + appointment.duracion);
        const horaFin = `${fechaFin.getHours().toString().padStart(2, '0')}:${fechaFin.getMinutes().toString().padStart(2, '0')}`;
        timeEl.textContent = `${horaInicio} - ${horaFin}`;
        
        // Resetear selecci√≥n de estado
        document.querySelectorAll('.attendance-btn').forEach(btn => {
            btn.classList.remove('selected');
        });
        
        // Seleccionar el estado actual si existe
        if (appointment.estado) {
            const currentStatusBtn = document.querySelector(`.attendance-btn[data-status="${appointment.estado}"]`);
            if (currentStatusBtn) {
                currentStatusBtn.classList.add('selected');
            }
        }
        
        // Notas de asistencia
        document.getElementById('attendance-notes').value = appointment.notasAsistencia || '';
        
        // Guardar referencia a la cita actual
        attendanceModal.dataset.appointmentId = appointment.id;
        
        // Mostrar modal
        attendanceModal.style.display = 'block';
    }
    
    // Cerrar modal de asistencia
    function closeAttendanceModal() {
        attendanceModal.style.display = 'none';
    }
    
    // Guardar asistencia
    function saveAttendance() {
        if (!isAdmin) return;
        
        const appointmentId = attendanceModal.dataset.appointmentId;
        const selectedBtn = document.querySelector('.attendance-btn.selected');
        
        if (!selectedBtn) {
            showStatusMessage('Por favor selecciona un estado de asistencia', 'warning');
            return;
        }
        
        const status = selectedBtn.dataset.status;
        const notes = document.getElementById('attendance-notes').value;
        
        showSpinner();
        
        // Actualizar en Firestore
        db.collection('citas').doc(appointmentId).update({
            estado: status,
            notasAsistencia: notes,
            actualizadoPor: currentUser.uid,
            fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
            closeAttendanceModal();
            showStatusMessage('Asistencia registrada correctamente', 'success');
            loadAppointments();
        })
        .catch((error) => {
            console.error("Error al registrar asistencia:", error);
            hideSpinner();
            showStatusMessage('Error al registrar la asistencia', 'error');
        });
    }
    
    // Mostrar/ocultar spinner de carga
    function showSpinner() {
        spinner.style.display = 'flex';
    }
    
    function hideSpinner() {
        spinner.style.display = 'none';
    }
    
    // Mostrar mensaje de estado
    function showStatusMessage(message, type = 'success') {
        statusMessage.textContent = message;
        statusMessage.className = 'status-message ' + type;
        statusMessage.style.display = 'block';
        
        // Ocultar despu√©s de 3 segundos
        setTimeout(() => {
            statusMessage.style.display = 'none';
        }, 3000);
    }
    </script>
</body>
</html>
