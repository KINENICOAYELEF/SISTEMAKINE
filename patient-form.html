<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Ingreso - Sistema Kinesiológico</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        /* Estilos adicionales para el formulario */
        .form-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            background-color: #fff;
        }
        
        .form-section-title {
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #007bff;
            color: #007bff;
        }
        
        .form-buttons {
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar (menú lateral) -->
            <div class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="sidebar-header mb-3">
                        <h5 class="text-center">Sistema Kinesiológico</h5>
                        <hr>
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="../dashboard.html">
                                <i class="fas fa-home"></i> Panel Principal
                            </a>
                        </li>
                        
                        <li class="nav-header mt-3">PACIENTES</li>
                        <li class="nav-item">
                            <a class="nav-link active" href="patient-form.html">
                                <i class="fas fa-user-plus"></i> Formulario de Ingreso
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="records.html">
                                <i class="fas fa-users"></i> Listado de Pacientes
                            </a>
                        </li>
                        
                        <li class="nav-header mt-3">EVALUACIÓN</li>
                        <li class="nav-item">
                            <a class="nav-link" href="diagnosis.html">
                                <i class="fas fa-stethoscope"></i> Diagnóstico Kinesiológico
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="treatment.html">
                                <i class="fas fa-clipboard-list"></i> Plan de Tratamiento
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="evolution.html">
                                <i class="fas fa-chart-line"></i> Evoluciones
                            </a>
                        </li>
                        
                        <li class="nav-header mt-3">ANÁLISIS</li>
                        <li class="nav-item">
                            <a class="nav-link" href="dashboard-analysis.html">
                                <i class="fas fa-chart-bar"></i> Dashboard y Análisis
                            </a>
                        </li>
                    </ul>
                    
                    <hr>
                    <div class="sidebar-footer">
                        <button id="logoutBtn" class="btn btn-outline-danger btn-sm w-100">
                            <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Contenido principal -->
            <div class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- Barra superior -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2"><i class="fas fa-user-plus"></i> Formulario de Ingreso</h1>
                </div>
                
                <!-- Botones principales -->
                <div class="form-buttons">
                    <button type="button" class="btn btn-primary" id="savePatientBtn">
                        <i class="fas fa-save"></i> Guardar Paciente
                    </button>
                    <button type="button" class="btn btn-secondary" id="clearFormBtn">
                        <i class="fas fa-eraser"></i> Limpiar Formulario
                    </button>
                </div>
                
                <!-- Formulario completo -->
                <form id="patientForm">
                    <input type="hidden" id="patientId">
                    
                    <!-- Datos del Kinesiólogo -->
                    <div class="form-section">
                        <h3 class="form-section-title">Datos del Kinesiólogo</h3>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="therapistName" class="form-label">Nombre del Kinesiólogo/Estudiante</label>
                                <input type="text" class="form-control" id="therapistName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="evaluationDate" class="form-label">Fecha de Evaluación</label>
                                <input type="date" class="form-control" id="evaluationDate" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Datos Básicos -->
                    <div class="form-section">
                        <h3 class="form-section-title">Datos Básicos</h3>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="firstName" class="form-label">Nombre</label>
                                <input type="text" class="form-control" id="firstName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lastName" class="form-label">Apellido</label>
                                <input type="text" class="form-control" id="lastName" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="rut" class="form-label">RUT</label>
                                <input type="text" class="form-control" id="rut" placeholder="12.345.678-9" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="birthDate" class="form-label">Fecha de Nacimiento</label>
                                <input type="date" class="form-control" id="birthDate" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="gender" class="form-label">Género</label>
                                <select class="form-select" id="gender" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="masculino">Masculino</option>
                                    <option value="femenino">Femenino</option>
                                    <option value="otro">Otro</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="age" class="form-label">Edad</label>
                                <input type="number" class="form-control" id="age" min="0" max="120">
                            </div>
                            <div class="col-md-8 mb-3">
                                <label for="laterality" class="form-label">Lateralidad</label>
                                <div class="form-check form-check-inline mt-2">
                                    <input class="form-check-input" type="radio" name="laterality" id="lateralityRight" value="diestro" checked>
                                    <label class="form-check-label" for="lateralityRight">Diestro</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="laterality" id="lateralityLeft" value="zurdo">
                                    <label class="form-check-label" for="lateralityLeft">Zurdo</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="laterality" id="lateralityAmbidextrous" value="ambidiestro">
                                    <label class="form-check-label" for="lateralityAmbidextrous">Ambidiestro</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Información de Contacto -->
                    <div class="form-section">
                        <h3 class="form-section-title">Información de Contacto</h3>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="phone" class="form-label">Teléfono</label>
                                <input type="tel" class="form-control" id="phone">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="address" class="form-label">Dirección</label>
                                <input type="text" class="form-control" id="address">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="city" class="form-label">Ciudad</label>
                                <input type="text" class="form-control" id="city">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Datos Sociodemográficos -->
                    <div class="form-section">
                        <h3 class="form-section-title">Datos Sociodemográficos</h3>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="nationality" class="form-label">Nacionalidad</label>
                                <input type="text" class="form-control" id="nationality">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="maritalStatus" class="form-label">Estado Civil</label>
                                <select class="form-select" id="maritalStatus">
                                    <option value="">Seleccionar...</option>
                                    <option value="soltero">Soltero/a</option>
                                    <option value="casado">Casado/a</option>
                                    <option value="divorciado">Divorciado/a</option>
                                    <option value="viudo">Viudo/a</option>
                                    <option value="otro">Otro</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="educationLevel" class="form-label">Nivel Educacional</label>
                                <select class="form-select" id="educationLevel">
                                    <option value="">Seleccionar...</option>
                                    <option value="basica">Básica</option>
                                    <option value="media">Media</option>
                                    <option value="tecnica">Técnica</option>
                                    <option value="universitaria">Universitaria</option>
                                    <option value="postgrado">Postgrado</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Motivo de Consulta -->
                    <div class="form-section">
                        <h3 class="form-section-title">Motivo de Consulta</h3>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="consultReason" class="form-label">Motivo de Consulta Detallado</label>
                                <textarea class="form-control" id="consultReason" rows="3" required></textarea>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="medicalDiagnosis" class="form-label">Diagnóstico Médico</label>
                                <input type="text" class="form-control" id="medicalDiagnosis">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="expectations" class="form-label">Expectativas del Paciente</label>
                                <textarea class="form-control" id="expectations" rows="3"></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="patientObjectives" class="form-label">Objetivos del Paciente</label>
                                <textarea class="form-control" id="patientObjectives" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botones finales -->
                    <div class="form-buttons">
                        <button type="button" class="btn btn-primary btn-lg" id="savePatientBtnBottom">
                            <i class="fas fa-save"></i> Guardar Paciente
                        </button>
                        <button type="button" class="btn btn-secondary btn-lg" id="clearFormBtnBottom">
                            <i class="fas fa-eraser"></i> Limpiar Formulario
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase y scripts personalizados -->
    <script type="module">
        import { auth, db } from "../js/firebase-config.js";
        import { 
            collection, 
            addDoc, 
            getDoc, 
            doc, 
            updateDoc 
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // Verificar autenticación
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                // No hay usuario autenticado, redirigir al login
                window.location.href = '../index.html';
            }
        });

        // Cerrar sesión
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = '../index.html';
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                alert("Error al cerrar sesión");
            }
        });

        // Variables globales
        let isEditing = false;
        
        // Verificar si hay un ID de paciente en la URL (para edición)
        const urlParams = new URLSearchParams(window.location.search);
        const patientId = urlParams.get('id');
        
        if (patientId) {
            // Estamos en modo edición
            isEditing = true;
            document.querySelector('h1').innerHTML = '<i class="fas fa-edit"></i> Editar Paciente';
            loadPatientData(patientId);
        } else {
            // Configurar fecha actual para la evaluación
            document.getElementById('evaluationDate').valueAsDate = new Date();
        }
        
        // Función para cargar datos del paciente (en modo edición)
        async function loadPatientData(id) {
            try {
                const docRef = doc(db, "patients", id);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const patientData = docSnap.data();
                    
                    // Llenar el formulario con los datos
                    document.getElementById('patientId').value = id;
                    document.getElementById('therapistName').value = patientData.therapistName || '';
                    document.getElementById('evaluationDate').value = patientData.evaluationDate || '';
                    document.getElementById('firstName').value = patientData.firstName || '';
                    document.getElementById('lastName').value = patientData.lastName || '';
                    document.getElementById('rut').value = patientData.rut || '';
                    document.getElementById('birthDate').value = patientData.birthDate || '';
                    document.getElementById('gender').value = patientData.gender || '';
                    document.getElementById('age').value = patientData.age || '';
                    
                    // Lateralidad
                    if (patientData.laterality) {
                        const lateralityRadio = document.querySelector(`input[name="laterality"][value="${patientData.laterality}"]`);
                        if (lateralityRadio) lateralityRadio.checked = true;
                    }
                    
                    // Información de contacto
                    document.getElementById('phone').value = patientData.phone || '';
                    document.getElementById('email').value = patientData.email || '';
                    document.getElementById('address').value = patientData.address || '';
                    document.getElementById('city').value = patientData.city || '';
                    
                    // Datos sociodemográficos
                    document.getElementById('nationality').value = patientData.nationality || '';
                    document.getElementById('maritalStatus').value = patientData.maritalStatus || '';
                    document.getElementById('educationLevel').value = patientData.educationLevel || '';
                    
                    // Motivo de consulta
                    document.getElementById('consultReason').value = patientData.consultReason || '';
                    document.getElementById('medicalDiagnosis').value = patientData.medicalDiagnosis || '';
                    document.getElementById('expectations').value = patientData.expectations || '';
                    document.getElementById('patientObjectives').value = patientData.patientObjectives || '';
                } else {
                    alert("No se encontró el paciente con ID: " + id);
                    window.location.href = 'records.html';
                }
            } catch (error) {
                console.error("Error al cargar datos del paciente:", error);
                alert("Error al cargar datos del paciente");
            }
        }
        
        // Evento para guardar paciente
        async function savePatient() {
            try {
                // Recopilar datos del formulario
                const patientData = {
                    therapistName: document.getElementById('therapistName').value,
                    evaluationDate: document.getElementById('evaluationDate').value,
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    rut: document.getElementById('rut').value,
                    birthDate: document.getElementById('birthDate').value,
                    gender: document.getElementById('gender').value,
                    age: document.getElementById('age').value ? parseInt(document.getElementById('age').value) : null,
                    laterality: document.querySelector('input[name="laterality"]:checked')?.value || 'diestro',
                    phone: document.getElementById('phone').value,
                    email: document.getElementById('email').value,
                    address: document.getElementById('address').value,
                    city: document.getElementById('city').value,
                    nationality: document.getElementById('nationality').value,
                    maritalStatus: document.getElementById('maritalStatus').value,
                    educationLevel: document.getElementById('educationLevel').value,
                    consultReason: document.getElementById('consultReason').value,
                    medicalDiagnosis: document.getElementById('medicalDiagnosis').value,
                    expectations: document.getElementById('expectations').value,
                    patientObjectives: document.getElementById('patientObjectives').value,
                    status: 'active', // Por defecto, los pacientes están activos
                    updatedAt: new Date().toISOString()
                };
                
                // ID del paciente (si estamos editando)
                const patientId = document.getElementById('patientId').value;
                
                if (isEditing && patientId) {
                    // Actualizar paciente existente
                    await updateDoc(doc(db, "patients", patientId), patientData);
                    alert("Paciente actualizado correctamente");
                } else {
                    // Agregar marca de tiempo de creación para nuevos pacientes
                    patientData.createdAt = new Date().toISOString();
                    
                    // Guardar nuevo paciente
                    const docRef = await addDoc(collection(db, "patients"), patientData);
                    alert("Paciente guardado correctamente con ID: " + docRef.id);
                    
                    // Limpiar formulario después de guardar
                    document.getElementById('patientForm').reset();
                    document.getElementById('evaluationDate').valueAsDate = new Date();
                }
            } catch (error) {
                console.error("Error al guardar paciente:", error);
                alert("Error al guardar paciente: " + error.message);
            }
        }
        
        // Validar formulario antes de enviar
        function validateForm() {
            const form = document.getElementById('patientForm');
            
            // Verificar campos requeridos
            const requiredFields = form.querySelectorAll('[required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });
            
            return isValid;
        }
        
        // Vincular eventos a botones
        document.getElementById('savePatientBtn').addEventListener('click', async () => {
            if (validateForm()) {
                await savePatient();
            } else {
                alert("Por favor complete todos los campos obligatorios");
            }
        });
        
        document.getElementById('savePatientBtnBottom').addEventListener('click', async () => {
            if (validateForm()) {
                await savePatient();
            } else {
                alert("Por favor complete todos los campos obligatorios");
            }
        });
        
        document.getElementById('clearFormBtn').addEventListener('click', () => {
            if (confirm("¿Está seguro de limpiar el formulario? Se perderán los datos no guardados.")) {
                document.getElementById('patientForm').reset();
                document.getElementById('evaluationDate').valueAsDate = new Date();
            }
        });
        
        document.getElementById('clearFormBtnBottom').addEventListener('click', () => {
            if (confirm("¿Está seguro de limpiar el formulario? Se perderán los datos no guardados.")) {
                document.getElementById('patientForm').reset();
                document.getElementById('evaluationDate').valueAsDate = new Date();
            }
        });
        
        // Calcular edad automáticamente al cambiar fecha de nacimiento
        document.getElementById('birthDate').addEventListener('change', function() {
            const birthDate = new Date(this.value);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            document.getElementById('age').value = age;
        });
    </script>
</body>
</html>
